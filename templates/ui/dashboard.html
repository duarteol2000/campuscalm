{% extends "ui/base_student.html" %}
{% load i18n %}

{% block content %}
{% trans "Sem dados" as label_no_data %}
{% url 'ui-dashboard' as dashboard_url %}

<!-- Cabeçalho da página -->
<div class="student-page-header">
  <div>
    <h1 class="student-page-title">{% trans "Dashboard" %}</h1>
    <p class="student-page-subtitle">{% trans "Resumo da semana" %}</p>
  </div>
  <form class="student-search" method="get">
    <input class="form-control form-control-sm" type="text" name="q" placeholder="{% trans "Buscar tarefa ou evento" %}"
           value="{{ search_query }}">
    <button class="btn btn-sm btn-outline-secondary" type="submit">{% trans "Aplicar" %}</button>
    <a class="btn btn-sm btn-link" href="{{ dashboard_url }}?clear=1">{% trans "Limpar" %}</a>
  </form>
</div>

<!-- Alerta de onboarding -->
{% if not onboarding_status.is_complete %}
  <div class="student-alert">
    <div class="fw-semibold">{% trans "Onboarding incompleto" %}</div>
    <div>{% trans "Finalize as etapas pendentes para liberar todo o painel." %}</div>
  </div>
{% endif %}

<div class="student-grid">
  <!-- Progresso do onboarding -->
  <section class="student-card student-span-7">
    <div class="student-card-header">
      <h2 class="student-card-title">{% trans "Progresso do onboarding" %}</h2>
      <span class="student-card-muted">{{ onboarding_status.completed_steps }}/{{ onboarding_status.total_steps }}</span>
    </div>
    <div class="student-progress">
      <div class="student-progress-bar" style="width: {{ onboarding_status.progress_percent }}%;"></div>
    </div>
    <ul class="student-checklist">
      {% for step in onboarding_status.steps %}
        <li class="student-checklist-item">
          <span>{{ step.label }}</span>
          {% if step.missing %}
            <span class="student-badge pending">{% trans "Pendente" %}</span>
          {% else %}
            <span class="student-badge ok">{% trans "Ok" %}</span>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
    {% if not onboarding_status.is_complete %}
      <div class="mt-3">
        <a class="student-btn student-btn-primary" href="{% url 'ui-onboarding' %}">{% trans "Continuar configuracao" %}</a>
      </div>
    {% endif %}
  </section>

  <!-- Card Hoje -->
  <section class="student-card student-span-5">
    <div class="student-card-header">
      <h2 class="student-card-title">{% trans "Hoje" %}</h2>
      <span class="student-card-muted">{% trans "Visao rapida" %}</span>
    </div>
    <ul class="student-list">
      <li class="student-list-item">
        <div>
          <div class="student-list-title">{% trans "Proxima tarefa" %}</div>
          {% if dashboard_data.upcoming_tasks %}
            <div class="student-list-meta">{{ dashboard_data.upcoming_tasks.0.title }}</div>
          {% else %}
            <div class="student-list-meta">{% trans "Sem itens no momento" %}</div>
          {% endif %}
        </div>
        {% if dashboard_data.upcoming_tasks %}
          <span class="student-list-meta">{{ dashboard_data.upcoming_tasks.0.due_date|date:"d/m/Y" }}</span>
        {% endif %}
      </li>
      <li class="student-list-item">
        <div>
          <div class="student-list-title">{% trans "Proximo evento" %}</div>
          {% if dashboard_data.upcoming_events %}
            <div class="student-list-meta">{{ dashboard_data.upcoming_events.0.title }}</div>
          {% else %}
            <div class="student-list-meta">{% trans "Sem itens no momento" %}</div>
          {% endif %}
        </div>
        {% if dashboard_data.upcoming_events %}
          <span class="student-list-meta">{{ dashboard_data.upcoming_events.0.start_at|date:"d/m/Y" }}</span>
        {% endif %}
      </li>
      <li class="student-list-item">
        <div>
          <div class="student-list-title">{% trans "Lembretes" %}</div>
          <div class="student-list-meta">{% trans "Sem itens no momento" %}</div>
        </div>
        <span class="student-list-meta">—</span>
      </li>
    </ul>
  </section>

  <!-- Próximas tarefas -->
  <section class="student-card student-span-7">
    <div class="student-card-header">
      <h2 class="student-card-title">{% trans "Proximas tarefas" %}</h2>
      <a class="student-card-muted" href="{% url 'ui-task-list' %}">{% trans "Ver todas" %}</a>
    </div>
    {% if dashboard_data.upcoming_tasks %}
      <ul class="student-list">
        {% for task in dashboard_data.upcoming_tasks %}
          <li class="student-list-item">
            <span class="student-list-title">{{ task.title }}</span>
            <span class="student-list-meta">{{ task.due_date|date:"d/m/Y" }}</span>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="student-card-muted">{% trans "Nenhuma tarefa proxima." %}</p>
    {% endif %}
  </section>

  <!-- Próximo evento -->
  <section class="student-card student-span-5">
    <div class="student-card-header">
      <h2 class="student-card-title">{% trans "Agenda" %}</h2>
      <a class="student-card-muted" href="{% url 'ui-agenda-list' %}">{% trans "Ver agenda" %}</a>
    </div>
    {% if dashboard_data.upcoming_events %}
      <div class="student-list">
        <div class="student-list-item">
          <div>
            <div class="student-list-title">{{ dashboard_data.upcoming_events.0.title }}</div>
            <div class="student-list-meta">{{ dashboard_data.upcoming_events.0.start_at|date:"d/m/Y H:i" }}</div>
          </div>
        </div>
      </div>
    {% else %}
      <p class="student-card-muted">{% trans "Nenhum evento nos proximos dias." %}</p>
    {% endif %}
  </section>

  <!-- Progresso por disciplina -->
  <section class="student-card student-span-12">
    <div class="student-card-header">
      <h2 class="student-card-title">{% trans "Progresso por disciplina" %}</h2>
      <span class="student-card-muted">{% trans "Acompanhe seu desempenho" %}</span>
    </div>
    {% if dashboard_data.course_progress %}
      {% for course in dashboard_data.course_progress %}
        <div class="student-course">
          <div class="student-course-header">
            <div class="student-list-title">{{ course.title }}</div>
            <div class="student-list-meta">{{ course.semester }}</div>
          </div>
          <div class="student-card-muted">
            {% blocktrans with current=course.current_average passing=course.passing_grade %}Media atual: {{ current }} | Media minima: {{ passing }}{% endblocktrans %}
          </div>
          <div class="student-progress">
            <div class="student-progress-bar" style="width: {{ course.progress_percent }}%;"></div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p class="student-card-muted">{% trans "Nenhuma disciplina cadastrada." %}</p>
    {% endif %}
  </section>

  <!-- Insights -->
  <section class="student-card student-span-12">
    <div class="student-card-header">
      <h2 class="student-card-title">{% trans "Insights" %}</h2>
      <span class="student-card-muted">{% trans "Visao geral da semana" %}</span>
    </div>
    <p class="student-card-muted mb-3">{{ dashboard_data.message_andamento|default:label_no_data }}</p>
    <div class="student-insights">
      <div class="student-insight insight-clickable" data-insight-type="mood" role="button" tabindex="0" aria-label="{% trans "Detalhes de humor" %}">
        <div class="student-insight-label">{% trans "Humor mais comum" %}</div>
        <div class="student-insight-value">{{ dashboard_data.mood_most_common|default:label_no_data }}</div>
        <div class="student-card-muted small">{% blocktrans with total=dashboard_data.mood_weekly_total %}{{ total }} registros{% endblocktrans %}</div>
      </div>
      <div class="student-insight insight-clickable" data-insight-type="focus" role="button" tabindex="0" aria-label="{% trans "Detalhes de foco" %}">
        <div class="student-insight-label">{% trans "Minutos de foco" %}</div>
        <div class="student-insight-value">{{ dashboard_data.focus_minutes_week }}</div>
        <div class="student-card-muted small">{% trans "Ultimos 7 dias" %}</div>
      </div>
      <div class="student-insight insight-clickable" data-insight-type="stress" role="button" tabindex="0" aria-label="{% trans "Detalhes de estresse" %}">
        <div class="student-insight-label">{% trans "Estresse medio" %}</div>
        <div class="student-insight-value">{{ dashboard_data.stress_avg_week|default:label_no_data }}</div>
        <div class="student-card-muted small">{% trans "Media dos check-ins" %}</div>
      </div>
      <div class="student-insight insight-clickable" data-insight-type="upcoming" role="button" tabindex="0" aria-label="{% trans "Detalhes de prazos" %}">
        <div class="student-insight-label">{% trans "Proximos prazos" %}</div>
        <div class="student-insight-value">{{ dashboard_data.upcoming_count }}</div>
        <div class="student-card-muted small">{% trans "Tarefas e eventos" %}</div>
      </div>
    </div>
  </section>
</div>

<div class="modal fade" id="insightDetailModal" tabindex="-1" aria-labelledby="insightDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="insightDetailModalLabel">{% trans "Detalhes do insight" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans "Fechar" %}"></button>
      </div>
      <div class="modal-body" id="insightDetailModalBody">
        <p class="text-muted mb-0">{% trans "Carregando detalhes..." %}</p>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    function initInsightModal() {
      var cards = document.querySelectorAll(".insight-clickable[data-insight-type]");
      if (!cards.length || typeof window.bootstrap === "undefined") {
        return;
      }

      var modalEl = document.getElementById("insightDetailModal");
      var modalBody = document.getElementById("insightDetailModalBody");
      var modalTitle = document.getElementById("insightDetailModalLabel");
      if (!modalEl || !modalBody || !modalTitle) {
        return;
      }

      var modal = window.bootstrap.Modal.getOrCreateInstance(modalEl);
      var detailUrl = "{% url 'insights_detail' %}";

      function loadInsightDetail(card) {
        var insightType = card.getAttribute("data-insight-type");
        var insightLabelEl = card.querySelector(".student-insight-label");
        var insightLabel = insightLabelEl ? insightLabelEl.textContent.trim() : "";
        modalTitle.textContent = insightLabel || "{% trans 'Detalhes do insight' %}";
        modalBody.innerHTML = '<p class="text-muted mb-0">{% trans "Carregando detalhes..." %}</p>';
        modal.show();

        fetch(detailUrl + "?type=" + encodeURIComponent(insightType), {
          credentials: "same-origin",
          headers: {
            "X-Requested-With": "XMLHttpRequest"
          }
        })
          .then(function (response) {
            if (!response.ok) {
              throw new Error("request failed");
            }
            return response.text();
          })
          .then(function (html) {
            modalBody.innerHTML = html;
          })
          .catch(function () {
            modalBody.innerHTML = '<p class="text-danger mb-0">{% trans "Nao foi possivel carregar os detalhes agora." %}</p>';
          });
      }

      cards.forEach(function (card) {
        card.addEventListener("click", function () {
          loadInsightDetail(card);
        });
        card.addEventListener("keydown", function (event) {
          if (event.key === "Enter" || event.key === " ") {
            event.preventDefault();
            loadInsightDetail(card);
          }
        });
      });
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initInsightModal);
      return;
    }
    initInsightModal();
  })();
</script>
{% endblock %}
