DUMP ENXUTO DO PROJETO CAMPUSCALM
Gerado em: 2026-02-13T08:52:27-03:00
Diretorio base: /home/marcosdo/projetos/campuscalm

========================================
ESCOPO
========================================
manage.py
requirements.txt
README.md
config
apps
utils
templates
static
scripts

========================================
ESTRUTURA (ENXUTA)
========================================
manage.py
requirements.txt
README.md
config
config/__init__.py
config/__pycache__
config/__pycache__/__init__.cpython-312.pyc
config/__pycache__/settings.cpython-312.pyc
config/__pycache__/settings_migrations.cpython-312.pyc
config/__pycache__/urls.cpython-312.pyc
config/__pycache__/views.cpython-312.pyc
config/__pycache__/wsgi.cpython-312.pyc
config/asgi.py
config/settings.py
config/settings_migrations.py
config/urls.py
config/views.py
config/wsgi.py
apps
apps/access_requests
apps/access_requests/__init__.py
apps/access_requests/__pycache__
apps/access_requests/__pycache__/__init__.cpython-312.pyc
apps/access_requests/__pycache__/admin.cpython-312.pyc
apps/access_requests/__pycache__/apps.cpython-312.pyc
apps/access_requests/__pycache__/models.cpython-312.pyc
apps/access_requests/__pycache__/serializers.cpython-312.pyc
apps/access_requests/__pycache__/urls.cpython-312.pyc
apps/access_requests/__pycache__/views.cpython-312.pyc
apps/access_requests/admin.py
apps/access_requests/apps.py
apps/access_requests/migrations
apps/access_requests/migrations/0001_initial.py
apps/access_requests/migrations/0002_initial.py
apps/access_requests/migrations/__init__.py
apps/access_requests/migrations/__pycache__
apps/access_requests/migrations/__pycache__/0001_initial.cpython-312.pyc
apps/access_requests/migrations/__pycache__/0002_initial.cpython-312.pyc
apps/access_requests/migrations/__pycache__/__init__.cpython-312.pyc
apps/access_requests/models.py
apps/access_requests/serializers.py
apps/access_requests/tests.py
apps/access_requests/urls.py
apps/access_requests/views.py
apps/accounts
apps/accounts/__init__.py
apps/accounts/__pycache__
apps/accounts/__pycache__/__init__.cpython-312.pyc
apps/accounts/__pycache__/admin.cpython-312.pyc
apps/accounts/__pycache__/apps.cpython-312.pyc
apps/accounts/__pycache__/models.cpython-312.pyc
apps/accounts/__pycache__/serializers.cpython-312.pyc
apps/accounts/__pycache__/signals.cpython-312.pyc
apps/accounts/__pycache__/urls.cpython-312.pyc
apps/accounts/__pycache__/views.cpython-312.pyc
apps/accounts/admin.py
apps/accounts/apps.py
apps/accounts/migrations
apps/accounts/migrations/0001_initial.py
apps/accounts/migrations/0002_userprofile.py
apps/accounts/migrations/__init__.py
apps/accounts/migrations/__pycache__
apps/accounts/migrations/__pycache__/0001_initial.cpython-312.pyc
apps/accounts/migrations/__pycache__/0002_userprofile.cpython-312.pyc
apps/accounts/migrations/__pycache__/__init__.cpython-312.pyc
apps/accounts/models.py
apps/accounts/serializers.py
apps/accounts/signals.py
apps/accounts/tests.py
apps/accounts/urls.py
apps/accounts/views.py
apps/agenda
apps/agenda/__init__.py
apps/agenda/__pycache__
apps/agenda/__pycache__/__init__.cpython-312.pyc
apps/agenda/__pycache__/admin.cpython-312.pyc
apps/agenda/__pycache__/apps.cpython-312.pyc
apps/agenda/__pycache__/models.cpython-312.pyc
apps/agenda/__pycache__/serializers.cpython-312.pyc
apps/agenda/__pycache__/urls.cpython-312.pyc
apps/agenda/__pycache__/views.cpython-312.pyc
apps/agenda/admin.py
apps/agenda/apps.py
apps/agenda/migrations
apps/agenda/migrations/0001_initial.py
apps/agenda/migrations/0002_alter_calendarevent_event_type_and_more.py
apps/agenda/migrations/__init__.py
apps/agenda/migrations/__pycache__
apps/agenda/migrations/__pycache__/0001_initial.cpython-312.pyc
apps/agenda/migrations/__pycache__/0002_alter_calendarevent_event_type_and_more.cpython-312.pyc
apps/agenda/migrations/__pycache__/__init__.cpython-312.pyc
apps/agenda/models.py
apps/agenda/serializers.py
apps/agenda/tests.py
apps/agenda/urls.py
apps/agenda/views.py
apps/analytics
apps/analytics/__init__.py
apps/analytics/__pycache__
apps/analytics/__pycache__/__init__.cpython-312.pyc
apps/analytics/__pycache__/admin.cpython-312.pyc
apps/analytics/__pycache__/apps.cpython-312.pyc
apps/analytics/__pycache__/models.cpython-312.pyc
apps/analytics/__pycache__/urls.cpython-312.pyc
apps/analytics/__pycache__/views.cpython-312.pyc
apps/analytics/admin.py
apps/analytics/apps.py
apps/analytics/management
apps/analytics/management/__init__.py
apps/analytics/management/__pycache__
apps/analytics/management/__pycache__/__init__.cpython-312.pyc
apps/analytics/management/commands
apps/analytics/management/commands/__init__.py
apps/analytics/management/commands/__pycache__
apps/analytics/management/commands/__pycache__/__init__.cpython-312.pyc
apps/analytics/management/commands/__pycache__/seed_demo_data.cpython-312.pyc
apps/analytics/management/commands/seed_demo_data.py
apps/analytics/migrations
apps/analytics/migrations/__init__.py
apps/analytics/migrations/__pycache__
apps/analytics/migrations/__pycache__/__init__.cpython-312.pyc
apps/analytics/models.py
apps/analytics/tests.py
apps/analytics/urls.py
apps/analytics/views.py
apps/billing
apps/billing/__init__.py
apps/billing/__pycache__
apps/billing/__pycache__/__init__.cpython-312.pyc
apps/billing/__pycache__/admin.cpython-312.pyc
apps/billing/__pycache__/apps.cpython-312.pyc
apps/billing/__pycache__/models.cpython-312.pyc
apps/billing/__pycache__/serializers.cpython-312.pyc
apps/billing/__pycache__/signals.cpython-312.pyc
apps/billing/__pycache__/urls.cpython-312.pyc
apps/billing/__pycache__/views.cpython-312.pyc
apps/billing/admin.py
apps/billing/apps.py
apps/billing/migrations
apps/billing/migrations/0001_initial.py
apps/billing/migrations/__init__.py
apps/billing/migrations/__pycache__
apps/billing/migrations/__pycache__/0001_initial.cpython-312.pyc
apps/billing/migrations/__pycache__/__init__.cpython-312.pyc
apps/billing/models.py
apps/billing/serializers.py
apps/billing/signals.py
apps/billing/tests.py
apps/billing/urls.py
apps/billing/views.py
apps/brain
apps/brain/__init__.py
apps/brain/__pycache__
apps/brain/__pycache__/__init__.cpython-312.pyc
apps/brain/__pycache__/admin.cpython-312.pyc
apps/brain/__pycache__/apps.cpython-312.pyc
apps/brain/__pycache__/constants.cpython-312.pyc
apps/brain/__pycache__/models.cpython-312.pyc
apps/brain/__pycache__/tests.cpython-312.pyc
apps/brain/__pycache__/urls.cpython-312.pyc
apps/brain/__pycache__/views.cpython-312.pyc
apps/brain/admin.py
apps/brain/apps.py
apps/brain/constants.py
apps/brain/migrations
apps/brain/migrations/0001_initial.py
apps/brain/migrations/0002_seed_initial_data.py
apps/brain/migrations/0003_seed_social_category.py
apps/brain/migrations/0004_expand_respostas_categorias.py
apps/brain/migrations/0005_seed_evolucao_category.py
apps/brain/migrations/0006_expand_evolucao_girias.py
apps/brain/migrations/0007_expand_evolucao_giria_maravilha.py
apps/brain/migrations/__init__.py
apps/brain/migrations/__pycache__
apps/brain/migrations/__pycache__/0001_initial.cpython-312.pyc
apps/brain/migrations/__pycache__/0002_seed_initial_data.cpython-312.pyc
apps/brain/migrations/__pycache__/0003_seed_social_category.cpython-312.pyc
apps/brain/migrations/__pycache__/0004_expand_respostas_categorias.cpython-312.pyc
apps/brain/migrations/__pycache__/0005_seed_evolucao_category.cpython-312.pyc
apps/brain/migrations/__pycache__/0006_expand_evolucao_girias.cpython-312.pyc
apps/brain/migrations/__pycache__/0007_expand_evolucao_giria_maravilha.cpython-312.pyc
apps/brain/migrations/__pycache__/__init__.cpython-312.pyc
apps/brain/models.py
apps/brain/tests.py
apps/brain/urls.py
apps/brain/views.py
apps/coach_ai
apps/coach_ai/__init__.py
apps/coach_ai/__pycache__
apps/coach_ai/__pycache__/__init__.cpython-312.pyc
apps/coach_ai/__pycache__/admin.cpython-312.pyc
apps/coach_ai/__pycache__/apps.cpython-312.pyc
apps/coach_ai/__pycache__/models.cpython-312.pyc
apps/coach_ai/admin.py
apps/coach_ai/apps.py
apps/coach_ai/migrations
apps/coach_ai/migrations/0001_initial.py
apps/coach_ai/migrations/__init__.py
apps/coach_ai/migrations/__pycache__
apps/coach_ai/migrations/__pycache__/0001_initial.cpython-312.pyc
apps/coach_ai/migrations/__pycache__/__init__.cpython-312.pyc
apps/coach_ai/models.py
apps/coach_ai/tests.py
apps/coach_ai/views.py
apps/content
apps/content/__init__.py
apps/content/__pycache__
apps/content/__pycache__/__init__.cpython-312.pyc
apps/content/__pycache__/admin.cpython-312.pyc
apps/content/__pycache__/apps.cpython-312.pyc
apps/content/__pycache__/models.cpython-312.pyc
apps/content/__pycache__/serializers.cpython-312.pyc
apps/content/__pycache__/urls.cpython-312.pyc
apps/content/__pycache__/views.cpython-312.pyc
apps/content/admin.py
apps/content/apps.py
apps/content/migrations
apps/content/migrations/0001_initial.py
apps/content/migrations/__init__.py
apps/content/migrations/__pycache__
apps/content/migrations/__pycache__/0001_initial.cpython-312.pyc
apps/content/migrations/__pycache__/__init__.cpython-312.pyc
apps/content/models.py
apps/content/serializers.py
apps/content/tests.py
apps/content/urls.py
apps/content/views.py
apps/mood
apps/mood/__init__.py
apps/mood/__pycache__
apps/mood/__pycache__/__init__.cpython-312.pyc
apps/mood/__pycache__/admin.cpython-312.pyc
apps/mood/__pycache__/apps.cpython-312.pyc
apps/mood/__pycache__/models.cpython-312.pyc
apps/mood/__pycache__/serializers.cpython-312.pyc
apps/mood/__pycache__/urls.cpython-312.pyc
apps/mood/__pycache__/views.cpython-312.pyc
apps/mood/admin.py
apps/mood/apps.py
apps/mood/migrations
apps/mood/migrations/0001_initial.py
apps/mood/migrations/__init__.py
apps/mood/migrations/__pycache__
apps/mood/migrations/__pycache__/0001_initial.cpython-312.pyc
apps/mood/migrations/__pycache__/__init__.cpython-312.pyc
apps/mood/models.py
apps/mood/serializers.py
apps/mood/tests.py
apps/mood/urls.py
apps/mood/views.py
apps/notifications
apps/notifications/__init__.py
apps/notifications/__pycache__
apps/notifications/__pycache__/__init__.cpython-312.pyc
apps/notifications/__pycache__/admin.cpython-312.pyc
apps/notifications/__pycache__/apps.cpython-312.pyc
apps/notifications/__pycache__/models.cpython-312.pyc
apps/notifications/__pycache__/serializers.cpython-312.pyc
apps/notifications/__pycache__/urls.cpython-312.pyc
apps/notifications/__pycache__/views.cpython-312.pyc
apps/notifications/admin.py
apps/notifications/apps.py
apps/notifications/management
apps/notifications/management/__init__.py
apps/notifications/management/__pycache__
apps/notifications/management/__pycache__/__init__.cpython-312.pyc
apps/notifications/management/commands
apps/notifications/management/commands/__init__.py
apps/notifications/management/commands/__pycache__
apps/notifications/management/commands/__pycache__/__init__.cpython-312.pyc
apps/notifications/management/commands/__pycache__/process_notification_queue.cpython-312.pyc
apps/notifications/management/commands/process_notification_queue.py
apps/notifications/migrations
apps/notifications/migrations/0001_initial.py
apps/notifications/migrations/0002_notificationqueue_action_taken_and_more.py
apps/notifications/migrations/__init__.py
apps/notifications/migrations/__pycache__
apps/notifications/migrations/__pycache__/0001_initial.cpython-312.pyc
apps/notifications/migrations/__pycache__/0002_notificationqueue_action_taken_and_more.cpython-312.pyc
apps/notifications/migrations/__pycache__/__init__.cpython-312.pyc
apps/notifications/models.py
apps/notifications/serializers.py
apps/notifications/services
apps/notifications/services/__pycache__
apps/notifications/services/__pycache__/reminder_queue.cpython-312.pyc
apps/notifications/services/__pycache__/whatsapp_cloud.cpython-312.pyc
apps/notifications/services/__pycache__/whatsapp_service.cpython-312.pyc
apps/notifications/services/reminder_queue.py
apps/notifications/services/whatsapp_cloud.py
apps/notifications/services/whatsapp_service.py
apps/notifications/tests.py
apps/notifications/urls.py
apps/notifications/views.py
apps/onboarding
apps/onboarding/__init__.py
apps/onboarding/__pycache__
apps/onboarding/__pycache__/__init__.cpython-312.pyc
apps/onboarding/__pycache__/admin.cpython-312.pyc
apps/onboarding/__pycache__/apps.cpython-312.pyc
apps/onboarding/__pycache__/models.cpython-312.pyc
apps/onboarding/__pycache__/services.cpython-312.pyc
apps/onboarding/__pycache__/signals.cpython-312.pyc
apps/onboarding/__pycache__/urls.cpython-312.pyc
apps/onboarding/__pycache__/views.cpython-312.pyc
apps/onboarding/admin.py
apps/onboarding/apps.py
apps/onboarding/migrations
apps/onboarding/migrations/0001_initial.py
apps/onboarding/migrations/__init__.py
apps/onboarding/migrations/__pycache__
apps/onboarding/migrations/__pycache__/0001_initial.cpython-312.pyc
apps/onboarding/migrations/__pycache__/__init__.cpython-312.pyc
apps/onboarding/models.py
apps/onboarding/services.py
apps/onboarding/signals.py
apps/onboarding/tests.py
apps/onboarding/urls.py
apps/onboarding/views.py
apps/planner
apps/planner/__init__.py
apps/planner/__pycache__
apps/planner/__pycache__/__init__.cpython-312.pyc
apps/planner/__pycache__/admin.cpython-312.pyc
apps/planner/__pycache__/apps.cpython-312.pyc
apps/planner/__pycache__/models.cpython-312.pyc
apps/planner/__pycache__/serializers.cpython-312.pyc
apps/planner/__pycache__/urls.cpython-312.pyc
apps/planner/__pycache__/views.cpython-312.pyc
apps/planner/admin.py
apps/planner/apps.py
apps/planner/migrations
apps/planner/migrations/0001_initial.py
apps/planner/migrations/__init__.py
apps/planner/migrations/__pycache__
apps/planner/migrations/__pycache__/0001_initial.cpython-312.pyc
apps/planner/migrations/__pycache__/__init__.cpython-312.pyc
apps/planner/models.py
apps/planner/serializers.py
apps/planner/tests.py
apps/planner/urls.py
apps/planner/views.py
apps/pomodoro
apps/pomodoro/__init__.py
apps/pomodoro/__pycache__
apps/pomodoro/__pycache__/__init__.cpython-312.pyc
apps/pomodoro/__pycache__/admin.cpython-312.pyc
apps/pomodoro/__pycache__/apps.cpython-312.pyc
apps/pomodoro/__pycache__/models.cpython-312.pyc
apps/pomodoro/__pycache__/serializers.cpython-312.pyc
apps/pomodoro/__pycache__/urls.cpython-312.pyc
apps/pomodoro/__pycache__/views.cpython-312.pyc
apps/pomodoro/admin.py
apps/pomodoro/apps.py
apps/pomodoro/migrations
apps/pomodoro/migrations/0001_initial.py
apps/pomodoro/migrations/__init__.py
apps/pomodoro/migrations/__pycache__
apps/pomodoro/migrations/__pycache__/0001_initial.cpython-312.pyc
apps/pomodoro/migrations/__pycache__/__init__.cpython-312.pyc
apps/pomodoro/models.py
apps/pomodoro/serializers.py
apps/pomodoro/tests.py
apps/pomodoro/urls.py
apps/pomodoro/views.py
apps/semester
apps/semester/__init__.py
apps/semester/__pycache__
apps/semester/__pycache__/__init__.cpython-312.pyc
apps/semester/__pycache__/admin.cpython-312.pyc
apps/semester/__pycache__/apps.cpython-312.pyc
apps/semester/__pycache__/models.cpython-312.pyc
apps/semester/__pycache__/serializers.cpython-312.pyc
apps/semester/__pycache__/urls.cpython-312.pyc
apps/semester/__pycache__/views.cpython-312.pyc
apps/semester/admin.py
apps/semester/apps.py
apps/semester/migrations
apps/semester/migrations/0001_initial.py
apps/semester/migrations/__init__.py
apps/semester/migrations/__pycache__
apps/semester/migrations/__pycache__/0001_initial.cpython-312.pyc
apps/semester/migrations/__pycache__/__init__.cpython-312.pyc
apps/semester/models.py
apps/semester/serializers.py
apps/semester/tests.py
apps/semester/urls.py
apps/semester/views.py
apps/ui
apps/ui/__init__.py
apps/ui/__pycache__
apps/ui/__pycache__/__init__.cpython-312.pyc
apps/ui/__pycache__/apps.cpython-312.pyc
apps/ui/__pycache__/forms.cpython-312.pyc
apps/ui/__pycache__/forms_academic.cpython-312.pyc
apps/ui/__pycache__/forms_agenda.cpython-312.pyc
apps/ui/__pycache__/forms_reminders.cpython-312.pyc
apps/ui/__pycache__/forms_tasks.cpython-312.pyc
apps/ui/__pycache__/services_academic.cpython-312.pyc
apps/ui/__pycache__/urls.cpython-312.pyc
apps/ui/__pycache__/views.cpython-312.pyc
apps/ui/__pycache__/views_academic.cpython-312.pyc
apps/ui/__pycache__/views_agenda.cpython-312.pyc
apps/ui/__pycache__/views_messages.cpython-312.pyc
apps/ui/__pycache__/views_reminders.cpython-312.pyc
apps/ui/__pycache__/views_tasks.cpython-312.pyc
apps/ui/apps.py
apps/ui/forms.py
apps/ui/forms_academic.py
apps/ui/forms_agenda.py
apps/ui/forms_reminders.py
apps/ui/forms_tasks.py
apps/ui/services_academic.py
apps/ui/urls.py
apps/ui/views.py
apps/ui/views_academic.py
apps/ui/views_agenda.py
apps/ui/views_messages.py
apps/ui/views_reminders.py
apps/ui/views_tasks.py
utils
utils/__init__.py
utils/__pycache__
utils/__pycache__/__init__.cpython-312.pyc
utils/__pycache__/academic_progress.cpython-312.pyc
utils/__pycache__/constants.cpython-312.pyc
utils/__pycache__/features.cpython-312.pyc
utils/__pycache__/gating.cpython-312.pyc
utils/__pycache__/messages.cpython-312.pyc
utils/__pycache__/triage.cpython-312.pyc
utils/academic_progress.py
utils/constants.py
utils/features.py
utils/gating.py
utils/messages.py
utils/triage.py
templates
templates/accounts
templates/accounts/email
templates/accounts/email/activate_account.html
templates/accounts/email/activate_account.txt
templates/base.html
templates/registration
templates/registration/password_reset_email.html
templates/registration/password_reset_subject.txt
templates/ui
templates/ui/agenda
templates/ui/agenda.html
templates/ui/agenda/agenda_confirm_delete.html
templates/ui/agenda/agenda_form.html
templates/ui/agenda/agenda_list.html
templates/ui/assessment
templates/ui/assessment/assessment_confirm_delete.html
templates/ui/assessment/assessment_form.html
templates/ui/auth_base.html
templates/ui/base_student.html
templates/ui/course
templates/ui/course/course_confirm_delete.html
templates/ui/course/course_detail.html
templates/ui/course/course_form.html
templates/ui/dashboard.html
templates/ui/first_access.html
templates/ui/home.html
templates/ui/login.html
templates/ui/messages
templates/ui/messages.html
templates/ui/messages/message_list.html
templates/ui/onboarding.html
templates/ui/partials
templates/ui/partials/campuscalm_widget.html
templates/ui/password_reset_complete.html
templates/ui/password_reset_confirm.html
templates/ui/password_reset_done.html
templates/ui/password_reset_form.html
templates/ui/reminders
templates/ui/reminders/reminder_confirm_delete.html
templates/ui/reminders/reminder_form.html
templates/ui/reminders/reminder_list.html
templates/ui/semester
templates/ui/semester/semester_confirm_delete.html
templates/ui/semester/semester_detail.html
templates/ui/semester/semester_form.html
templates/ui/semester/semester_list.html
templates/ui/semesters.html
templates/ui/tasks
templates/ui/tasks.html
templates/ui/tasks/task_confirm_delete.html
templates/ui/tasks/task_detail.html
templates/ui/tasks/task_form.html
templates/ui/tasks/task_list.html
static
static/css
static/css/app.css
static/css/home.css
static/css/student.css
static/img
static/img/logo-campus-calm.png
static/img/logoalgorithminsights_empresa.png
static/ui
static/ui/css
static/ui/css/campuscalm_widget.css
static/ui/js
static/ui/js/campuscalm_widget.js
scripts
scripts/i18n_refresh.sh
scripts/run_curl_demo.sh

========================================
CONTEUDO DOS ARQUIVOS DE TEXTO (ENXUTO)
========================================

----- BEGIN FILE: README.md -----
# Campus Calm (MVP)

MVP para universitarios acompanharem o semestre com bem-estar, organizacao e foco. O projeto usa Django + Django REST Framework, autenticacao JWT e banco SQLite em dev.

## Requisitos
- Python 3.12+
- Pip

## Setup rapido
```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt

python manage.py migrate
python manage.py createsuperuser
python manage.py runserver
```

## Variaveis de ambiente
Copie `.env.example` e ajuste conforme necessario. A variavel `TRIAGE_USE_LLM` prepara a triagem para LLM futuro (mock no MVP).

## Endpoints principais
- Auth: `/api/auth/register/`, `/api/auth/login/`, `/api/auth/refresh/`, `/api/auth/me/`
- Billing: `/api/billing/plan/`, `/api/billing/set-plan/` (admin)
- Onboarding: `/api/onboarding/status/`
- Mood: `/api/mood/entries/`, `/api/mood/summary/weekly/`
- Pomodoro: `/api/pomodoro/start/`, `/api/pomodoro/stop/{id}/`, `/api/pomodoro/summary/weekly/`
- Planner: `/api/planner/tasks/`
- Agenda: `/api/agenda/events/`, `/api/agenda/week/`, `/api/agenda/generate-reminders/`
- Semester: `/api/semester/semesters/`, `/api/semester/courses/`, `/api/semester/assessments/`, `/api/semester/courses/{id}/progress/`, `/api/semester/finish/{semester_id}/`
- Content: `/api/content/guided/`, `/api/content/guided/{id}/`
- Notifications: `/api/notifications/test-email/`, `/api/notifications/pending/`
- Access Requests: `/api/access/requests/`, `/api/access/requests/{id}/approve/`, `/api/access/requests/{id}/reject/`, `/api/access/triage/{id}/log/`
- Analytics: `/api/analytics/dashboard/`, `/api/analytics/semester/{semester_id}/`

## Documentacao automatica
- Schema: `/api/schema/`
- Swagger UI: `/api/docs/`

## Exemplos com curl
### Registrar
```bash
curl -X POST http://localhost:8000/api/auth/register/ \
  -H "Content-Type: application/json" \
  -d '{"email":"aluno@exemplo.com","name":"Aluno","password":"senha123"}'
```

### Login
```bash
curl -X POST http://localhost:8000/api/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{"email":"aluno@exemplo.com","password":"senha123"}'
```

### Criar check-in de humor
```bash
curl -X POST http://localhost:8000/api/mood/entries/ \
  -H "Authorization: Bearer <ACCESS_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{"mood":"OK","notes":"Dia produtivo"}'
```

### Criar tarefa
```bash
curl -X POST http://localhost:8000/api/planner/tasks/ \
  -H "Authorization: Bearer <ACCESS_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{"title":"Trabalho final","due_date":"2026-03-10","stress_level":3,"status":"TODO"}'
```

### Criar regra de lembrete e gerar notificacoes
```bash
curl -X POST http://localhost:8000/api/agenda/reminder-rules/ \
  -H "Authorization: Bearer <ACCESS_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{"target_type":"TASK","remind_before_minutes":60,"channels":["EMAIL"],"is_active":true}'

curl -X POST http://localhost:8000/api/agenda/generate-reminders/ \
  -H "Authorization: Bearer <ACCESS_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{}'
```

### Solicitar acesso (triagem automatica)
```bash
curl -X POST http://localhost:8000/api/access/requests/ \
  -H "Content-Type: application/json" \
  -d '{"requester_email":"coord@faculdade.com","requester_type":"INSTITUTION","estimated_users":120}'
```

## Health-check
```bash
curl http://localhost:8000/health/
```

## Script de demo (curl)
```bash
bash scripts/run_curl_demo.sh
```

## Seed de dados (mais completo)
```bash
python manage.py seed_demo_data --email nari.naluu@gmail.com
```

## Notificacoes
- Email: backend console em dev.
- WhatsApp/SMS: mock no MVP.

Processar fila manualmente:
```bash
python manage.py process_notification_queue
```

## Sistema de mensagens
O Campus Calm usa um **Message Framework** centralizado em `utils/messages.py`.
- Tipos: REMINDER, CARE, INCENTIVE, WARNING, ACHIEVEMENT, SYSTEM
- Canais: IN_APP (sempre), EMAIL (conforme plano), WHATSAPP/SMS (mock)
- Todas as mensagens usam tom calmo e nao clinico.

As mensagens ficam registradas em `notifications.NotificationQueue`.

## Progresso academico
Os calculos de progresso ficam em `utils/academic_progress.py`:
- **media ponderada** por peso
- **progress_percent** limitado a 100%
- **needed_to_pass** nunca negativo

Regras de status:
- progress_percent >= 100% -> PASSED
- semestre finalizado e progress_percent < 100% -> FAILED
- caso contrario -> IN_PROGRESS

Mensagens automaticas:
- Nova nota: INCENTIVE (progresso subiu) ou CARE (progresso caiu)
- Progresso < 70% com avaliacao proxima: WARNING suave
- Disciplina atinge 100%: ACHIEVEMENT
- Finalizar semestre: ACHIEVEMENT se todas aprovadas; CARE + INCENTIVE se alguma reprovada

## Observacoes de seguranca
- O sistema nao e um dispositivo medico.
- Em humor muito baixo recorrente, o sistema recomenda apoio profissional (ex: CVV 188).

## Tests
```bash
python manage.py test
```

----- END FILE: README.md -----

----- BEGIN FILE: apps/access_requests/admin.py -----
from django.contrib import admin

from access_requests.models import AccessRequest, AITriageLog


@admin.register(AccessRequest)
class AccessRequestAdmin(admin.ModelAdmin):
    list_display = ("requester_email", "requester_type", "status", "recommended_plan", "decided_plan")
    list_filter = ("status", "requester_type")
    search_fields = ("requester_email", "requester_name")


@admin.register(AITriageLog)
class AITriageLogAdmin(admin.ModelAdmin):
    list_display = ("access_request", "model_name", "created_at")

----- END FILE: apps/access_requests/admin.py -----

----- BEGIN FILE: apps/access_requests/apps.py -----
from django.apps import AppConfig


class AccessRequestsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'access_requests'

----- END FILE: apps/access_requests/apps.py -----

----- BEGIN FILE: apps/access_requests/migrations/0001_initial.py -----
# Generated by Django 4.2.11 on 2026-01-28 13:35

from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='AccessRequest',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('requester_email', models.EmailField(max_length=254)),
                ('requester_name', models.CharField(blank=True, max_length=255)),
                ('requester_type', models.CharField(choices=[('INDIVIDUAL', 'Individual'), ('INSTITUTION', 'Institution')], max_length=20)),
                ('institution_name', models.CharField(blank=True, max_length=255)),
                ('estimated_users', models.PositiveIntegerField(blank=True, null=True)),
                ('wants_features', models.JSONField(default=list)),
                ('message', models.TextField(blank=True)),
                ('status', models.CharField(choices=[('PENDING', 'Pending'), ('APPROVED', 'Approved'), ('REJECTED', 'Rejected')], default='PENDING', max_length=20)),
                ('recommended_plan', models.CharField(blank=True, choices=[('LITE', 'Lite'), ('PRO', 'Pro')], max_length=10)),
                ('decided_plan', models.CharField(blank=True, choices=[('LITE', 'Lite'), ('PRO', 'Pro')], max_length=10)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
        ),
        migrations.CreateModel(
            name='AITriageLog',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('model_name', models.CharField(max_length=100)),
                ('input_payload', models.JSONField()),
                ('output_payload', models.JSONField()),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('access_request', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='triage_logs', to='access_requests.accessrequest')),
            ],
        ),
    ]

----- END FILE: apps/access_requests/migrations/0001_initial.py -----

----- BEGIN FILE: apps/access_requests/migrations/0002_initial.py -----
# Generated by Django 4.2.11 on 2026-01-28 13:35

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('access_requests', '0001_initial'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.AddField(
            model_name='accessrequest',
            name='created_user',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL),
        ),
    ]

----- END FILE: apps/access_requests/migrations/0002_initial.py -----

----- BEGIN FILE: apps/access_requests/models.py -----
from django.conf import settings
from django.db import models

from utils.constants import ACCESS_STATUS_CHOICES, ACCESS_PENDING, PLAN_CHOICES, REQUESTER_TYPE_CHOICES


class AccessRequest(models.Model):
    requester_email = models.EmailField()
    requester_name = models.CharField(max_length=255, blank=True)
    requester_type = models.CharField(max_length=20, choices=REQUESTER_TYPE_CHOICES)
    institution_name = models.CharField(max_length=255, blank=True)
    estimated_users = models.PositiveIntegerField(null=True, blank=True)
    wants_features = models.JSONField(default=list)
    message = models.TextField(blank=True)
    status = models.CharField(max_length=20, choices=ACCESS_STATUS_CHOICES, default=ACCESS_PENDING)
    recommended_plan = models.CharField(max_length=10, choices=PLAN_CHOICES, blank=True)
    decided_plan = models.CharField(max_length=10, choices=PLAN_CHOICES, blank=True)
    created_user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.SET_NULL, null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return self.requester_email


class AITriageLog(models.Model):
    access_request = models.ForeignKey(AccessRequest, on_delete=models.CASCADE, related_name="triage_logs")
    model_name = models.CharField(max_length=100)
    input_payload = models.JSONField()
    output_payload = models.JSONField()
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return f"{self.access_request.id} - {self.model_name}"

----- END FILE: apps/access_requests/models.py -----

----- BEGIN FILE: apps/access_requests/serializers.py -----
from rest_framework import serializers

from access_requests.models import AccessRequest, AITriageLog
from utils.constants import ACCESS_APPROVED, ACCESS_REJECTED


class AccessRequestCreateSerializer(serializers.ModelSerializer):
    class Meta:
        model = AccessRequest
        fields = (
            "id",
            "requester_email",
            "requester_name",
            "requester_type",
            "institution_name",
            "estimated_users",
            "wants_features",
            "message",
            "status",
            "recommended_plan",
            "created_at",
        )
        read_only_fields = ("id", "status", "recommended_plan", "created_at")


class AccessRequestSerializer(serializers.ModelSerializer):
    class Meta:
        model = AccessRequest
        fields = "__all__"


class AITriageLogSerializer(serializers.ModelSerializer):
    class Meta:
        model = AITriageLog
        fields = ("id", "model_name", "input_payload", "output_payload", "created_at")
        read_only_fields = fields


class AccessDecisionSerializer(serializers.Serializer):
    decided_plan = serializers.CharField(required=False)

    def validate_decided_plan(self, value):
        if value and value not in {"LITE", "PRO"}:
            raise serializers.ValidationError("Plano invalido")
        return value

----- END FILE: apps/access_requests/serializers.py -----

----- BEGIN FILE: apps/access_requests/tests.py -----
from rest_framework.test import APITestCase

from utils.constants import FEATURE_EMAIL_NOTIFICATIONS, PLAN_PRO


class AccessRequestTriageTests(APITestCase):
    def test_triage_recommends_pro(self):
        payload = {
            "requester_email": "inst@example.com",
            "requester_type": "INDIVIDUAL",
            "wants_features": [FEATURE_EMAIL_NOTIFICATIONS],
        }
        response = self.client.post("/api/access/requests/", payload, format="json")
        self.assertEqual(response.status_code, 201)
        self.assertEqual(response.data["recommended_plan"], PLAN_PRO)

----- END FILE: apps/access_requests/tests.py -----

----- BEGIN FILE: apps/access_requests/urls.py -----
from django.urls import path

from access_requests.views import (
    AccessApproveView,
    AccessRejectView,
    AccessRequestDetailView,
    AccessRequestListCreateView,
    AccessTriageLogView,
)

urlpatterns = [
    path("requests/", AccessRequestListCreateView.as_view(), name="access-request-list-create"),
    path("requests/<int:pk>/", AccessRequestDetailView.as_view(), name="access-request-detail"),
    path("requests/<int:pk>/approve/", AccessApproveView.as_view(), name="access-request-approve"),
    path("requests/<int:pk>/reject/", AccessRejectView.as_view(), name="access-request-reject"),
    path("triage/<int:pk>/log/", AccessTriageLogView.as_view(), name="access-triage-log"),
]

----- END FILE: apps/access_requests/urls.py -----

----- BEGIN FILE: apps/access_requests/views.py -----
from django.shortcuts import get_object_or_404
from rest_framework import permissions, status
from rest_framework.response import Response
from rest_framework.views import APIView

from access_requests.models import AccessRequest, AITriageLog
from access_requests.serializers import (
    AccessDecisionSerializer,
    AccessRequestCreateSerializer,
    AccessRequestSerializer,
    AITriageLogSerializer,
)
from utils.constants import ACCESS_APPROVED, ACCESS_REJECTED
from utils.triage import TRIAGE_MODEL_NAME, run_triage


class AccessRequestListCreateView(APIView):
    def get_permissions(self):
        if self.request.method == "POST":
            return [permissions.AllowAny()]
        return [permissions.IsAdminUser()]

    def get(self, request):
        requests = AccessRequest.objects.all().order_by("-created_at")
        return Response(AccessRequestSerializer(requests, many=True).data)

    def post(self, request):
        serializer = AccessRequestCreateSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        access_request = serializer.save()
        triage_result = run_triage(access_request)
        recommended_plan = triage_result["recommended_plan"]
        access_request.recommended_plan = recommended_plan
        access_request.save(update_fields=["recommended_plan"])
        input_payload = serializer.validated_data
        output_payload = triage_result["output_payload"]
        AITriageLog.objects.create(
            access_request=access_request,
            model_name=TRIAGE_MODEL_NAME,
            input_payload=input_payload,
            output_payload=output_payload,
        )
        return Response(AccessRequestCreateSerializer(access_request).data, status=status.HTTP_201_CREATED)


class AccessRequestDetailView(APIView):
    permission_classes = [permissions.IsAdminUser]

    def get(self, request, pk):
        access_request = get_object_or_404(AccessRequest, pk=pk)
        return Response(AccessRequestSerializer(access_request).data)


class AccessApproveView(APIView):
    permission_classes = [permissions.IsAdminUser]

    def post(self, request, pk):
        access_request = get_object_or_404(AccessRequest, pk=pk)
        serializer = AccessDecisionSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        access_request.status = ACCESS_APPROVED
        access_request.decided_plan = serializer.validated_data.get("decided_plan") or access_request.recommended_plan
        access_request.save(update_fields=["status", "decided_plan"])
        return Response(AccessRequestSerializer(access_request).data)


class AccessRejectView(APIView):
    permission_classes = [permissions.IsAdminUser]

    def post(self, request, pk):
        access_request = get_object_or_404(AccessRequest, pk=pk)
        access_request.status = ACCESS_REJECTED
        access_request.save(update_fields=["status"])
        return Response(AccessRequestSerializer(access_request).data)


class AccessTriageLogView(APIView):
    permission_classes = [permissions.IsAdminUser]

    def get(self, request, pk):
        access_request = get_object_or_404(AccessRequest, pk=pk)
        log = access_request.triage_logs.order_by("-created_at").first()
        if not log:
            return Response({"detail": "Sem log de triagem."}, status=status.HTTP_404_NOT_FOUND)
        return Response(AITriageLogSerializer(log).data)

----- END FILE: apps/access_requests/views.py -----

----- BEGIN FILE: apps/accounts/admin.py -----
from django.contrib import admin
from django.contrib.auth.admin import UserAdmin as DjangoUserAdmin

from accounts.models import User, UserProfile


@admin.register(User)
class UserAdmin(DjangoUserAdmin):
    model = User
    ordering = ("email",)
    list_display = ("email", "name", "is_staff", "is_active", "created_at")
    search_fields = ("email", "name")
    fieldsets = (
        (None, {"fields": ("email", "password")}),
        ("Personal info", {"fields": ("name", "phone_number")}),
        ("Permissions", {"fields": ("is_active", "is_staff", "is_superuser", "groups", "user_permissions")}),
        ("Important dates", {"fields": ("last_login",)}),
    )
    add_fieldsets = (
        (
            None,
            {
                "classes": ("wide",),
                "fields": ("email", "name", "password1", "password2", "is_staff", "is_superuser"),
            },
        ),
    )


@admin.register(UserProfile)
class UserProfileAdmin(admin.ModelAdmin):
    list_display = ("user", "plan", "allow_email", "allow_whatsapp", "allow_sms", "consent_at")
    list_filter = ("plan", "allow_email", "allow_whatsapp", "allow_sms")

----- END FILE: apps/accounts/admin.py -----

----- BEGIN FILE: apps/accounts/apps.py -----
from django.apps import AppConfig


class AccountsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'accounts'

    def ready(self):
        from accounts import signals  # noqa: F401

----- END FILE: apps/accounts/apps.py -----

----- BEGIN FILE: apps/accounts/migrations/0001_initial.py -----
# Generated by Django 4.2.11 on 2026-01-28 13:35

from django.db import migrations, models
import django.utils.timezone


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('auth', '0012_alter_user_first_name_max_length'),
    ]

    operations = [
        migrations.CreateModel(
            name='User',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('password', models.CharField(max_length=128, verbose_name='password')),
                ('last_login', models.DateTimeField(blank=True, null=True, verbose_name='last login')),
                ('is_superuser', models.BooleanField(default=False, help_text='Designates that this user has all permissions without explicitly assigning them.', verbose_name='superuser status')),
                ('email', models.EmailField(max_length=254, unique=True)),
                ('name', models.CharField(max_length=255)),
                ('phone_number', models.CharField(blank=True, max_length=30)),
                ('created_at', models.DateTimeField(default=django.utils.timezone.now)),
                ('is_active', models.BooleanField(default=True)),
                ('is_staff', models.BooleanField(default=False)),
                ('groups', models.ManyToManyField(blank=True, help_text='The groups this user belongs to. A user will get all permissions granted to each of their groups.', related_name='user_set', related_query_name='user', to='auth.group', verbose_name='groups')),
                ('user_permissions', models.ManyToManyField(blank=True, help_text='Specific permissions for this user.', related_name='user_set', related_query_name='user', to='auth.permission', verbose_name='user permissions')),
            ],
            options={
                'abstract': False,
            },
        ),
    ]

----- END FILE: apps/accounts/migrations/0001_initial.py -----

----- BEGIN FILE: apps/accounts/migrations/0002_userprofile.py -----
# Generated by Django 6.0.1 on 2026-02-02 14:09

import django.db.models.deletion
import django.utils.timezone
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('accounts', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='UserProfile',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('phone', models.CharField(blank=True, max_length=30)),
                ('plan', models.CharField(choices=[('FREE', 'Free'), ('PAGO', 'Pago')], default='FREE', max_length=10)),
                ('allow_whatsapp', models.BooleanField(default=True)),
                ('allow_sms', models.BooleanField(default=False)),
                ('allow_email', models.BooleanField(default=True)),
                ('consent_at', models.DateTimeField(default=django.utils.timezone.now)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('user', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='profile', to=settings.AUTH_USER_MODEL)),
            ],
        ),
    ]

----- END FILE: apps/accounts/migrations/0002_userprofile.py -----

----- BEGIN FILE: apps/accounts/models.py -----
from django.contrib.auth.models import AbstractBaseUser, BaseUserManager, PermissionsMixin
from django.db import models
from django.utils import timezone


class UserManager(BaseUserManager):
    def create_user(self, email, password=None, **extra_fields):
        if not email:
            raise ValueError("Email is required")
        email = self.normalize_email(email)
        user = self.model(email=email, **extra_fields)
        user.set_password(password)
        user.save(using=self._db)
        return user

    def create_superuser(self, email, password=None, **extra_fields):
        extra_fields.setdefault("is_staff", True)
        extra_fields.setdefault("is_superuser", True)
        extra_fields.setdefault("is_active", True)
        if not extra_fields.get("is_staff"):
            raise ValueError("Superuser must have is_staff=True")
        if not extra_fields.get("is_superuser"):
            raise ValueError("Superuser must have is_superuser=True")
        return self.create_user(email, password, **extra_fields)


class User(AbstractBaseUser, PermissionsMixin):
    email = models.EmailField(unique=True)
    name = models.CharField(max_length=255)
    phone_number = models.CharField(max_length=30, blank=True)
    created_at = models.DateTimeField(default=timezone.now)

    is_active = models.BooleanField(default=True)
    is_staff = models.BooleanField(default=False)

    objects = UserManager()

    EMAIL_FIELD = "email"
    USERNAME_FIELD = "email"
    REQUIRED_FIELDS = ["name"]

    def __str__(self):
        return self.email


# Bloco: Perfil e consentimentos do usuario
class UserProfile(models.Model):
    PLAN_FREE = "FREE"
    PLAN_PAID = "PAGO"
    PLAN_CHOICES = [
        (PLAN_FREE, "Free"),
        (PLAN_PAID, "Pago"),
    ]

    user = models.OneToOneField(User, on_delete=models.CASCADE, related_name="profile")
    phone = models.CharField(max_length=30, blank=True)
    plan = models.CharField(max_length=10, choices=PLAN_CHOICES, default=PLAN_FREE)
    allow_whatsapp = models.BooleanField(default=True)
    allow_sms = models.BooleanField(default=False)
    allow_email = models.BooleanField(default=True)
    consent_at = models.DateTimeField(default=timezone.now)
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return f"{self.user.email} profile"

----- END FILE: apps/accounts/models.py -----

----- BEGIN FILE: apps/accounts/serializers.py -----
from django.contrib.auth import get_user_model
from rest_framework import serializers

User = get_user_model()


class UserSerializer(serializers.ModelSerializer):
    class Meta:
        model = User
        fields = ("id", "email", "name", "phone_number", "created_at")
        read_only_fields = ("id", "created_at")


class RegisterSerializer(serializers.ModelSerializer):
    password = serializers.CharField(write_only=True, min_length=6)

    class Meta:
        model = User
        fields = ("email", "name", "phone_number", "password")

    def create(self, validated_data):
        password = validated_data.pop("password")
        user = User.objects.create_user(password=password, **validated_data)
        return user

----- END FILE: apps/accounts/serializers.py -----

----- BEGIN FILE: apps/accounts/signals.py -----
from django.db.models.signals import post_save
from django.dispatch import receiver

from accounts.models import User, UserProfile


# Bloco: Criacao automatica de perfil
@receiver(post_save, sender=User)
def ensure_user_profile(sender, instance, created, **kwargs):
    if created:
        UserProfile.objects.get_or_create(
            user=instance,
            defaults={
                "phone": instance.phone_number or "",
                "plan": UserProfile.PLAN_FREE,
                "allow_whatsapp": True,
                "allow_sms": False,
                "allow_email": True,
            },
        )

----- END FILE: apps/accounts/signals.py -----

----- BEGIN FILE: apps/accounts/tests.py -----
from django.urls import reverse
from rest_framework.test import APITestCase


class AuthTests(APITestCase):
    def test_register_and_login(self):
        register_url = "/api/auth/register/"
        payload = {
            "email": "test@example.com",
            "name": "Teste",
            "password": "strongpass123",
        }
        response = self.client.post(register_url, payload, format="json")
        self.assertEqual(response.status_code, 201)
        self.assertIn("access", response.data)

        login_url = "/api/auth/login/"
        login_response = self.client.post(login_url, {"email": payload["email"], "password": payload["password"]})
        self.assertEqual(login_response.status_code, 200)
        self.assertIn("access", login_response.data)

----- END FILE: apps/accounts/tests.py -----

----- BEGIN FILE: apps/accounts/urls.py -----
from django.urls import path
from rest_framework_simplejwt.views import TokenObtainPairView, TokenRefreshView

from accounts.views import MeView, RegisterView

urlpatterns = [
    path("register/", RegisterView.as_view(), name="auth-register"),
    path("login/", TokenObtainPairView.as_view(), name="auth-login"),
    path("refresh/", TokenRefreshView.as_view(), name="auth-refresh"),
    path("me/", MeView.as_view(), name="auth-me"),
]

----- END FILE: apps/accounts/urls.py -----

----- BEGIN FILE: apps/accounts/views.py -----
from rest_framework import permissions, status
from rest_framework.response import Response
from rest_framework.views import APIView
from rest_framework_simplejwt.tokens import RefreshToken

from accounts.serializers import RegisterSerializer, UserSerializer
from billing.models import Plan, UserSubscription
from utils.constants import PLAN_LITE


class RegisterView(APIView):
    permission_classes = [permissions.AllowAny]

    def post(self, request):
        serializer = RegisterSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        user = serializer.save()
        plan = Plan.objects.filter(code=PLAN_LITE, is_active=True).first()
        if plan:
            UserSubscription.objects.get_or_create(user=user, defaults={"plan": plan})
        refresh = RefreshToken.for_user(user)
        return Response(
            {
                "user": UserSerializer(user).data,
                "refresh": str(refresh),
                "access": str(refresh.access_token),
            },
            status=status.HTTP_201_CREATED,
        )


class MeView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request):
        return Response(UserSerializer(request.user).data)

----- END FILE: apps/accounts/views.py -----

----- BEGIN FILE: apps/agenda/admin.py -----
from django.contrib import admin

from agenda.models import CalendarEvent, ReminderRule


@admin.register(CalendarEvent)
class CalendarEventAdmin(admin.ModelAdmin):
    list_display = ("title", "user", "event_type", "start_at")
    list_filter = ("event_type",)
    search_fields = ("title", "user__email")


@admin.register(ReminderRule)
class ReminderRuleAdmin(admin.ModelAdmin):
    list_display = ("user", "target_type", "remind_before_minutes", "is_active")
    list_filter = ("target_type", "is_active")

----- END FILE: apps/agenda/admin.py -----

----- BEGIN FILE: apps/agenda/apps.py -----
from django.apps import AppConfig


class AgendaConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'agenda'

----- END FILE: apps/agenda/apps.py -----

----- BEGIN FILE: apps/agenda/migrations/0001_initial.py -----
# Generated by Django 4.2.11 on 2026-01-28 13:35

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
        ('planner', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='ReminderRule',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('target_type', models.CharField(choices=[('TASK', 'Task'), ('EVENT', 'Event')], max_length=10)),
                ('remind_before_minutes', models.PositiveIntegerField()),
                ('channels', models.JSONField(default=list)),
                ('is_active', models.BooleanField(default=True)),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='reminder_rules', to=settings.AUTH_USER_MODEL)),
            ],
        ),
        migrations.CreateModel(
            name='CalendarEvent',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('title', models.CharField(max_length=200)),
                ('event_type', models.CharField(choices=[('PROVA', 'Prova'), ('ENTREGA', 'Entrega'), ('APRESENTACAO', 'Apresentacao'), ('AULA_IMPORTANTE', 'Aula importante'), ('OUTRO', 'Outro')], max_length=20)),
                ('start_at', models.DateTimeField()),
                ('end_at', models.DateTimeField(blank=True, null=True)),
                ('notes', models.TextField(blank=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('related_task', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='events', to='planner.task')),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='events', to=settings.AUTH_USER_MODEL)),
            ],
        ),
    ]

----- END FILE: apps/agenda/migrations/0001_initial.py -----

----- BEGIN FILE: apps/agenda/migrations/0002_alter_calendarevent_event_type_and_more.py -----
# Generated by Django 6.0.1 on 2026-02-02 15:01

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('agenda', '0001_initial'),
    ]

    operations = [
        migrations.AlterField(
            model_name='calendarevent',
            name='event_type',
            field=models.CharField(choices=[('PROVA', 'Prova'), ('ENTREGA', 'Entrega'), ('APRESENTACAO', 'Apresentacao'), ('AULA_IMPORTANTE', 'Aula importante'), ('REUNIAO_GRUPO', 'Reuniao em grupo'), ('REUNIAO_PROFESSORES', 'Reuniao com professores'), ('ESTUDAR_FACULDADE', 'Estudar na faculdade'), ('OUTRO', 'Outro')], max_length=20),
        ),
        migrations.AlterField(
            model_name='reminderrule',
            name='target_type',
            field=models.CharField(choices=[('TASK', 'Tarefa'), ('EVENT', 'Evento')], max_length=10),
        ),
    ]

----- END FILE: apps/agenda/migrations/0002_alter_calendarevent_event_type_and_more.py -----

----- BEGIN FILE: apps/agenda/models.py -----
from django.conf import settings
from django.db import models

from planner.models import Task
from utils.constants import EVENT_TYPE_CHOICES, REMINDER_TARGET_CHOICES


class CalendarEvent(models.Model):
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name="events")
    title = models.CharField(max_length=200)
    event_type = models.CharField(max_length=20, choices=EVENT_TYPE_CHOICES)
    start_at = models.DateTimeField()
    end_at = models.DateTimeField(null=True, blank=True)
    related_task = models.ForeignKey(Task, on_delete=models.SET_NULL, null=True, blank=True, related_name="events")
    notes = models.TextField(blank=True)
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return self.title


class ReminderRule(models.Model):
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name="reminder_rules")
    target_type = models.CharField(max_length=10, choices=REMINDER_TARGET_CHOICES)
    remind_before_minutes = models.PositiveIntegerField()
    channels = models.JSONField(default=list)
    is_active = models.BooleanField(default=True)

    def __str__(self):
        return f"{self.user.email} - {self.target_type}"

----- END FILE: apps/agenda/models.py -----

----- BEGIN FILE: apps/agenda/serializers.py -----
from rest_framework import serializers

from agenda.models import CalendarEvent, ReminderRule


class CalendarEventSerializer(serializers.ModelSerializer):
    class Meta:
        model = CalendarEvent
        fields = (
            "id",
            "title",
            "event_type",
            "start_at",
            "end_at",
            "related_task",
            "notes",
            "created_at",
        )
        read_only_fields = ("id", "created_at")


class ReminderRuleSerializer(serializers.ModelSerializer):
    class Meta:
        model = ReminderRule
        fields = ("id", "target_type", "remind_before_minutes", "channels", "is_active")
        read_only_fields = ("id",)

----- END FILE: apps/agenda/serializers.py -----

----- BEGIN FILE: apps/agenda/tests.py -----
from datetime import date

from django.contrib.auth import get_user_model
from rest_framework.test import APITestCase
from rest_framework_simplejwt.tokens import RefreshToken

from billing.models import Plan, UserSubscription
from utils.constants import FEATURE_IN_APP_REMINDERS, FEATURE_PLANNER_BASIC, PLAN_LITE

User = get_user_model()


class ReminderGenerationTests(APITestCase):
    def setUp(self):
        self.user = User.objects.create_user(email="agenda@example.com", name="Agenda", password="pass12345")
        plan, _ = Plan.objects.get_or_create(
            code=PLAN_LITE,
            defaults={
                "name": "Lite",
                "features": [FEATURE_PLANNER_BASIC, FEATURE_IN_APP_REMINDERS],
                "is_active": True,
            },
        )
        UserSubscription.objects.create(user=self.user, plan=plan)
        refresh = RefreshToken.for_user(self.user)
        self.client.credentials(HTTP_AUTHORIZATION=f"Bearer {refresh.access_token}")

    def test_task_create_and_generate_reminders(self):
        task_payload = {
            "title": "Trabalho",
            "description": "Entrega final",
            "due_date": date.today().isoformat(),
            "stress_level": 3,
            "status": "TODO",
        }
        task_response = self.client.post("/api/planner/tasks/", task_payload, format="json")
        self.assertEqual(task_response.status_code, 201)

        rule_payload = {
            "target_type": "TASK",
            "remind_before_minutes": 60,
            "channels": ["EMAIL"],
            "is_active": True,
        }
        rule_response = self.client.post("/api/agenda/reminder-rules/", rule_payload, format="json")
        self.assertEqual(rule_response.status_code, 201)

        generate_response = self.client.post("/api/agenda/generate-reminders/", {}, format="json")
        self.assertEqual(generate_response.status_code, 200)
        self.assertIn("created", generate_response.data)

----- END FILE: apps/agenda/tests.py -----

----- BEGIN FILE: apps/agenda/urls.py -----
from django.urls import path
from rest_framework.routers import DefaultRouter

from agenda.views import CalendarEventViewSet, GenerateRemindersView, AgendaWeekView, ReminderRuleViewSet

router = DefaultRouter()
router.register(r"events", CalendarEventViewSet, basename="events")
router.register(r"reminder-rules", ReminderRuleViewSet, basename="reminder-rules")

urlpatterns = router.urls + [
    path("week/", AgendaWeekView.as_view(), name="agenda-week"),
    path("generate-reminders/", GenerateRemindersView.as_view(), name="agenda-generate-reminders"),
]

----- END FILE: apps/agenda/urls.py -----

----- BEGIN FILE: apps/agenda/views.py -----
from datetime import datetime, time, timedelta

from django.utils import timezone
from rest_framework import permissions, status, viewsets
from rest_framework.response import Response
from rest_framework.views import APIView

from agenda.models import CalendarEvent, ReminderRule
from agenda.serializers import CalendarEventSerializer, ReminderRuleSerializer
from notifications.models import NotificationQueue
from notifications.services.reminder_queue import create_notifications_for_user
from planner.models import Task
from utils.constants import (
    CHANNEL_EMAIL,
    FEATURE_AGENDA_BASIC,
    FEATURE_IN_APP_REMINDERS,
    NOTIF_PENDING,
    REMINDER_TARGET_EVENT,
    REMINDER_TARGET_TASK,
)
from utils.features import require_feature
from utils.gating import gate_generate_reminders


class CalendarEventViewSet(viewsets.ModelViewSet):
    serializer_class = CalendarEventSerializer
    permission_classes = [permissions.IsAuthenticated]

    def initial(self, request, *args, **kwargs):
        require_feature(request.user, FEATURE_AGENDA_BASIC)
        return super().initial(request, *args, **kwargs)

    def get_queryset(self):
        return CalendarEvent.objects.filter(user=self.request.user).order_by("start_at")

    def perform_create(self, serializer):
        serializer.save(user=self.request.user)


class ReminderRuleViewSet(viewsets.ModelViewSet):
    serializer_class = ReminderRuleSerializer
    permission_classes = [permissions.IsAuthenticated]

    def initial(self, request, *args, **kwargs):
        require_feature(request.user, FEATURE_IN_APP_REMINDERS)
        return super().initial(request, *args, **kwargs)

    def get_queryset(self):
        return ReminderRule.objects.filter(user=self.request.user)

    def perform_create(self, serializer):
        serializer.save(user=self.request.user)


class AgendaWeekView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request):
        require_feature(request.user, FEATURE_AGENDA_BASIC)
        now = timezone.now()
        start_of_week = now - timedelta(days=now.weekday())
        end_of_week = start_of_week + timedelta(days=6)
        events = CalendarEvent.objects.filter(
            user=request.user,
            start_at__date__gte=start_of_week.date(),
            start_at__date__lte=end_of_week.date(),
        ).order_by("start_at")
        return Response(CalendarEventSerializer(events, many=True).data)


class GenerateRemindersView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def post(self, request):
        require_feature(request.user, FEATURE_IN_APP_REMINDERS)
        allowed, message = gate_generate_reminders(request.user)
        if not allowed:
            return Response({"detail": message}, status=status.HTTP_403_FORBIDDEN)

        # Bloco: Geracao de lembretes para usuario
        created = create_notifications_for_user(request.user)
        return Response({"created": created})

----- END FILE: apps/agenda/views.py -----

----- BEGIN FILE: apps/analytics/admin.py -----
from django.contrib import admin

# No models to register for MVP.

----- END FILE: apps/analytics/admin.py -----

----- BEGIN FILE: apps/analytics/apps.py -----
from django.apps import AppConfig


class AnalyticsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'analytics'

----- END FILE: apps/analytics/apps.py -----

----- BEGIN FILE: apps/analytics/management/commands/seed_demo_data.py -----
from datetime import date, timedelta

from django.core.management.base import BaseCommand
from django.utils import timezone

from agenda.models import CalendarEvent, ReminderRule
from billing.models import Plan, UserSubscription
from content.models import GuidedContent
from mood.models import MoodEntry
from planner.models import Task
from semester.models import Assessment, Course, Semester
from utils.constants import (
    CONTENT_ANTI_PROCRASTINACAO,
    CONTENT_FOCO,
    CONTENT_PRE_PROVA,
    EVENT_ENTREGA,
    EVENT_PROVA,
    MOOD_BAD,
    MOOD_GOOD,
    MOOD_OK,
    MOOD_VERY_GOOD,
    PLAN_LITE,
)
from django.contrib.auth import get_user_model


class Command(BaseCommand):
    help = "Cria dados de exemplo para o MVP"

    def add_arguments(self, parser):
        parser.add_argument("--email", help="Email do usuario para popular dados")

    def handle(self, *args, **options):
        User = get_user_model()
        email = options.get("email")
        if email:
            user = User.objects.filter(email=email).first()
            if not user:
                self.stdout.write(self.style.ERROR("Usuario nao encontrado."))
                return
        else:
            user = User.objects.first()
            if not user:
                self.stdout.write(self.style.ERROR("Nenhum usuario encontrado."))
                return

        plan = Plan.objects.filter(code=PLAN_LITE).first()
        if plan:
            UserSubscription.objects.get_or_create(user=user, defaults={"plan": plan})

        MoodEntry.objects.get_or_create(user=user, mood=MOOD_OK, defaults={"notes": "Inicio do semestre"})
        MoodEntry.objects.get_or_create(user=user, mood=MOOD_GOOD, defaults={"notes": "Boa semana"})
        MoodEntry.objects.get_or_create(user=user, mood=MOOD_BAD, defaults={"notes": "Cansaco"})
        MoodEntry.objects.get_or_create(user=user, mood=MOOD_VERY_GOOD, defaults={"notes": "Semana excelente"})

        Task.objects.get_or_create(
            user=user,
            title="Trabalho final",
            defaults={
                "description": "Entrega da disciplina X",
                "due_date": date.today() + timedelta(days=10),
                "stress_level": 3,
                "status": "TODO",
            },
        )
        Task.objects.get_or_create(
            user=user,
            title="Leitura cap. 3",
            defaults={
                "description": "Revisao para prova",
                "due_date": date.today() + timedelta(days=5),
                "stress_level": 2,
                "status": "DOING",
            },
        )
        Task.objects.get_or_create(
            user=user,
            title="Lista de exercicios",
            defaults={
                "description": "Praticar conteudos de logica",
                "due_date": date.today() + timedelta(days=3),
                "stress_level": 2,
                "status": "TODO",
            },
        )

        semester, _ = Semester.objects.get_or_create(
            user=user,
            name="2026.1",
            defaults={
                "start_date": date.today() - timedelta(days=20),
                "end_date": date.today() + timedelta(days=120),
            },
        )

        course_math, _ = Course.objects.get_or_create(
            semester=semester,
            title="Matematica Discreta",
            defaults={"teacher": "Prof. Silva", "credits": 4},
        )
        course_alg, _ = Course.objects.get_or_create(
            semester=semester,
            title="Algoritmos I",
            defaults={"teacher": "Prof. Souza", "credits": 4},
        )
        course_db, _ = Course.objects.get_or_create(
            semester=semester,
            title="Banco de Dados",
            defaults={"teacher": "Profa. Carla", "credits": 4},
        )

        Assessment.objects.get_or_create(
            course=course_math,
            title="Prova 1",
            defaults={"score": 7.5, "max_score": 10, "weight": 1, "date": date.today() + timedelta(days=7)},
        )
        Assessment.objects.get_or_create(
            course=course_math,
            title="Trabalho 1",
            defaults={"score": 8.0, "max_score": 10, "weight": 1, "date": date.today() + timedelta(days=14)},
        )
        Assessment.objects.get_or_create(
            course=course_alg,
            title="Trabalho 1",
            defaults={"score": 8.0, "max_score": 10, "weight": 1, "date": date.today() + timedelta(days=12)},
        )
        Assessment.objects.get_or_create(
            course=course_db,
            title="Prova 1",
            defaults={"score": 6.5, "max_score": 10, "weight": 1, "date": date.today() + timedelta(days=9)},
        )

        CalendarEvent.objects.get_or_create(
            user=user,
            title="Entrega Trabalho Final",
            defaults={"event_type": EVENT_ENTREGA, "start_at": timezone.now() + timedelta(days=9)},
        )
        CalendarEvent.objects.get_or_create(
            user=user,
            title="Prova Matematica",
            defaults={"event_type": EVENT_PROVA, "start_at": timezone.now() + timedelta(days=7)},
        )
        CalendarEvent.objects.get_or_create(
            user=user,
            title="Prova Banco de Dados",
            defaults={"event_type": EVENT_PROVA, "start_at": timezone.now() + timedelta(days=9)},
        )

        ReminderRule.objects.get_or_create(
            user=user,
            target_type="TASK",
            defaults={"remind_before_minutes": 1440, "channels": ["EMAIL"], "is_active": True},
        )

        GuidedContent.objects.get_or_create(
            title="Respiracao pre-prova",
            defaults={
                "category": CONTENT_PRE_PROVA,
                "duration_minutes": 8,
                "body_text": "Exercicio guiado de respiracao para antes da prova.",
                "is_premium": False,
            },
        )
        GuidedContent.objects.get_or_create(
            title="Anti-procrastinacao em 10 minutos",
            defaults={
                "category": CONTENT_ANTI_PROCRASTINACAO,
                "duration_minutes": 10,
                "body_text": "Passos curtos para iniciar tarefas e manter o ritmo.",
                "is_premium": False,
            },
        )
        GuidedContent.objects.get_or_create(
            title="Foco profundo 25min",
            defaults={
                "category": CONTENT_FOCO,
                "duration_minutes": 25,
                "body_text": "Sessao guiada de foco com pausas conscientes.",
                "is_premium": True,
            },
        )

        self.stdout.write(self.style.SUCCESS("seed_demo_data: ok"))

----- END FILE: apps/analytics/management/commands/seed_demo_data.py -----

----- BEGIN FILE: apps/analytics/models.py -----
from django.db import models

# Intencionalmente vazio para o MVP.

----- END FILE: apps/analytics/models.py -----

----- BEGIN FILE: apps/analytics/urls.py -----
from django.urls import path

from analytics.views import DashboardView, SemesterAnalyticsView

urlpatterns = [
    path("dashboard/", DashboardView.as_view(), name="analytics-dashboard"),
    path("semester/<int:semester_id>/", SemesterAnalyticsView.as_view(), name="analytics-semester"),
]

----- END FILE: apps/analytics/urls.py -----

----- BEGIN FILE: apps/analytics/views.py -----
from django.shortcuts import get_object_or_404
from django.utils import timezone
from rest_framework import permissions, status
from rest_framework.response import Response
from rest_framework.views import APIView

from agenda.models import CalendarEvent
from mood.models import MoodEntry
from planner.models import Task
from semester.models import Semester
from utils.constants import FEATURE_DASHBOARD_BASIC, FEATURE_REPORTS_ADVANCED, SEMESTER_ACTIVE
from utils.features import has_feature, require_feature


class DashboardView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request):
        require_feature(request.user, FEATURE_DASHBOARD_BASIC)
        now = timezone.now()
        tasks = Task.objects.filter(user=request.user)
        events = CalendarEvent.objects.filter(user=request.user, start_at__gte=now)
        moods = MoodEntry.objects.filter(user=request.user)
        active_semester = Semester.objects.filter(user=request.user, status=SEMESTER_ACTIVE).first()
        return Response(
            {
                "tasks": {
                    "todo": tasks.filter(status="TODO").count(),
                    "doing": tasks.filter(status="DOING").count(),
                    "done": tasks.filter(status="DONE").count(),
                },
                "upcoming_events": events.count(),
                "mood_entries": moods.count(),
                "active_semester": active_semester.name if active_semester else None,
            }
        )


class SemesterAnalyticsView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request, semester_id):
        if not has_feature(request.user, FEATURE_REPORTS_ADVANCED):
            return Response({"detail": "Plano atual nao permite analytics avancado."}, status=status.HTTP_403_FORBIDDEN)
        semester = get_object_or_404(Semester, pk=semester_id, user=request.user)
        courses = semester.courses.all()
        return Response(
            {
                "semester": semester.name,
                "courses": [
                    {
                        "title": course.title,
                        "status": course.status,
                        "final_grade": course.final_grade,
                    }
                    for course in courses
                ],
            }
        )

----- END FILE: apps/analytics/views.py -----

----- BEGIN FILE: apps/billing/admin.py -----
from django.contrib import admin

from billing.models import Plan, UserSubscription


@admin.register(Plan)
class PlanAdmin(admin.ModelAdmin):
    list_display = ("code", "name", "is_active")
    list_filter = ("is_active",)


@admin.register(UserSubscription)
class UserSubscriptionAdmin(admin.ModelAdmin):
    list_display = ("user", "plan", "is_active", "started_at")
    list_filter = ("is_active", "plan")

----- END FILE: apps/billing/admin.py -----

----- BEGIN FILE: apps/billing/apps.py -----
from django.apps import AppConfig
from django.db.models.signals import post_migrate


class BillingConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'billing'

    def ready(self):
        from billing.signals import seed_plans

        post_migrate.connect(seed_plans, sender=self)

----- END FILE: apps/billing/apps.py -----

----- BEGIN FILE: apps/billing/migrations/0001_initial.py -----
# Generated by Django 4.2.11 on 2026-01-28 13:35

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='Plan',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('code', models.CharField(choices=[('LITE', 'Lite'), ('PRO', 'Pro')], max_length=10, unique=True)),
                ('name', models.CharField(max_length=100)),
                ('description', models.TextField(blank=True)),
                ('features', models.JSONField(default=list)),
                ('is_active', models.BooleanField(default=True)),
            ],
        ),
        migrations.CreateModel(
            name='UserSubscription',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('started_at', models.DateTimeField(auto_now_add=True)),
                ('is_active', models.BooleanField(default=True)),
                ('plan', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, to='billing.plan')),
                ('user', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='subscription', to=settings.AUTH_USER_MODEL)),
            ],
        ),
    ]

----- END FILE: apps/billing/migrations/0001_initial.py -----

----- BEGIN FILE: apps/billing/models.py -----
from django.conf import settings
from django.db import models

from utils.constants import PLAN_CHOICES, PLAN_LITE


class Plan(models.Model):
    code = models.CharField(max_length=10, choices=PLAN_CHOICES, unique=True)
    name = models.CharField(max_length=100)
    description = models.TextField(blank=True)
    features = models.JSONField(default=list)
    is_active = models.BooleanField(default=True)

    def __str__(self):
        return f"{self.code}"

    @staticmethod
    def default_lite_features():
        return [
            "MOOD_BASIC",
            "POMODORO_BASIC",
            "PLANNER_BASIC",
            "AGENDA_BASIC",
            "IN_APP_REMINDERS",
            "DASHBOARD_BASIC",
            "CONTENT_LIMITED",
        ]

    @staticmethod
    def default_pro_features():
        return Plan.default_lite_features() + [
            "EMAIL_NOTIFICATIONS",
            "REPORTS_ADVANCED",
            "SEMESTER_SUMMARY",
            "COACH_ADVANCED",
            "CONTENT_FULL",
        ]


class UserSubscription(models.Model):
    user = models.OneToOneField(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name="subscription")
    plan = models.ForeignKey(Plan, on_delete=models.PROTECT)
    started_at = models.DateTimeField(auto_now_add=True)
    is_active = models.BooleanField(default=True)

    def __str__(self):
        return f"{self.user.email} -> {self.plan.code if self.plan else PLAN_LITE}"

----- END FILE: apps/billing/models.py -----

----- BEGIN FILE: apps/billing/serializers.py -----
from rest_framework import serializers

from billing.models import Plan, UserSubscription


class PlanSerializer(serializers.ModelSerializer):
    class Meta:
        model = Plan
        fields = ("code", "name", "description", "features")


class UserSubscriptionSerializer(serializers.ModelSerializer):
    plan = PlanSerializer()

    class Meta:
        model = UserSubscription
        fields = ("plan", "started_at", "is_active")


class SetPlanSerializer(serializers.Serializer):
    user_id = serializers.IntegerField()
    plan_code = serializers.CharField()

----- END FILE: apps/billing/serializers.py -----

----- BEGIN FILE: apps/billing/signals.py -----
from django.db import transaction

from billing.models import Plan
from utils.constants import (
    FEATURE_AGENDA_BASIC,
    FEATURE_COACH_ADVANCED,
    FEATURE_CONTENT_FULL,
    FEATURE_CONTENT_LIMITED,
    FEATURE_DASHBOARD_BASIC,
    FEATURE_EMAIL_NOTIFICATIONS,
    FEATURE_IN_APP_REMINDERS,
    FEATURE_MOOD_BASIC,
    FEATURE_PLANNER_BASIC,
    FEATURE_POMODORO_BASIC,
    FEATURE_REPORTS_ADVANCED,
    FEATURE_SEMESTER_SUMMARY,
    PLAN_LITE,
    PLAN_PRO,
)


def seed_plans(sender, **kwargs):
    with transaction.atomic():
        Plan.objects.get_or_create(
            code=PLAN_LITE,
            defaults={
                "name": "Lite",
                "description": "Plano basico para organizacao e bem-estar.",
                "features": [
                    FEATURE_MOOD_BASIC,
                    FEATURE_POMODORO_BASIC,
                    FEATURE_PLANNER_BASIC,
                    FEATURE_AGENDA_BASIC,
                    FEATURE_IN_APP_REMINDERS,
                    FEATURE_DASHBOARD_BASIC,
                    FEATURE_CONTENT_LIMITED,
                ],
                "is_active": True,
            },
        )
        Plan.objects.get_or_create(
            code=PLAN_PRO,
            defaults={
                "name": "Pro",
                "description": "Plano completo com notificacoes e relatorios.",
                "features": [
                    FEATURE_MOOD_BASIC,
                    FEATURE_POMODORO_BASIC,
                    FEATURE_PLANNER_BASIC,
                    FEATURE_AGENDA_BASIC,
                    FEATURE_IN_APP_REMINDERS,
                    FEATURE_DASHBOARD_BASIC,
                    FEATURE_CONTENT_LIMITED,
                    FEATURE_EMAIL_NOTIFICATIONS,
                    FEATURE_REPORTS_ADVANCED,
                    FEATURE_SEMESTER_SUMMARY,
                    FEATURE_COACH_ADVANCED,
                    FEATURE_CONTENT_FULL,
                ],
                "is_active": True,
            },
        )

----- END FILE: apps/billing/signals.py -----

----- BEGIN FILE: apps/billing/urls.py -----
from django.urls import path

from billing.views import CurrentPlanView, SetPlanView

urlpatterns = [
    path("plan/", CurrentPlanView.as_view(), name="billing-plan"),
    path("set-plan/", SetPlanView.as_view(), name="billing-set-plan"),
]

----- END FILE: apps/billing/urls.py -----

----- BEGIN FILE: apps/billing/views.py -----
from django.contrib.auth import get_user_model
from rest_framework import permissions, status
from rest_framework.response import Response
from rest_framework.views import APIView

from billing.models import Plan, UserSubscription
from billing.serializers import PlanSerializer, SetPlanSerializer, UserSubscriptionSerializer
from utils.constants import PLAN_LITE

User = get_user_model()


class CurrentPlanView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request):
        subscription = UserSubscription.objects.filter(user=request.user, is_active=True).select_related("plan").first()
        if subscription:
            return Response(UserSubscriptionSerializer(subscription).data)
        plan = Plan.objects.filter(code=PLAN_LITE, is_active=True).first()
        if not plan:
            return Response({"detail": "Plano nao configurado."}, status=status.HTTP_404_NOT_FOUND)
        return Response({"plan": PlanSerializer(plan).data, "started_at": None, "is_active": False})


class SetPlanView(APIView):
    permission_classes = [permissions.IsAdminUser]

    def post(self, request):
        serializer = SetPlanSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        user = User.objects.get(id=serializer.validated_data["user_id"])
        plan = Plan.objects.get(code=serializer.validated_data["plan_code"])
        subscription, _ = UserSubscription.objects.get_or_create(user=user, defaults={"plan": plan})
        subscription.plan = plan
        subscription.is_active = True
        subscription.save()
        return Response(UserSubscriptionSerializer(subscription).data)

----- END FILE: apps/billing/views.py -----

----- BEGIN FILE: apps/brain/admin.py -----
from django.contrib import admin

from brain.models import CategoriaEmocional, GatilhoEmocional, InteracaoAluno, MicroIntervencao, RespostaEmocional


@admin.register(CategoriaEmocional)
class CategoriaEmocionalAdmin(admin.ModelAdmin):
    list_display = ("nome", "slug", "emoji", "ativo")
    list_filter = ("ativo",)
    search_fields = ("nome", "slug")


@admin.register(GatilhoEmocional)
class GatilhoEmocionalAdmin(admin.ModelAdmin):
    list_display = ("categoria", "ativo")
    list_filter = ("ativo", "categoria")
    search_fields = ("palavras_chave", "categoria__nome", "categoria__slug")


@admin.register(RespostaEmocional)
class RespostaEmocionalAdmin(admin.ModelAdmin):
    list_display = ("categoria", "ativo")
    list_filter = ("ativo", "categoria")
    search_fields = ("texto", "categoria__nome", "categoria__slug")


@admin.register(MicroIntervencao)
class MicroIntervencaoAdmin(admin.ModelAdmin):
    list_display = ("nome", "ativo")
    list_filter = ("ativo",)
    search_fields = ("nome", "texto")


@admin.register(InteracaoAluno)
class InteracaoAlunoAdmin(admin.ModelAdmin):
    list_display = ("user", "categoria_detectada", "origem", "created_at")
    list_filter = ("origem", "categoria_detectada", "created_at")
    search_fields = ("user__email", "mensagem_usuario", "resposta_texto")

----- END FILE: apps/brain/admin.py -----

----- BEGIN FILE: apps/brain/apps.py -----
from django.apps import AppConfig


class BrainConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "brain"

----- END FILE: apps/brain/apps.py -----

----- BEGIN FILE: apps/brain/constants.py -----
ANXIETY_KEYWORDS = [
    "ansioso",
    "ansiosa",
    "ancioso",
    "anciosa",
    "ansiedade",
    "nervoso",
    "nervosa",
    "panico",
    "pnico",
    "taquicardia",
    "tremendo",
    "tremor",
    "suando",
    "suor",
    "apreensivo",
    "apreensiva",
]

EXAM_KEYWORDS = [
    "prova",
    "teste",
    "exame",
    "apresentacao",
    "apresentao",
    "seminario",
    "seminrio",
    "avaliacao",
    "avaliao",
    "banca",
    "trabalho",
    "entrega",
]

CONTEXT_MESSAGES = {
    "stress_repeat": [
        "Percebo que isso esta se repetindo. Quer me contar um pouco mais do que esta pesando?",
        "Notei que isso voltou a aparecer. Vamos escolher um passo pequeno para aliviar agora?",
        "Entendi. Isso tem se repetido. Quer que eu te ajude a reduzir a carga em 1 prioridade?",
    ],
    "evolucao_repeat": [
        "Voce esta criando consistencia. Quer definir a proxima meta pequena?",
        "Isso e repeticao do bem: consistencia. Qual a proxima etapa simples?",
        "Voce esta mantendo um bom ritmo. Quer escolher um objetivo de 15 minutos agora?",
    ],
    "stress_to_evolucao": [
        "Olha o progresso ai. Ontem parecia pesado e hoje voce avancou.",
        "Da para ver evolucao. Mesmo com desafios recentes, voce conseguiu avancar.",
        "Isso e um bom sinal: voce saiu do peso e foi para a acao. Parabens pelo passo.",
    ],
    "stress_anxiety": [
        "Ansiedade antes de prova e comum. Quer que eu te guie por 60 segundos para acalmar o corpo?",
        "Entendi. Vamos reduzir a ansiedade agora: respira devagar e me diz de 0 a 10 como esta.",
        "Voce nao esta sozinho nisso. Vamos focar no que esta sob controle: qual assunto voce revisou melhor?",
        "Se a ansiedade estiver alta, a meta agora e estabilizar. Quer uma tecnica rapida de aterramento (5-4-3-2-1)?",
    ],
}

----- END FILE: apps/brain/constants.py -----

----- BEGIN FILE: apps/brain/migrations/0001_initial.py -----
# Generated by Django 6.0.1 on 2026-02-12 13:20

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='CategoriaEmocional',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('nome', models.CharField(max_length=120)),
                ('slug', models.SlugField(unique=True)),
                ('emoji', models.CharField(max_length=10)),
                ('ativo', models.BooleanField(default=True)),
            ],
        ),
        migrations.CreateModel(
            name='MicroIntervencao',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('nome', models.CharField(max_length=120)),
                ('texto', models.TextField()),
                ('ativo', models.BooleanField(default=True)),
            ],
        ),
        migrations.CreateModel(
            name='GatilhoEmocional',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('palavras_chave', models.TextField()),
                ('ativo', models.BooleanField(default=True)),
                ('categoria', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='gatilhos', to='brain.categoriaemocional')),
            ],
        ),
        migrations.CreateModel(
            name='InteracaoAluno',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('mensagem_usuario', models.TextField()),
                ('resposta_texto', models.TextField()),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('origem', models.CharField(default='widget', max_length=40)),
                ('categoria_detectada', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='interacoes', to='brain.categoriaemocional')),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='interacoes_brain', to=settings.AUTH_USER_MODEL)),
            ],
        ),
        migrations.CreateModel(
            name='RespostaEmocional',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('texto', models.TextField()),
                ('ativo', models.BooleanField(default=True)),
                ('categoria', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='respostas', to='brain.categoriaemocional')),
            ],
        ),
    ]

----- END FILE: apps/brain/migrations/0001_initial.py -----

----- BEGIN FILE: apps/brain/migrations/0002_seed_initial_data.py -----
# Generated by Codex on 2026-02-12

from django.db import migrations


def seed_brain_initial_data(apps, schema_editor):
    CategoriaEmocional = apps.get_model("brain", "CategoriaEmocional")
    GatilhoEmocional = apps.get_model("brain", "GatilhoEmocional")
    RespostaEmocional = apps.get_model("brain", "RespostaEmocional")
    MicroIntervencao = apps.get_model("brain", "MicroIntervencao")

    categorias_data = [
        {
            "nome": "Stress",
            "slug": "stress",
            "emoji": "",
            "gatilhos": [
                "ansioso,ansiedade,nervoso,prova",
                "sobrecarregado,pressao,prazo,estressado",
            ],
            "resposta": "Percebi sinais de stress. Vamos escolher um unico passo simples para comecar agora?",
        },
        {
            "nome": "Duvida",
            "slug": "duvida",
            "emoji": "",
            "gatilhos": [
                "duvida,nao entendi,nao consigo entender",
                "bloqueio,materia dificil,explicacao",
            ],
            "resposta": "Vamos destravar isso por partes. Qual ponto exato da materia esta confuso neste momento?",
        },
        {
            "nome": "Motivacao baixa",
            "slug": "motivacao_baixa",
            "emoji": "",
            "gatilhos": [
                "desmotivado,sem motivacao,desanimado",
                "procrastinando,sem vontade,nada rende",
            ],
            "resposta": "Quando a motivacao cai, o melhor caminho e reduzir o tamanho do passo. Qual tarefa de 10 minutos voce topa iniciar?",
        },
        {
            "nome": "Cansaco mental",
            "slug": "cansaco_mental",
            "emoji": "",
            "gatilhos": [
                "cansado,exausto,sono,dormi pouco",
                "mente cansada,esgotado,sem energia",
            ],
            "resposta": "Seu corpo esta sinalizando cansaco. Que tal recuperar energia com uma pausa breve e depois retomar com uma tarefa leve?",
        },
        {
            "nome": "Foco alto",
            "slug": "foco_alto",
            "emoji": "",
            "gatilhos": [
                "focado,produtivo,concentrado",
                "animado para estudar,ritmo bom,avancando",
            ],
            "resposta": "Excelente momento de foco. Vamos proteger esse ritmo definindo o proximo bloco de estudo sem interrupcoes?",
        },
    ]

    for item in categorias_data:
        categoria, _created = CategoriaEmocional.objects.update_or_create(
            slug=item["slug"],
            defaults={"nome": item["nome"], "emoji": item["emoji"], "ativo": True},
        )

        RespostaEmocional.objects.update_or_create(
            categoria=categoria,
            texto=item["resposta"],
            defaults={"ativo": True},
        )

        for palavras in item["gatilhos"]:
            GatilhoEmocional.objects.update_or_create(
                categoria=categoria,
                palavras_chave=palavras,
                defaults={"ativo": True},
            )

    micro_intervencoes_data = [
        {"nome": "Beber agua", "texto": "Pare 1 minuto e beba um copo de agua para hidratar e retomar com clareza."},
        {
            "nome": "Respiracao 4-4-4",
            "texto": "Inspire por 4 segundos, segure por 4 segundos e expire por 4 segundos durante 3 ciclos.",
        },
    ]
    for item in micro_intervencoes_data:
        MicroIntervencao.objects.update_or_create(
            nome=item["nome"],
            defaults={"texto": item["texto"], "ativo": True},
        )


def unseed_brain_initial_data(apps, schema_editor):
    CategoriaEmocional = apps.get_model("brain", "CategoriaEmocional")
    MicroIntervencao = apps.get_model("brain", "MicroIntervencao")

    CategoriaEmocional.objects.filter(
        slug__in=["stress", "duvida", "motivacao_baixa", "cansaco_mental", "foco_alto"]
    ).delete()
    MicroIntervencao.objects.filter(nome__in=["Beber agua", "Respiracao 4-4-4"]).delete()


class Migration(migrations.Migration):
    dependencies = [
        ("brain", "0001_initial"),
    ]

    operations = [
        migrations.RunPython(seed_brain_initial_data, unseed_brain_initial_data),
    ]

----- END FILE: apps/brain/migrations/0002_seed_initial_data.py -----

----- BEGIN FILE: apps/brain/migrations/0003_seed_social_category.py -----
# Generated by Codex on 2026-02-12

from django.db import migrations


def seed_social_category(apps, schema_editor):
    CategoriaEmocional = apps.get_model("brain", "CategoriaEmocional")
    GatilhoEmocional = apps.get_model("brain", "GatilhoEmocional")
    RespostaEmocional = apps.get_model("brain", "RespostaEmocional")

    categoria_social, _created = CategoriaEmocional.objects.update_or_create(
        slug="social",
        defaults={"nome": "Social", "emoji": "", "ativo": True},
    )

    gatilhos = [
        "obrigado",
        "obrigada",
        "valeu",
        "gratido",
        "agradecido",
    ]
    for gatilho in gatilhos:
        GatilhoEmocional.objects.update_or_create(
            categoria=categoria_social,
            palavras_chave=gatilho,
            defaults={"ativo": True},
        )

    respostas = [
        "Fico feliz em ajudar ",
        "Sempre que precisar, estou aqui.",
        "Conta comigo para o que precisar.",
        " muito bom saber que estou ajudando.",
    ]
    for texto in respostas:
        RespostaEmocional.objects.update_or_create(
            categoria=categoria_social,
            texto=texto,
            defaults={"ativo": True},
        )


def unseed_social_category(apps, schema_editor):
    CategoriaEmocional = apps.get_model("brain", "CategoriaEmocional")
    CategoriaEmocional.objects.filter(slug="social").delete()


class Migration(migrations.Migration):
    dependencies = [
        ("brain", "0002_seed_initial_data"),
    ]

    operations = [
        migrations.RunPython(seed_social_category, unseed_social_category),
    ]

----- END FILE: apps/brain/migrations/0003_seed_social_category.py -----

----- BEGIN FILE: apps/brain/migrations/0004_expand_respostas_categorias.py -----
# Generated by Codex on 2026-02-12

from django.db import migrations


CATEGORY_RESPONSES = {
    "stress": [
        "Entendi. Vamos reduzir isso: qual e a menor parte que voce consegue fazer agora?",
        "Respira um pouco. O que esta te pressionando mais hoje?",
        "Se parecer demais, a gente escolhe so 1 prioridade para hoje.",
        "Vamos com calma: 10 minutos agora ja contam como progresso.",
    ],
    "duvida": [
        "Tudo bem ter duvida. Qual parte ficou mais confusa?",
        "Me diga o tema e eu organizo em passos simples.",
        "O que voce entendeu ate aqui? Mesmo que seja pouco.",
        "Quer um exemplo pratico para destravar esse conteudo?",
    ],
    "motivacao_baixa": [
        "Vamos so comecar: 15 minutos e pronto. Depois voce decide se continua.",
        "Escolhe uma tarefa pequena. O objetivo e ritmo, nao perfeicao.",
        "Quer que eu te ajude a escolher a tarefa mais facil para destravar?",
        "Voce nao precisa render tudo hoje. So precisa dar o primeiro passo.",
    ],
    "cansaco_mental": [
        "Parece cansaco mental. Que tal uma pausa curta antes de continuar?",
        "Vamos reduzir a carga: escolha algo leve e rapido agora.",
        "Se estiver pesado, da para dividir a tarefa em duas partes menores.",
        "Me diz como voce esta agora de 0 a 10, so para eu ajustar melhor.",
    ],
    "foco_alto": [
        "Otimo! Quer aproveitar e atacar a tarefa mais dificil agora?",
        "Perfeito. Qual e a prioridade #1 para concluir hoje?",
        "Se o foco esta alto, da para adiantar uma etapa e ganhar folga depois.",
        "Bora transformar esse foco em resultado: qual meta para a proxima 1 hora?",
    ],
}


def seed_expand_category_replies(apps, schema_editor):
    CategoriaEmocional = apps.get_model("brain", "CategoriaEmocional")
    RespostaEmocional = apps.get_model("brain", "RespostaEmocional")

    for slug, responses in CATEGORY_RESPONSES.items():
        categoria = CategoriaEmocional.objects.filter(slug=slug).first()
        if not categoria:
            continue

        for text in responses:
            RespostaEmocional.objects.update_or_create(
                categoria=categoria,
                texto=text,
                defaults={"ativo": True},
            )


def unseed_expand_category_replies(apps, schema_editor):
    CategoriaEmocional = apps.get_model("brain", "CategoriaEmocional")
    RespostaEmocional = apps.get_model("brain", "RespostaEmocional")

    for slug, responses in CATEGORY_RESPONSES.items():
        categoria = CategoriaEmocional.objects.filter(slug=slug).first()
        if not categoria:
            continue
        RespostaEmocional.objects.filter(categoria=categoria, texto__in=responses).delete()


class Migration(migrations.Migration):
    dependencies = [
        ("brain", "0003_seed_social_category"),
    ]

    operations = [
        migrations.RunPython(seed_expand_category_replies, unseed_expand_category_replies),
    ]

----- END FILE: apps/brain/migrations/0004_expand_respostas_categorias.py -----

----- BEGIN FILE: apps/brain/migrations/0005_seed_evolucao_category.py -----
# Generated by Codex on 2026-02-12

from django.db import migrations


def seed_evolucao_category(apps, schema_editor):
    CategoriaEmocional = apps.get_model("brain", "CategoriaEmocional")
    GatilhoEmocional = apps.get_model("brain", "GatilhoEmocional")
    RespostaEmocional = apps.get_model("brain", "RespostaEmocional")

    categoria_evolucao, _created = CategoriaEmocional.objects.update_or_create(
        slug="evolucao",
        defaults={"nome": "Evoluo", "emoji": "", "ativo": True},
    )

    gatilhos = [
        "estou melhor",
        "evolui",
        "evolu",
        "melhorei",
        "to indo bem",
        "t indo bem",
        "deu certo",
        "consegui",
        "bati a meta",
        "terminei",
        "orgulhoso",
        "orgulhosa",
    ]
    for palavras_chave in gatilhos:
        GatilhoEmocional.objects.update_or_create(
            categoria=categoria_evolucao,
            palavras_chave=palavras_chave,
            defaults={"ativo": True},
        )

    respostas = [
        "Que boa notcia. Quer me dizer o que voc fez que ajudou a melhorar?",
        "Parabns! Qual foi a parte mais difcil que voc superou?",
        "Isso  progresso real. Quer definir a prxima meta pequena para manter o ritmo?",
        "Muito bom. Quer registrar essa vitria para lembrar nos dias difceis?",
    ]
    for texto in respostas:
        RespostaEmocional.objects.update_or_create(
            categoria=categoria_evolucao,
            texto=texto,
            defaults={"ativo": True},
        )


def unseed_evolucao_category(apps, schema_editor):
    CategoriaEmocional = apps.get_model("brain", "CategoriaEmocional")
    CategoriaEmocional.objects.filter(slug="evolucao").delete()


class Migration(migrations.Migration):
    dependencies = [
        ("brain", "0004_expand_respostas_categorias"),
    ]

    operations = [
        migrations.RunPython(seed_evolucao_category, unseed_evolucao_category),
    ]

----- END FILE: apps/brain/migrations/0005_seed_evolucao_category.py -----

----- BEGIN FILE: apps/brain/migrations/0006_expand_evolucao_girias.py -----
# Generated by Codex on 2026-02-12

from django.db import migrations


def seed_evolucao_slang_triggers(apps, schema_editor):
    CategoriaEmocional = apps.get_model("brain", "CategoriaEmocional")
    GatilhoEmocional = apps.get_model("brain", "GatilhoEmocional")

    categoria = CategoriaEmocional.objects.filter(slug="evolucao").first()
    if not categoria:
        return

    girias = [
        "que massa",
        "show",
        "top",
        "consegui",
    ]
    for palavras_chave in girias:
        GatilhoEmocional.objects.update_or_create(
            categoria=categoria,
            palavras_chave=palavras_chave,
            defaults={"ativo": True},
        )


def unseed_evolucao_slang_triggers(apps, schema_editor):
    CategoriaEmocional = apps.get_model("brain", "CategoriaEmocional")
    GatilhoEmocional = apps.get_model("brain", "GatilhoEmocional")

    categoria = CategoriaEmocional.objects.filter(slug="evolucao").first()
    if not categoria:
        return

    GatilhoEmocional.objects.filter(
        categoria=categoria,
        palavras_chave__in=["que massa", "show", "top", "consegui"],
    ).delete()


class Migration(migrations.Migration):
    dependencies = [
        ("brain", "0005_seed_evolucao_category"),
    ]

    operations = [
        migrations.RunPython(seed_evolucao_slang_triggers, unseed_evolucao_slang_triggers),
    ]

----- END FILE: apps/brain/migrations/0006_expand_evolucao_girias.py -----

----- BEGIN FILE: apps/brain/migrations/0007_expand_evolucao_giria_maravilha.py -----
# Generated by Codex on 2026-02-12

from django.db import migrations


def seed_evolucao_maravilha_trigger(apps, schema_editor):
    CategoriaEmocional = apps.get_model("brain", "CategoriaEmocional")
    GatilhoEmocional = apps.get_model("brain", "GatilhoEmocional")

    categoria = CategoriaEmocional.objects.filter(slug="evolucao").first()
    if not categoria:
        return

    GatilhoEmocional.objects.update_or_create(
        categoria=categoria,
        palavras_chave="maravilha",
        defaults={"ativo": True},
    )


def unseed_evolucao_maravilha_trigger(apps, schema_editor):
    CategoriaEmocional = apps.get_model("brain", "CategoriaEmocional")
    GatilhoEmocional = apps.get_model("brain", "GatilhoEmocional")

    categoria = CategoriaEmocional.objects.filter(slug="evolucao").first()
    if not categoria:
        return

    GatilhoEmocional.objects.filter(categoria=categoria, palavras_chave="maravilha").delete()


class Migration(migrations.Migration):
    dependencies = [
        ("brain", "0006_expand_evolucao_girias"),
    ]

    operations = [
        migrations.RunPython(seed_evolucao_maravilha_trigger, unseed_evolucao_maravilha_trigger),
    ]

----- END FILE: apps/brain/migrations/0007_expand_evolucao_giria_maravilha.py -----

----- BEGIN FILE: apps/brain/models.py -----
from django.conf import settings
from django.db import models


class CategoriaEmocional(models.Model):
    nome = models.CharField(max_length=120)
    slug = models.SlugField(unique=True)
    emoji = models.CharField(max_length=10)
    ativo = models.BooleanField(default=True)

    def __str__(self):
        return self.nome


class GatilhoEmocional(models.Model):
    categoria = models.ForeignKey(CategoriaEmocional, on_delete=models.CASCADE, related_name="gatilhos")
    palavras_chave = models.TextField()
    ativo = models.BooleanField(default=True)

    def __str__(self):
        return f"{self.categoria.slug} - gatilho"


class RespostaEmocional(models.Model):
    categoria = models.ForeignKey(CategoriaEmocional, on_delete=models.CASCADE, related_name="respostas")
    texto = models.TextField()
    ativo = models.BooleanField(default=True)

    def __str__(self):
        return f"{self.categoria.slug} - resposta"


class MicroIntervencao(models.Model):
    nome = models.CharField(max_length=120)
    texto = models.TextField()
    ativo = models.BooleanField(default=True)

    def __str__(self):
        return self.nome


class InteracaoAluno(models.Model):
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name="interacoes_brain")
    mensagem_usuario = models.TextField()
    categoria_detectada = models.ForeignKey(
        CategoriaEmocional,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name="interacoes",
    )
    resposta_texto = models.TextField()
    created_at = models.DateTimeField(auto_now_add=True)
    origem = models.CharField(max_length=40, default="widget")

    def __str__(self):
        return f"{self.user_id} - {self.created_at:%Y-%m-%d %H:%M:%S}"

----- END FILE: apps/brain/models.py -----

----- BEGIN FILE: apps/brain/tests.py -----
from unittest.mock import patch
from datetime import timedelta

from django.contrib.auth import get_user_model
from django.utils import timezone
from rest_framework.test import APITestCase
from rest_framework_simplejwt.tokens import RefreshToken

from brain.constants import CONTEXT_MESSAGES
from brain.models import CategoriaEmocional, GatilhoEmocional, InteracaoAluno, MicroIntervencao, RespostaEmocional

User = get_user_model()


class WidgetChatTests(APITestCase):
    def setUp(self):
        self.user = User.objects.create_user(email="brain@example.com", name="Brain", password="pass12345")
        refresh = RefreshToken.for_user(self.user)
        self.client.credentials(HTTP_AUTHORIZATION=f"Bearer {refresh.access_token}")

        self.multi_categoria = CategoriaEmocional.objects.create(nome="Multipla", slug="multipla_teste", emoji="")
        GatilhoEmocional.objects.create(categoria=self.multi_categoria, palavras_chave="zzmulti")
        RespostaEmocional.objects.create(categoria=self.multi_categoria, texto="Resposta A")
        RespostaEmocional.objects.create(categoria=self.multi_categoria, texto="Resposta B")
        RespostaEmocional.objects.create(categoria=self.multi_categoria, texto="Resposta C")

        # Seed inicial deve manter ao menos 2 microintervencoes ativas.
        self.assertGreaterEqual(MicroIntervencao.objects.filter(ativo=True).count(), 2)

    def _create_interacao_with_hours_ago(self, categoria_slug, hours_ago):
        categoria = CategoriaEmocional.objects.get(slug=categoria_slug)
        interaction = InteracaoAluno.objects.create(
            user=self.user,
            mensagem_usuario=f"hist-{categoria_slug}-{hours_ago}",
            categoria_detectada=categoria,
            resposta_texto=f"resp-{categoria_slug}",
            origem="widget",
        )
        timestamp = timezone.now() - timedelta(hours=hours_ago)
        InteracaoAluno.objects.filter(pk=interaction.pk).update(created_at=timestamp)
        interaction.refresh_from_db()
        return interaction

    def _create_interacao_custom(self, categoria_slug, resposta_texto, hours_ago):
        categoria = CategoriaEmocional.objects.get(slug=categoria_slug)
        interaction = InteracaoAluno.objects.create(
            user=self.user,
            mensagem_usuario=f"custom-{categoria_slug}-{hours_ago}",
            categoria_detectada=categoria,
            resposta_texto=resposta_texto,
            origem="widget",
        )
        timestamp = timezone.now() - timedelta(hours=hours_ago)
        InteracaoAluno.objects.filter(pk=interaction.pk).update(created_at=timestamp)
        interaction.refresh_from_db()
        return interaction

    def test_detects_social_category(self):
        response = self.client.post("/api/widget/chat/", {"message": "Tenho muita GRATIDAO pela ajuda!"}, format="json")
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response.data["category"], "social")
        self.assertEqual(response.data["emoji"], "")
        self.assertIn(
            response.data["reply"],
            {
                "Fico feliz em ajudar ",
                "Sempre que precisar, estou aqui.",
                "Conta comigo para o que precisar.",
                " muito bom saber que estou ajudando.",
            },
        )
        self.assertEqual(response.data["micro_interventions"], [])
        self.assertEqual(InteracaoAluno.objects.count(), 1)

    def test_social_message_obrigado_returns_empty_micro_interventions(self):
        response = self.client.post("/api/widget/chat/", {"message": "obrigado"}, format="json")
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response.data["category"], "social")
        self.assertEqual(response.data["emoji"], "")
        self.assertEqual(response.data["micro_interventions"], [])

    def test_detects_evolucao_category(self):
        response = self.client.post("/api/widget/chat/", {"message": "Consegui, to indo bem e evolui"}, format="json")
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response.data["category"], "evolucao")
        self.assertEqual(response.data["emoji"], "")
        self.assertTrue(response.data["reply"])
        self.assertEqual(response.data["micro_interventions"], [])

    def test_detects_evolucao_with_student_slang(self):
        response = self.client.post(
            "/api/widget/chat/",
            {"message": "Que massa, show, top, consegui!"},
            format="json",
        )
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response.data["category"], "evolucao")
        self.assertEqual(response.data["emoji"], "")
        self.assertTrue(response.data["reply"])
        self.assertEqual(response.data["micro_interventions"], [])

    def test_detects_evolucao_with_maravilha_slang(self):
        response = self.client.post(
            "/api/widget/chat/",
            {"message": "Maravilha, hoje mandei bem!"},
            format="json",
        )
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response.data["category"], "evolucao")
        self.assertEqual(response.data["emoji"], "")
        self.assertTrue(response.data["reply"])
        self.assertEqual(response.data["micro_interventions"], [])

    def test_detects_stress_anxiety_before_exam(self):
        response = self.client.post(
            "/api/widget/chat/",
            {"message": "vou fazer uma prova e estou muito ansioso"},
            format="json",
        )
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response.data["category"], "stress")
        self.assertIn(response.data["reply"], CONTEXT_MESSAGES["stress_anxiety"])
        self.assertLessEqual(len(response.data["micro_interventions"]), 1)

    def test_detects_stress_anxiety_general_message(self):
        response = self.client.post(
            "/api/widget/chat/",
            {"message": "o que mais posso fazer pra melhorar minha ansiedade?"},
            format="json",
        )
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response.data["category"], "stress")
        self.assertIn(response.data["reply"], CONTEXT_MESSAGES["stress_anxiety"])
        self.assertLessEqual(len(response.data["micro_interventions"]), 1)

    def test_detects_stress_anxiety_with_common_typo(self):
        response = self.client.post(
            "/api/widget/chat/",
            {"message": "boa tarde, vou fazer uma prova e estou muito ancioso"},
            format="json",
        )
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response.data["category"], "stress")
        self.assertIn(response.data["reply"], CONTEXT_MESSAGES["stress_anxiety"])
        self.assertLessEqual(len(response.data["micro_interventions"]), 1)

    def test_weak_positive_with_negative_context_falls_back_to_stress(self):
        response = self.client.post(
            "/api/widget/chat/",
            {"message": "show, mas estou muito ansioso para a prova"},
            format="json",
        )
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response.data["category"], "stress")

    def test_weak_positive_preserved_when_message_is_positive(self):
        response = self.client.post(
            "/api/widget/chat/",
            {"message": "show, consegui terminar tudo"},
            format="json",
        )
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response.data["category"], "evolucao")

    def test_strong_positive_phrase_remains_evolucao(self):
        response = self.client.post(
            "/api/widget/chat/",
            {"message": "que massa, consegui tirar boa nota"},
            format="json",
        )
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response.data["category"], "evolucao")

    def test_micro_interventions_are_limited_to_one_when_present(self):
        response = self.client.post(
            "/api/widget/chat/",
            {"message": "estou sobrecarregado com prazo e estressado"},
            format="json",
        )
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response.data["category"], "stress")
        self.assertLessEqual(len(response.data["micro_interventions"]), 1)

    def test_micro_intervention_avoids_immediate_repeat_when_multiple_options(self):
        first = self.client.post(
            "/api/widget/chat/",
            {"message": "estou sobrecarregado e estressado"},
            format="json",
        )
        second = self.client.post(
            "/api/widget/chat/",
            {"message": "ainda estou sobrecarregado e estressado"},
            format="json",
        )
        self.assertEqual(first.status_code, 200)
        self.assertEqual(second.status_code, 200)
        self.assertLessEqual(len(first.data["micro_interventions"]), 1)
        self.assertLessEqual(len(second.data["micro_interventions"]), 1)

        if first.data["micro_interventions"] and second.data["micro_interventions"]:
            first_name = first.data["micro_interventions"][0]["nome"]
            second_name = second.data["micro_interventions"][0]["nome"]
            if MicroIntervencao.objects.filter(ativo=True).count() > 1:
                self.assertNotEqual(first_name, second_name)

    def test_contextual_memory_stress_repetition_within_48h(self):
        self._create_interacao_with_hours_ago("stress", 2)
        self._create_interacao_with_hours_ago("stress", 4)
        self._create_interacao_with_hours_ago("stress", 6)

        response = self.client.post(
            "/api/widget/chat/",
            {"message": "Estou muito sobrecarregado e estressado"},
            format="json",
        )
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response.data["category"], "stress")
        self.assertIn(response.data["reply"], CONTEXT_MESSAGES["stress_repeat"])

    def test_contextual_memory_repeated_evolucao_within_48h(self):
        self._create_interacao_with_hours_ago("evolucao", 3)
        self._create_interacao_with_hours_ago("evolucao", 5)

        response = self.client.post(
            "/api/widget/chat/",
            {"message": "Consegui, to indo bem"},
            format="json",
        )
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response.data["category"], "evolucao")
        self.assertIn(response.data["reply"], CONTEXT_MESSAGES["evolucao_repeat"])
        self.assertEqual(response.data["micro_interventions"], [])

    def test_contextual_memory_stress_to_evolucao_within_24h(self):
        self._create_interacao_with_hours_ago("stress", 12)

        response = self.client.post(
            "/api/widget/chat/",
            {"message": "Consegui bater a meta, to indo bem"},
            format="json",
        )
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response.data["category"], "evolucao")
        self.assertIn(response.data["reply"], CONTEXT_MESSAGES["stress_to_evolucao"])
        self.assertEqual(response.data["micro_interventions"], [])

    def test_contextual_memory_ignores_interactions_older_than_48h(self):
        self._create_interacao_with_hours_ago("stress", 50)
        self._create_interacao_with_hours_ago("stress", 60)
        self._create_interacao_with_hours_ago("stress", 70)

        response = self.client.post(
            "/api/widget/chat/",
            {"message": "Estou muito sobrecarregado e estressado"},
            format="json",
        )
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response.data["category"], "stress")
        self.assertNotIn(response.data["reply"], CONTEXT_MESSAGES["stress_repeat"])

    def test_contextual_memory_avoids_immediate_repeat_variant(self):
        repeated_text = CONTEXT_MESSAGES["stress_repeat"][0]
        self._create_interacao_custom("stress", repeated_text, 1)
        self._create_interacao_with_hours_ago("stress", 2)
        self._create_interacao_with_hours_ago("stress", 3)

        response = self.client.post(
            "/api/widget/chat/",
            {"message": "Estou muito sobrecarregado e estressado"},
            format="json",
        )
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response.data["category"], "stress")
        self.assertIn(response.data["reply"], CONTEXT_MESSAGES["stress_repeat"])
        self.assertNotEqual(response.data["reply"], repeated_text)

    def test_long_positive_message_prefers_evolucao_over_stress(self):
        response = self.client.post(
            "/api/widget/chat/",
            {"message": "eu estudei bastante, com bastante foco e consegui tirar uma boa nota na prova"},
            format="json",
        )
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response.data["category"], "evolucao")
        self.assertEqual(response.data["emoji"], "")
        self.assertEqual(response.data["micro_interventions"], [])

    def test_primary_categories_have_at_least_four_active_replies(self):
        category_slugs = ["stress", "duvida", "motivacao_baixa", "cansaco_mental", "foco_alto"]
        for slug in category_slugs:
            categoria = CategoriaEmocional.objects.filter(slug=slug).first()
            self.assertIsNotNone(categoria)
            active_count = RespostaEmocional.objects.filter(categoria=categoria, ativo=True).count()
            self.assertGreaterEqual(active_count, 4)

    def test_evolucao_category_has_at_least_four_active_replies(self):
        categoria = CategoriaEmocional.objects.filter(slug="evolucao").first()
        self.assertIsNotNone(categoria)
        active_count = RespostaEmocional.objects.filter(categoria=categoria, ativo=True).count()
        self.assertGreaterEqual(active_count, 4)

    def test_endpoint_typical_messages_for_primary_categories(self):
        samples = [
            ("stress", "Estou sobrecarregado com prazo"),
            ("duvida", "Nao entendi essa materia"),
            ("motivacao_baixa", "Estou desmotivado hoje"),
            ("cansaco_mental", "Estou esgotado e sem energia"),
            ("foco_alto", "Hoje estou concentrado e produtivo"),
        ]
        for expected_slug, message in samples:
            response = self.client.post("/api/widget/chat/", {"message": message}, format="json")
            self.assertEqual(response.status_code, 200)
            self.assertEqual(response.data["category"], expected_slug)
            self.assertTrue(response.data["reply"])

    def test_scoring_phrase_weight_wins_over_single_word(self):
        phrase_categoria = CategoriaEmocional.objects.create(nome="Score Frase", slug="score_frase_teste", emoji="")
        word_categoria = CategoriaEmocional.objects.create(nome="Score Palavra", slug="score_palavra_teste", emoji="")

        GatilhoEmocional.objects.create(categoria=phrase_categoria, palavras_chave="mega progresso")
        GatilhoEmocional.objects.create(categoria=word_categoria, palavras_chave="mega")

        RespostaEmocional.objects.create(categoria=phrase_categoria, texto="Resposta categoria frase")
        RespostaEmocional.objects.create(categoria=word_categoria, texto="Resposta categoria palavra")

        response = self.client.post("/api/widget/chat/", {"message": "hoje foi mega progresso"}, format="json")
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response.data["category"], "score_frase_teste")
        self.assertEqual(response.data["emoji"], "")
        self.assertTrue(response.data["reply"])

    @patch("brain.views.choose_variant", return_value="Resposta B")
    def test_selects_random_reply_among_category_options(self, choose_variant_mock):
        response = self.client.post("/api/widget/chat/", {"message": "zzmulti agora"}, format="json")
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response.data["category"], "multipla_teste")
        self.assertEqual(response.data["reply"], "Resposta B")
        choose_variant_mock.assert_called()

    @patch("brain.views.choose_variant", return_value="Resposta B")
    def test_avoids_immediate_reply_repetition_for_same_user(self, choose_variant_mock):
        InteracaoAluno.objects.create(
            user=self.user,
            mensagem_usuario="mensagem anterior",
            categoria_detectada=self.multi_categoria,
            resposta_texto="Resposta A",
            origem="widget",
        )

        response = self.client.post("/api/widget/chat/", {"message": "zzmulti novamente"}, format="json")
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response.data["reply"], "Resposta B")
        self.assertNotEqual(response.data["reply"], "Resposta A")
        choose_variant_mock.assert_called()

    @patch("brain.views.random.choice", return_value="Entendi. Me fala um pouco mais para eu poder te ajudar melhor.")
    def test_fallback_returns_null_category_and_no_micro_interventions(self, random_choice_mock):
        response = self.client.post(
            "/api/widget/chat/",
            {"message": "mensagem sem qualquer gatilho conhecido qwerty"},
            format="json",
        )
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response.data["category"], None)
        self.assertEqual(response.data["emoji"], None)
        self.assertEqual(response.data["micro_interventions"], [])
        self.assertEqual(response.data["reply"], "Entendi. Me fala um pouco mais para eu poder te ajudar melhor.")
        random_choice_mock.assert_called()

----- END FILE: apps/brain/tests.py -----

----- BEGIN FILE: apps/brain/urls.py -----
from django.urls import path

from brain.views import WidgetChatView

urlpatterns = [
    path("chat/", WidgetChatView.as_view(), name="widget-chat"),
]

----- END FILE: apps/brain/urls.py -----

----- BEGIN FILE: apps/brain/views.py -----
import re
import random
import unicodedata
from collections import defaultdict
from datetime import timedelta

from django.conf import settings
from django.utils import timezone

from rest_framework import permissions, serializers, status
from rest_framework.authentication import SessionAuthentication
from rest_framework.response import Response
from rest_framework.views import APIView
from rest_framework_simplejwt.authentication import JWTAuthentication

from brain.constants import ANXIETY_KEYWORDS, CONTEXT_MESSAGES, EXAM_KEYWORDS
from brain.models import GatilhoEmocional, InteracaoAluno, MicroIntervencao, RespostaEmocional


class WidgetChatRequestSerializer(serializers.Serializer):
    message = serializers.CharField(allow_blank=False, trim_whitespace=True)


FALLBACK_REPLIES = [
    "Estou aqui com voce. Quer me contar um pouco mais sobre isso?",
    "Entendi. Me fala um pouco mais para eu poder te ajudar melhor.",
]

CATEGORY_PRIORITY = [
    "evolucao",
    "foco_alto",
    "social",
    "duvida",
    "motivacao_baixa",
    "cansaco_mental",
    "stress",
]

SOCIAL_STRONG_HINTS = ("obrigad", "valeu")
NEGATIVE_KEYWORDS = [
    "ansioso",
    "ansiosa",
    "ansiedade",
    "nervoso",
    "nervosa",
    "cansado",
    "cansada",
    "estressado",
    "estressada",
    "dificil",
    "difcil",
    "medo",
    "preocupado",
    "preocupada",
    "triste",
]
WEAK_POSITIVE_KEYWORDS = [
    "show",
    "top",
    "massa",
]


def choose_variant(options: list[str], last_text: str | None) -> str:
    unique_options = list(dict.fromkeys(options or []))
    if not unique_options:
        return ""
    if last_text in unique_options and len(unique_options) > 1:
        filtered = [text for text in unique_options if text != last_text]
        return random.choice(filtered)
    return random.choice(unique_options)


def _normalize_text(value):
    normalized = unicodedata.normalize("NFD", str(value or "").lower())
    no_accents = "".join(char for char in normalized if unicodedata.category(char) != "Mn")
    no_punctuation = re.sub(r"[^a-z0-9\s]", " ", no_accents)
    return re.sub(r"\s+", " ", no_punctuation).strip()


def _extract_keywords(raw_keywords):
    parts = re.split(r"[,\n;]+", str(raw_keywords or ""))
    cleaned = []
    for part in parts:
        keyword = _normalize_text(part.strip())
        if keyword:
            cleaned.append(keyword)
    return cleaned


def _contains_keyword(message_text, message_words, keyword):
    if not keyword:
        return False
    if " " in keyword:
        return keyword in message_text
    return keyword in message_words


def _has_any_keyword(message_text, keywords):
    if not message_text:
        return False
    message_words = set(message_text.split())
    for raw_keyword in keywords:
        keyword = _normalize_text(raw_keyword)
        if keyword and _contains_keyword(message_text, message_words, keyword):
            return True
    return False


def _detect_categoria(message_text):
    if not message_text:
        return None

    message_words = set(message_text.split())
    has_negative_keywords = _has_any_keyword(message_text, NEGATIVE_KEYWORDS)
    gatilhos = GatilhoEmocional.objects.filter(ativo=True, categoria__ativo=True).select_related("categoria").order_by("id")
    score_by_slug = defaultdict(int)
    category_by_slug = {}

    for gatilho in gatilhos:
        categoria = gatilho.categoria
        slug = categoria.slug
        category_by_slug[slug] = categoria
        keywords = _extract_keywords(gatilho.palavras_chave)
        for keyword in keywords:
            if _contains_keyword(message_text, message_words, keyword):
                if keyword in WEAK_POSITIVE_KEYWORDS and has_negative_keywords:
                    weight = 0
                else:
                    weight = 2 if " " in keyword else 1
                score_by_slug[slug] += weight

    if not score_by_slug:
        return None

    max_score = max(score_by_slug.values())
    if max_score <= 0:
        return None

    top_slugs = [slug for slug, score in score_by_slug.items() if score == max_score]

    # Optional UX rule: social should win ties only for clear/short gratitude signals.
    if "social" in top_slugs and len(top_slugs) > 1:
        is_short_message = len(message_text) <= 40
        has_social_hint = any(hint in message_text for hint in SOCIAL_STRONG_HINTS)
        if not (is_short_message or has_social_hint):
            filtered = [slug for slug in top_slugs if slug != "social"]
            if filtered:
                top_slugs = filtered

    for priority_slug in CATEGORY_PRIORITY:
        if priority_slug in top_slugs:
            return category_by_slug.get(priority_slug)

    chosen_slug = sorted(top_slugs)[0]
    return category_by_slug.get(chosen_slug)


def _pick_category_reply(categoria, last_response_text):
    respostas = list(RespostaEmocional.objects.filter(categoria=categoria, ativo=True).values_list("texto", flat=True))
    if not respostas:
        return None
    return choose_variant(respostas, last_response_text)


def _load_recent_history(user):
    memory_hours = getattr(settings, "BRAIN_MEMORY_HOURS", 48)
    history_limit = getattr(settings, "BRAIN_HISTORY_LIMIT", 10)
    limite_48h = timezone.now() - timedelta(hours=memory_hours)
    return list(
        InteracaoAluno.objects.filter(user=user, created_at__gte=limite_48h)
        .select_related("categoria_detectada")
        .order_by("-created_at")[:history_limit]
    )


def _pick_contextual_reply(categoria, history, now, last_response_text):
    if not categoria:
        return None

    stress_threshold = getattr(settings, "BRAIN_STRESS_REPEAT_THRESHOLD", 3)
    evolucao_threshold = getattr(settings, "BRAIN_EVOLUCAO_REPEAT_THRESHOLD", 2)
    stress_to_evolucao_window = getattr(settings, "BRAIN_STRESS_TO_EVOLUCAO_WINDOW_HOURS", 24)

    current_slug = categoria.slug
    history_slugs = [item.categoria_detectada.slug for item in history if item.categoria_detectada]

    if current_slug == "stress":
        if len(history_slugs) >= stress_threshold and all(slug == "stress" for slug in history_slugs[:stress_threshold]):
            return choose_variant(CONTEXT_MESSAGES["stress_repeat"], last_response_text)
        return None

    if current_slug == "evolucao":
        if len(history_slugs) >= evolucao_threshold and all(
            slug == "evolucao" for slug in history_slugs[:evolucao_threshold]
        ):
            return choose_variant(CONTEXT_MESSAGES["evolucao_repeat"], last_response_text)

        limite_24h = now - timedelta(hours=stress_to_evolucao_window)
        has_recent_stress = any(
            item.categoria_detectada
            and item.categoria_detectada.slug == "stress"
            and item.created_at >= limite_24h
            for item in history
        )
        if has_recent_stress:
            return choose_variant(CONTEXT_MESSAGES["stress_to_evolucao"], last_response_text)

    return None


def _pick_micro_intervention(request, categoria):
    if not categoria or categoria.slug in {"social", "evolucao"}:
        return []

    options = list(MicroIntervencao.objects.filter(ativo=True).order_by("id"))
    if not options:
        return []

    session_key = "brain_last_micro_intervention_name"
    last_micro_name = request.session.get(session_key)

    candidates = options
    if last_micro_name and len(options) > 1:
        filtered = [item for item in options if item.nome != last_micro_name]
        if filtered:
            candidates = filtered

    selected = random.choice(candidates)
    request.session[session_key] = selected.nome
    return [{"nome": selected.nome, "texto": selected.texto}]


class WidgetChatView(APIView):
    authentication_classes = [SessionAuthentication, JWTAuthentication]
    permission_classes = [permissions.IsAuthenticated]

    def post(self, request):
        serializer = WidgetChatRequestSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)

        mensagem_usuario = serializer.validated_data["message"].strip()
        normalized_message = _normalize_text(mensagem_usuario)
        now = timezone.now()
        last_response_text = (
            InteracaoAluno.objects.filter(user=request.user)
            .order_by("-created_at", "-id")
            .values_list("resposta_texto", flat=True)
            .first()
        )

        categoria = _detect_categoria(normalized_message)
        if categoria:
            reply_text = None
            if categoria.slug == "stress":
                has_anxiety = _has_any_keyword(normalized_message, ANXIETY_KEYWORDS)
                has_exam = _has_any_keyword(normalized_message, EXAM_KEYWORDS)
                if has_anxiety and has_exam:
                    reply_text = choose_variant(CONTEXT_MESSAGES["stress_anxiety"], last_response_text)
                elif has_anxiety:
                    reply_text = choose_variant(CONTEXT_MESSAGES["stress_anxiety"], last_response_text)

            historico = _load_recent_history(request.user)
            if not reply_text:
                reply_text = _pick_contextual_reply(categoria, historico, now, last_response_text)
            if not reply_text:
                reply_text = _pick_category_reply(categoria, last_response_text)
            if not reply_text:
                reply_text = random.choice(FALLBACK_REPLIES)
            payload_micro_intervencoes = _pick_micro_intervention(request, categoria)
        else:
            reply_text = random.choice(FALLBACK_REPLIES)
            payload_micro_intervencoes = []

        InteracaoAluno.objects.create(
            user=request.user,
            mensagem_usuario=mensagem_usuario,
            categoria_detectada=categoria,
            resposta_texto=reply_text,
            origem="widget",
        )

        return Response(
            {
                "reply": reply_text,
                "category": categoria.slug if categoria else None,
                "emoji": categoria.emoji if categoria else None,
                "micro_interventions": payload_micro_intervencoes,
            },
            status=status.HTTP_200_OK,
        )

----- END FILE: apps/brain/views.py -----

----- BEGIN FILE: apps/coach_ai/admin.py -----
from django.contrib import admin

from coach_ai.models import CoachLog


@admin.register(CoachLog)
class CoachLogAdmin(admin.ModelAdmin):
    list_display = ("user", "trigger_type", "created_at")
    list_filter = ("trigger_type",)

----- END FILE: apps/coach_ai/admin.py -----

----- BEGIN FILE: apps/coach_ai/apps.py -----
from django.apps import AppConfig


class CoachAiConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'coach_ai'

----- END FILE: apps/coach_ai/apps.py -----

----- BEGIN FILE: apps/coach_ai/migrations/0001_initial.py -----
# Generated by Django 4.2.11 on 2026-01-28 13:35

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='CoachLog',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('trigger_type', models.CharField(choices=[('PRAZO_PROXIMO', 'Prazo proximo'), ('ATRASO', 'Atraso'), ('HUMOR_BAIXO', 'Humor baixo'), ('SEMESTRE_CONCLUIDO', 'Semestre concluido'), ('REPROVACAO', 'Reprovacao')], max_length=30)),
                ('suggestion_text', models.TextField()),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='coach_logs', to=settings.AUTH_USER_MODEL)),
            ],
        ),
    ]

----- END FILE: apps/coach_ai/migrations/0001_initial.py -----

----- BEGIN FILE: apps/coach_ai/models.py -----
from django.conf import settings
from django.db import models

from utils.constants import COACH_TRIGGER_CHOICES


class CoachLog(models.Model):
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name="coach_logs")
    trigger_type = models.CharField(max_length=30, choices=COACH_TRIGGER_CHOICES)
    suggestion_text = models.TextField()
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return f"{self.user.email} - {self.trigger_type}"

----- END FILE: apps/coach_ai/models.py -----

----- BEGIN FILE: apps/content/admin.py -----
from django.contrib import admin

from content.models import GuidedContent


@admin.register(GuidedContent)
class GuidedContentAdmin(admin.ModelAdmin):
    list_display = ("title", "category", "duration_minutes", "is_premium")
    list_filter = ("category", "is_premium")

----- END FILE: apps/content/admin.py -----

----- BEGIN FILE: apps/content/apps.py -----
from django.apps import AppConfig


class ContentConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'content'

----- END FILE: apps/content/apps.py -----

----- BEGIN FILE: apps/content/migrations/0001_initial.py -----
# Generated by Django 4.2.11 on 2026-01-28 13:35

from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='GuidedContent',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('title', models.CharField(max_length=200)),
                ('category', models.CharField(choices=[('PRE_PROVA', 'Pre-prova'), ('ANTI_PROCRASTINACAO', 'Anti-procrastinacao'), ('FOCO', 'Foco')], max_length=50)),
                ('duration_minutes', models.PositiveIntegerField()),
                ('body_text', models.TextField()),
                ('is_premium', models.BooleanField(default=False)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
            ],
        ),
    ]

----- END FILE: apps/content/migrations/0001_initial.py -----

----- BEGIN FILE: apps/content/models.py -----
from django.db import models

from utils.constants import CONTENT_CATEGORY_CHOICES


class GuidedContent(models.Model):
    title = models.CharField(max_length=200)
    category = models.CharField(max_length=50, choices=CONTENT_CATEGORY_CHOICES)
    duration_minutes = models.PositiveIntegerField()
    body_text = models.TextField()
    is_premium = models.BooleanField(default=False)
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return self.title

----- END FILE: apps/content/models.py -----

----- BEGIN FILE: apps/content/serializers.py -----
from rest_framework import serializers

from content.models import GuidedContent


class GuidedContentSerializer(serializers.ModelSerializer):
    class Meta:
        model = GuidedContent
        fields = ("id", "title", "category", "duration_minutes", "body_text", "is_premium", "created_at")
        read_only_fields = ("id", "created_at")

----- END FILE: apps/content/serializers.py -----

----- BEGIN FILE: apps/content/urls.py -----
from django.urls import path

from content.views import GuidedContentDetailView, GuidedContentListView

urlpatterns = [
    path("guided/", GuidedContentListView.as_view(), name="guided-content"),
    path("guided/<int:pk>/", GuidedContentDetailView.as_view(), name="guided-content-detail"),
]

----- END FILE: apps/content/urls.py -----

----- BEGIN FILE: apps/content/views.py -----
from django.shortcuts import get_object_or_404
from rest_framework import permissions, status
from rest_framework.response import Response
from rest_framework.views import APIView

from content.models import GuidedContent
from content.serializers import GuidedContentSerializer
from utils.constants import FEATURE_CONTENT_FULL, FEATURE_CONTENT_LIMITED
from utils.features import has_feature


class GuidedContentListView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request):
        if not has_feature(request.user, FEATURE_CONTENT_FULL) and not has_feature(request.user, FEATURE_CONTENT_LIMITED):
            return Response({"detail": "Plano atual nao permite conteudos."}, status=status.HTTP_403_FORBIDDEN)
        queryset = GuidedContent.objects.all().order_by("-created_at")
        if not has_feature(request.user, FEATURE_CONTENT_FULL):
            queryset = queryset.filter(is_premium=False)
        return Response(GuidedContentSerializer(queryset, many=True).data)


class GuidedContentDetailView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request, pk):
        content = get_object_or_404(GuidedContent, pk=pk)
        if content.is_premium and not has_feature(request.user, FEATURE_CONTENT_FULL):
            return Response({"detail": "Plano atual nao permite este conteudo."}, status=status.HTTP_403_FORBIDDEN)
        return Response(GuidedContentSerializer(content).data)

----- END FILE: apps/content/views.py -----

----- BEGIN FILE: apps/mood/admin.py -----
from django.contrib import admin

from mood.models import MoodEntry


@admin.register(MoodEntry)
class MoodEntryAdmin(admin.ModelAdmin):
    list_display = ("user", "mood", "created_at")
    list_filter = ("mood",)
    search_fields = ("user__email",)

----- END FILE: apps/mood/admin.py -----

----- BEGIN FILE: apps/mood/apps.py -----
from django.apps import AppConfig


class MoodConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'mood'

----- END FILE: apps/mood/apps.py -----

----- BEGIN FILE: apps/mood/migrations/0001_initial.py -----
# Generated by Django 4.2.11 on 2026-01-28 13:35

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='MoodEntry',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('mood', models.CharField(choices=[('VERY_BAD', 'Very bad'), ('BAD', 'Bad'), ('OK', 'Ok'), ('GOOD', 'Good'), ('VERY_GOOD', 'Very good')], max_length=20)),
                ('notes', models.TextField(blank=True)),
                ('tags', models.JSONField(default=list)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='mood_entries', to=settings.AUTH_USER_MODEL)),
            ],
        ),
    ]

----- END FILE: apps/mood/migrations/0001_initial.py -----

----- BEGIN FILE: apps/mood/models.py -----
from django.conf import settings
from django.db import models

from utils.constants import MOOD_CHOICES


class MoodEntry(models.Model):
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name="mood_entries")
    mood = models.CharField(max_length=20, choices=MOOD_CHOICES)
    notes = models.TextField(blank=True)
    tags = models.JSONField(default=list)
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return f"{self.user.email} - {self.mood}"

----- END FILE: apps/mood/models.py -----

----- BEGIN FILE: apps/mood/serializers.py -----
from rest_framework import serializers

from mood.models import MoodEntry


class MoodEntrySerializer(serializers.ModelSerializer):
    class Meta:
        model = MoodEntry
        fields = ("id", "mood", "notes", "tags", "created_at")
        read_only_fields = ("id", "created_at")

----- END FILE: apps/mood/serializers.py -----

----- BEGIN FILE: apps/mood/tests.py -----
from django.contrib.auth import get_user_model
from rest_framework.test import APITestCase
from rest_framework_simplejwt.tokens import RefreshToken

from billing.models import Plan, UserSubscription
from utils.constants import FEATURE_MOOD_BASIC, PLAN_LITE

User = get_user_model()


class MoodEntryTests(APITestCase):
    def setUp(self):
        self.user = User.objects.create_user(email="mood@example.com", name="Mood", password="pass12345")
        plan, _ = Plan.objects.get_or_create(
            code=PLAN_LITE, defaults={"name": "Lite", "features": [FEATURE_MOOD_BASIC], "is_active": True}
        )
        UserSubscription.objects.create(user=self.user, plan=plan)
        refresh = RefreshToken.for_user(self.user)
        self.client.credentials(HTTP_AUTHORIZATION=f"Bearer {refresh.access_token}")

    def test_create_mood_entry(self):
        response = self.client.post("/api/mood/entries/", {"mood": "OK", "notes": "Tudo bem"}, format="json")
        self.assertEqual(response.status_code, 201)

----- END FILE: apps/mood/tests.py -----

----- BEGIN FILE: apps/mood/urls.py -----
from django.urls import path

from mood.views import MoodEntryListCreateView, MoodWeeklySummaryView

urlpatterns = [
    path("entries/", MoodEntryListCreateView.as_view(), name="mood-entries"),
    path("summary/weekly/", MoodWeeklySummaryView.as_view(), name="mood-summary-weekly"),
]

----- END FILE: apps/mood/urls.py -----

----- BEGIN FILE: apps/mood/views.py -----
from datetime import timedelta

from django.utils import timezone
from rest_framework import permissions, status
from rest_framework.response import Response
from rest_framework.views import APIView
from rest_framework.generics import ListCreateAPIView

from mood.models import MoodEntry
from mood.serializers import MoodEntrySerializer
from utils.constants import FEATURE_MOOD_BASIC, MOOD_VERY_BAD
from utils.features import require_feature


class MoodEntryListCreateView(ListCreateAPIView):
    serializer_class = MoodEntrySerializer
    permission_classes = [permissions.IsAuthenticated]

    def get_queryset(self):
        require_feature(self.request.user, FEATURE_MOOD_BASIC)
        return MoodEntry.objects.filter(user=self.request.user).order_by("-created_at")

    def perform_create(self, serializer):
        require_feature(self.request.user, FEATURE_MOOD_BASIC)
        serializer.save(user=self.request.user)

    def create(self, request, *args, **kwargs):
        response = super().create(request, *args, **kwargs)
        week_ago = timezone.now() - timedelta(days=7)
        very_bad_count = MoodEntry.objects.filter(
            user=request.user, mood=MOOD_VERY_BAD, created_at__gte=week_ago
        ).count()
        if very_bad_count >= 3:
            response.data["wellness_notice"] = (
                "Percebemos humor muito baixo recorrente. Procure apoio profissional."
                " No Brasil, o CVV atende 188 (24h)."
            )
        return response


class MoodWeeklySummaryView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request):
        require_feature(request.user, FEATURE_MOOD_BASIC)
        week_ago = timezone.now() - timedelta(days=7)
        entries = MoodEntry.objects.filter(user=request.user, created_at__gte=week_ago)
        summary = {}
        for mood, _label in MoodEntry._meta.get_field("mood").choices:
            summary[mood] = entries.filter(mood=mood).count()
        return Response({"summary": summary})

----- END FILE: apps/mood/views.py -----

----- BEGIN FILE: apps/notifications/admin.py -----
from django.contrib import admin

from notifications.models import IncomingMessage, NotificationQueue


@admin.register(NotificationQueue)
class NotificationQueueAdmin(admin.ModelAdmin):
    list_display = ("user", "channel", "status", "action_taken", "scheduled_for", "sent_at", "attempts")
    list_filter = ("channel", "status", "action_taken")


@admin.register(IncomingMessage)
class IncomingMessageAdmin(admin.ModelAdmin):
    list_display = ("phone_from", "parsed_action", "received_at", "matched_notification")
    list_filter = ("parsed_action",)

----- END FILE: apps/notifications/admin.py -----

----- BEGIN FILE: apps/notifications/apps.py -----
from django.apps import AppConfig


class NotificationsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'notifications'

----- END FILE: apps/notifications/apps.py -----

----- BEGIN FILE: apps/notifications/management/commands/process_notification_queue.py -----
from django.core.management.base import BaseCommand
from django.core.mail import send_mail
from django.utils import timezone

from accounts.models import UserProfile
from notifications.models import NotificationQueue
from notifications.services.whatsapp_service import normalize_phone, send_whatsapp_message_raw
from utils.constants import (
    CHANNEL_EMAIL,
    CHANNEL_IN_APP,
    CHANNEL_SMS,
    CHANNEL_WHATSAPP,
    NOTIF_FAILED,
    NOTIF_PENDING,
    NOTIF_SENT,
)


class Command(BaseCommand):
    help = "Processa a fila de notificacoes pendentes."

    def handle(self, *args, **options):
        now = timezone.now()
        pending = NotificationQueue.objects.filter(status=NOTIF_PENDING, scheduled_for__lte=now)
        for notification in pending:
            try:
                # Bloco: Contagem de tentativas
                notification.attempts += 1

                if notification.channel == CHANNEL_EMAIL:
                    # Bloco: Envio de email
                    send_mail(notification.title, notification.message, None, [notification.user.email])
                elif notification.channel == CHANNEL_WHATSAPP:
                    # Bloco: Envio de WhatsApp
                    phone = notification.to_phone
                    if not phone:
                        try:
                            phone = notification.user.profile.phone
                        except UserProfile.DoesNotExist:
                            phone = notification.user.phone_number
                    phone = normalize_phone(phone)
                    if not phone:
                        raise RuntimeError("Telefone WhatsApp nao informado.")

                    body = f"{notification.message} [#N{notification.id}]\\nResponda 1 confirmar, 2 adiar 10min, 3 cancelar"
                    response = send_whatsapp_message_raw(phone, body)
                    provider_id = ""
                    if isinstance(response, dict):
                        provider_id = response.get("messages", [{}])[0].get("id", "")
                    if response is None:
                        raise RuntimeError("Falha no envio do WhatsApp.")
                    notification.provider = "META"
                    notification.provider_message_id = provider_id or ""
                    notification.to_phone = phone
                elif notification.channel == CHANNEL_SMS:
                    # Bloco: SMS mock (fallback)
                    notification.provider = "MOCK"
                elif notification.channel == CHANNEL_IN_APP:
                    # Bloco: In-app (sem envio externo)
                    notification.provider = "IN_APP"

                notification.status = NOTIF_SENT
                notification.sent_at = timezone.now()
                notification.last_error = ""
                notification.save()
                self.stdout.write(self.style.SUCCESS(f"Enviado: {notification.id}"))
            except Exception as exc:
                notification.status = NOTIF_FAILED
                notification.last_error = str(exc)
                notification.save()
                self.stdout.write(self.style.ERROR(f"Falhou: {notification.id}"))

----- END FILE: apps/notifications/management/commands/process_notification_queue.py -----

----- BEGIN FILE: apps/notifications/migrations/0001_initial.py -----
# Generated by Django 4.2.11 on 2026-01-28 13:35

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='NotificationQueue',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('channel', models.CharField(choices=[('EMAIL', 'Email'), ('WHATSAPP', 'WhatsApp'), ('SMS', 'SMS')], max_length=20)),
                ('title', models.CharField(max_length=200)),
                ('message', models.TextField()),
                ('scheduled_for', models.DateTimeField()),
                ('status', models.CharField(choices=[('PENDING', 'Pending'), ('SENT', 'Sent'), ('FAILED', 'Failed')], default='PENDING', max_length=20)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='notifications', to=settings.AUTH_USER_MODEL)),
            ],
        ),
    ]

----- END FILE: apps/notifications/migrations/0001_initial.py -----

----- BEGIN FILE: apps/notifications/migrations/0002_notificationqueue_action_taken_and_more.py -----
# Generated by Django 6.0.1 on 2026-02-02 14:09

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('notifications', '0001_initial'),
    ]

    operations = [
        migrations.AddField(
            model_name='notificationqueue',
            name='action_taken',
            field=models.CharField(choices=[('NONE', 'None'), ('CONFIRMED', 'Confirmed'), ('DELAYED', 'Delayed'), ('CANCELED', 'Canceled')], default='NONE', max_length=20),
        ),
        migrations.AddField(
            model_name='notificationqueue',
            name='attempts',
            field=models.PositiveIntegerField(default=0),
        ),
        migrations.AddField(
            model_name='notificationqueue',
            name='last_error',
            field=models.TextField(blank=True),
        ),
        migrations.AddField(
            model_name='notificationqueue',
            name='provider',
            field=models.CharField(blank=True, max_length=50),
        ),
        migrations.AddField(
            model_name='notificationqueue',
            name='provider_message_id',
            field=models.CharField(blank=True, max_length=200),
        ),
        migrations.AddField(
            model_name='notificationqueue',
            name='sent_at',
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='notificationqueue',
            name='to_phone',
            field=models.CharField(blank=True, max_length=30),
        ),
        migrations.AlterField(
            model_name='notificationqueue',
            name='channel',
            field=models.CharField(choices=[('IN_APP', 'In app'), ('EMAIL', 'Email'), ('WHATSAPP', 'WhatsApp'), ('SMS', 'SMS')], max_length=20),
        ),
        migrations.CreateModel(
            name='IncomingMessage',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('phone_from', models.CharField(max_length=30)),
                ('text', models.TextField()),
                ('received_at', models.DateTimeField(auto_now_add=True)),
                ('raw_payload', models.JSONField()),
                ('parsed_action', models.CharField(choices=[('NONE', 'None'), ('CONFIRMED', 'Confirmed'), ('DELAYED', 'Delayed'), ('CANCELED', 'Canceled')], default='NONE', max_length=20)),
                ('matched_notification', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='incoming_messages', to='notifications.notificationqueue')),
            ],
        ),
    ]

----- END FILE: apps/notifications/migrations/0002_notificationqueue_action_taken_and_more.py -----

----- BEGIN FILE: apps/notifications/models.py -----
from django.conf import settings
from django.db import models

from utils.constants import (
    CHANNEL_CHOICES,
    NOTIFICATION_ACTION_CHOICES,
    NOTIFICATION_STATUS_CHOICES,
    ACTION_NONE,
    NOTIF_PENDING,
)


# Bloco: Fila de notificacoes
class NotificationQueue(models.Model):
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name="notifications")
    channel = models.CharField(max_length=20, choices=CHANNEL_CHOICES)
    title = models.CharField(max_length=200)
    message = models.TextField()
    scheduled_for = models.DateTimeField()
    status = models.CharField(max_length=20, choices=NOTIFICATION_STATUS_CHOICES, default=NOTIF_PENDING)
    action_taken = models.CharField(max_length=20, choices=NOTIFICATION_ACTION_CHOICES, default=ACTION_NONE)
    provider = models.CharField(max_length=50, blank=True)
    provider_message_id = models.CharField(max_length=200, blank=True)
    last_error = models.TextField(blank=True)
    attempts = models.PositiveIntegerField(default=0)
    to_phone = models.CharField(max_length=30, blank=True)
    sent_at = models.DateTimeField(null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return f"{self.user.email} - {self.channel}"


# Bloco: Mensagens recebidas do WhatsApp
class IncomingMessage(models.Model):
    phone_from = models.CharField(max_length=30)
    text = models.TextField()
    received_at = models.DateTimeField(auto_now_add=True)
    raw_payload = models.JSONField()
    parsed_action = models.CharField(max_length=20, choices=NOTIFICATION_ACTION_CHOICES, default=ACTION_NONE)
    matched_notification = models.ForeignKey(
        NotificationQueue, on_delete=models.SET_NULL, null=True, blank=True, related_name="incoming_messages"
    )

    def __str__(self):
        return f"{self.phone_from} - {self.received_at:%Y-%m-%d %H:%M}"

----- END FILE: apps/notifications/models.py -----

----- BEGIN FILE: apps/notifications/serializers.py -----
from rest_framework import serializers

from notifications.models import NotificationQueue


class NotificationQueueSerializer(serializers.ModelSerializer):
    class Meta:
        model = NotificationQueue
        fields = (
            "id",
            "channel",
            "title",
            "message",
            "scheduled_for",
            "status",
            "created_at",
        )
        read_only_fields = ("id", "created_at")

----- END FILE: apps/notifications/serializers.py -----

----- BEGIN FILE: apps/notifications/services/reminder_queue.py -----
from datetime import datetime, time, timedelta

from django.utils import timezone

from accounts.models import UserProfile
from agenda.models import CalendarEvent, ReminderRule
from notifications.models import NotificationQueue
from planner.models import Task
from utils.constants import (
    CHANNEL_EMAIL,
    CHANNEL_SMS,
    CHANNEL_WHATSAPP,
    NOTIF_PENDING,
    REMINDER_TARGET_EVENT,
    REMINDER_TARGET_TASK,
)


# Bloco: Preferencias do usuario
def _get_user_preferences(user):
    try:
        profile = user.profile
    except UserProfile.DoesNotExist:
        profile = None

    return {
        "allow_email": getattr(profile, "allow_email", True),
        "allow_whatsapp": getattr(profile, "allow_whatsapp", True),
        "allow_sms": getattr(profile, "allow_sms", False),
        "phone": getattr(profile, "phone", "") or getattr(user, "phone_number", ""),
    }


# Bloco: Filtro de canais permitidos
def _filter_channels(channels, prefs):
    allowed = []
    for channel in channels:
        if channel == CHANNEL_EMAIL and prefs["allow_email"]:
            allowed.append(channel)
        if channel == CHANNEL_WHATSAPP and prefs["allow_whatsapp"]:
            allowed.append(channel)
        if channel == CHANNEL_SMS and prefs["allow_sms"]:
            allowed.append(channel)
    return allowed


# Bloco: Criacao de notificacao
def _queue_notification(user, channel, title, message, scheduled_for, phone=""):
    exists = NotificationQueue.objects.filter(
        user=user,
        channel=channel,
        title=title,
        scheduled_for=scheduled_for,
    ).exists()
    if exists:
        return False

    NotificationQueue.objects.create(
        user=user,
        channel=channel,
        title=title,
        message=message,
        scheduled_for=scheduled_for,
        status=NOTIF_PENDING,
        to_phone=phone or "",
    )
    return True


# Bloco: Lembretes para evento
def create_notifications_for_event(user, event: CalendarEvent) -> int:
    now = timezone.now()
    created = 0
    prefs = _get_user_preferences(user)
    rules = ReminderRule.objects.filter(user=user, is_active=True, target_type=REMINDER_TARGET_EVENT)
    for rule in rules:
        channels = rule.channels or [CHANNEL_EMAIL]
        allowed_channels = _filter_channels(channels, prefs)
        scheduled_for = event.start_at - timedelta(minutes=rule.remind_before_minutes)
        if scheduled_for < now:
            scheduled_for = now
        for channel in allowed_channels:
            title = f"Lembrete: {event.title}"
            message = f"Evento {event.title} em {event.start_at}."
            phone = prefs["phone"] if channel in {CHANNEL_WHATSAPP, CHANNEL_SMS} else ""
            if _queue_notification(user, channel, title, message, scheduled_for, phone):
                created += 1
    return created


# Bloco: Lembretes para tarefa
def create_notifications_for_task(user, task: Task) -> int:
    now = timezone.now()
    created = 0
    prefs = _get_user_preferences(user)
    rules = ReminderRule.objects.filter(user=user, is_active=True, target_type=REMINDER_TARGET_TASK)
    for rule in rules:
        channels = rule.channels or [CHANNEL_EMAIL]
        allowed_channels = _filter_channels(channels, prefs)
        due_datetime = datetime.combine(task.due_date, time(9, 0), tzinfo=timezone.get_current_timezone())
        scheduled_for = due_datetime - timedelta(minutes=rule.remind_before_minutes)
        if scheduled_for < now:
            scheduled_for = now
        for channel in allowed_channels:
            title = f"Lembrete: {task.title}"
            message = f"Tarefa {task.title} vence em {task.due_date}."
            phone = prefs["phone"] if channel in {CHANNEL_WHATSAPP, CHANNEL_SMS} else ""
            if _queue_notification(user, channel, title, message, scheduled_for, phone):
                created += 1
    return created


# Bloco: Lembretes para usuario (geracao completa)
def create_notifications_for_user(user) -> int:
    created = 0
    now = timezone.now()
    events = CalendarEvent.objects.filter(user=user, start_at__gte=now)
    for event in events:
        created += create_notifications_for_event(user, event)

    tasks = Task.objects.filter(user=user, due_date__gte=timezone.localdate())
    for task in tasks:
        created += create_notifications_for_task(user, task)

    return created

----- END FILE: apps/notifications/services/reminder_queue.py -----

----- BEGIN FILE: apps/notifications/services/whatsapp_cloud.py -----
import json
import re
import urllib.request
from typing import Dict

from django.conf import settings


# Bloco: Normalizacao de telefone
def normalize_phone(raw_phone: str) -> str:
    if not raw_phone:
        return ""
    digits = re.sub(r"\D", "", raw_phone)
    if digits.startswith("55"):
        return digits
    return f"55{digits}"


# Bloco: Envio de mensagem via WhatsApp Cloud API
def send_whatsapp_text(to_phone: str, body: str) -> Dict:
    token = getattr(settings, "WHATSAPP_CLOUD_TOKEN", "")
    phone_number_id = getattr(settings, "WHATSAPP_PHONE_NUMBER_ID", "")
    if not token or not phone_number_id:
        raise RuntimeError("Credenciais do WhatsApp Cloud nao configuradas.")

    normalized = normalize_phone(to_phone)
    if not normalized:
        raise RuntimeError("Telefone invalido para envio de WhatsApp.")

    url = f"https://graph.facebook.com/v19.0/{phone_number_id}/messages"
    payload = {
        "messaging_product": "whatsapp",
        "to": normalized,
        "type": "text",
        "text": {"body": body},
    }
    data = json.dumps(payload).encode("utf-8")
    request = urllib.request.Request(
        url,
        data=data,
        headers={
            "Authorization": f"Bearer {token}",
            "Content-Type": "application/json",
        },
        method="POST",
    )
    try:
        with urllib.request.urlopen(request, timeout=10) as response:
            raw = response.read().decode("utf-8")
            return json.loads(raw)
    except Exception as exc:  # pragma: no cover
        raise RuntimeError(f"Erro ao enviar WhatsApp: {exc}") from exc

----- END FILE: apps/notifications/services/whatsapp_cloud.py -----

----- BEGIN FILE: apps/notifications/services/whatsapp_service.py -----
import logging
import re
from typing import Dict, Optional

import requests
from django.conf import settings

logger = logging.getLogger(__name__)


# Bloco: Normalizacao de telefone
def normalize_phone(raw_phone: str) -> str:
    if not raw_phone:
        return ""
    digits = re.sub(r"\D", "", raw_phone)
    if digits.startswith("55"):
        return digits
    return f"55{digits}"


# Bloco: Envio de mensagem WhatsApp (retorna resposta)
def send_whatsapp_message_raw(phone_number: str, message: str) -> Optional[Dict]:
    token = getattr(settings, "WHATSAPP_CLOUD_TOKEN", "")
    phone_number_id = getattr(settings, "WHATSAPP_PHONE_NUMBER_ID", "")
    if not token or not phone_number_id:
        logger.error("Credenciais do WhatsApp Cloud nao configuradas.")
        return None

    normalized = normalize_phone(phone_number)
    if not normalized:
        logger.error("Telefone invalido para envio de WhatsApp.")
        return None

    url = f"https://graph.facebook.com/v22.0/{phone_number_id}/messages"
    payload = {
        "messaging_product": "whatsapp",
        "to": normalized,
        "type": "text",
        "text": {"body": message},
    }
    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json",
    }

    try:
        response = requests.post(url, json=payload, headers=headers, timeout=10)
        if response.status_code >= 400:
            logger.error("Erro WhatsApp Cloud %s: %s", response.status_code, response.text)
            return None
        return response.json()
    except requests.RequestException as exc:
        logger.exception("Erro ao enviar WhatsApp: %s", exc)
        return None


# Bloco: Envio de mensagem WhatsApp (retorna sucesso)
def send_whatsapp_message(phone_number: str, message: str) -> bool:
    return send_whatsapp_message_raw(phone_number, message) is not None

----- END FILE: apps/notifications/services/whatsapp_service.py -----

----- BEGIN FILE: apps/notifications/urls.py -----
from django.urls import path

from . import views

urlpatterns = [
    path("test-email/", views.TestEmailView.as_view(), name="notifications-test-email"),
    path("pending/", views.PendingNotificationsView.as_view(), name="notifications-pending"),
    path("whatsapp/webhook/", views.whatsapp_webhook_view, name="notifications-whatsapp-webhook"),
]

----- END FILE: apps/notifications/urls.py -----

----- BEGIN FILE: apps/notifications/views.py -----
import json
import re
from datetime import timedelta

from django.conf import settings
from django.core.mail import send_mail
from django.http import HttpResponse, HttpResponseForbidden, JsonResponse
from django.utils import timezone
from django.views.decorators.csrf import csrf_exempt
from rest_framework import permissions, status
from rest_framework.response import Response
from rest_framework.views import APIView

from notifications.models import IncomingMessage, NotificationQueue
from notifications.serializers import NotificationQueueSerializer
from notifications.services.whatsapp_service import send_whatsapp_message_raw
from utils.constants import (
    ACTION_CANCELED,
    ACTION_CONFIRMED,
    ACTION_DELAYED,
    ACTION_NONE,
    CHANNEL_EMAIL,
    CHANNEL_WHATSAPP,
    NOTIF_PENDING,
    NOTIF_SENT,
)
from utils.features import has_feature
from utils.constants import FEATURE_EMAIL_NOTIFICATIONS


class TestEmailView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def post(self, request):
        if not has_feature(request.user, FEATURE_EMAIL_NOTIFICATIONS):
            return Response({"detail": "Plano atual nao permite email."}, status=status.HTTP_403_FORBIDDEN)
        subject = "Campus Calm - Teste de Email"
        message = "Este e um email de teste do Campus Calm."
        send_mail(subject, message, None, [request.user.email])
        return Response({"detail": "Email enviado para console."})


class PendingNotificationsView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request):
        now = timezone.now()
        pending = NotificationQueue.objects.filter(
            user=request.user, status=NOTIF_PENDING, scheduled_for__lte=now
        ).order_by("scheduled_for")
        return Response(NotificationQueueSerializer(pending, many=True).data)


# Bloco: Webhook WhatsApp Cloud
@csrf_exempt
def whatsapp_webhook_view(request):
    if request.method == "GET":
        verify_token = request.GET.get("hub.verify_token", "")
        challenge = request.GET.get("hub.challenge", "")
        if verify_token and verify_token == getattr(settings, "WHATSAPP_VERIFY_TOKEN", ""):
            return HttpResponse(challenge, status=200)
        return HttpResponseForbidden("Token invalido.")

    if request.method != "POST":
        return JsonResponse({"detail": "Metodo nao permitido."}, status=405)

    try:
        payload = json.loads(request.body.decode("utf-8") or "{}")
    except json.JSONDecodeError:
        payload = {}

    phone_from, text_body = _extract_whatsapp_message(payload)
    parsed_action = _parse_action(text_body)
    matched_notification = _match_notification(phone_from, text_body)

    incoming = IncomingMessage.objects.create(
        phone_from=phone_from or "",
        text=text_body or "",
        raw_payload=payload,
        parsed_action=parsed_action,
        matched_notification=matched_notification,
    )

    if matched_notification and parsed_action != ACTION_NONE:
        _apply_action(matched_notification, parsed_action)

    return JsonResponse({"detail": "ok", "incoming_id": incoming.id})


# Bloco: Extracao de mensagem do payload
def _extract_whatsapp_message(payload):
    try:
        entry = payload.get("entry", [])[0]
        change = entry.get("changes", [])[0]
        value = change.get("value", {})
        message = value.get("messages", [])[0]
        phone_from = message.get("from", "")
        text_body = message.get("text", {}).get("body", "")
        return phone_from, text_body
    except (IndexError, AttributeError):
        return "", ""


# Bloco: Interpretacao da acao
def _parse_action(text_body: str):
    if not text_body:
        return ACTION_NONE
    text = text_body.strip()
    if text.startswith("1"):
        return ACTION_CONFIRMED
    if text.startswith("2"):
        return ACTION_DELAYED
    if text.startswith("3"):
        return ACTION_CANCELED
    return ACTION_NONE


# Bloco: Matching da notificacao
def _match_notification(phone_from: str, text_body: str):
    if not phone_from and not text_body:
        return None

    match = re.search(r"N(\\d+)", text_body.upper())
    if match:
        notification_id = int(match.group(1))
        notification = NotificationQueue.objects.filter(id=notification_id).first()
        if notification and (not notification.to_phone or notification.to_phone == phone_from):
            return notification
        return None

    if phone_from:
        since = timezone.now() - timedelta(hours=24)
        return (
            NotificationQueue.objects.filter(
                channel=CHANNEL_WHATSAPP,
                to_phone=phone_from,
                status=NOTIF_SENT,
                action_taken=ACTION_NONE,
                created_at__gte=since,
            )
            .order_by("-created_at")
            .first()
        )

    return None


# Bloco: Aplicacao da acao e resposta
def _apply_action(notification: NotificationQueue, action: str):
    notification.action_taken = action
    notification.save(update_fields=["action_taken"])

    if action == ACTION_CONFIRMED:
        _reply_whatsapp(notification.to_phone, "Confirmado ")
        return

    if action == ACTION_DELAYED:
        delayed_for = timezone.now() + timedelta(minutes=10)
        NotificationQueue.objects.create(
            user=notification.user,
            channel=notification.channel,
            title=notification.title,
            message=notification.message,
            scheduled_for=delayed_for,
            status=NOTIF_PENDING,
            to_phone=notification.to_phone,
        )
        _reply_whatsapp(notification.to_phone, "Adiado por 10 minutos ")
        return

    if action == ACTION_CANCELED:
        _reply_whatsapp(notification.to_phone, "Cancelado ")


# Bloco: Envio de resposta via WhatsApp
def _reply_whatsapp(phone: str, body: str):
    if not phone:
        return
    try:
        send_whatsapp_message_raw(phone, body)
    except Exception:
        return

----- END FILE: apps/notifications/views.py -----

----- BEGIN FILE: apps/onboarding/admin.py -----
from django.contrib import admin

from onboarding.models import UserSetupProgress


@admin.register(UserSetupProgress)
class UserSetupProgressAdmin(admin.ModelAdmin):
    list_display = ("user", "has_profile", "has_active_semester", "has_at_least_one_course", "has_at_least_one_assessment", "has_reminder_rule")

----- END FILE: apps/onboarding/admin.py -----

----- BEGIN FILE: apps/onboarding/apps.py -----
from django.apps import AppConfig


class OnboardingConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'onboarding'

    def ready(self):
        from onboarding import signals  # noqa: F401

----- END FILE: apps/onboarding/apps.py -----

----- BEGIN FILE: apps/onboarding/migrations/0001_initial.py -----
# Generated by Django 4.2.11 on 2026-01-28 13:35

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='UserSetupProgress',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('has_profile', models.BooleanField(default=False)),
                ('has_active_semester', models.BooleanField(default=False)),
                ('has_at_least_one_course', models.BooleanField(default=False)),
                ('has_at_least_one_assessment', models.BooleanField(default=False)),
                ('has_reminder_rule', models.BooleanField(default=False)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('user', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='setup_progress', to=settings.AUTH_USER_MODEL)),
            ],
        ),
    ]

----- END FILE: apps/onboarding/migrations/0001_initial.py -----

----- BEGIN FILE: apps/onboarding/models.py -----
from django.conf import settings
from django.db import models


class UserSetupProgress(models.Model):
    user = models.OneToOneField(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name="setup_progress")
    has_profile = models.BooleanField(default=False)
    has_active_semester = models.BooleanField(default=False)
    has_at_least_one_course = models.BooleanField(default=False)
    has_at_least_one_assessment = models.BooleanField(default=False)
    has_reminder_rule = models.BooleanField(default=False)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return self.user.email

----- END FILE: apps/onboarding/models.py -----

----- BEGIN FILE: apps/onboarding/services.py -----
from semester.models import Assessment, Course, Semester
from agenda.models import ReminderRule
from onboarding.models import UserSetupProgress
from utils.constants import SEMESTER_ACTIVE


def refresh_user_progress(user):
    progress, _ = UserSetupProgress.objects.get_or_create(user=user)
    progress.has_profile = bool(user.name)
    progress.has_active_semester = Semester.objects.filter(user=user, status=SEMESTER_ACTIVE).exists()
    progress.has_at_least_one_course = Course.objects.filter(semester__user=user).exists()
    progress.has_at_least_one_assessment = Assessment.objects.filter(course__semester__user=user).exists()
    progress.has_reminder_rule = ReminderRule.objects.filter(user=user, is_active=True).exists()
    progress.save()
    return progress

----- END FILE: apps/onboarding/services.py -----

----- BEGIN FILE: apps/onboarding/signals.py -----
from django.db.models.signals import post_delete, post_save
from django.dispatch import receiver

from accounts.models import User
from agenda.models import ReminderRule
from onboarding.services import refresh_user_progress
from semester.models import Assessment, Course, Semester


@receiver(post_save, sender=User)
def user_saved(sender, instance, **kwargs):
    refresh_user_progress(instance)


@receiver(post_save, sender=Semester)
@receiver(post_delete, sender=Semester)
def semester_changed(sender, instance, **kwargs):
    refresh_user_progress(instance.user)


@receiver(post_save, sender=Course)
@receiver(post_delete, sender=Course)
def course_changed(sender, instance, **kwargs):
    refresh_user_progress(instance.semester.user)


@receiver(post_save, sender=Assessment)
@receiver(post_delete, sender=Assessment)
def assessment_changed(sender, instance, **kwargs):
    refresh_user_progress(instance.course.semester.user)


@receiver(post_save, sender=ReminderRule)
@receiver(post_delete, sender=ReminderRule)
def reminder_changed(sender, instance, **kwargs):
    refresh_user_progress(instance.user)

----- END FILE: apps/onboarding/signals.py -----

----- BEGIN FILE: apps/onboarding/urls.py -----
from django.urls import path

from onboarding.views import OnboardingStatusView

urlpatterns = [
    path("status/", OnboardingStatusView.as_view(), name="onboarding-status"),
]

----- END FILE: apps/onboarding/urls.py -----

----- BEGIN FILE: apps/onboarding/views.py -----
from rest_framework import permissions
from rest_framework.response import Response
from rest_framework.views import APIView

from onboarding.services import refresh_user_progress
from utils.gating import compute_status


class OnboardingStatusView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request):
        progress = refresh_user_progress(request.user)
        current_step, missing_steps, required_actions = compute_status(progress)
        return Response(
            {
                "current_step": current_step,
                "missing_steps": missing_steps,
                "required_actions": required_actions,
            }
        )

----- END FILE: apps/onboarding/views.py -----

----- BEGIN FILE: apps/planner/admin.py -----
from django.contrib import admin

from planner.models import Task


@admin.register(Task)
class TaskAdmin(admin.ModelAdmin):
    list_display = ("title", "user", "due_date", "status")
    list_filter = ("status",)
    search_fields = ("title", "user__email")

----- END FILE: apps/planner/admin.py -----

----- BEGIN FILE: apps/planner/apps.py -----
from django.apps import AppConfig


class PlannerConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'planner'

----- END FILE: apps/planner/apps.py -----

----- BEGIN FILE: apps/planner/migrations/0001_initial.py -----
# Generated by Django 4.2.11 on 2026-01-28 13:35

from django.conf import settings
import django.core.validators
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='Task',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('title', models.CharField(max_length=200)),
                ('description', models.TextField(blank=True)),
                ('due_date', models.DateField()),
                ('stress_level', models.PositiveSmallIntegerField(validators=[django.core.validators.MinValueValidator(1), django.core.validators.MaxValueValidator(5)])),
                ('status', models.CharField(choices=[('TODO', 'Todo'), ('DOING', 'Doing'), ('DONE', 'Done')], default='TODO', max_length=10)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='tasks', to=settings.AUTH_USER_MODEL)),
            ],
        ),
    ]

----- END FILE: apps/planner/migrations/0001_initial.py -----

----- BEGIN FILE: apps/planner/models.py -----
from django.conf import settings
from django.core.validators import MaxValueValidator, MinValueValidator
from django.db import models

from utils.constants import TASK_STATUS_CHOICES, TASK_TODO


class Task(models.Model):
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name="tasks")
    title = models.CharField(max_length=200)
    description = models.TextField(blank=True)
    due_date = models.DateField()
    stress_level = models.PositiveSmallIntegerField(validators=[MinValueValidator(1), MaxValueValidator(5)])
    status = models.CharField(max_length=10, choices=TASK_STATUS_CHOICES, default=TASK_TODO)
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return self.title

----- END FILE: apps/planner/models.py -----

----- BEGIN FILE: apps/planner/serializers.py -----
from rest_framework import serializers

from planner.models import Task


class TaskSerializer(serializers.ModelSerializer):
    class Meta:
        model = Task
        fields = (
            "id",
            "title",
            "description",
            "due_date",
            "stress_level",
            "status",
            "created_at",
        )
        read_only_fields = ("id", "created_at")

----- END FILE: apps/planner/serializers.py -----

----- BEGIN FILE: apps/planner/urls.py -----
from rest_framework.routers import DefaultRouter

from planner.views import TaskViewSet

router = DefaultRouter()
router.register(r"tasks", TaskViewSet, basename="tasks")

urlpatterns = router.urls

----- END FILE: apps/planner/urls.py -----

----- BEGIN FILE: apps/planner/views.py -----
from rest_framework import permissions, viewsets

from planner.models import Task
from planner.serializers import TaskSerializer
from utils.constants import FEATURE_PLANNER_BASIC
from utils.features import require_feature


class TaskViewSet(viewsets.ModelViewSet):
    serializer_class = TaskSerializer
    permission_classes = [permissions.IsAuthenticated]

    def initial(self, request, *args, **kwargs):
        require_feature(request.user, FEATURE_PLANNER_BASIC)
        return super().initial(request, *args, **kwargs)

    def get_queryset(self):
        return Task.objects.filter(user=self.request.user).order_by("-created_at")

    def perform_create(self, serializer):
        serializer.save(user=self.request.user)

----- END FILE: apps/planner/views.py -----

----- BEGIN FILE: apps/pomodoro/admin.py -----
from django.contrib import admin

from pomodoro.models import PomodoroSession


@admin.register(PomodoroSession)
class PomodoroSessionAdmin(admin.ModelAdmin):
    list_display = ("user", "status", "started_at", "ended_at")
    list_filter = ("status",)

----- END FILE: apps/pomodoro/admin.py -----

----- BEGIN FILE: apps/pomodoro/apps.py -----
from django.apps import AppConfig


class PomodoroConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'pomodoro'

----- END FILE: apps/pomodoro/apps.py -----

----- BEGIN FILE: apps/pomodoro/migrations/0001_initial.py -----
# Generated by Django 4.2.11 on 2026-01-28 13:35

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion
import django.utils.timezone


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='PomodoroSession',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('focus_minutes', models.PositiveIntegerField(default=25)),
                ('break_minutes', models.PositiveIntegerField(default=5)),
                ('started_at', models.DateTimeField(default=django.utils.timezone.now)),
                ('ended_at', models.DateTimeField(blank=True, null=True)),
                ('status', models.CharField(choices=[('COMPLETED', 'Completed'), ('STOPPED', 'Stopped')], default='STOPPED', max_length=20)),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='pomodoro_sessions', to=settings.AUTH_USER_MODEL)),
            ],
        ),
    ]

----- END FILE: apps/pomodoro/migrations/0001_initial.py -----

----- BEGIN FILE: apps/pomodoro/models.py -----
from django.conf import settings
from django.db import models
from django.utils import timezone

from utils.constants import POMODORO_STATUS_CHOICES, POMODORO_STOPPED


class PomodoroSession(models.Model):
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name="pomodoro_sessions")
    focus_minutes = models.PositiveIntegerField(default=25)
    break_minutes = models.PositiveIntegerField(default=5)
    started_at = models.DateTimeField(default=timezone.now)
    ended_at = models.DateTimeField(null=True, blank=True)
    status = models.CharField(max_length=20, choices=POMODORO_STATUS_CHOICES, default=POMODORO_STOPPED)

    def __str__(self):
        return f"{self.user.email} - {self.status}"

----- END FILE: apps/pomodoro/models.py -----

----- BEGIN FILE: apps/pomodoro/serializers.py -----
from rest_framework import serializers

from pomodoro.models import PomodoroSession


class PomodoroSessionSerializer(serializers.ModelSerializer):
    class Meta:
        model = PomodoroSession
        fields = (
            "id",
            "focus_minutes",
            "break_minutes",
            "started_at",
            "ended_at",
            "status",
        )
        read_only_fields = ("id", "started_at", "ended_at", "status")

----- END FILE: apps/pomodoro/serializers.py -----

----- BEGIN FILE: apps/pomodoro/urls.py -----
from django.urls import path

from pomodoro.views import PomodoroStartView, PomodoroStopView, PomodoroWeeklySummaryView

urlpatterns = [
    path("start/", PomodoroStartView.as_view(), name="pomodoro-start"),
    path("stop/<int:pk>/", PomodoroStopView.as_view(), name="pomodoro-stop"),
    path("summary/weekly/", PomodoroWeeklySummaryView.as_view(), name="pomodoro-summary-weekly"),
]

----- END FILE: apps/pomodoro/urls.py -----

----- BEGIN FILE: apps/pomodoro/views.py -----
from datetime import timedelta

from django.utils import timezone
from rest_framework import permissions, status
from rest_framework.response import Response
from rest_framework.views import APIView

from pomodoro.models import PomodoroSession
from pomodoro.serializers import PomodoroSessionSerializer
from utils.constants import FEATURE_POMODORO_BASIC, POMODORO_COMPLETED, POMODORO_STOPPED
from utils.features import require_feature


class PomodoroStartView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def post(self, request):
        require_feature(request.user, FEATURE_POMODORO_BASIC)
        focus_minutes = int(request.data.get("focus_minutes", 25))
        break_minutes = int(request.data.get("break_minutes", 5))
        session = PomodoroSession.objects.create(
            user=request.user,
            focus_minutes=focus_minutes,
            break_minutes=break_minutes,
        )
        return Response(PomodoroSessionSerializer(session).data, status=status.HTTP_201_CREATED)


class PomodoroStopView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def post(self, request, pk):
        require_feature(request.user, FEATURE_POMODORO_BASIC)
        session = PomodoroSession.objects.get(pk=pk, user=request.user)
        completed_value = request.data.get("completed", False)
        completed = str(completed_value).lower() in {"1", "true", "yes", "on"}
        session.ended_at = timezone.now()
        session.status = POMODORO_COMPLETED if completed else POMODORO_STOPPED
        session.save()
        return Response(PomodoroSessionSerializer(session).data)


class PomodoroWeeklySummaryView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request):
        require_feature(request.user, FEATURE_POMODORO_BASIC)
        week_ago = timezone.now() - timedelta(days=7)
        sessions = PomodoroSession.objects.filter(user=request.user, started_at__gte=week_ago)
        total_sessions = sessions.count()
        total_focus_minutes = sum(session.focus_minutes for session in sessions)
        return Response(
            {
                "total_sessions": total_sessions,
                "total_focus_minutes": total_focus_minutes,
            }
        )

----- END FILE: apps/pomodoro/views.py -----

----- BEGIN FILE: apps/semester/admin.py -----
from django.contrib import admin

from semester.models import Assessment, Course, Semester, SemesterCheckin


@admin.register(Semester)
class SemesterAdmin(admin.ModelAdmin):
    list_display = ("name", "user", "status", "start_date", "end_date")
    list_filter = ("status",)


@admin.register(Course)
class CourseAdmin(admin.ModelAdmin):
    list_display = ("title", "semester", "status", "passing_grade", "final_grade")
    list_filter = ("status",)


@admin.register(Assessment)
class AssessmentAdmin(admin.ModelAdmin):
    list_display = ("title", "course", "score", "max_score", "weight")


@admin.register(SemesterCheckin)
class SemesterCheckinAdmin(admin.ModelAdmin):
    list_display = ("semester", "overall_stress", "created_at")

----- END FILE: apps/semester/admin.py -----

----- BEGIN FILE: apps/semester/apps.py -----
from django.apps import AppConfig


class SemesterConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'semester'

----- END FILE: apps/semester/apps.py -----

----- BEGIN FILE: apps/semester/migrations/0001_initial.py -----
# Generated by Django 4.2.11 on 2026-01-28 13:35

from decimal import Decimal
from django.conf import settings
import django.core.validators
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='Semester',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=50)),
                ('start_date', models.DateField()),
                ('end_date', models.DateField()),
                ('status', models.CharField(choices=[('ACTIVE', 'Active'), ('FINISHED', 'Finished')], default='ACTIVE', max_length=20)),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='semesters', to=settings.AUTH_USER_MODEL)),
            ],
        ),
        migrations.CreateModel(
            name='SemesterCheckin',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('overall_stress', models.PositiveSmallIntegerField(validators=[django.core.validators.MinValueValidator(1), django.core.validators.MaxValueValidator(5)])),
                ('comment', models.TextField(blank=True)),
                ('semester', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='checkins', to='semester.semester')),
            ],
        ),
        migrations.CreateModel(
            name='Course',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('title', models.CharField(max_length=200)),
                ('teacher', models.CharField(blank=True, max_length=200)),
                ('credits', models.PositiveIntegerField(blank=True, null=True)),
                ('passing_grade', models.DecimalField(decimal_places=2, default=Decimal('7.0'), max_digits=4)),
                ('status', models.CharField(choices=[('IN_PROGRESS', 'In progress'), ('PASSED', 'Passed'), ('FAILED', 'Failed')], default='IN_PROGRESS', max_length=20)),
                ('final_grade', models.DecimalField(blank=True, decimal_places=2, max_digits=5, null=True)),
                ('notes', models.TextField(blank=True)),
                ('semester', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='courses', to='semester.semester')),
            ],
        ),
        migrations.CreateModel(
            name='Assessment',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('title', models.CharField(max_length=200)),
                ('score', models.DecimalField(decimal_places=2, max_digits=5, validators=[django.core.validators.MinValueValidator(0)])),
                ('max_score', models.DecimalField(decimal_places=2, default=Decimal('10.0'), max_digits=5)),
                ('weight', models.DecimalField(decimal_places=2, default=Decimal('1.0'), max_digits=5, validators=[django.core.validators.MinValueValidator(0)])),
                ('date', models.DateField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('course', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='assessments', to='semester.course')),
            ],
        ),
    ]

----- END FILE: apps/semester/migrations/0001_initial.py -----

----- BEGIN FILE: apps/semester/models.py -----
from decimal import Decimal

from django.conf import settings
from django.core.validators import MaxValueValidator, MinValueValidator
from django.db import models

from utils.constants import COURSE_STATUS_CHOICES, COURSE_IN_PROGRESS, SEMESTER_STATUS_CHOICES, SEMESTER_ACTIVE


class Semester(models.Model):
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name="semesters")
    name = models.CharField(max_length=50)
    start_date = models.DateField()
    end_date = models.DateField()
    status = models.CharField(max_length=20, choices=SEMESTER_STATUS_CHOICES, default=SEMESTER_ACTIVE)

    def __str__(self):
        return self.name


class Course(models.Model):
    semester = models.ForeignKey(Semester, on_delete=models.CASCADE, related_name="courses")
    title = models.CharField(max_length=200)
    teacher = models.CharField(max_length=200, blank=True)
    credits = models.PositiveIntegerField(null=True, blank=True)
    passing_grade = models.DecimalField(max_digits=4, decimal_places=2, default=Decimal("7.0"))
    status = models.CharField(max_length=20, choices=COURSE_STATUS_CHOICES, default=COURSE_IN_PROGRESS)
    final_grade = models.DecimalField(max_digits=5, decimal_places=2, null=True, blank=True)
    notes = models.TextField(blank=True)

    def __str__(self):
        return self.title


class Assessment(models.Model):
    course = models.ForeignKey(Course, on_delete=models.CASCADE, related_name="assessments")
    title = models.CharField(max_length=200)
    score = models.DecimalField(max_digits=5, decimal_places=2, validators=[MinValueValidator(0)])
    max_score = models.DecimalField(max_digits=5, decimal_places=2, default=Decimal("10.0"))
    weight = models.DecimalField(max_digits=5, decimal_places=2, default=Decimal("1.0"), validators=[MinValueValidator(0)])
    date = models.DateField(null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return self.title


class SemesterCheckin(models.Model):
    semester = models.ForeignKey(Semester, on_delete=models.CASCADE, related_name="checkins")
    created_at = models.DateTimeField(auto_now_add=True)
    overall_stress = models.PositiveSmallIntegerField(validators=[MinValueValidator(1), MaxValueValidator(5)])
    comment = models.TextField(blank=True)

    def __str__(self):
        return f"{self.semester.name} checkin"

----- END FILE: apps/semester/models.py -----

----- BEGIN FILE: apps/semester/serializers.py -----
from decimal import Decimal

from rest_framework import serializers

from semester.models import Assessment, Course, Semester, SemesterCheckin
from utils.academic_progress import (
    calculate_course_average,
    calculate_needed_to_pass,
    calculate_progress_percent,
)


class SemesterSerializer(serializers.ModelSerializer):
    class Meta:
        model = Semester
        fields = ("id", "name", "start_date", "end_date", "status")
        read_only_fields = ("id",)


class CourseSerializer(serializers.ModelSerializer):
    current_average = serializers.SerializerMethodField()
    progress_percent = serializers.SerializerMethodField()
    needed_to_pass = serializers.SerializerMethodField()

    class Meta:
        model = Course
        fields = (
            "id",
            "semester",
            "title",
            "teacher",
            "credits",
            "passing_grade",
            "status",
            "final_grade",
            "notes",
            "current_average",
            "progress_percent",
            "needed_to_pass",
        )
        read_only_fields = ("id", "status", "final_grade", "current_average", "progress_percent", "needed_to_pass")

    def get_current_average(self, obj):
        return calculate_course_average(obj)

    def get_progress_percent(self, obj):
        return calculate_progress_percent(obj)

    def get_needed_to_pass(self, obj):
        return calculate_needed_to_pass(obj)


class AssessmentSerializer(serializers.ModelSerializer):
    class Meta:
        model = Assessment
        fields = ("id", "course", "title", "score", "max_score", "weight", "date", "created_at")
        read_only_fields = ("id", "created_at")

    def validate(self, attrs):
        score = attrs.get("score")
        max_score = attrs.get("max_score")
        weight = attrs.get("weight")
        if score is not None and max_score is not None and score > max_score:
            raise serializers.ValidationError("score deve ser <= max_score")
        if weight is not None and weight < 0:
            raise serializers.ValidationError("weight deve ser >= 0")
        return attrs


class SemesterCheckinSerializer(serializers.ModelSerializer):
    class Meta:
        model = SemesterCheckin
        fields = ("id", "semester", "created_at", "overall_stress", "comment")
        read_only_fields = ("id", "created_at")

----- END FILE: apps/semester/serializers.py -----

----- BEGIN FILE: apps/semester/tests.py -----
from datetime import date
from decimal import Decimal

from django.contrib.auth import get_user_model
from rest_framework.test import APITestCase
from rest_framework_simplejwt.tokens import RefreshToken

from coach_ai.models import CoachLog
from semester.models import Assessment, Course, Semester
from utils.constants import COACH_REPROVACAO, COACH_SEMESTRE_CONCLUIDO, COURSE_FAILED, COURSE_PASSED

User = get_user_model()


class SemesterProgressTests(APITestCase):
    def setUp(self):
        self.user = User.objects.create_user(email="semester@example.com", name="Semestre", password="pass12345")
        refresh = RefreshToken.for_user(self.user)
        self.client.credentials(HTTP_AUTHORIZATION=f"Bearer {refresh.access_token}")
        self.semester = Semester.objects.create(
            user=self.user,
            name="2026.1",
            start_date=date.today(),
            end_date=date.today(),
        )
        self.course = Course.objects.create(semester=self.semester, title="Matematica")

    def test_course_progress_requires_assessment(self):
        response = self.client.get(f"/api/semester/courses/{self.course.id}/progress/")
        self.assertEqual(response.status_code, 403)
        self.assertIn("detail", response.data)

    def test_finish_semester_passed(self):
        Assessment.objects.create(course=self.course, title="Prova 1", score=Decimal("9"), max_score=Decimal("10"))
        response = self.client.post(f"/api/semester/finish/{self.semester.id}/")
        self.assertEqual(response.status_code, 200)
        self.course.refresh_from_db()
        self.assertEqual(self.course.status, COURSE_PASSED)
        self.assertTrue(CoachLog.objects.filter(user=self.user, trigger_type=COACH_SEMESTRE_CONCLUIDO).exists())

    def test_finish_semester_failed(self):
        failing_course = Course.objects.create(semester=self.semester, title="Fisica", passing_grade=Decimal("7"))
        Assessment.objects.create(course=failing_course, title="Prova 1", score=Decimal("3"), max_score=Decimal("10"))
        response = self.client.post(f"/api/semester/finish/{self.semester.id}/")
        self.assertEqual(response.status_code, 200)
        failing_course.refresh_from_db()
        self.assertEqual(failing_course.status, COURSE_FAILED)
        self.assertTrue(CoachLog.objects.filter(user=self.user, trigger_type=COACH_REPROVACAO).exists())

----- END FILE: apps/semester/tests.py -----

----- BEGIN FILE: apps/semester/urls.py -----
from django.urls import path
from rest_framework.routers import DefaultRouter

from semester.views import AssessmentViewSet, CourseProgressView, CourseViewSet, FinishSemesterView, SemesterViewSet

router = DefaultRouter()
router.register(r"semesters", SemesterViewSet, basename="semesters")
router.register(r"courses", CourseViewSet, basename="courses")
router.register(r"assessments", AssessmentViewSet, basename="assessments")

urlpatterns = router.urls + [
    path("courses/<int:pk>/progress/", CourseProgressView.as_view(), name="course-progress"),
    path("finish/<int:semester_id>/", FinishSemesterView.as_view(), name="semester-finish"),
]

----- END FILE: apps/semester/urls.py -----

----- BEGIN FILE: apps/semester/views.py -----
from datetime import timedelta

from django.shortcuts import get_object_or_404
from django.utils import timezone
from rest_framework import permissions, status, viewsets
from rest_framework.exceptions import PermissionDenied
from rest_framework.response import Response
from rest_framework.views import APIView

from coach_ai.models import CoachLog
from semester.models import Assessment, Course, Semester
from semester.serializers import AssessmentSerializer, CourseSerializer, SemesterSerializer
from utils.academic_progress import (
    calculate_course_average,
    calculate_needed_to_pass,
    calculate_progress_percent,
    update_course_status,
)
from utils.constants import (
    CHANNEL_EMAIL,
    CHANNEL_IN_APP,
    COACH_REPROVACAO,
    COACH_SEMESTRE_CONCLUIDO,
    COURSE_FAILED,
    SEMESTER_FINISHED,
)
from utils.gating import gate_course_progress, gate_finish_semester
from utils.messages import (
    MESSAGE_ACHIEVEMENT,
    MESSAGE_CARE,
    MESSAGE_INCENTIVE,
    MESSAGE_WARNING,
    send_message,
)


class SemesterViewSet(viewsets.ModelViewSet):
    serializer_class = SemesterSerializer
    permission_classes = [permissions.IsAuthenticated]

    def get_queryset(self):
        return Semester.objects.filter(user=self.request.user).order_by("-start_date")

    def perform_create(self, serializer):
        serializer.save(user=self.request.user)


class CourseViewSet(viewsets.ModelViewSet):
    serializer_class = CourseSerializer
    permission_classes = [permissions.IsAuthenticated]

    def get_queryset(self):
        return Course.objects.filter(semester__user=self.request.user).order_by("title")

    def perform_create(self, serializer):
        semester = serializer.validated_data["semester"]
        if semester.user != self.request.user:
            raise PermissionDenied("Semestre nao pertence ao usuario")
        serializer.save()


class AssessmentViewSet(viewsets.ModelViewSet):
    serializer_class = AssessmentSerializer
    permission_classes = [permissions.IsAuthenticated]

    def get_queryset(self):
        return Assessment.objects.filter(course__semester__user=self.request.user).order_by("-created_at")

    def perform_create(self, serializer):
        course = serializer.validated_data["course"]
        if course.semester.user != self.request.user:
            raise PermissionDenied("Curso nao pertence ao usuario")
        previous_progress = calculate_progress_percent(course)
        serializer.save()
        course.refresh_from_db()
        new_progress = calculate_progress_percent(course)
        update_course_status(course, semester_status=course.semester.status)
        course.final_grade = calculate_course_average(course)
        course.save(update_fields=["status", "final_grade"])

        if new_progress > previous_progress:
            send_message(
                self.request.user,
                MESSAGE_INCENTIVE,
                {
                    "event": "assessment_progress_up",
                    "course": course.title,
                    "progress": int(new_progress),
                },
                channels=[CHANNEL_IN_APP, CHANNEL_EMAIL],
            )
        elif new_progress < previous_progress:
            send_message(
                self.request.user,
                MESSAGE_CARE,
                {
                    "event": "assessment_progress_down",
                    "course": course.title,
                    "progress": int(new_progress),
                },
                channels=[CHANNEL_IN_APP, CHANNEL_EMAIL],
            )

        if new_progress >= 100 and previous_progress < 100:
            send_message(
                self.request.user,
                MESSAGE_ACHIEVEMENT,
                {
                    "event": "course_passed",
                    "course": course.title,
                    "progress": int(new_progress),
                },
                channels=[CHANNEL_IN_APP, CHANNEL_EMAIL],
            )

        week_ahead = timezone.localdate() + timedelta(days=7)
        upcoming = course.assessments.filter(date__gte=timezone.localdate(), date__lte=week_ahead).exists()
        if new_progress < 70 and upcoming:
            send_message(
                self.request.user,
                MESSAGE_WARNING,
                {
                    "event": "low_progress_upcoming",
                    "course": course.title,
                    "progress": int(new_progress),
                },
                channels=[CHANNEL_IN_APP, CHANNEL_EMAIL],
            )


class CourseProgressView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request, pk):
        course = get_object_or_404(Course, pk=pk, semester__user=request.user)
        allowed, message = gate_course_progress(course)
        if not allowed:
            return Response({"detail": message}, status=status.HTTP_403_FORBIDDEN)
        current_average = calculate_course_average(course)
        progress_percent = calculate_progress_percent(course)
        needed_to_pass = calculate_needed_to_pass(course)
        return Response(
            {
                "course_id": course.id,
                "current_average": current_average,
                "progress_percent": progress_percent,
                "needed_to_pass": needed_to_pass,
            }
        )


class FinishSemesterView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def post(self, request, semester_id):
        semester = get_object_or_404(Semester, pk=semester_id, user=request.user)
        allowed, message = gate_finish_semester(semester)
        if not allowed:
            return Response({"detail": message}, status=status.HTTP_403_FORBIDDEN)

        any_failed = False
        for course in semester.courses.all():
            current_average = calculate_course_average(course)
            course.final_grade = current_average
            update_course_status(course, semester_status=SEMESTER_FINISHED)
            if course.status == COURSE_FAILED:
                any_failed = True
            course.save(update_fields=["final_grade", "status"])

        semester.status = SEMESTER_FINISHED
        semester.save()

        if any_failed:
            CoachLog.objects.create(
                user=request.user,
                trigger_type=COACH_REPROVACAO,
                suggestion_text=(
                    "Identificamos disciplinas reprovadas. Vamos montar um plano de continuidade e recuperar o ritmo."
                ),
            )
            send_message(
                request.user,
                MESSAGE_CARE,
                {
                    "event": "semester_with_fail",
                    "course": "",
                },
                channels=[CHANNEL_IN_APP, CHANNEL_EMAIL],
            )
            send_message(
                request.user,
                MESSAGE_INCENTIVE,
                {
                    "event": "semester_continue",
                    "course": "",
                },
                channels=[CHANNEL_IN_APP, CHANNEL_EMAIL],
            )
        else:
            CoachLog.objects.create(
                user=request.user,
                trigger_type=COACH_SEMESTRE_CONCLUIDO,
                suggestion_text=(
                    "Parabens! Voce concluiu o semestre sem reprovacoes. Continue com esse ritmo."
                ),
            )
            send_message(
                request.user,
                MESSAGE_ACHIEVEMENT,
                {
                    "event": "semester_all_passed",
                    "course": "",
                },
                channels=["IN_APP", "EMAIL"],
            )

        return Response({"detail": "Semestre finalizado."})

----- END FILE: apps/semester/views.py -----

----- BEGIN FILE: apps/ui/apps.py -----
from django.apps import AppConfig


class UiConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "ui"

----- END FILE: apps/ui/apps.py -----

----- BEGIN FILE: apps/ui/forms.py -----
from django import forms
from django.contrib.auth import authenticate, get_user_model
from django.contrib.auth.forms import AuthenticationForm
from django.utils.translation import gettext_lazy as _


class EmailAuthenticationForm(AuthenticationForm):
    error_messages = {
        **AuthenticationForm.error_messages,
        "inactive": _("Confirme seu e-mail para entrar."),
    }

    username = forms.EmailField(
        label=_("Email"),
        widget=forms.EmailInput(attrs={"class": "form-control", "placeholder": "seu.email@universidade.edu"}),
    )
    password = forms.CharField(
        label=_("Senha"),
        widget=forms.PasswordInput(attrs={"class": "form-control", "placeholder": "Sua senha"}),
    )

    def clean(self):
        username = self.cleaned_data.get("username")
        password = self.cleaned_data.get("password")

        if username is not None and password:
            self.user_cache = authenticate(self.request, username=username, password=password)
            if self.user_cache is None:
                user_model = get_user_model()
                user = user_model._default_manager.filter(email__iexact=username).first()
                if user and user.check_password(password) and not user.is_active:
                    raise forms.ValidationError(self.error_messages["inactive"], code="inactive")
                raise self.get_invalid_login_error()
            self.confirm_login_allowed(self.user_cache)

        return self.cleaned_data


# Bloco: Formulario de primeiro acesso
class FirstAccessForm(forms.Form):
    PLAN_FREE = "FREE"
    PLAN_PAID = "PAGO"
    PLAN_CHOICES = [
        (PLAN_FREE, _("Free")),
        (PLAN_PAID, _("Pago")),
    ]

    name = forms.CharField(label=_("Nome"), max_length=255, widget=forms.TextInput(attrs={"class": "form-control"}))
    email = forms.EmailField(label=_("Email"), widget=forms.EmailInput(attrs={"class": "form-control"}))
    phone = forms.CharField(
        label=_("Telefone (WhatsApp)"),
        max_length=30,
        required=False,
        widget=forms.TextInput(attrs={"class": "form-control"}),
    )
    plan = forms.ChoiceField(
        label=_("Plano"),
        choices=PLAN_CHOICES,
        initial=PLAN_FREE,
        widget=forms.Select(attrs={"class": "form-select"}),
    )
    password1 = forms.CharField(
        label=_("Senha"),
        widget=forms.PasswordInput(attrs={"class": "form-control"}),
        min_length=6,
    )
    password2 = forms.CharField(
        label=_("Confirmar senha"),
        widget=forms.PasswordInput(attrs={"class": "form-control"}),
        min_length=6,
    )
    allow_email = forms.BooleanField(
        label=_("Receber email"),
        required=False,
        initial=True,
        widget=forms.CheckboxInput(attrs={"class": "form-check-input"}),
    )
    allow_whatsapp = forms.BooleanField(
        label=_("Receber WhatsApp"),
        required=False,
        initial=True,
        widget=forms.CheckboxInput(attrs={"class": "form-check-input"}),
    )
    allow_sms = forms.BooleanField(
        label=_("Receber SMS"),
        required=False,
        initial=False,
        widget=forms.CheckboxInput(attrs={"class": "form-check-input"}),
    )

    def clean(self):
        data = super().clean()
        if data.get("password1") != data.get("password2"):
            self.add_error("password2", _("As senhas nao conferem."))
        return data

----- END FILE: apps/ui/forms.py -----

----- BEGIN FILE: apps/ui/forms_academic.py -----
from django import forms
from django.core.exceptions import ValidationError
from django.utils.translation import gettext_lazy as _

from semester.models import Assessment, Course, Semester


class SemesterForm(forms.ModelForm):
    class Meta:
        model = Semester
        fields = ["name", "start_date", "end_date", "status"]
        labels = {
            "name": _("Nome do semestre"),
            "start_date": _("Data de inicio"),
            "end_date": _("Data de termino"),
            "status": _("Status"),
        }
        widgets = {
            "name": forms.TextInput(attrs={"class": "form-control"}),
            "start_date": forms.DateInput(attrs={"class": "form-control", "type": "date"}),
            "end_date": forms.DateInput(attrs={"class": "form-control", "type": "date"}),
            "status": forms.Select(attrs={"class": "form-select"}),
        }


class CourseForm(forms.ModelForm):
    class Meta:
        model = Course
        fields = ["title", "teacher", "credits", "passing_grade", "status", "final_grade", "notes"]
        labels = {
            "title": _("Nome da disciplina"),
            "teacher": _("Professor"),
            "credits": _("Creditos"),
            "passing_grade": _("Nota minima"),
            "status": _("Status"),
            "final_grade": _("Nota final"),
            "notes": _("Anotacoes"),
        }
        widgets = {
            "title": forms.TextInput(attrs={"class": "form-control"}),
            "teacher": forms.TextInput(attrs={"class": "form-control"}),
            "credits": forms.NumberInput(attrs={"class": "form-control", "min": 0}),
            "passing_grade": forms.NumberInput(attrs={"class": "form-control", "step": "0.01", "min": 0}),
            "status": forms.Select(attrs={"class": "form-select"}),
            "final_grade": forms.NumberInput(attrs={"class": "form-control", "step": "0.01", "min": 0}),
            "notes": forms.Textarea(attrs={"class": "form-control", "rows": 4}),
        }

    def clean_passing_grade(self):
        passing_grade = self.cleaned_data.get("passing_grade")
        if passing_grade is not None and passing_grade <= 0:
            raise ValidationError(_("A nota minima deve ser maior que zero."))
        return passing_grade


class AssessmentForm(forms.ModelForm):
    class Meta:
        model = Assessment
        fields = ["title", "score", "max_score", "weight", "date"]
        labels = {
            "title": _("Titulo"),
            "score": _("Nota obtida"),
            "max_score": _("Nota maxima"),
            "weight": _("Peso"),
            "date": _("Data"),
        }
        widgets = {
            "title": forms.TextInput(attrs={"class": "form-control"}),
            "score": forms.NumberInput(attrs={"class": "form-control", "step": "0.01", "min": 0}),
            "max_score": forms.NumberInput(attrs={"class": "form-control", "step": "0.01", "min": 0}),
            "weight": forms.NumberInput(attrs={"class": "form-control", "step": "0.01", "min": 0}),
            "date": forms.DateInput(attrs={"class": "form-control", "type": "date"}),
        }

    def clean(self):
        cleaned_data = super().clean()
        score = cleaned_data.get("score")
        max_score = cleaned_data.get("max_score")
        weight = cleaned_data.get("weight")
        if score is not None and max_score is not None and score > max_score:
            raise ValidationError(_("A nota obtida nao pode ser maior que a nota maxima."))
        if weight is not None and weight < 0:
            raise ValidationError(_("O peso deve ser maior ou igual a zero."))
        return cleaned_data

----- END FILE: apps/ui/forms_academic.py -----

----- BEGIN FILE: apps/ui/forms_agenda.py -----
from django import forms
from django.utils.translation import gettext_lazy as _

from agenda.models import CalendarEvent
from planner.models import Task


class CalendarEventForm(forms.ModelForm):
    class Meta:
        model = CalendarEvent
        fields = ["title", "event_type", "start_at", "end_at", "related_task", "notes"]
        labels = {
            "title": _("Titulo"),
            "event_type": _("Tipo"),
            "start_at": _("Inicio"),
            "end_at": _("Fim"),
            "related_task": _("Tarefa relacionada"),
            "notes": _("Observacoes"),
        }
        widgets = {
            "title": forms.TextInput(attrs={"class": "form-control"}),
            "event_type": forms.Select(attrs={"class": "form-select"}),
            "start_at": forms.DateTimeInput(
                attrs={"class": "form-control", "type": "datetime-local"},
                format="%Y-%m-%dT%H:%M",
            ),
            "end_at": forms.DateTimeInput(
                attrs={"class": "form-control", "type": "datetime-local"},
                format="%Y-%m-%dT%H:%M",
            ),
            "related_task": forms.Select(attrs={"class": "form-select"}),
            "notes": forms.Textarea(attrs={"class": "form-control", "rows": 4}),
        }

    def __init__(self, *args, **kwargs):
        user = kwargs.pop("user", None)
        super().__init__(*args, **kwargs)
        self.fields["start_at"].input_formats = ["%Y-%m-%dT%H:%M"]
        self.fields["end_at"].input_formats = ["%Y-%m-%dT%H:%M"]
        if user is not None:
            self.fields["related_task"].queryset = Task.objects.filter(user=user).order_by("due_date")
        self.fields["related_task"].required = False
        self.fields["related_task"].empty_label = _("Estudos")

----- END FILE: apps/ui/forms_agenda.py -----

----- BEGIN FILE: apps/ui/forms_reminders.py -----
from django import forms
from django.core.exceptions import ValidationError
from django.utils.translation import gettext_lazy as _

from agenda.models import ReminderRule
from utils.constants import CHANNEL_EMAIL, CHANNEL_SMS, CHANNEL_WHATSAPP

CHANNEL_OPTIONS = [
    (CHANNEL_EMAIL, "Email"),
    (CHANNEL_WHATSAPP, "WhatsApp"),
    (CHANNEL_SMS, "SMS"),
]


class ReminderRuleForm(forms.ModelForm):
    channels = forms.MultipleChoiceField(
        choices=CHANNEL_OPTIONS,
        widget=forms.CheckboxSelectMultiple,
        label=_("Canais"),
        required=False,
    )

    class Meta:
        model = ReminderRule
        fields = ["target_type", "remind_before_minutes", "channels", "is_active"]
        labels = {
            "target_type": _("Tipo de alvo"),
            "remind_before_minutes": _("Minutos antes"),
            "is_active": _("Ativo"),
        }
        widgets = {
            "target_type": forms.Select(attrs={"class": "form-select"}),
            "remind_before_minutes": forms.NumberInput(attrs={"class": "form-control", "min": 1}),
            "is_active": forms.CheckboxInput(attrs={"class": "form-check-input"}),
        }

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        if self.instance and self.instance.channels:
            self.fields["channels"].initial = self.instance.channels

    def clean_remind_before_minutes(self):
        minutes = self.cleaned_data.get("remind_before_minutes")
        if minutes is not None and minutes <= 0:
            raise ValidationError(_("Informe um valor maior que zero."))
        return minutes

    def save(self, commit=True):
        instance = super().save(commit=False)
        instance.channels = self.cleaned_data.get("channels", [])
        if commit:
            instance.save()
        return instance

----- END FILE: apps/ui/forms_reminders.py -----

----- BEGIN FILE: apps/ui/forms_tasks.py -----
from django import forms
from django.utils.translation import gettext_lazy as _

from planner.models import Task


class TaskForm(forms.ModelForm):
    class Meta:
        model = Task
        fields = ["title", "description", "due_date", "stress_level", "status"]
        labels = {
            "title": _("Titulo"),
            "description": _("Descricao"),
            "due_date": _("Data de entrega"),
            "stress_level": _("Nivel de estresse(0 a 5)"),
            "status": _("Status"),
        }
        widgets = {
            "title": forms.TextInput(attrs={"class": "form-control"}),
            "description": forms.Textarea(attrs={"class": "form-control", "rows": 4}),
            "due_date": forms.DateInput(attrs={"class": "form-control", "type": "date"}),
            "stress_level": forms.NumberInput(attrs={"class": "form-control", "min": 1, "max": 5}),
            "status": forms.Select(attrs={"class": "form-select"}),
        }

----- END FILE: apps/ui/forms_tasks.py -----

----- BEGIN FILE: apps/ui/services_academic.py -----
from utils.academic_progress import (
    calculate_course_average,
    calculate_needed_to_pass,
    calculate_progress_percent,
)


def build_course_progress(course):
    assessments_qs = course.assessments.all()
    has_assessments = assessments_qs.exists()
    current_average = calculate_course_average(course)
    progress_percent = calculate_progress_percent(course)
    needed_to_pass = calculate_needed_to_pass(course)
    return {
        "has_assessments": has_assessments,
        "current_average": current_average,
        "passing_grade": course.passing_grade,
        "progress_percent": progress_percent,
        "needed_to_pass": needed_to_pass,
    }

----- END FILE: apps/ui/services_academic.py -----

----- BEGIN FILE: apps/ui/urls.py -----
from django.contrib.auth import views as auth_views
from django.urls import path

from ui.forms import EmailAuthenticationForm
from ui.views import (
    activate_account_view,
    dashboard_view,
    first_access_view,
    home_view,
    onboarding_view,
    semesters_view,
    tasks_view,
)
from ui.views_academic import (
    assessment_create_view,
    assessment_delete_view,
    assessment_update_view,
    course_create_view,
    course_delete_view,
    course_detail_view,
    course_update_view,
    semester_create_view,
    semester_delete_view,
    semester_detail_view,
    semester_list_view,
    semester_update_view,
)
from ui.views_agenda import agenda_create_view, agenda_delete_view, agenda_list_view, agenda_update_view
from ui.views_messages import message_list_view
from ui.views_reminders import (
    reminder_create_view,
    reminder_delete_view,
    reminder_generate_view,
    reminder_list_view,
    reminder_update_view,
)
from ui.views_tasks import task_create_view, task_delete_view, task_detail_view, task_list_view, task_update_view

urlpatterns = [
    path(
        "login/",
        auth_views.LoginView.as_view(
            template_name="ui/login.html",
            authentication_form=EmailAuthenticationForm,
        ),
        name="ui-login",
    ),
    path("home/", home_view, name="ui-home"),
    path("primeiro-acesso/", first_access_view, name="ui-first-access"),
    path("ativar/<uidb64>/<token>/", activate_account_view, name="ui-activate-account"),
    path("logout/", auth_views.LogoutView.as_view(next_page="/login/"), name="ui-logout"),
    path("logout/", auth_views.LogoutView.as_view(next_page="/login/"), name="logout"),
    path(
        "password-reset/",
        auth_views.PasswordResetView.as_view(
            template_name="ui/password_reset_form.html",
            email_template_name="registration/password_reset_email.html",
            subject_template_name="registration/password_reset_subject.txt",
            success_url="/password-reset/done/",
        ),
        name="password_reset",
    ),
    path(
        "password-reset/done/",
        auth_views.PasswordResetDoneView.as_view(
            template_name="ui/password_reset_done.html",
        ),
        name="password_reset_done",
    ),
    path(
        "reset/<uidb64>/<token>/",
        auth_views.PasswordResetConfirmView.as_view(
            template_name="ui/password_reset_confirm.html",
            success_url="/reset/done/",
        ),
        name="password_reset_confirm",
    ),
    path(
        "reset/done/",
        auth_views.PasswordResetCompleteView.as_view(
            template_name="ui/password_reset_complete.html",
        ),
        name="password_reset_complete",
    ),
    path("", dashboard_view, name="ui-dashboard"),
    path("onboarding/", onboarding_view, name="ui-onboarding"),
    path("semesters/", semesters_view, name="ui-semesters"),
    path("semestres/", semester_list_view, name="ui-semester-list"),
    path("semestres/novo/", semester_create_view, name="ui-semester-create"),
    path("semestres/<int:pk>/", semester_detail_view, name="ui-semester-detail"),
    path("semestres/<int:pk>/editar/", semester_update_view, name="ui-semester-edit"),
    path("semestres/<int:pk>/excluir/", semester_delete_view, name="ui-semester-delete"),
    path("semestres/<int:sem_id>/disciplinas/nova/", course_create_view, name="ui-course-create"),
    path("disciplinas/<int:pk>/", course_detail_view, name="ui-course-detail"),
    path("disciplinas/<int:pk>/editar/", course_update_view, name="ui-course-edit"),
    path("disciplinas/<int:pk>/excluir/", course_delete_view, name="ui-course-delete"),
    path("disciplinas/<int:course_id>/avaliacoes/nova/", assessment_create_view, name="ui-assessment-create"),
    path("avaliacoes/<int:pk>/editar/", assessment_update_view, name="ui-assessment-edit"),
    path("avaliacoes/<int:pk>/excluir/", assessment_delete_view, name="ui-assessment-delete"),
    path("tasks/", task_list_view, name="ui-tasks"),
    path("agenda/", agenda_list_view, name="ui-agenda-list"),
    path("messages/", message_list_view, name="ui-messages"),
    path("tarefas/", task_list_view, name="ui-task-list"),
    path("tarefas/nova/", task_create_view, name="ui-task-create"),
    path("tarefas/<int:pk>/", task_detail_view, name="ui-task-detail"),
    path("tarefas/<int:pk>/editar/", task_update_view, name="ui-task-edit"),
    path("tarefas/<int:pk>/excluir/", task_delete_view, name="ui-task-delete"),
    path("agenda/novo/", agenda_create_view, name="ui-agenda-create"),
    path("agenda/<int:pk>/editar/", agenda_update_view, name="ui-agenda-edit"),
    path("agenda/<int:pk>/excluir/", agenda_delete_view, name="ui-agenda-delete"),
    path("lembretes/", reminder_list_view, name="ui-reminder-list"),
    path("lembretes/gerar/", reminder_generate_view, name="ui-reminder-generate"),
    path("lembretes/novo/", reminder_create_view, name="ui-reminder-create"),
    path("lembretes/<int:pk>/editar/", reminder_update_view, name="ui-reminder-edit"),
    path("lembretes/<int:pk>/excluir/", reminder_delete_view, name="ui-reminder-delete"),
    path("mensagens/", message_list_view, name="ui-message-list"),
]

----- END FILE: apps/ui/urls.py -----

----- BEGIN FILE: apps/ui/views.py -----
from collections import Counter
from datetime import timedelta

from django.conf import settings
from django.contrib import messages
from django.contrib.auth import get_user_model
from django.contrib.auth.decorators import login_required
from django.contrib.auth.tokens import default_token_generator
from django.core.mail import EmailMultiAlternatives
from django.db.models import Q
from django.shortcuts import redirect, render
from django.template.loader import render_to_string
from django.urls import reverse
from django.utils.encoding import force_bytes, force_str
from django.utils.http import urlsafe_base64_decode, urlsafe_base64_encode
from django.utils import timezone
from django.utils.translation import gettext_lazy as _

from accounts.models import UserProfile
from agenda.models import CalendarEvent, ReminderRule
from billing.models import Plan, UserSubscription
from mood.models import MoodEntry
from notifications.models import NotificationQueue
from onboarding.services import refresh_user_progress
from planner.models import Task
from pomodoro.models import PomodoroSession
from semester.models import Course, Semester, SemesterCheckin
from utils.academic_progress import (
    calculate_course_average,
    calculate_needed_to_pass,
    calculate_progress_percent,
    update_course_status,
)
from utils.constants import (
    EVENT_TYPE_CHOICES,
    CHANNEL_IN_APP,
    SEMESTER_ACTIVE,
    SEMESTER_FINISHED,
    TASK_DOING,
    TASK_DONE,
    TASK_TODO,
    PLAN_LITE,
    PLAN_PRO,
)
from utils.gating import STEPS, compute_status
from ui.forms import FirstAccessForm

STEP_LABELS = {
    "STEP_1_PROFILE": _("Perfil"),
    "STEP_2_SEMESTER": _("Semestre"),
    "STEP_3_COURSES": _("Disciplinas"),
    "STEP_4_ASSESSMENTS": _("Avaliacoes"),
    "STEP_5_REMINDERS": _("Lembretes"),
    "STEP_6_DASHBOARD": _("Dashboard"),
}


def home_view(request):
    return render(request, "ui/home.html")


def _build_activation_url(request, uidb64, token):
    activate_path = reverse("ui-activate-account", kwargs={"uidb64": uidb64, "token": token})
    site_base_url = (settings.SITE_BASE_URL or "").strip().rstrip("/")
    if site_base_url:
        return f"{site_base_url}{activate_path}"
    return request.build_absolute_uri(activate_path)


def _send_activation_email(request, user):
    uidb64 = urlsafe_base64_encode(force_bytes(user.pk))
    token = default_token_generator.make_token(user)
    activation_url = _build_activation_url(request, uidb64, token)
    context = {"user": user, "activation_url": activation_url}

    subject = _("Ative sua conta no CampusCalm")
    text_body = render_to_string("accounts/email/activate_account.txt", context)
    html_body = render_to_string("accounts/email/activate_account.html", context)

    email = EmailMultiAlternatives(
        subject=subject,
        body=text_body,
        from_email=settings.DEFAULT_FROM_EMAIL,
        to=[user.email],
    )
    email.attach_alternative(html_body, "text/html")
    email.send(fail_silently=False)


def _build_steps(progress):
    current_step, missing_steps, required_actions = compute_status(progress)
    steps = []
    for step, _field, message in STEPS:
        label = STEP_LABELS.get(step, step)
        is_missing = step in missing_steps
        steps.append(
            {
                "code": step,
                "label": label,
                "missing": is_missing,
                "message": message if is_missing else _("Concluido"),
            }
        )
    total_steps = len(steps)
    completed_steps = total_steps - len(missing_steps)
    progress_percent = int((completed_steps / total_steps) * 100) if total_steps else 0
    return {
        "current_step": current_step,
        "missing_steps": missing_steps,
        "required_actions": required_actions,
        "steps": steps,
        "is_complete": len(missing_steps) == 0,
        "total_steps": total_steps,
        "completed_steps": completed_steps,
        "progress_percent": progress_percent,
    }


# Bloco: Primeiro acesso / Criar conta
def first_access_view(request):
    user_model = get_user_model()
    if request.method == "POST":
        form = FirstAccessForm(request.POST)
        if form.is_valid():
            email = form.cleaned_data["email"].lower()
            if user_model.objects.filter(email=email).exists():
                form.add_error("email", _("Ja existe um usuario com este email."))
                return render(request, "ui/first_access.html", {"form": form})

            user = user_model.objects.create_user(
                email=email,
                name=form.cleaned_data["name"],
                phone_number=form.cleaned_data.get("phone", ""),
                password=form.cleaned_data["password1"],
                is_active=False,
            )

            profile = UserProfile.objects.get_or_create(user=user)[0]
            profile.phone = form.cleaned_data.get("phone", "")
            profile.plan = form.cleaned_data["plan"]
            profile.allow_email = form.cleaned_data.get("allow_email", True)
            profile.allow_whatsapp = form.cleaned_data.get("allow_whatsapp", True)
            profile.allow_sms = form.cleaned_data.get("allow_sms", False)
            profile.consent_at = timezone.now()
            profile.save()

            plan_code = PLAN_PRO if profile.plan == UserProfile.PLAN_PAID else PLAN_LITE
            plan = Plan.objects.filter(code=plan_code, is_active=True).first()
            if plan:
                UserSubscription.objects.get_or_create(user=user, defaults={"plan": plan})

            _send_activation_email(request, user)
            messages.success(request, _("Enviamos um link de ativacao para seu e-mail."))
            return redirect("ui-login")
    else:
        form = FirstAccessForm()
    return render(request, "ui/first_access.html", {"form": form})


def activate_account_view(request, uidb64, token):
    user_model = get_user_model()
    user = None
    try:
        uid = force_str(urlsafe_base64_decode(uidb64))
        user = user_model.objects.get(pk=uid)
    except (TypeError, ValueError, OverflowError, user_model.DoesNotExist):
        user = None

    if user and default_token_generator.check_token(user, token):
        if not user.is_active:
            user.is_active = True
            user.save(update_fields=["is_active"])
            messages.success(request, _("Conta ativada com sucesso. Agora voce pode entrar."))
        else:
            messages.info(request, _("Sua conta ja esta ativada."))
    else:
        messages.error(request, _("Link de ativacao invalido ou expirado."))
    return redirect("ui-login")


@login_required(login_url="/login/")
def dashboard_view(request):
    user = request.user
    progress = refresh_user_progress(user)
    onboarding_status = _build_steps(progress)

    session_key = "ui_dashboard_filters"
    if request.GET.get("clear") == "1":
        request.session.pop(session_key, None)
        return redirect(request.path)
    if "q" in request.GET:
        search_query = request.GET.get("q", "").strip()
        request.session[session_key] = {"q": search_query}
    else:
        search_query = request.session.get(session_key, {}).get("q", "")

    now = timezone.now()
    week_ago = now - timedelta(days=7)

    mood_entries = MoodEntry.objects.filter(user=user, created_at__gte=week_ago)
    mood_counts = Counter(mood_entries.values_list("mood", flat=True))
    most_common_mood = None
    if mood_counts:
        most_common_mood = mood_counts.most_common(1)[0][0]

    focus_minutes = (
        PomodoroSession.objects.filter(user=user, started_at__gte=week_ago)
        .values_list("focus_minutes", flat=True)
    )
    total_focus_minutes = sum(focus_minutes)

    stress_values = SemesterCheckin.objects.filter(semester__user=user, created_at__gte=week_ago).values_list(
        "overall_stress", flat=True
    )
    stress_avg = round(sum(stress_values) / len(stress_values), 2) if stress_values else None

    today = timezone.localdate()
    next_week = today + timedelta(days=7)
    upcoming_tasks = Task.objects.filter(user=user, due_date__gte=today, due_date__lte=next_week).order_by("due_date")
    upcoming_events = CalendarEvent.objects.filter(
        user=user, start_at__date__gte=today, start_at__date__lte=next_week
    ).order_by("start_at")
    if search_query:
        upcoming_tasks = upcoming_tasks.filter(Q(title__icontains=search_query) | Q(description__icontains=search_query))
        upcoming_events = upcoming_events.filter(title__icontains=search_query)

    tasks = Task.objects.filter(user=user)
    courses = Course.objects.filter(semester__user=user).select_related("semester").order_by("title")
    course_progress = []
    for course in courses:
        course_progress.append(
            {
                "title": course.title,
                "semester": course.semester.name,
                "current_average": calculate_course_average(course),
                "passing_grade": course.passing_grade,
                "progress_percent": int(calculate_progress_percent(course)),
            }
        )
    dashboard_data = {
        "tasks": {
            "todo": tasks.filter(status=TASK_TODO).count(),
            "doing": tasks.filter(status=TASK_DOING).count(),
            "done": tasks.filter(status=TASK_DONE).count(),
        },
        "mood_weekly_total": mood_entries.count(),
        "mood_most_common": most_common_mood,
        "focus_minutes_week": total_focus_minutes,
        "stress_avg_week": stress_avg,
        "upcoming_tasks": upcoming_tasks[:5],
        "upcoming_events": upcoming_events[:5],
        "upcoming_count": upcoming_tasks.count() + upcoming_events.count(),
        "course_progress": course_progress[:5],
    }

    return render(
        request,
        "ui/dashboard.html",
        {
            "onboarding_status": onboarding_status,
            "dashboard_data": dashboard_data,
            "search_query": search_query,
        },
    )


@login_required(login_url="/login/")
def onboarding_view(request):
    user = request.user
    progress = refresh_user_progress(user)
    onboarding_status = _build_steps(progress)
    return render(
        request,
        "ui/onboarding.html",
        {
            "current_step": onboarding_status["current_step"],
            "missing_steps": onboarding_status["missing_steps"],
            "required_actions": onboarding_status["required_actions"],
            "steps": onboarding_status["steps"],
        },
    )


@login_required(login_url="/login/")
def semesters_view(request):
    user = request.user
    session_key = "ui_semesters_filters"
    if request.GET.get("clear") == "1":
        request.session.pop(session_key, None)
        return redirect(request.path)
    if any(key in request.GET for key in ("status", "course", "teacher")):
        status_filter = request.GET.get("status", "")
        course_query = request.GET.get("course", "").strip()
        teacher_query = request.GET.get("teacher", "").strip()
        request.session[session_key] = {
            "status": status_filter,
            "course": course_query,
            "teacher": teacher_query,
        }
    else:
        saved = request.session.get(session_key, {})
        status_filter = saved.get("status", "")
        course_query = saved.get("course", "")
        teacher_query = saved.get("teacher", "")
    semesters = Semester.objects.filter(user=user)
    if status_filter in {SEMESTER_ACTIVE, SEMESTER_FINISHED}:
        semesters = semesters.filter(status=status_filter)
    semesters = semesters.order_by("-start_date")
    semester_cards = []
    for semester in semesters.prefetch_related("courses__assessments"):
        courses_data = []
        for course in semester.courses.all():
            if course_query and course_query.lower() not in course.title.lower():
                continue
            if teacher_query and teacher_query.lower() not in (course.teacher or "").lower():
                continue
            current_average = calculate_course_average(course)
            progress_percent = calculate_progress_percent(course)
            progress_value = float(progress_percent)
            progress_display = f"{progress_value:.2f}"
            needed_to_pass = calculate_needed_to_pass(course)
            previous_status = course.status
            update_course_status(course, semester_status=semester.status)
            if course.status != previous_status:
                course.save(update_fields=["status"])
            courses_data.append(
                {
                    "title": course.title,
                    "teacher": course.teacher,
                    "status": course.status,
                    "passing_grade": course.passing_grade,
                    "current_average": current_average,
                    "progress_percent": progress_display,
                    "progress_percent_css": progress_display,
                    "needed_to_pass": needed_to_pass,
                }
            )
        if (course_query or teacher_query) and not courses_data:
            continue
        semester_cards.append(
            {
                "name": semester.name,
                "start_date": semester.start_date,
                "end_date": semester.end_date,
                "status": semester.status,
                "courses": courses_data,
            }
        )

    return render(
        request,
        "ui/semesters.html",
        {
            "semesters": semester_cards,
            "status_filter": status_filter,
            "course_query": course_query,
            "teacher_query": teacher_query,
        },
    )


@login_required(login_url="/login/")
def tasks_view(request):
    user = request.user
    session_key = "ui_tasks_filters"
    if request.GET.get("clear") == "1":
        request.session.pop(session_key, None)
        return redirect(request.path)
    if any(key in request.GET for key in ("status", "due", "q", "stress")):
        status_filter = request.GET.get("status", "")
        due_filter = request.GET.get("due", "")
        search_query = request.GET.get("q", "").strip()
        stress_filter = request.GET.get("stress", "")
        request.session[session_key] = {
            "status": status_filter,
            "due": due_filter,
            "q": search_query,
            "stress": stress_filter,
        }
    else:
        saved = request.session.get(session_key, {})
        status_filter = saved.get("status", "")
        due_filter = saved.get("due", "")
        search_query = saved.get("q", "")
        stress_filter = saved.get("stress", "")
    tasks = Task.objects.filter(user=user)
    if status_filter in {TASK_TODO, TASK_DOING, TASK_DONE}:
        tasks = tasks.filter(status=status_filter)
    today = timezone.localdate()
    if due_filter == "overdue":
        tasks = tasks.filter(due_date__lt=today)
    elif due_filter == "today":
        tasks = tasks.filter(due_date=today)
    elif due_filter == "week":
        tasks = tasks.filter(due_date__gte=today, due_date__lte=today + timedelta(days=7))
    elif due_filter == "month":
        tasks = tasks.filter(due_date__gte=today, due_date__lte=today + timedelta(days=30))
    if search_query:
        tasks = tasks.filter(Q(title__icontains=search_query) | Q(description__icontains=search_query))
    if stress_filter in {"1", "2", "3", "4", "5"}:
        tasks = tasks.filter(stress_level=int(stress_filter))
    tasks = tasks.order_by("due_date")
    return render(
        request,
        "ui/tasks.html",
        {
            "tasks": tasks,
            "status_filter": status_filter,
            "due_filter": due_filter,
            "search_query": search_query,
            "stress_filter": stress_filter,
        },
    )


@login_required(login_url="/login/")
def agenda_view(request):
    user = request.user
    today = timezone.localdate()
    session_key = "ui_agenda_filters"
    if request.GET.get("clear") == "1":
        request.session.pop(session_key, None)
        return redirect(request.path)
    if any(key in request.GET for key in ("range", "q", "type")):
        range_days = request.GET.get("range", "30")
        if range_days not in {"7", "15", "30", "60", "90"}:
            range_days = "30"
        search_query = request.GET.get("q", "").strip()
        type_filter = request.GET.get("type", "")
        request.session[session_key] = {
            "range": range_days,
            "q": search_query,
            "type": type_filter,
        }
    else:
        saved = request.session.get(session_key, {})
        range_days = saved.get("range", "30")
        search_query = saved.get("q", "")
        type_filter = saved.get("type", "")
    next_month = today + timedelta(days=int(range_days))
    events = CalendarEvent.objects.filter(
        user=user, start_at__date__gte=today, start_at__date__lte=next_month
    ).order_by("start_at")
    if search_query:
        events = events.filter(title__icontains=search_query)
    event_type_values = [value for value, _label in EVENT_TYPE_CHOICES]
    if type_filter in event_type_values:
        events = events.filter(event_type=type_filter)
    reminder_rules = ReminderRule.objects.filter(user=user, is_active=True)
    return render(
        request,
        "ui/agenda.html",
        {
            "events": events,
            "reminder_rules": reminder_rules,
            "range_days": range_days,
            "search_query": search_query,
            "type_filter": type_filter,
            "event_type_choices": EVENT_TYPE_CHOICES,
        },
    )


@login_required(login_url="/login/")
def messages_view(request):
    user = request.user
    notifications = NotificationQueue.objects.filter(user=user, channel=CHANNEL_IN_APP).order_by("-scheduled_for")
    return render(
        request,
        "ui/messages.html",
        {
            "notifications": notifications,
        },
    )

----- END FILE: apps/ui/views.py -----

----- BEGIN FILE: apps/ui/views_academic.py -----
from django.contrib import messages
from django.contrib.auth.decorators import login_required
from django.shortcuts import get_object_or_404, redirect, render
from django.utils.translation import gettext_lazy as _

from semester.models import Assessment, Course, Semester
from ui.forms_academic import AssessmentForm, CourseForm, SemesterForm
from ui.services_academic import build_course_progress


@login_required(login_url="/login/")
def semester_list_view(request):
    semesters = Semester.objects.filter(user=request.user).order_by("-start_date")
    return render(request, "ui/semester/semester_list.html", {"semesters": semesters})


@login_required(login_url="/login/")
def semester_create_view(request):
    if request.method == "POST":
        form = SemesterForm(request.POST)
        if form.is_valid():
            semester = form.save(commit=False)
            semester.user = request.user
            semester.save()
            messages.success(request, _("Semestre criado com sucesso."))
            return redirect("ui-semester-detail", pk=semester.pk)
    else:
        form = SemesterForm()
    return render(request, "ui/semester/semester_form.html", {"form": form, "mode": "create"})


@login_required(login_url="/login/")
def semester_detail_view(request, pk: int):
    semester = get_object_or_404(Semester, pk=pk, user=request.user)
    courses = semester.courses.all().order_by("title")
    return render(
        request,
        "ui/semester/semester_detail.html",
        {"semester": semester, "courses": courses},
    )


@login_required(login_url="/login/")
def semester_update_view(request, pk: int):
    semester = get_object_or_404(Semester, pk=pk, user=request.user)
    if request.method == "POST":
        form = SemesterForm(request.POST, instance=semester)
        if form.is_valid():
            form.save()
            messages.success(request, _("Semestre atualizado com sucesso."))
            return redirect("ui-semester-detail", pk=semester.pk)
    else:
        form = SemesterForm(instance=semester)
    return render(
        request,
        "ui/semester/semester_form.html",
        {"form": form, "semester": semester, "mode": "edit"},
    )


@login_required(login_url="/login/")
def semester_delete_view(request, pk: int):
    semester = get_object_or_404(Semester, pk=pk, user=request.user)
    if request.method == "POST":
        semester.delete()
        messages.success(request, _("Semestre excluido com sucesso."))
        return redirect("ui-semester-list")
    return render(
        request,
        "ui/semester/semester_confirm_delete.html",
        {"semester": semester},
    )


@login_required(login_url="/login/")
def course_create_view(request, sem_id: int):
    semester = get_object_or_404(Semester, pk=sem_id, user=request.user)
    if request.method == "POST":
        form = CourseForm(request.POST)
        if form.is_valid():
            course = form.save(commit=False)
            course.semester = semester
            course.save()
            messages.success(request, _("Disciplina criada com sucesso."))
            return redirect("ui-course-detail", pk=course.pk)
    else:
        form = CourseForm()
    return render(
        request,
        "ui/course/course_form.html",
        {"form": form, "semester": semester, "mode": "create"},
    )


@login_required(login_url="/login/")
def course_detail_view(request, pk: int):
    course = get_object_or_404(Course, pk=pk, semester__user=request.user)
    assessments = course.assessments.all().order_by("-date", "-created_at")
    progress = build_course_progress(course)
    return render(
        request,
        "ui/course/course_detail.html",
        {"course": course, "assessments": assessments, "progress": progress},
    )


@login_required(login_url="/login/")
def course_update_view(request, pk: int):
    course = get_object_or_404(Course, pk=pk, semester__user=request.user)
    if request.method == "POST":
        form = CourseForm(request.POST, instance=course)
        if form.is_valid():
            form.save()
            messages.success(request, _("Disciplina atualizada com sucesso."))
            return redirect("ui-course-detail", pk=course.pk)
    else:
        form = CourseForm(instance=course)
    return render(
        request,
        "ui/course/course_form.html",
        {"form": form, "course": course, "semester": course.semester, "mode": "edit"},
    )


@login_required(login_url="/login/")
def course_delete_view(request, pk: int):
    course = get_object_or_404(Course, pk=pk, semester__user=request.user)
    if request.method == "POST":
        semester_id = course.semester_id
        course.delete()
        messages.success(request, _("Disciplina excluida com sucesso."))
        return redirect("ui-semester-detail", pk=semester_id)
    return render(
        request,
        "ui/course/course_confirm_delete.html",
        {"course": course},
    )


@login_required(login_url="/login/")
def assessment_create_view(request, course_id: int):
    course = get_object_or_404(Course, pk=course_id, semester__user=request.user)
    if request.method == "POST":
        form = AssessmentForm(request.POST)
        if form.is_valid():
            assessment = form.save(commit=False)
            assessment.course = course
            assessment.save()
            messages.success(request, _("Avaliacao criada com sucesso."))
            return redirect("ui-course-detail", pk=course.pk)
    else:
        form = AssessmentForm()
    return render(
        request,
        "ui/assessment/assessment_form.html",
        {"form": form, "course": course, "mode": "create"},
    )


@login_required(login_url="/login/")
def assessment_update_view(request, pk: int):
    assessment = get_object_or_404(Assessment, pk=pk, course__semester__user=request.user)
    if request.method == "POST":
        form = AssessmentForm(request.POST, instance=assessment)
        if form.is_valid():
            form.save()
            messages.success(request, _("Avaliacao atualizada com sucesso."))
            return redirect("ui-course-detail", pk=assessment.course_id)
    else:
        form = AssessmentForm(instance=assessment)
    return render(
        request,
        "ui/assessment/assessment_form.html",
        {"form": form, "course": assessment.course, "assessment": assessment, "mode": "edit"},
    )


@login_required(login_url="/login/")
def assessment_delete_view(request, pk: int):
    assessment = get_object_or_404(Assessment, pk=pk, course__semester__user=request.user)
    if request.method == "POST":
        course_id = assessment.course_id
        assessment.delete()
        messages.success(request, _("Avaliacao excluida com sucesso."))
        return redirect("ui-course-detail", pk=course_id)
    return render(
        request,
        "ui/assessment/assessment_confirm_delete.html",
        {"assessment": assessment, "course": assessment.course},
    )

----- END FILE: apps/ui/views_academic.py -----

----- BEGIN FILE: apps/ui/views_agenda.py -----
from django.contrib import messages
from django.contrib.auth.decorators import login_required
from django.shortcuts import get_object_or_404, redirect, render
from django.utils import timezone
from django.utils.translation import gettext_lazy as _

from agenda.models import CalendarEvent
from notifications.services.reminder_queue import create_notifications_for_event
from ui.forms_agenda import CalendarEventForm


@login_required(login_url="/login/")
def agenda_list_view(request):
    events = CalendarEvent.objects.filter(user=request.user).order_by("start_at")
    return render(
        request,
        "ui/agenda/agenda_list.html",
        {
            "events": events,
            "now": timezone.now(),
        },
    )


@login_required(login_url="/login/")
def agenda_create_view(request):
    if request.method == "POST":
        form = CalendarEventForm(request.POST, user=request.user)
        if form.is_valid():
            event = form.save(commit=False)
            event.user = request.user
            event.save()
            # Bloco: Criacao de lembretes para evento
            create_notifications_for_event(request.user, event)
            messages.success(request, _("Evento criado com sucesso."))
            return redirect("ui-agenda-list")
    else:
        form = CalendarEventForm(user=request.user)
    return render(request, "ui/agenda/agenda_form.html", {"form": form, "mode": "create"})


@login_required(login_url="/login/")
def agenda_update_view(request, pk: int):
    event = get_object_or_404(CalendarEvent, pk=pk, user=request.user)
    if request.method == "POST":
        form = CalendarEventForm(request.POST, instance=event, user=request.user)
        if form.is_valid():
            event = form.save()
            # Bloco: Atualizacao de lembretes para evento
            create_notifications_for_event(request.user, event)
            messages.success(request, _("Evento atualizado com sucesso."))
            return redirect("ui-agenda-list")
    else:
        form = CalendarEventForm(instance=event, user=request.user)
    return render(request, "ui/agenda/agenda_form.html", {"form": form, "mode": "edit", "event": event})


@login_required(login_url="/login/")
def agenda_delete_view(request, pk: int):
    event = get_object_or_404(CalendarEvent, pk=pk, user=request.user)
    if request.method == "POST":
        event.delete()
        messages.success(request, _("Evento excluido com sucesso."))
        return redirect("ui-agenda-list")
    return render(request, "ui/agenda/agenda_confirm_delete.html", {"event": event})

----- END FILE: apps/ui/views_agenda.py -----

----- BEGIN FILE: apps/ui/views_messages.py -----
from django.contrib.auth.decorators import login_required
from django.shortcuts import render
from django.utils.translation import gettext_lazy as _

from notifications.models import NotificationQueue
from utils.constants import CHANNEL_CHOICES, NOTIFICATION_STATUS_CHOICES


@login_required(login_url="/login/")
def message_list_view(request):
    status_filter = request.GET.get("status", "")
    channel_filter = request.GET.get("channel", "")

    notifications = NotificationQueue.objects.filter(user=request.user)
    if status_filter:
        notifications = notifications.filter(status=status_filter)
    if channel_filter:
        notifications = notifications.filter(channel=channel_filter)

    notifications = notifications.order_by("-scheduled_for", "-created_at")

    return render(
        request,
        "ui/messages/message_list.html",
        {
            "notifications": notifications,
            "status_filter": status_filter,
            "channel_filter": channel_filter,
            "status_choices": NOTIFICATION_STATUS_CHOICES,
            "channel_choices": CHANNEL_CHOICES,
        },
    )

----- END FILE: apps/ui/views_messages.py -----

----- BEGIN FILE: apps/ui/views_reminders.py -----
from django.contrib import messages
from django.contrib.auth.decorators import login_required
from django.shortcuts import get_object_or_404, redirect, render
from django.utils.translation import gettext_lazy as _

from agenda.models import ReminderRule
from notifications.services.reminder_queue import create_notifications_for_user
from ui.forms_reminders import ReminderRuleForm


@login_required(login_url="/login/")
def reminder_list_view(request):
    reminders = ReminderRule.objects.filter(user=request.user).order_by("-is_active", "remind_before_minutes")
    return render(request, "ui/reminders/reminder_list.html", {"reminders": reminders})


# Bloco: Gerar lembretes via interface web
@login_required(login_url="/login/")
def reminder_generate_view(request):
    if request.method != "POST":
        return redirect("ui-reminder-list")

    created = create_notifications_for_user(request.user)
    if created:
        messages.success(request, _("Lembretes gerados com sucesso."))
    else:
        messages.info(request, _("Nenhum lembrete novo foi gerado."))
    return redirect("ui-reminder-list")


@login_required(login_url="/login/")
def reminder_create_view(request):
    if request.method == "POST":
        form = ReminderRuleForm(request.POST)
        if form.is_valid():
            reminder = form.save(commit=False)
            reminder.user = request.user
            reminder.save()
            messages.success(request, _("Regra de lembrete criada com sucesso."))
            return redirect("ui-reminder-list")
    else:
        form = ReminderRuleForm()
    return render(request, "ui/reminders/reminder_form.html", {"form": form, "mode": "create"})


@login_required(login_url="/login/")
def reminder_update_view(request, pk: int):
    reminder = get_object_or_404(ReminderRule, pk=pk, user=request.user)
    if request.method == "POST":
        form = ReminderRuleForm(request.POST, instance=reminder)
        if form.is_valid():
            form.save()
            messages.success(request, _("Regra de lembrete atualizada com sucesso."))
            return redirect("ui-reminder-list")
    else:
        form = ReminderRuleForm(instance=reminder)
    return render(
        request,
        "ui/reminders/reminder_form.html",
        {"form": form, "mode": "edit", "reminder": reminder},
    )


@login_required(login_url="/login/")
def reminder_delete_view(request, pk: int):
    reminder = get_object_or_404(ReminderRule, pk=pk, user=request.user)
    if request.method == "POST":
        reminder.delete()
        messages.success(request, _("Regra de lembrete excluida com sucesso."))
        return redirect("ui-reminder-list")
    return render(request, "ui/reminders/reminder_confirm_delete.html", {"reminder": reminder})

----- END FILE: apps/ui/views_reminders.py -----

----- BEGIN FILE: apps/ui/views_tasks.py -----
from django.contrib import messages
from django.contrib.auth.decorators import login_required
from django.db.models import Q
from django.shortcuts import get_object_or_404, redirect, render
from django.utils.translation import gettext_lazy as _

from notifications.services.reminder_queue import create_notifications_for_task
from planner.models import Task
from ui.forms_tasks import TaskForm
from utils.constants import TASK_DONE, TASK_DOING, TASK_TODO


@login_required(login_url="/login/")
def task_list_view(request):
    tasks = Task.objects.filter(user=request.user)
    status_filter = request.GET.get("status", "")
    query = request.GET.get("q", "").strip()

    if status_filter in {TASK_TODO, TASK_DOING, TASK_DONE}:
        tasks = tasks.filter(status=status_filter)
    if query:
        tasks = tasks.filter(Q(title__icontains=query) | Q(description__icontains=query))

    tasks = tasks.order_by("due_date")

    return render(
        request,
        "ui/tasks/task_list.html",
        {
            "tasks": tasks,
            "status_filter": status_filter,
            "query": query,
        },
    )


@login_required(login_url="/login/")
def task_create_view(request):
    if request.method == "POST":
        form = TaskForm(request.POST)
        if form.is_valid():
            task = form.save(commit=False)
            task.user = request.user
            task.save()
            # Bloco: Criacao de lembretes para tarefa
            create_notifications_for_task(request.user, task)
            messages.success(request, _("Tarefa criada com sucesso."))
            return redirect("ui-task-detail", pk=task.pk)
    else:
        form = TaskForm()
    return render(request, "ui/tasks/task_form.html", {"form": form, "mode": "create"})


@login_required(login_url="/login/")
def task_detail_view(request, pk: int):
    task = get_object_or_404(Task, pk=pk, user=request.user)
    return render(request, "ui/tasks/task_detail.html", {"task": task})


@login_required(login_url="/login/")
def task_update_view(request, pk: int):
    task = get_object_or_404(Task, pk=pk, user=request.user)
    if request.method == "POST":
        form = TaskForm(request.POST, instance=task)
        if form.is_valid():
            task = form.save()
            # Bloco: Atualizacao de lembretes para tarefa
            create_notifications_for_task(request.user, task)
            messages.success(request, _("Tarefa atualizada com sucesso."))
            return redirect("ui-task-detail", pk=task.pk)
    else:
        form = TaskForm(instance=task)
    return render(request, "ui/tasks/task_form.html", {"form": form, "mode": "edit", "task": task})


@login_required(login_url="/login/")
def task_delete_view(request, pk: int):
    task = get_object_or_404(Task, pk=pk, user=request.user)
    if request.method == "POST":
        task.delete()
        messages.success(request, _("Tarefa excluida com sucesso."))
        return redirect("ui-task-list")
    return render(request, "ui/tasks/task_confirm_delete.html", {"task": task})

----- END FILE: apps/ui/views_tasks.py -----

----- BEGIN FILE: config/asgi.py -----
"""
ASGI config for config project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/4.2/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

application = get_asgi_application()

----- END FILE: config/asgi.py -----

----- BEGIN FILE: config/settings.py -----
"""
Django settings for campus_calm project.
"""

import os
import sys
from pathlib import Path

from django.utils.translation import gettext_lazy as _

BASE_DIR = Path(__file__).resolve().parent.parent

# Ensure /apps is on the path for INSTALLED_APPS like "accounts"
sys.path.insert(0, str(BASE_DIR / "apps"))

SECRET_KEY = os.getenv("DJANGO_SECRET_KEY", "django-insecure-dev-key")
DEBUG = os.getenv("DJANGO_DEBUG", "True").lower() == "true"
_allowed_hosts_env = [host for host in os.getenv("DJANGO_ALLOWED_HOSTS", "").split(",") if host]
if _allowed_hosts_env:
    ALLOWED_HOSTS = _allowed_hosts_env
elif DEBUG:
    ALLOWED_HOSTS = ["localhost", "127.0.0.1", "[::1]", ".ngrok-free.app", ".ngrok-free.dev", ".ngrok.io"]
else:
    ALLOWED_HOSTS = []

INSTALLED_APPS = [
    "django.contrib.admin",
    "django.contrib.auth",
    "django.contrib.contenttypes",
    "django.contrib.sessions",
    "django.contrib.messages",
    "django.contrib.staticfiles",
    "corsheaders",
    "rest_framework",
    "rest_framework_simplejwt",
    "drf_spectacular",
    "accounts",
    "billing.apps.BillingConfig",
    "mood",
    "pomodoro",
    "planner",
    "agenda",
    "semester",
    "content",
    "coach_ai",
    "brain",
    "notifications",
    "access_requests",
    "onboarding.apps.OnboardingConfig",
    "analytics",
    "ui.apps.UiConfig",
]

MIDDLEWARE = [
    "corsheaders.middleware.CorsMiddleware",
    "django.middleware.security.SecurityMiddleware",
    "django.contrib.sessions.middleware.SessionMiddleware",
    "django.middleware.locale.LocaleMiddleware",
    "django.middleware.common.CommonMiddleware",
    "django.middleware.csrf.CsrfViewMiddleware",
    "django.contrib.auth.middleware.AuthenticationMiddleware",
    "django.contrib.messages.middleware.MessageMiddleware",
    "django.middleware.clickjacking.XFrameOptionsMiddleware",
]

ROOT_URLCONF = "config.urls"

TEMPLATES = [
    {
        "BACKEND": "django.template.backends.django.DjangoTemplates",
        "DIRS": [BASE_DIR / "templates"],
        "APP_DIRS": True,
        "OPTIONS": {
            "context_processors": [
                "django.template.context_processors.debug",
                "django.template.context_processors.request",
                "django.contrib.auth.context_processors.auth",
                "django.contrib.messages.context_processors.messages",
            ],
        },
    }
]

WSGI_APPLICATION = "config.wsgi.application"

DATABASES = {
    "default": {
        "ENGINE": "django.db.backends.sqlite3",
        "NAME": BASE_DIR / "db.sqlite3",
    }
}

AUTH_PASSWORD_VALIDATORS = [
    {"NAME": "django.contrib.auth.password_validation.UserAttributeSimilarityValidator"},
    {"NAME": "django.contrib.auth.password_validation.MinimumLengthValidator"},
    {"NAME": "django.contrib.auth.password_validation.CommonPasswordValidator"},
    {"NAME": "django.contrib.auth.password_validation.NumericPasswordValidator"},
]

LANGUAGE_CODE = "pt-br"
TIME_ZONE = "America/Sao_Paulo"
USE_I18N = True
USE_TZ = True
LANGUAGES = [
    ("en", _("English")),
    ("pt-br", _("Portugus (Brasil)")),
    ("pt-pt", _("Portugus (Portugal)")),
]
LOCALE_PATHS = [BASE_DIR / "locale"]

STATIC_URL = "/static/"
STATICFILES_DIRS = [BASE_DIR / "static"]

MEDIA_URL = "/media/"
MEDIA_ROOT = BASE_DIR / "media"

DEFAULT_AUTO_FIELD = "django.db.models.BigAutoField"
AUTH_USER_MODEL = "accounts.User"

REST_FRAMEWORK = {
    "DEFAULT_AUTHENTICATION_CLASSES": (
        "rest_framework_simplejwt.authentication.JWTAuthentication",
    ),
    "DEFAULT_PERMISSION_CLASSES": ("rest_framework.permissions.IsAuthenticated",),
    "DEFAULT_SCHEMA_CLASS": "drf_spectacular.openapi.AutoSchema",
}

SPECTACULAR_SETTINGS = {
    "TITLE": "Campus Calm API",
    "DESCRIPTION": "API do MVP Campus Calm",
    "VERSION": "0.1.0",
}

CORS_ALLOW_ALL_ORIGINS = True

EMAIL_BACKEND = "django.core.mail.backends.console.EmailBackend"
DEFAULT_FROM_EMAIL = os.getenv("DEFAULT_FROM_EMAIL", "no-reply@campuscalm.local")

LOGIN_URL = "/login/"
LOGIN_REDIRECT_URL = "/"
LOGOUT_REDIRECT_URL = "/login/"

# Bloco: WhatsApp Cloud API
WHATSAPP_CLOUD_TOKEN = os.getenv("WHATSAPP_CLOUD_TOKEN", "")
WHATSAPP_PHONE_NUMBER_ID = os.getenv("WHATSAPP_PHONE_NUMBER_ID", "")
WHATSAPP_VERIFY_TOKEN = os.getenv("WHATSAPP_VERIFY_TOKEN", "")
SITE_BASE_URL = os.getenv("SITE_BASE_URL", "")

# Brain contextual memory settings (MVP 1.4)
BRAIN_MEMORY_HOURS = 48
BRAIN_HISTORY_LIMIT = 10
BRAIN_STRESS_REPEAT_THRESHOLD = 3
BRAIN_EVOLUCAO_REPEAT_THRESHOLD = 2
BRAIN_STRESS_TO_EVOLUCAO_WINDOW_HOURS = 24

if DEBUG:
    CSRF_TRUSTED_ORIGINS = [
        "https://*.ngrok-free.app",
        "https://*.ngrok-free.dev",
        "https://*.ngrok.io",
    ]

----- END FILE: config/settings.py -----

----- BEGIN FILE: config/settings_migrations.py -----
"""Settings file for generating migrations without third-party dependencies."""

import os
import sys
from pathlib import Path

BASE_DIR = Path(__file__).resolve().parent.parent
sys.path.insert(0, str(BASE_DIR / "apps"))

SECRET_KEY = "migration-only"
DEBUG = True
ALLOWED_HOSTS = []

INSTALLED_APPS = [
    "django.contrib.admin",
    "django.contrib.auth",
    "django.contrib.contenttypes",
    "django.contrib.sessions",
    "django.contrib.messages",
    "django.contrib.staticfiles",
    "accounts",
    "billing.apps.BillingConfig",
    "mood",
    "pomodoro",
    "planner",
    "agenda",
    "semester",
    "content",
    "coach_ai",
    "brain",
    "notifications",
    "access_requests",
    "onboarding.apps.OnboardingConfig",
    "analytics",
    "ui.apps.UiConfig",
]

MIDDLEWARE = [
    "django.middleware.security.SecurityMiddleware",
    "django.contrib.sessions.middleware.SessionMiddleware",
    "django.middleware.common.CommonMiddleware",
    "django.middleware.csrf.CsrfViewMiddleware",
    "django.contrib.auth.middleware.AuthenticationMiddleware",
    "django.contrib.messages.middleware.MessageMiddleware",
    "django.middleware.clickjacking.XFrameOptionsMiddleware",
]

ROOT_URLCONF = "config.urls"

TEMPLATES = [
    {
        "BACKEND": "django.template.backends.django.DjangoTemplates",
        "DIRS": [BASE_DIR / "templates"],
        "APP_DIRS": True,
        "OPTIONS": {
            "context_processors": [
                "django.template.context_processors.debug",
                "django.template.context_processors.request",
                "django.contrib.auth.context_processors.auth",
                "django.contrib.messages.context_processors.messages",
            ],
        },
    }
]

DATABASES = {
    "default": {
        "ENGINE": "django.db.backends.sqlite3",
        "NAME": BASE_DIR / "db.sqlite3",
    }
}

LANGUAGE_CODE = "pt-br"
TIME_ZONE = "America/Sao_Paulo"
USE_I18N = True
USE_TZ = True

STATIC_URL = "/static/"
MEDIA_URL = "/media/"
MEDIA_ROOT = BASE_DIR / "media"

DEFAULT_AUTO_FIELD = "django.db.models.BigAutoField"
AUTH_USER_MODEL = "accounts.User"

----- END FILE: config/settings_migrations.py -----

----- BEGIN FILE: config/urls.py -----
from django.conf import settings
from django.conf.urls.static import static
from django.contrib import admin
from django.urls import include, path
from drf_spectacular.views import SpectacularAPIView, SpectacularSwaggerView

from config.views import health_check

urlpatterns = [
    path("admin/", admin.site.urls),
    path("health/", health_check, name="health-check"),
    path("i18n/", include("django.conf.urls.i18n")),
    path("", include("ui.urls")),
    path("api/schema/", SpectacularAPIView.as_view(), name="schema"),
    path("api/docs/", SpectacularSwaggerView.as_view(url_name="schema"), name="docs"),
    path("api/auth/", include("accounts.urls")),
    path("api/billing/", include("billing.urls")),
    path("api/mood/", include("mood.urls")),
    path("api/pomodoro/", include("pomodoro.urls")),
    path("api/planner/", include("planner.urls")),
    path("api/agenda/", include("agenda.urls")),
    path("api/semester/", include("semester.urls")),
    path("api/content/", include("content.urls")),
    path("api/widget/", include("brain.urls")),
    path("api/notifications/", include("notifications.urls")),
    path("api/access/", include("access_requests.urls")),
    path("api/onboarding/", include("onboarding.urls")),
    path("api/analytics/", include("analytics.urls")),
]

if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)

----- END FILE: config/urls.py -----

----- BEGIN FILE: config/views.py -----
from django.http import JsonResponse
from django.utils import timezone


def health_check(_request):
    return JsonResponse({"status": "ok", "timestamp": timezone.now().isoformat()})

----- END FILE: config/views.py -----

----- BEGIN FILE: config/wsgi.py -----
"""
WSGI config for config project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/4.2/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

application = get_wsgi_application()

----- END FILE: config/wsgi.py -----

----- BEGIN FILE: manage.py -----
#!/usr/bin/env python3
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()

----- END FILE: manage.py -----

----- BEGIN FILE: requirements.txt -----
Django>=5.0
djangorestframework>=3.15
djangorestframework-simplejwt>=5.3
django-cors-headers>=4.3
drf-spectacular>=0.27
requests>=2.31

----- END FILE: requirements.txt -----

----- BEGIN FILE: scripts/i18n_refresh.sh -----
#!/usr/bin/env bash
set -euo pipefail

if ! command -v msguniq >/dev/null 2>&1 || ! command -v msgfmt >/dev/null 2>&1; then
  echo "GNU gettext tools (msguniq/msgfmt) not found. Install gettext and re-run."
  exit 1
fi

python3 manage.py makemessages -l en -l pt_BR -l pt_PT
python3 manage.py compilemessages

----- END FILE: scripts/i18n_refresh.sh -----

----- BEGIN FILE: scripts/run_curl_demo.sh -----
#!/usr/bin/env bash
set -euo pipefail

API_HOST="${API_HOST:-http://localhost:8000}"
EMAIL="${API_EMAIL:-nari.naluu@gmail.com}"
PASSWORD="${API_PASSWORD:-Pucca&garu@20}"

login_response=$(curl -s -X POST "${API_HOST}/api/auth/login/" \
  -H "Content-Type: application/json" \
  -d "{\"email\":\"${EMAIL}\",\"password\":\"${PASSWORD}\"}")

access=$(printf '%s' "$login_response" | python3 - <<'PY'
import json, sys
try:
    data = json.load(sys.stdin)
    print(data.get("access", ""))
except Exception:
    print("", end="")
PY
)

if [ -z "$access" ]; then
  echo "Falha no login. Resposta:" >&2
  echo "$login_response" >&2
  exit 1
fi

bearer="Authorization: Bearer $access"

echo "== /api/auth/me/"
curl -s -H "$bearer" "${API_HOST}/api/auth/me/" | python3 -m json.tool

echo "== /api/mood/entries/"
curl -s -H "$bearer" "${API_HOST}/api/mood/entries/" | python3 -m json.tool

echo "== /api/planner/tasks/"
curl -s -H "$bearer" "${API_HOST}/api/planner/tasks/" | python3 -m json.tool

echo "== /api/agenda/week/"
curl -s -H "$bearer" "${API_HOST}/api/agenda/week/" | python3 -m json.tool

echo "== /api/semester/courses/"
course_list=$(curl -s -H "$bearer" "${API_HOST}/api/semester/courses/")
course_id=$(printf '%s' "$course_list" | python3 - <<'PY'
import json, sys
try:
    data = json.load(sys.stdin)
    if data:
        print(data[0].get("id", ""))
except Exception:
    print("")
PY
)

echo "$course_list" | python3 -m json.tool

if [ -n "$course_id" ]; then
  echo "== /api/semester/courses/${course_id}/progress/"
  curl -s -H "$bearer" "${API_HOST}/api/semester/courses/${course_id}/progress/" | python3 -m json.tool
fi

echo "== /api/content/guided/"
curl -s -H "$bearer" "${API_HOST}/api/content/guided/" | python3 -m json.tool

echo "== /api/onboarding/status/"
curl -s -H "$bearer" "${API_HOST}/api/onboarding/status/" | python3 -m json.tool

echo "== /api/analytics/dashboard/"
curl -s -H "$bearer" "${API_HOST}/api/analytics/dashboard/" | python3 -m json.tool

----- END FILE: scripts/run_curl_demo.sh -----

----- BEGIN FILE: static/css/app.css -----
:root {
  --sidebar-width: 220px;
  --sidebar-bg: #ffffff;
  --primary-soft: #e8f0fb;
  --brand: #1d4ed8;
}

body {
  font-family: "Sora", system-ui, sans-serif;
}

.sidebar {
  width: var(--sidebar-width);
  min-height: 100vh;
  position: fixed;
  left: 0;
  top: 0;
  padding-top: 0;
  box-shadow: 0 0 12px rgba(15, 23, 42, 0.04);
}

.content {
  margin-left: var(--sidebar-width);
  min-height: 100vh;
}

.nav-link {
  color: #334155;
  padding: 0.5rem 0.75rem;
  margin-bottom: 4px;
}

.nav-link:hover {
  background: var(--primary-soft);
  border-radius: 6px;
}

.nav-link.active {
  background: #dbe7f8;
  border-radius: 6px;
  font-weight: 600;
}

.sidebar-panel-title {
  display: block;
  width: 100%;
  padding: 0.35rem 0.75rem;
  border-radius: 8px;
  background: #effaf2;
  color: #2f6f45;
  font-weight: 700;
  font-size: 0.9rem;
  line-height: 1.1;
  text-align: center;
  box-sizing: border-box;
}

.card {
  border-radius: 10px;
  border: 1px solid #e2e8f0;
}

.card-soft-blue {
  background-color: #edf4ff !important;
  border-color: #dce9ff !important;
}

.card-soft-green {
  background-color: #eef8f2 !important;
  border-color: #d8eee2 !important;
}

.card-soft-amber {
  background-color: #fff5ec !important;
  border-color: #f7e6d6 !important;
}

.card-soft-purple {
  background-color: #f3f0ff !important;
  border-color: #e5defa !important;
}

.bg-auth {
  min-height: 100vh;
  background: radial-gradient(circle at top left, #e2e8f0, #f8fafc 60%);
  position: relative;
  overflow: hidden;
}

.auth-shell {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 24px;
  position: relative;
  z-index: 1;
}

.auth-language-switcher {
  z-index: 2;
}

.auth-card {
  background: #ffffff;
  border-radius: 16px;
  width: min(420px, 100%);
  overflow: hidden;
  border: 1px solid #e2e8f0;
}

.auth-header {
  padding: 28px 28px 16px;
  background: linear-gradient(135deg, #1d4ed8, #3b82f6);
  color: #fff;
}

.auth-logo {
  font-weight: 700;
  font-size: 1.25rem;
  letter-spacing: 0.2px;
}

.auth-subtitle {
  font-size: 0.85rem;
  opacity: 0.9;
}

.brand-logo {
  width: 44px;
  height: 44px;
  object-fit: contain;
}

.brand-logo-large {
  width: 180px;
  height: 180px;
  object-fit: contain;
  margin-bottom: -32px;
}

.auth-logo-img {
  width: 56px;
  height: 56px;
  object-fit: contain;
  margin-bottom: 8px;
}

.auth-body {
  padding: 24px 28px 28px;
}

.bg-auth::before,
.bg-auth::after {
  content: "";
  position: absolute;
  width: 320px;
  height: 320px;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, rgba(59, 130, 246, 0.25), transparent 60%);
  filter: blur(2px);
}

.bg-auth::before {
  top: -80px;
  right: -120px;
}

.bg-auth::after {
  bottom: -100px;
  left: -120px;
}

----- END FILE: static/css/app.css -----

----- BEGIN FILE: static/css/home.css -----
:root {
  --brand: #1d3b5f;
  --brand-strong: #0f2a4a;
  --brand-soft: #e4edf7;
  --brand-soft-2: #eff4fb;
  --ink: #1f2a3a;
  --muted: #5d6b82;
  --bg: #f2f5f9;
  --surface: #ffffff;
  --border: #e4e9f1;
  --shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
  --radius: 18px;
  --side-width: 250px;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: "IBM Plex Sans", "Segoe UI", sans-serif;
  color: var(--ink);
  background: linear-gradient(180deg, #f7f9fc 0%, #eef2f7 100%);
  line-height: 1.6;
}

a {
  color: inherit;
  text-decoration: none;
}

.container {
  width: min(1180px, 92vw);
  margin: 0 auto;
}

.page-shell {
  display: flex;
  min-height: 100vh;
}

.side-panel {
  width: var(--side-width);
  background: #f8fafd;
  color: var(--ink);
  padding: 32px 22px;
  display: flex;
  flex-direction: column;
  gap: 24px;
  position: sticky;
  top: 0;
  height: 100vh;
  border-right: 1px solid var(--border);
}

.side-brand {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
}

.side-logo {
  width: 150px;
  height: 150px;
  object-fit: contain;
  margin-bottom: 12px;
}

.side-title {
  font-weight: 600;
  font-size: 1.05rem;
  margin-bottom: 4px;
}

.side-subtitle {
  font-size: 0.95rem;
  color: var(--muted);
}

.side-nav {
  display: grid;
  gap: 10px;
}

.side-nav a {
  padding: 12px 16px;
  border-radius: 12px;
  background: transparent;
  color: var(--muted);
  font-size: 0.95rem;
  transition: background 0.2s ease, color 0.2s ease;
}

.side-nav a:hover,
.side-nav a:focus {
  background: var(--brand-soft-2);
  color: var(--brand-strong);
}

.side-nav a.active {
  background: var(--brand-soft);
  color: var(--brand-strong);
  font-weight: 600;
}

.page-body {
  flex: 1;
  padding-bottom: 32px;
}

/* Bloco Header */
.site-header {
  position: sticky;
  top: 0;
  background: rgba(242, 245, 249, 0.92);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid var(--border);
  z-index: 10;
}

.header-content {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 18px 0;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 18px;
}

.brand {
  display: flex;
  align-items: center;
  gap: 16px;
}

.brand-logo {
  height: 72px;
  width: auto;
}

.brand-copy {
  max-width: 360px;
}

.brand-title {
  font-weight: 600;
  font-size: 1.25rem;
  margin-bottom: 4px;
}

.brand-tagline {
  font-size: 0.9rem;
  color: var(--muted);
  line-height: 1.4;
  font-weight: 600;
}

.site-nav {
  display: flex;
  gap: 10px;
  font-size: 0.95rem;
  color: var(--muted);
}

.site-nav a {
  padding: 6px 12px;
  border-radius: 999px;
  background: transparent;
  transition: background 0.2s ease, color 0.2s ease;
}

.site-nav a:hover,
.site-nav a:focus {
  background: var(--brand-soft);
  color: var(--brand-strong);
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 12px;
}

.header-link {
  font-size: 0.9rem;
  color: var(--muted);
  font-weight: 500;
}

.header-link:hover,
.header-link:focus {
  color: var(--brand-strong);
}

/* Bloco Hero */
.hero {
  padding: 48px 0 28px;
}

.hero-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 32px;
  align-items: stretch;
}

.hero-copy {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 32px;
  box-shadow: var(--shadow);
}

.eyebrow {
  text-transform: uppercase;
  font-size: 0.72rem;
  letter-spacing: 0.12em;
  color: var(--brand-strong);
  font-weight: 600;
  margin-bottom: 12px;
}

.hero h1 {
  font-size: clamp(2.2rem, 3.5vw, 3.4rem);
  line-height: 1.2;
  margin-bottom: 14px;
}

.lead {
  color: var(--muted);
  margin-bottom: 22px;
  font-size: 1rem;
  max-width: 56ch;
}

.hero-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
}

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 11px 20px;
  border-radius: 999px;
  font-weight: 600;
  border: 1px solid transparent;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.btn-primary {
  background: var(--brand);
  color: #fff;
}

.btn-secondary {
  background: #ffffff;
  color: var(--brand-strong);
  border-color: var(--border);
}

.btn-ghost {
  background: transparent;
  color: var(--brand-strong);
  border-color: #dbe3ee;
}

.btn-primary:hover,
.btn-primary:focus {
  transform: translateY(-1px);
  box-shadow: 0 12px 24px rgba(15, 42, 74, 0.2);
}

.btn-secondary:hover,
.btn-secondary:focus,
.btn-ghost:hover,
.btn-ghost:focus {
  transform: translateY(-1px);
  box-shadow: 0 10px 20px rgba(15, 42, 74, 0.12);
}

.hero-panel {
  display: flex;
  align-items: stretch;
  justify-content: flex-end;
}

.hero-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 28px;
  box-shadow: var(--shadow);
  width: 100%;
  animation: fadeInUp 0.6s ease both;
}

.hero-tag {
  display: inline-block;
  padding: 4px 12px;
  background: var(--brand-soft);
  color: var(--brand-strong);
  border-radius: 999px;
  font-size: 0.8rem;
  font-weight: 600;
  margin-bottom: 16px;
}

.hero-card h2 {
  font-size: 1.35rem;
  margin-bottom: 12px;
}

.hero-card p {
  color: var(--muted);
  margin-bottom: 20px;
}

.hero-metrics {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 12px;
}

.metric-title {
  display: block;
  font-weight: 600;
  color: var(--brand-strong);
  font-size: 0.9rem;
}

.metric-text {
  font-size: 0.85rem;
  color: var(--muted);
}

/* Bloco Sees */
.section {
  padding: 48px 0;
}

.section-alt {
  background: linear-gradient(180deg, #f8fbff, #f1f5f9);
}

.section-header {
  max-width: 720px;
  margin-bottom: 32px;
}

.section-header h2 {
  font-size: 2rem;
  margin-bottom: 12px;
}

.section-header p {
  color: var(--muted);
}

.feature-grid {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 22px;
}

.feature-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 22px;
  box-shadow: 0 12px 30px rgba(15, 23, 42, 0.06);
}

.feature-card h3 {
  margin-bottom: 10px;
  font-size: 1.15rem;
}

.feature-card p {
  color: var(--muted);
}

.link-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 32px;
  align-items: center;
}

.institution-card {
  background: var(--surface);
  border-left: 4px solid var(--brand);
  border-radius: 16px;
  padding: 24px 28px;
  box-shadow: 0 14px 30px rgba(15, 23, 42, 0.08);
}

.institution-title {
  font-weight: 700;
  margin-bottom: 8px;
}

.pillar-grid {
  display: grid;
  grid-template-columns: repeat(12, minmax(0, 1fr));
  gap: 20px;
}

.pillar-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 22px;
  min-height: 200px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  box-shadow: 0 8px 18px rgba(15, 23, 42, 0.06);
  animation: fadeInUp 0.7s ease both;
}

.pillar-card-primary {
  border-color: #c9d8ec;
  background: linear-gradient(180deg, #f9fbff, #f3f7fd);
}

.pillar-card-secondary {
  background: #fcfdff;
}

.pillar-badge {
  display: inline-flex;
  align-self: flex-start;
  padding: 4px 10px;
  border-radius: 999px;
  background: var(--brand-soft);
  color: var(--brand-strong);
  font-size: 0.75rem;
  font-weight: 700;
}

.pillar-span-6 {
  grid-column: span 6;
}

.pillar-span-5 {
  grid-column: span 5;
}

.pillar-span-7 {
  grid-column: span 7;
}

.pillar-card:nth-child(2) {
  animation-delay: 0.05s;
}

.pillar-card:nth-child(3) {
  animation-delay: 0.1s;
}

.pillar-card:nth-child(4) {
  animation-delay: 0.15s;
}

/* Bloco Icones dos pilares */
.pillar-icon {
  width: 42px;
  height: 42px;
  border-radius: 12px;
  background: #edf3fb;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.pillar-icon-svg {
  width: 24px;
  height: 24px;
  fill: none;
  stroke: var(--brand-strong);
  stroke-width: 1.7;
  stroke-linecap: round;
  stroke-linejoin: round;
}

.pillar-icon-svg .tone {
  stroke: #6a82a3;
}

.pillar-card h3 {
  font-size: 1.05rem;
}

.pillar-card p {
  color: var(--muted);
}

/* Bloco Rodap */
.site-footer {
  padding: 48px 0 56px;
  border-top: 1px solid var(--border);
  background: #f8fafc;
}

.footer-grid {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 28px;
}

.footer-logo {
  height: 60px;
  width: auto;
}

.footer-brand-row {
  display: flex;
  align-items: center;
  gap: 14px;
  margin-bottom: 12px;
}

.footer-tagline {
  font-size: 0.9rem;
  color: var(--muted);
  line-height: 1.4;
}

.footer-title {
  font-weight: 700;
  font-size: 1.1rem;
  margin-bottom: 6px;
}

.footer-tagline {
  font-weight: 600;
}

.footer-heading {
  font-weight: 600;
  margin-bottom: 8px;
}

.footer-text {
  color: var(--muted);
}

.footer-link {
  color: var(--brand-strong);
  font-weight: 600;
}

/* Bloco Motion */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(16px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@media (prefers-reduced-motion: reduce) {
  * {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

/* Bloco Responsivo */
@media (max-width: 1100px) {
  .side-panel {
    display: none;
  }

  .site-nav { display: flex; }
}

@media (min-width: 1101px) {
  .site-nav {
    display: none;
  }
}

@media (max-width: 960px) {
  .hero-grid,
  .link-grid {
    grid-template-columns: 1fr;
  }

  .hero-panel {
    justify-content: flex-start;
  }

  .feature-grid {
    grid-template-columns: 1fr 1fr;
  }

  .pillar-grid,
  .footer-grid {
    grid-template-columns: 1fr 1fr;
  }

  .pillar-card {
    grid-column: auto;
  }
}

@media (max-width: 720px) {
  .header-content {
    flex-direction: column;
    gap: 16px;
  }

  .header-right {
    width: 100%;
    flex-direction: column;
    align-items: flex-start;
  }

  .header-actions {
    width: 100%;
    justify-content: flex-start;
    flex-wrap: wrap;
  }

  .header-link {
    padding: 8px 0;
  }

  .brand {
    flex-direction: column;
    align-items: flex-start;
  }

  .footer-brand-row {
    flex-direction: column;
    align-items: flex-start;
  }

  .feature-grid,
  .pillar-grid,
  .footer-grid {
    grid-template-columns: 1fr;
  }

  .hero {
    padding-top: 36px;
  }

  .side-logo {
    width: 120px;
    height: 120px;
  }

  .pillar-icon {
    width: 40px;
    height: 40px;
  }

  .pillar-icon-svg {
    width: 22px;
    height: 22px;
  }
}

----- END FILE: static/css/home.css -----

----- BEGIN FILE: static/css/student.css -----
:root {
  --student-bg: #f2f5f9;
  --student-surface: #ffffff;
  --student-border: #e4e9f1;
  --student-muted: #5c6b82;
  --student-ink: #1f2a3a;
  --student-primary: #1d3b5f;
  --student-primary-dark: #0f2a4a;
  --student-primary-soft: #e6eef7;
  --student-radius: 16px;
  --student-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
}

* {
  box-sizing: border-box;
}

.student-body {
  margin: 0;
  font-family: "Sora", system-ui, sans-serif;
  background: var(--student-bg);
  color: var(--student-ink);
}

.student-shell {
  display: flex;
  min-height: 100vh;
}

.student-sidebar {
  width: 250px;
  background: var(--student-surface);
  border-right: 1px solid var(--student-border);
  position: sticky;
  top: 0;
  height: 100vh;
}

.student-sidebar-inner {
  display: flex;
  flex-direction: column;
  height: 100%;
  padding: 24px 20px;
  gap: 20px;
}

.student-brand {
  display: flex;
  align-items: center;
  gap: 12px;
}

.student-brand-logo {
  width: 56px;
  height: 56px;
  object-fit: contain;
}

.student-brand-title {
  font-weight: 600;
  font-size: 1.05rem;
}

.student-brand-subtitle {
  font-size: 0.85rem;
  color: var(--student-muted);
}

.student-user {
  font-size: 0.95rem;
  color: var(--student-muted);
}

.student-language {
  margin-top: 4px;
}

.student-nav {
  display: grid;
  gap: 8px;
}

.student-nav a {
  display: flex;
  align-items: center;
  padding: 10px 12px;
  border-radius: 12px;
  color: var(--student-ink);
  text-decoration: none;
  background: transparent;
  transition: background 0.2s ease, color 0.2s ease;
}

.student-nav a:hover,
.student-nav a:focus {
  background: var(--student-primary-soft);
  color: var(--student-primary);
}

.student-nav a.is-active {
  background: var(--student-primary);
  color: #fff;
}

.student-logout {
  margin-top: auto;
  padding-top: 12px;
  border-top: 1px solid var(--student-border);
}

.student-link {
  background: none;
  border: none;
  color: #d64545;
  font-weight: 600;
  padding: 0;
}

.student-main {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.student-topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 18px 28px;
  border-bottom: 1px solid var(--student-border);
  background: rgba(242, 245, 249, 0.92);
  backdrop-filter: blur(10px);
  position: sticky;
  top: 0;
  z-index: 5;
}

.student-topbar-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.student-greeting {
  margin: 0;
  font-weight: 600;
}

.student-subtitle {
  margin: 0;
  font-size: 0.85rem;
  color: var(--student-muted);
}

.student-topbar-actions {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.student-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 8px 16px;
  border-radius: 999px;
  font-weight: 600;
  font-size: 0.85rem;
  border: 1px solid transparent;
  text-decoration: none;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.student-btn-primary {
  background: var(--student-primary);
  color: #fff;
}

.student-btn-ghost {
  background: #fff;
  border-color: var(--student-border);
  color: var(--student-primary);
}

.student-btn:hover,
.student-btn:focus {
  transform: translateY(-1px);
  box-shadow: 0 10px 18px rgba(15, 23, 42, 0.12);
}

.student-content {
  padding: 28px;
}

.student-container {
  width: min(1120px, 100%);
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.student-page-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  flex-wrap: wrap;
}

.student-page-title {
  margin: 0;
  font-size: 1.4rem;
}

.student-page-subtitle {
  margin: 4px 0 0;
  color: var(--student-muted);
}

.student-search {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.student-card {
  background: var(--student-surface);
  border: 1px solid var(--student-border);
  border-radius: var(--student-radius);
  padding: 20px;
  box-shadow: var(--student-shadow);
}

.student-card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}

.student-card-title {
  margin: 0;
  font-size: 1.05rem;
  font-weight: 600;
}

.student-card-muted {
  color: var(--student-muted);
  font-size: 0.9rem;
}

.student-grid {
  display: grid;
  grid-template-columns: repeat(12, minmax(0, 1fr));
  gap: 16px;
}

.student-span-12 {
  grid-column: span 12;
}

.student-span-7 {
  grid-column: span 7;
}

.student-span-5 {
  grid-column: span 5;
}

.student-span-6 {
  grid-column: span 6;
}

.student-span-4 {
  grid-column: span 4;
}

.student-progress {
  width: 100%;
  height: 10px;
  border-radius: 999px;
  background: #eef2f7;
  overflow: hidden;
  margin: 12px 0 16px;
}

.student-progress-bar {
  height: 100%;
  background: var(--student-primary);
}

.student-checklist {
  display: grid;
  gap: 8px;
  padding: 0;
  list-style: none;
  margin: 0;
}

.student-checklist-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  border-radius: 12px;
  background: #f8fafc;
  border: 1px solid var(--student-border);
}

.student-badge {
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 0.75rem;
  font-weight: 600;
}

.student-badge.ok {
  background: #e7f7ee;
  color: #2e7d4f;
}

.student-badge.pending {
  background: #fff4e5;
  color: #b45d0a;
}

.student-list {
  list-style: none;
  margin: 0;
  padding: 0;
  display: grid;
  gap: 10px;
}

.student-list-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid var(--student-border);
  background: #fbfcfe;
}

.student-list-title {
  font-weight: 600;
}

.student-list-meta {
  font-size: 0.85rem;
  color: var(--student-muted);
}

.student-insights {
  display: grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap: 12px;
}

.student-insight {
  background: #f8fafc;
  border: 1px solid var(--student-border);
  border-radius: 12px;
  padding: 12px;
}

.student-insight-label {
  font-size: 0.8rem;
  color: var(--student-muted);
}

.student-insight-value {
  font-size: 1.2rem;
  font-weight: 700;
  margin-top: 6px;
}

.student-course {
  display: grid;
  gap: 8px;
  margin-bottom: 16px;
}

.student-course-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

.student-alert {
  border-radius: 12px;
  border: 1px solid #fde4c7;
  background: #fff8ee;
  padding: 12px 16px;
}

.student-nav-toggle {
  display: none;
}

.student-nav-toggle-button {
  display: none;
  background: #fff;
  border: 1px solid var(--student-border);
  border-radius: 10px;
  padding: 6px 10px;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
}

.student-overlay {
  display: none;
}

@media (max-width: 1100px) {
  .student-sidebar {
    position: fixed;
    left: 0;
    top: 0;
    transform: translateX(-100%);
    transition: transform 0.2s ease;
    z-index: 20;
    height: 100vh;
  }

  .student-nav-toggle:checked ~ .student-shell .student-sidebar {
    transform: translateX(0);
  }

  .student-overlay {
    display: none;
  }

  .student-nav-toggle:checked ~ .student-shell .student-overlay {
    display: block;
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.4);
    z-index: 15;
  }

  .student-nav-toggle-button {
    display: inline-flex;
  }

  .student-topbar {
    padding: 16px 20px;
  }

  .student-content {
    padding: 20px;
  }
}

@media (max-width: 960px) {
  .student-grid {
    grid-template-columns: repeat(6, minmax(0, 1fr));
  }

  .student-span-7,
  .student-span-5 {
    grid-column: span 6;
  }

  .student-insights {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
}

@media (max-width: 640px) {
  .student-grid {
    grid-template-columns: 1fr;
  }

  .student-span-12,
  .student-span-7,
  .student-span-6,
  .student-span-5,
  .student-span-4 {
    grid-column: span 1;
  }

  .student-topbar {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }

  .student-topbar-actions {
    width: 100%;
  }

  .student-search {
    width: 100%;
  }
}

----- END FILE: static/css/student.css -----

----- BEGIN FILE: static/ui/css/campuscalm_widget.css -----
.cc-widget {
  position: fixed;
  right: 24px;
  bottom: calc(24px + env(safe-area-inset-bottom, 0px));
  z-index: 1080;
  pointer-events: none;
}

.cc-widget * {
  box-sizing: border-box;
}

.cc-widget-trigger,
.cc-widget-panel {
  pointer-events: auto;
}

.cc-widget-trigger {
  width: 56px;
  height: 56px;
  border: 0;
  border-radius: 999px;
  background: linear-gradient(145deg, #1d4ed8, #2563eb);
  color: #f8fafc;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 16px 30px rgba(30, 64, 175, 0.28);
  position: relative;
  transition: transform 0.18s ease, box-shadow 0.18s ease;
}

.cc-widget-trigger:hover {
  transform: translateY(-1px);
  box-shadow: 0 20px 35px rgba(30, 64, 175, 0.34);
}

.cc-widget-trigger:focus-visible,
.cc-widget-close:focus-visible,
.cc-widget-send:focus-visible,
.cc-widget-input:focus-visible {
  outline: 2px solid #1d4ed8;
  outline-offset: 2px;
}

.cc-widget-icon {
  font-size: 1.05rem;
  font-weight: 700;
  line-height: 1;
}

.cc-widget-tooltip {
  position: absolute;
  right: 68px;
  top: 50%;
  transform: translateY(-50%);
  background: #0f172a;
  color: #f8fafc;
  border-radius: 999px;
  padding: 6px 11px;
  font-size: 0.74rem;
  white-space: nowrap;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.16s ease, visibility 0.16s ease;
}

.cc-widget-trigger:hover .cc-widget-tooltip,
.cc-widget-trigger:focus-visible .cc-widget-tooltip {
  opacity: 1;
  visibility: visible;
}

.cc-widget-panel {
  position: absolute;
  right: 0;
  bottom: 72px;
  width: min(360px, calc(100vw - 24px));
  max-height: min(70vh, 540px);
  display: flex;
  flex-direction: column;
  border-radius: 16px;
  border: 1px solid #dbe5f3;
  background: #ffffff;
  box-shadow: 0 24px 52px rgba(15, 23, 42, 0.2);
  overflow: hidden;
  opacity: 0;
  visibility: hidden;
  transform: translateY(10px) scale(0.985);
  transition: transform 0.18s ease, opacity 0.18s ease, visibility 0.18s ease;
}

.cc-widget.is-open .cc-widget-panel {
  opacity: 1;
  visibility: visible;
  transform: translateY(0) scale(1);
}

.cc-widget-header {
  padding: 14px 16px;
  border-bottom: 1px solid #e2e8f0;
  background: #f8fbff;
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 12px;
}

.cc-widget-title {
  margin: 0;
  color: #1e3a8a;
  font-size: 0.95rem;
  font-weight: 700;
}

.cc-widget-subtitle {
  margin: 4px 0 0;
  color: #475569;
  font-size: 0.79rem;
}

.cc-widget-close {
  border: 0;
  background: transparent;
  color: #64748b;
  font-size: 0.9rem;
  line-height: 1;
  border-radius: 8px;
  padding: 4px 7px;
  cursor: pointer;
}

.cc-widget-close:hover {
  background: #e2e8f0;
  color: #0f172a;
}

.cc-widget-messages {
  padding: 14px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  overflow-y: auto;
  min-height: 220px;
  max-height: 320px;
  background: linear-gradient(180deg, #f9fbff 0%, #ffffff 35%);
}

.cc-widget-bubble {
  max-width: 88%;
  border-radius: 14px;
  padding: 9px 11px;
  font-size: 0.87rem;
  line-height: 1.45;
  white-space: pre-wrap;
}

.cc-widget-bubble-bot {
  align-self: flex-start;
  color: #1f2937;
  background: #eef3ff;
  border: 1px solid #dbe7ff;
}

.cc-widget-bubble-user {
  align-self: flex-end;
  color: #f8fafc;
  background: #2563eb;
}

.cc-widget-form {
  border-top: 1px solid #e2e8f0;
  padding: 10px;
  background: #ffffff;
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 8px;
  align-items: end;
}

.cc-widget-input {
  border: 1px solid #d1d5db;
  border-radius: 10px;
  padding: 8px 10px;
  min-height: 40px;
  max-height: 120px;
  resize: vertical;
  font-size: 0.88rem;
  line-height: 1.4;
}

.cc-widget-send {
  border: 0;
  border-radius: 10px;
  background: #1d4ed8;
  color: #ffffff;
  font-size: 0.86rem;
  font-weight: 600;
  padding: 9px 12px;
  cursor: pointer;
}

.cc-widget-send:hover {
  background: #1e40af;
}

@media (max-width: 767.98px) {
  .cc-widget {
    right: 12px;
    bottom: calc(16px + env(safe-area-inset-bottom, 0px));
  }

  .cc-widget-panel {
    width: min(85vw, 360px);
    max-height: min(66vh, 500px);
    bottom: 68px;
  }

  .cc-widget-tooltip {
    display: none;
  }
}

----- END FILE: static/ui/css/campuscalm_widget.css -----

----- BEGIN FILE: static/ui/js/campuscalm_widget.js -----
(function () {
  var root = document.querySelector("[data-campuscalm-widget]");
  if (!root) {
    return;
  }

  var trigger = root.querySelector("[data-cc-trigger]");
  var panel = root.querySelector("[data-cc-panel]");
  var closeButton = root.querySelector("[data-cc-close]");
  var messagesContainer = root.querySelector("[data-cc-messages]");
  var form = root.querySelector("[data-cc-form]");
  var input = root.querySelector("[data-cc-input]");

  if (!trigger || !panel || !closeButton || !messagesContainer || !form || !input) {
    return;
  }

  var API_ENDPOINT = "/api/widget/chat/";
  var STORAGE_KEY = "campuscalm_widget_history_v1";
  var LEGACY_INITIAL_BOT_MESSAGE = "Oi! Quer organizar o que esta te preocupando agora?";
  var INITIAL_BOT_MESSAGE =
    "Oi! Quer organizar o que esta te preocupando agora?\nSe voce quiser, eu te ajudo a transformar isso em 10 minutos de acao.";
  var history = loadHistory();

  if (!history.length) {
    history = [{ role: "bot", text: INITIAL_BOT_MESSAGE }];
    persistHistory();
  } else if (history[0] && history[0].role === "bot" && history[0].text === LEGACY_INITIAL_BOT_MESSAGE) {
    history[0].text = INITIAL_BOT_MESSAGE;
    persistHistory();
  }

  renderHistory(history);

  trigger.addEventListener("click", function () {
    if (panel.hidden) {
      openWidget();
      return;
    }
    closeWidget();
  });

  closeButton.addEventListener("click", function () {
    closeWidget();
  });

  form.addEventListener("submit", function (event) {
    event.preventDefault();
    submitMessage();
  });

  input.addEventListener("keydown", function (event) {
    if (event.key === "Enter" && !event.shiftKey) {
      event.preventDefault();
      submitMessage();
    }
  });

  function openWidget() {
    panel.hidden = false;
    panel.setAttribute("aria-hidden", "false");
    root.classList.add("is-open");
    trigger.setAttribute("aria-expanded", "true");
    window.setTimeout(function () {
      input.focus();
      scrollMessagesToBottom();
    }, 20);
  }

  function closeWidget() {
    panel.setAttribute("aria-hidden", "true");
    trigger.setAttribute("aria-expanded", "false");
    root.classList.remove("is-open");
    window.setTimeout(function () {
      panel.hidden = true;
    }, 180);
  }

  function submitMessage() {
    var text = input.value.trim();
    if (!text) {
      return;
    }

    appendMessage("user", text);
    input.value = "";
    requestBackendReply(text);
  }

  function appendMessage(role, text) {
    var message = { role: role, text: text };
    history.push(message);
    persistHistory();

    var bubble = buildBubble(message);
    messagesContainer.appendChild(bubble);
    scrollMessagesToBottom();
  }

  function renderHistory(items) {
    messagesContainer.innerHTML = "";
    items.forEach(function (item) {
      messagesContainer.appendChild(buildBubble(item));
    });
    scrollMessagesToBottom();
  }

  function buildBubble(message) {
    var bubble = document.createElement("div");
    bubble.className =
      "cc-widget-bubble " +
      (message.role === "user" ? "cc-widget-bubble-user" : "cc-widget-bubble-bot");
    bubble.textContent = message.text;
    return bubble;
  }

  function scrollMessagesToBottom() {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function requestBackendReply(text) {
    fetchBackendReply(text)
      .then(function (reply) {
        appendMessage("bot", reply);
      })
      .catch(function () {
        window.setTimeout(function () {
          appendMessage("bot", buildMockReply(text));
        }, 300);
      });
  }

  function fetchBackendReply(text) {
    var headers = {
      "Content-Type": "application/json",
      Accept: "application/json",
    };
    var csrfToken = getCsrfToken();
    if (csrfToken) {
      headers["X-CSRFToken"] = csrfToken;
    }

    return window
      .fetch(API_ENDPOINT, {
        method: "POST",
        credentials: "same-origin",
        headers: headers,
        body: JSON.stringify({ message: text }),
      })
      .then(function (response) {
        if (!response.ok) {
          throw new Error("Request failed");
        }
        return response.json();
      })
      .then(function (payload) {
        return formatBackendReply(payload);
      });
  }

  function formatBackendReply(payload) {
    if (!payload || typeof payload.reply !== "string" || payload.reply.trim() === "") {
      throw new Error("Invalid payload");
    }

    var reply = payload.reply.trim();
    var emojiPrefix = payload.emoji ? String(payload.emoji).trim() + " " : "";
    var microLines = formatMicroInterventions(payload.micro_interventions);
    return emojiPrefix + reply + microLines;
  }

  function formatMicroInterventions(items) {
    if (!Array.isArray(items) || !items.length) {
      return "";
    }

    var lines = items
      .filter(function (item) {
        return item && typeof item.nome === "string" && typeof item.texto === "string";
      })
      .map(function (item) {
        return "- " + item.nome + ": " + item.texto;
      });

    if (!lines.length) {
      return "";
    }

    return "\n\nMicrointervencoes:\n" + lines.join("\n");
  }

  function getCsrfToken() {
    var cookies = document.cookie ? document.cookie.split(";") : [];
    for (var i = 0; i < cookies.length; i += 1) {
      var cookie = cookies[i].trim();
      if (cookie.indexOf("csrftoken=") === 0) {
        return decodeURIComponent(cookie.substring("csrftoken=".length));
      }
    }
    return "";
  }

  function buildMockReply(rawText) {
    var text = normalizeText(rawText);

    if (
      containsAny(text, [
        "ansioso",
        "prova",
        "medo",
        "nao estou preparado",
        "nao estudei o bastante",
      ])
    ) {
      return "Entendi. Vamos dividir isso em 1 passo pequeno agora. O que e a proxima coisa mais simples que voce pode fazer em 10 minutos?";
    }

    if (containsAny(text, ["cansado", "exausto", "dormi pouco", "sono"])) {
      return "Seu corpo esta pedindo um ajuste. Quer fazer uma pausa de 2 minutos (respiracao) e depois escolher 1 tarefa leve?";
    }

    if (
      containsAny(text, [
        "distraido",
        "redes sociais",
        "me tira a atencao",
        "nao consigo concentrar",
      ])
    ) {
      return "Vamos reduzir a friccao: coloque o celular longe por 10 minutos e escolha uma tarefa unica. Qual tarefa voce quer atacar primeiro?";
    }

    if (containsAny(text, ["travei", "nao consigo entender", "bloqueio"])) {
      return "Ok. Vamos trocar 'entender tudo' por 'entender 1 parte'. Qual e o topico exato que esta travando?";
    }

    return "Entendi. Quer transformar isso em um plano curto de 10 minutos agora?";
  }

  function containsAny(text, terms) {
    return terms.some(function (term) {
      return text.indexOf(term) !== -1;
    });
  }

  function normalizeText(value) {
    return String(value || "")
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "");
  }

  function loadHistory() {
    try {
      var raw = window.sessionStorage.getItem(STORAGE_KEY);
      if (!raw) {
        return [];
      }
      var parsed = JSON.parse(raw);
      if (!Array.isArray(parsed)) {
        return [];
      }
      return parsed.filter(function (item) {
        return (
          item &&
          (item.role === "bot" || item.role === "user") &&
          typeof item.text === "string" &&
          item.text.trim() !== ""
        );
      });
    } catch (error) {
      return [];
    }
  }

  function persistHistory() {
    try {
      window.sessionStorage.setItem(STORAGE_KEY, JSON.stringify(history));
    } catch (error) {
      // Ignore storage issues in restricted environments.
    }
  }
})();

----- END FILE: static/ui/js/campuscalm_widget.js -----

----- BEGIN FILE: templates/accounts/email/activate_account.html -----
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ative sua conta no CampusCalm</title>
</head>
<body style="margin:0;padding:0;background:#f8fafc;font-family:Arial,sans-serif;color:#0f172a;">
  <table role="presentation" cellpadding="0" cellspacing="0" width="100%" style="padding:24px 0;">
    <tr>
      <td align="center">
        <table role="presentation" cellpadding="0" cellspacing="0" width="100%" style="max-width:560px;background:#ffffff;border:1px solid #e2e8f0;border-radius:12px;">
          <tr>
            <td style="padding:24px;">
              <h1 style="margin:0 0 16px;font-size:22px;line-height:1.3;">Ative sua conta no CampusCalm</h1>
              <p style="margin:0 0 12px;font-size:15px;line-height:1.6;">
                Ola{% if user.name %}, {{ user.name }}{% endif %}.
              </p>
              <p style="margin:0 0 20px;font-size:15px;line-height:1.6;">
                Para concluir seu cadastro e acessar a plataforma, confirme seu e-mail no link abaixo.
              </p>
              <p style="margin:0 0 20px;">
                <a href="{{ activation_url }}" style="display:inline-block;padding:12px 18px;background:#2563eb;color:#ffffff;text-decoration:none;border-radius:8px;font-size:14px;font-weight:600;">
                  Ativar conta
                </a>
              </p>
              <p style="margin:0 0 8px;font-size:14px;line-height:1.6;">
                Se o botao nao funcionar, copie e cole este link no navegador:
              </p>
              <p style="margin:0 0 20px;font-size:13px;line-height:1.6;word-break:break-all;">
                <a href="{{ activation_url }}" style="color:#1d4ed8;">{{ activation_url }}</a>
              </p>
              <p style="margin:0;font-size:13px;line-height:1.6;color:#475569;">
                Se voce nao solicitou este cadastro, ignore esta mensagem.
              </p>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>
</html>

----- END FILE: templates/accounts/email/activate_account.html -----

----- BEGIN FILE: templates/accounts/email/activate_account.txt -----
Ative sua conta no CampusCalm

Ola{% if user.name %}, {{ user.name }}{% endif %}.

Para concluir seu cadastro e acessar a plataforma, confirme seu e-mail no link abaixo:
{{ activation_url }}

Se voce nao solicitou este cadastro, ignore esta mensagem.

----- END FILE: templates/accounts/email/activate_account.txt -----

----- BEGIN FILE: templates/base.html -----
{% load i18n static %}
{% get_current_language as CURRENT_LANGUAGE %}
{% get_available_languages as AVAILABLE_LANGUAGES %}
{% get_language_info_list for AVAILABLE_LANGUAGES as languages %}
<!DOCTYPE html>
<html lang="{{ CURRENT_LANGUAGE }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Campus Calm</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{% static 'css/app.css' %}" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="d-flex">
    <nav class="sidebar bg-white border-end">
      <div class="p-3">
        <div class="text-center mb-2">
          <img src="/media/Logo%20Campus%20Calm.png" alt="Campus Calm" class="brand-logo-large">
          <div class="sidebar-panel-title text-muted small">{% trans "Painel do aluno" %}</div>
        </div>
        <div class="mt-3 small text-muted">
          {% blocktrans with name=request.user.name|default:request.user.email %}Ol, {{ name }}{% endblocktrans %}
        </div>
        <form class="mt-3" method="post" action="{% url 'set_language' %}">
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ request.get_full_path }}">
          <label class="form-label small text-muted mb-1" for="language-select">{% trans "Idioma" %}</label>
          {% with current_lang=CURRENT_LANGUAGE|cut:"-"|cut:"_" %}
            <select id="language-select" class="form-select form-select-sm" name="language" onchange="this.form.submit()">
              {% for language in languages %}
                {% with code=language.code|cut:"-"|cut:"_"|lower %}
                  <option value="{{ language.code }}"{% if language.code|cut:"-"|cut:"_" == current_lang %} selected{% endif %}>
                    {% if code == "ptbr" %}{% elif code == "ptpt" %}{% elif code == "en" %}{% else %}{% endif %}
                    {{ language.name_local }}
                  </option>
                {% endwith %}
              {% endfor %}
            </select>
          {% endwith %}
        </form>
        <ul class="nav flex-column mt-4">
          <li class="nav-item">
            <a class="nav-link {% if request.path == '/' %}active{% endif %}" href="/">{% trans "Dashboard" %}</a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if request.path|slice:":11" == "/onboarding" %}active{% endif %}" href="/onboarding/">{% trans "Onboarding" %}</a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if request.path|slice:":10" == "/semestres" %}active{% endif %}" href="/semestres/">{% trans "Semestres" %}</a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if request.path|slice:":8" == "/tarefas" %}active{% endif %}" href="/tarefas/">{% trans "Tarefas" %}</a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if request.path|slice:":7" == "/agenda" %}active{% endif %}" href="/agenda/">{% trans "Agenda" %}</a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if request.path|slice:":11" == "/lembretes" %}active{% endif %}" href="/lembretes/">{% trans "Lembretes" %}</a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if request.path|slice:":10" == "/mensagens" %}active{% endif %}" href="/mensagens/">{% trans "Mensagens" %}</a>
          </li>
        </ul>
        <div class="mt-4 pt-3 border-top">
          <form method="post" action="/logout/">
            {% csrf_token %}
            <button class="nav-link text-danger btn btn-link p-0" type="submit">{% trans "Sair" %}</button>
          </form>
        </div>
      </div>
    </nav>

    <main class="content flex-grow-1">
      <div class="container-fluid py-4">
        {% if messages %}
          {% for message in messages %}
            <div class="alert alert-{{ message.tags|default:"info" }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="{% trans "Fechar" %}"></button>
            </div>
          {% endfor %}
        {% endif %}
        {% block content %}{% endblock %}
      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

----- END FILE: templates/base.html -----

----- BEGIN FILE: templates/registration/password_reset_email.html -----
{% autoescape off %}
Voce solicitou a redefinicao de senha do Campus Calm.

Para criar uma nova senha, acesse o link abaixo:
{{ protocol }}://{{ domain }}{% url 'password_reset_confirm' uidb64=uid token=token %}

Se voce nao solicitou, ignore esta mensagem.
{% endautoescape %}

----- END FILE: templates/registration/password_reset_email.html -----

----- BEGIN FILE: templates/registration/password_reset_subject.txt -----
Campus Calm - Redefinicao de senha

----- END FILE: templates/registration/password_reset_subject.txt -----

----- BEGIN FILE: templates/ui/agenda.html -----
{% extends "ui/base_student.html" %}
{% load i18n %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h1 class="h4 mb-1">{% trans "Agenda" %}</h1>
    <div class="text-muted">{% blocktrans with days=range_days %}Eventos dos proximos {{ days }} dias{% endblocktrans %}</div>
  </div>
</div>

<form class="row g-2 mb-3" method="get">
  <div class="col-sm-4 col-md-3">
    <input class="form-control form-control-sm" type="text" name="q" placeholder="{% trans "Buscar evento" %}"
           value="{{ search_query }}">
  </div>
  <div class="col-sm-4 col-md-3">
    <select class="form-select form-select-sm" name="type">
      <option value="">{% trans "Todos os tipos" %}</option>
      {% for value,label in event_type_choices %}
        <option value="{{ value }}" {% if type_filter == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-sm-4 col-md-3">
    <select class="form-select form-select-sm" name="range">
      <option value="7" {% if range_days == "7" %}selected{% endif %}>{% trans "Proximos 7 dias" %}</option>
      <option value="15" {% if range_days == "15" %}selected{% endif %}>{% trans "Proximos 15 dias" %}</option>
      <option value="30" {% if range_days == "30" %}selected{% endif %}>{% trans "Proximos 30 dias" %}</option>
      <option value="60" {% if range_days == "60" %}selected{% endif %}>{% trans "Proximos 60 dias" %}</option>
      <option value="90" {% if range_days == "90" %}selected{% endif %}>{% trans "Proximos 90 dias" %}</option>
    </select>
  </div>
  <div class="col-auto">
    <button class="btn btn-sm btn-outline-secondary" type="submit">{% trans "Filtrar" %}</button>
    <a class="btn btn-sm btn-link" href="/agenda/?clear=1">{% trans "Limpar" %}</a>
  </div>
</form>

<div class="row g-3">
  <div class="col-lg-7">
    <div class="card shadow-sm">
      <div class="card-header bg-white fw-semibold">{% trans "Eventos" %}</div>
      <div class="card-body">
        {% if events %}
          <ul class="list-group list-group-flush">
            {% for event in events %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-semibold">{{ event.title }}</div>
                  <div class="text-muted small">{{ event.event_type }}</div>
                </div>
                <span class="text-muted small">{{ event.start_at|date:"d/m/Y H:i" }}</span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted">{% trans "Nenhum evento nos proximos dias." %}</div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-lg-5">
    <div class="card shadow-sm">
      <div class="card-header bg-white fw-semibold">{% trans "Lembretes ativos" %}</div>
      <div class="card-body">
        {% if reminder_rules %}
          <ul class="list-group list-group-flush">
            {% for rule in reminder_rules %}
              <li class="list-group-item d-flex justify-content-between">
                <span>{{ rule.target_type }}</span>
                <span class="text-muted small">{% blocktrans with minutes=rule.remind_before_minutes %}{{ minutes }} min antes{% endblocktrans %}</span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted">{% trans "Nenhuma regra ativa." %}</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

----- END FILE: templates/ui/agenda.html -----

----- BEGIN FILE: templates/ui/agenda/agenda_confirm_delete.html -----
{% extends "ui/base_student.html" %}
{% load i18n %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">{% trans "Dashboard" %}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'ui-agenda-list' %}">{% trans "Agenda" %}</a></li>
    <li class="breadcrumb-item active" aria-current="page">{% trans "Excluir evento" %}</li>
  </ol>
</nav>

<div class="card shadow-sm">
  <div class="card-body">
    <h1 class="h5 mb-3">{% trans "Excluir evento" %}</h1>
    <p class="text-muted">{% trans "Tem certeza que deseja excluir o evento" %} <strong>{{ event.title }}</strong>?</p>
    <form method="post">
      {% csrf_token %}
      <a class="btn btn-outline-secondary" href="{% url 'ui-agenda-list' %}">{% trans "Cancelar" %}</a>
      <button class="btn btn-danger" type="submit">{% trans "Excluir" %}</button>
    </form>
  </div>
</div>
{% endblock %}

----- END FILE: templates/ui/agenda/agenda_confirm_delete.html -----

----- BEGIN FILE: templates/ui/agenda/agenda_form.html -----
{% extends "ui/base_student.html" %}
{% load i18n %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">{% trans "Dashboard" %}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'ui-agenda-list' %}">{% trans "Agenda" %}</a></li>
    {% if mode == "edit" %}
      <li class="breadcrumb-item active" aria-current="page">{% trans "Editar evento" %}</li>
    {% else %}
      <li class="breadcrumb-item active" aria-current="page">{% trans "Novo evento" %}</li>
    {% endif %}
  </ol>
</nav>

<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    {% if mode == "edit" %}
      <h1 class="h4 mb-1">{% trans "Editar evento" %}</h1>
      <div class="text-muted">{{ event.title }}</div>
    {% else %}
      <h1 class="h4 mb-1">{% trans "Novo evento" %}</h1>
      <div class="text-muted">{% trans "Cadastre um novo evento." %}</div>
    {% endif %}
  </div>
  <a class="btn btn-outline-secondary" href="{% url 'ui-agenda-list' %}">{% trans "Voltar" %}</a>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <form method="post">
      {% csrf_token %}
      {% if form.non_field_errors %}
        <div class="alert alert-danger">{{ form.non_field_errors }}</div>
      {% endif %}
      {% for field in form %}
        <div class="mb-3">
          <label class="form-label">{{ field.label }}</label>
          {{ field }}
          {% if field.help_text %}
            <div class="form-text">{{ field.help_text }}</div>
          {% endif %}
          {% for error in field.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
      {% endfor %}
      <button class="btn btn-primary" type="submit">
        {% if mode == "edit" %}{% trans "Salvar" %}{% else %}{% trans "Criar" %}{% endif %}
      </button>
    </form>
  </div>
</div>
{% endblock %}

----- END FILE: templates/ui/agenda/agenda_form.html -----

----- BEGIN FILE: templates/ui/agenda/agenda_list.html -----
{% extends "ui/base_student.html" %}
{% load i18n %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">{% trans "Dashboard" %}</a></li>
    <li class="breadcrumb-item active" aria-current="page">{% trans "Agenda" %}</li>
  </ol>
</nav>

<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h1 class="h4 mb-1">{% trans "Agenda" %}</h1>
    <div class="text-muted">{% trans "Seus eventos e compromissos." %}</div>
  </div>
  <a class="btn btn-primary" href="{% url 'ui-agenda-create' %}">{% trans "Novo evento" %}</a>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    {% if events %}
      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>{% trans "Evento" %}</th>
              <th>{% trans "Tipo" %}</th>
              <th>{% trans "Inicio" %}</th>
              <th>{% trans "Fim" %}</th>
              <th class="text-end">{% trans "Acoes" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for event in events %}
              <tr>
                <td>{{ event.title }}</td>
                <td><span class="badge text-bg-light">{{ event.get_event_type_display }}</span></td>
                <td>{{ event.start_at|date:"d/m/Y H:i" }}</td>
                <td>{{ event.end_at|date:"d/m/Y H:i"|default:"-" }}</td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-secondary" href="{% url 'ui-agenda-edit' event.pk %}">{% trans "Editar" %}</a>
                  <a class="btn btn-sm btn-outline-danger" href="{% url 'ui-agenda-delete' event.pk %}">{% trans "Excluir" %}</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted">{% trans "Nenhum evento cadastrado." %}</div>
    {% endif %}
  </div>
</div>
{% endblock %}

----- END FILE: templates/ui/agenda/agenda_list.html -----

----- BEGIN FILE: templates/ui/assessment/assessment_confirm_delete.html -----
{% extends "ui/base_student.html" %}
{% load i18n %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">{% trans "Dashboard" %}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'ui-semester-list' %}">{% trans "Semestres" %}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'ui-semester-detail' course.semester.pk %}">{{ course.semester.name }}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'ui-course-detail' course.pk %}">{{ course.title }}</a></li>
    <li class="breadcrumb-item active" aria-current="page">{% trans "Excluir avaliacao" %}</li>
  </ol>
</nav>

<div class="card shadow-sm">
  <div class="card-body">
    <h1 class="h5 mb-3">{% trans "Excluir avaliacao" %}</h1>
    <p class="text-muted">{% trans "Tem certeza que deseja excluir a avaliacao" %} <strong>{{ assessment.title }}</strong>?</p>
    <form method="post">
      {% csrf_token %}
      <a class="btn btn-outline-secondary" href="{% url 'ui-course-detail' course.pk %}">{% trans "Cancelar" %}</a>
      <button class="btn btn-danger" type="submit">{% trans "Excluir" %}</button>
    </form>
  </div>
</div>
{% endblock %}

----- END FILE: templates/ui/assessment/assessment_confirm_delete.html -----

----- BEGIN FILE: templates/ui/assessment/assessment_form.html -----
{% extends "ui/base_student.html" %}
{% load i18n %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">{% trans "Dashboard" %}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'ui-semester-list' %}">{% trans "Semestres" %}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'ui-semester-detail' course.semester.pk %}">{{ course.semester.name }}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'ui-course-detail' course.pk %}">{{ course.title }}</a></li>
    {% if mode == "edit" %}
      <li class="breadcrumb-item active" aria-current="page">{% trans "Editar avaliacao" %}</li>
    {% else %}
      <li class="breadcrumb-item active" aria-current="page">{% trans "Nova avaliacao" %}</li>
    {% endif %}
  </ol>
</nav>

<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    {% if mode == "edit" %}
      <h1 class="h4 mb-1">{% trans "Editar avaliacao" %}</h1>
      <div class="text-muted">{{ assessment.title }}</div>
    {% else %}
      <h1 class="h4 mb-1">{% trans "Nova avaliacao" %}</h1>
      <div class="text-muted">{{ course.title }}</div>
    {% endif %}
  </div>
  <a class="btn btn-outline-secondary" href="{% url 'ui-course-detail' course.pk %}">{% trans "Voltar" %}</a>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <form method="post">
      {% csrf_token %}
      {% if form.non_field_errors %}
        <div class="alert alert-danger">{{ form.non_field_errors }}</div>
      {% endif %}
      {% for field in form %}
        <div class="mb-3">
          <label class="form-label">{{ field.label }}</label>
          {{ field }}
          {% if field.help_text %}
            <div class="form-text">{{ field.help_text }}</div>
          {% endif %}
          {% for error in field.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
      {% endfor %}
      <button class="btn btn-primary" type="submit">
        {% if mode == "edit" %}{% trans "Salvar" %}{% else %}{% trans "Criar" %}{% endif %}
      </button>
    </form>
  </div>
</div>
{% endblock %}

----- END FILE: templates/ui/assessment/assessment_form.html -----

----- BEGIN FILE: templates/ui/auth_base.html -----
{% load i18n static %}
{% get_current_language as CURRENT_LANGUAGE %}
{% get_available_languages as AVAILABLE_LANGUAGES %}
{% get_language_info_list for AVAILABLE_LANGUAGES as languages %}
<!DOCTYPE html>
<html lang="{{ CURRENT_LANGUAGE }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% trans "Campus Calm - Acesso" %}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{% static 'css/app.css' %}" rel="stylesheet">
</head>
<body class="bg-auth">
  <div class="position-absolute top-0 end-0 p-3 auth-language-switcher">
    <form method="post" action="{% url 'set_language' %}">
      {% csrf_token %}
      <input type="hidden" name="next" value="{{ request.get_full_path }}">
      <label class="form-label small text-muted mb-1" for="auth-language-select">{% trans "Idioma" %}</label>
      {% with current_lang=CURRENT_LANGUAGE|cut:"-"|cut:"_" %}
        <select id="auth-language-select" class="form-select form-select-sm" name="language" onchange="this.form.submit()">
          {% for language in languages %}
            {% with code=language.code|cut:"-"|cut:"_"|lower %}
              <option value="{{ language.code }}"{% if language.code|cut:"-"|cut:"_" == current_lang %} selected{% endif %}>
                {% if code == "ptbr" %}{% elif code == "ptpt" %}{% elif code == "en" %}{% else %}{% endif %}
                {{ language.name_local }}
              </option>
            {% endwith %}
          {% endfor %}
        </select>
      {% endwith %}
    </form>
  </div>
  <div class="auth-shell">
    {% block content %}{% endblock %}
  </div>
</body>
</html>

----- END FILE: templates/ui/auth_base.html -----

----- BEGIN FILE: templates/ui/base_student.html -----
{% load i18n static %}
{% get_current_language as CURRENT_LANGUAGE %}
{% get_available_languages as AVAILABLE_LANGUAGES %}
{% get_language_info_list for AVAILABLE_LANGUAGES as languages %}
<!DOCTYPE html>
<html lang="{{ CURRENT_LANGUAGE }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CampusCalm</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{% static 'css/app.css' %}" rel="stylesheet">
  <link href="{% static 'css/student.css' %}" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'ui/css/campuscalm_widget.css' %}">
</head>
<body class="student-body">
  <input type="checkbox" id="student-nav-toggle" class="student-nav-toggle" aria-hidden="true">
  <div class="student-shell">
    <label class="student-overlay" for="student-nav-toggle" aria-hidden="true"></label>

    <!-- Sidebar -->
    {% block sidebar %}
    <aside class="student-sidebar">
      <div class="student-sidebar-inner">
        <div class="student-brand">
          <img src="{% static 'img/logo-campus-calm.png' %}" alt="CampusCalm" class="student-brand-logo">
          <div>
            <div class="student-brand-title">CampusCalm</div>
            <div class="student-brand-subtitle">{% trans "Painel do aluno" %}</div>
          </div>
        </div>

        <div class="student-user">
          {% blocktrans with name=request.user.name|default:request.user.email %}Ol, {{ name }}{% endblocktrans %}
        </div>

        <form class="student-language" method="post" action="{% url 'set_language' %}">
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ request.get_full_path }}">
          <label class="form-label small text-muted mb-1" for="language-select">{% trans "Idioma" %}</label>
          {% with current_lang=CURRENT_LANGUAGE|cut:"-"|cut:"_" %}
            <select id="language-select" class="form-select form-select-sm" name="language" onchange="this.form.submit()">
              {% for language in languages %}
                {% with code=language.code|cut:"-"|cut:"_"|lower %}
                  <option value="{{ language.code }}"{% if language.code|cut:"-"|cut:"_" == current_lang %} selected{% endif %}>
                    {% if code == "ptbr" %}{% elif code == "ptpt" %}{% elif code == "en" %}{% else %}{% endif %}
                    {{ language.name_local }}
                  </option>
                {% endwith %}
              {% endfor %}
            </select>
          {% endwith %}
        </form>

        {% url 'ui-dashboard' as dashboard_url %}
        {% url 'ui-onboarding' as onboarding_url %}
        {% url 'ui-semester-list' as semesters_url %}
        {% url 'ui-semesters' as semesters_alt_url %}
        {% url 'ui-task-list' as tasks_url %}
        {% url 'ui-tasks' as tasks_alt_url %}
        {% url 'ui-agenda-list' as agenda_url %}
        {% url 'ui-reminder-list' as reminders_url %}
        {% url 'ui-message-list' as messages_url %}
        {% url 'ui-messages' as messages_alt_url %}

        <nav class="student-nav">
          <a class="{% if request.path == dashboard_url %}is-active{% endif %}" href="{{ dashboard_url }}">{% trans "Dashboard" %}</a>
          <a class="{% if request.path|slice:":11" == onboarding_url|slice:":11" %}is-active{% endif %}" href="{{ onboarding_url }}">{% trans "Onboarding" %}</a>
          <a class="{% if request.path|slice:":10" == semesters_url|slice:":10" or request.path|slice:":10" == semesters_alt_url|slice:":10" %}is-active{% endif %}" href="{{ semesters_url }}">{% trans "Semestres" %}</a>
          <a class="{% if request.path|slice:":8" == tasks_url|slice:":8" or request.path|slice:":6" == tasks_alt_url|slice:":6" %}is-active{% endif %}" href="{{ tasks_url }}">{% trans "Tarefas" %}</a>
          <a class="{% if request.path|slice:":7" == agenda_url|slice:":7" %}is-active{% endif %}" href="{{ agenda_url }}">{% trans "Agenda" %}</a>
          <a class="{% if request.path|slice:":11" == reminders_url|slice:":11" %}is-active{% endif %}" href="{{ reminders_url }}">{% trans "Lembretes" %}</a>
          <a class="{% if request.path|slice:":10" == messages_url|slice:":10" or request.path|slice:":10" == messages_alt_url|slice:":10" %}is-active{% endif %}" href="{{ messages_url }}">{% trans "Mensagens" %}</a>
        </nav>

        <div class="student-logout">
          <form method="post" action="{% url 'ui-logout' %}">
            {% csrf_token %}
            <button class="student-link" type="submit">{% trans "Sair" %}</button>
          </form>
        </div>
      </div>
    </aside>
    {% endblock %}

    <div class="student-main">
      <!-- Topbar -->
      {% block topbar %}
      <header class="student-topbar">
        <div class="student-topbar-left">
          <label class="student-nav-toggle-button" for="student-nav-toggle">{% trans "Menu" %}</label>
          <div>
            <div class="dropdown">
              <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                {{ request.user.name|default:request.user.email }}
              </button>

              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <form method="post" action="{% url 'logout' %}" class="px-3 py-1">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger w-100">{% trans "Sair" %}</button>
                  </form>
                </li>
              </ul>
            </div>
            <p class="student-subtitle">{% trans "Ambiente de estudo" %}</p>
          </div>
        </div>
        <div class="student-topbar-actions">
          <a class="student-btn student-btn-ghost" href="{% url 'ui-task-create' %}">{% trans "Nova tarefa" %}</a>
          <a class="student-btn student-btn-ghost" href="{% url 'ui-agenda-create' %}">{% trans "Novo evento" %}</a>
          <a class="student-btn student-btn-primary" href="{% url 'ui-reminder-create' %}">{% trans "Novo lembrete" %}</a>
        </div>
      </header>
      {% endblock %}

      <!-- Contedo -->
      <main class="student-content">
        <div class="student-container">
          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-{{ message.tags|default:"info" }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="{% trans "Fechar" %}"></button>
              </div>
            {% endfor %}
          {% endif %}
          {% block content %}{% endblock %}
        </div>
      </main>
    </div>
  </div>

  {% include "ui/partials/campuscalm_widget.html" %}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{% static 'ui/js/campuscalm_widget.js' %}" defer></script>
</body>
</html>

----- END FILE: templates/ui/base_student.html -----

----- BEGIN FILE: templates/ui/course/course_confirm_delete.html -----
{% extends "ui/base_student.html" %}
{% load i18n %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">{% trans "Dashboard" %}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'ui-semester-list' %}">{% trans "Semestres" %}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'ui-semester-detail' course.semester.pk %}">{{ course.semester.name }}</a></li>
    <li class="breadcrumb-item active" aria-current="page">{% trans "Excluir disciplina" %}</li>
  </ol>
</nav>

<div class="card shadow-sm">
  <div class="card-body">
    <h1 class="h5 mb-3">{% trans "Excluir disciplina" %}</h1>
    <p class="text-muted">{% trans "Tem certeza que deseja excluir a disciplina" %} <strong>{{ course.title }}</strong>?</p>
    <form method="post">
      {% csrf_token %}
      <a class="btn btn-outline-secondary" href="{% url 'ui-course-detail' course.pk %}">{% trans "Cancelar" %}</a>
      <button class="btn btn-danger" type="submit">{% trans "Excluir" %}</button>
    </form>
  </div>
</div>
{% endblock %}

----- END FILE: templates/ui/course/course_confirm_delete.html -----

----- BEGIN FILE: templates/ui/course/course_detail.html -----
{% extends "ui/base_student.html" %}
{% load i18n %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">{% trans "Dashboard" %}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'ui-semester-list' %}">{% trans "Semestres" %}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'ui-semester-detail' course.semester.pk %}">{{ course.semester.name }}</a></li>
    <li class="breadcrumb-item active" aria-current="page">{{ course.title }}</li>
  </ol>
</nav>

<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h1 class="h4 mb-1">{{ course.title }}</h1>
    <div class="text-muted">{{ course.teacher|default:"-" }}</div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{% url 'ui-semester-detail' course.semester.pk %}">{% trans "Voltar" %}</a>
    <a class="btn btn-outline-primary" href="{% url 'ui-course-edit' course.pk %}">{% trans "Editar" %}</a>
    <a class="btn btn-primary" href="{% url 'ui-assessment-create' course.pk %}">{% trans "Nova Avaliacao" %}</a>
  </div>
</div>

{% if not progress.has_assessments %}
  <div class="alert alert-warning">
    {% trans "Cadastre ao menos uma avaliacao para calcular a barra de progresso." %}
  </div>
{% endif %}

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-3">
        <div class="text-muted small">{% trans "Nota minima" %}</div>
        <div class="fw-semibold">{{ progress.passing_grade|floatformat:2 }}</div>
      </div>
      <div class="col-md-3">
        <div class="text-muted small">{% trans "Media atual" %}</div>
        <div class="fw-semibold">{{ progress.current_average|floatformat:2 }}</div>
      </div>
      <div class="col-md-3">
        <div class="text-muted small">{% trans "Falta para passar" %}</div>
        <div class="fw-semibold">{{ progress.needed_to_pass|floatformat:2 }}</div>
      </div>
      <div class="col-md-3">
        <div class="text-muted small">{% trans "Status" %}</div>
        <div class="fw-semibold">{{ course.get_status_display }}</div>
      </div>
    </div>
    <div class="mt-3">
      <div class="progress" role="progressbar" aria-valuenow="{{ progress.progress_percent|floatformat:0 }}" aria-valuemin="0" aria-valuemax="100">
        <div class="progress-bar" style="width: {{ progress.progress_percent|floatformat:0 }}%;">
          {{ progress.progress_percent|floatformat:0 }}%
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h2 class="h6 mb-0">{% trans "Avaliacoes" %}</h2>
    </div>
    {% if assessments %}
      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>{% trans "Avaliacao" %}</th>
              <th>{% trans "Nota" %}</th>
              <th>{% trans "Peso" %}</th>
              <th>{% trans "Data" %}</th>
              <th class="text-end">{% trans "Acoes" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for assessment in assessments %}
              <tr>
                <td>{{ assessment.title }}</td>
                <td>{{ assessment.score|floatformat:2 }} / {{ assessment.max_score|floatformat:2 }}</td>
                <td>{{ assessment.weight|floatformat:2 }}</td>
                <td>{{ assessment.date|date:"d/m/Y"|default:"-" }}</td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-secondary" href="{% url 'ui-assessment-edit' assessment.pk %}">{% trans "Editar" %}</a>
                  <a class="btn btn-sm btn-outline-danger" href="{% url 'ui-assessment-delete' assessment.pk %}">{% trans "Excluir" %}</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted">{% trans "Nenhuma avaliacao cadastrada." %}</div>
    {% endif %}
  </div>
</div>
{% endblock %}

----- END FILE: templates/ui/course/course_detail.html -----

----- BEGIN FILE: templates/ui/course/course_form.html -----
{% extends "ui/base_student.html" %}
{% load i18n %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">{% trans "Dashboard" %}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'ui-semester-list' %}">{% trans "Semestres" %}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'ui-semester-detail' semester.pk %}">{{ semester.name }}</a></li>
    {% if mode == "edit" %}
      <li class="breadcrumb-item active" aria-current="page">{% trans "Editar disciplina" %}</li>
    {% else %}
      <li class="breadcrumb-item active" aria-current="page">{% trans "Nova disciplina" %}</li>
    {% endif %}
  </ol>
</nav>

<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    {% if mode == "edit" %}
      <h1 class="h4 mb-1">{% trans "Editar disciplina" %}</h1>
      <div class="text-muted">{{ course.title }}</div>
    {% else %}
      <h1 class="h4 mb-1">{% trans "Nova disciplina" %}</h1>
      <div class="text-muted">{{ semester.name }}</div>
    {% endif %}
  </div>
  <a class="btn btn-outline-secondary" href="{% url 'ui-semester-detail' semester.pk %}">{% trans "Voltar" %}</a>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <form method="post">
      {% csrf_token %}
      {% if form.non_field_errors %}
        <div class="alert alert-danger">{{ form.non_field_errors }}</div>
      {% endif %}
      {% for field in form %}
        <div class="mb-3">
          <label class="form-label">{{ field.label }}</label>
          {{ field }}
          {% if field.help_text %}
            <div class="form-text">{{ field.help_text }}</div>
          {% endif %}
          {% for error in field.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
      {% endfor %}
      <button class="btn btn-primary" type="submit">
        {% if mode == "edit" %}{% trans "Salvar" %}{% else %}{% trans "Criar" %}{% endif %}
      </button>
    </form>
  </div>
</div>
{% endblock %}

----- END FILE: templates/ui/course/course_form.html -----

----- BEGIN FILE: templates/ui/dashboard.html -----
{% extends "ui/base_student.html" %}
{% load i18n %}

{% block content %}
{% trans "Sem dados" as label_no_data %}
{% url 'ui-dashboard' as dashboard_url %}

<!-- Cabealho da pgina -->
<div class="student-page-header">
  <div>
    <h1 class="student-page-title">{% trans "Dashboard" %}</h1>
    <p class="student-page-subtitle">{% trans "Resumo da semana" %}</p>
  </div>
  <form class="student-search" method="get">
    <input class="form-control form-control-sm" type="text" name="q" placeholder="{% trans "Buscar tarefa ou evento" %}"
           value="{{ search_query }}">
    <button class="btn btn-sm btn-outline-secondary" type="submit">{% trans "Aplicar" %}</button>
    <a class="btn btn-sm btn-link" href="{{ dashboard_url }}?clear=1">{% trans "Limpar" %}</a>
  </form>
</div>

<!-- Alerta de onboarding -->
{% if not onboarding_status.is_complete %}
  <div class="student-alert">
    <div class="fw-semibold">{% trans "Onboarding incompleto" %}</div>
    <div>{% trans "Finalize as etapas pendentes para liberar todo o painel." %}</div>
  </div>
{% endif %}

<div class="student-grid">
  <!-- Progresso do onboarding -->
  <section class="student-card student-span-7">
    <div class="student-card-header">
      <h2 class="student-card-title">{% trans "Progresso do onboarding" %}</h2>
      <span class="student-card-muted">{{ onboarding_status.completed_steps }}/{{ onboarding_status.total_steps }}</span>
    </div>
    <div class="student-progress">
      <div class="student-progress-bar" style="width: {{ onboarding_status.progress_percent }}%;"></div>
    </div>
    <ul class="student-checklist">
      {% for step in onboarding_status.steps %}
        <li class="student-checklist-item">
          <span>{{ step.label }}</span>
          {% if step.missing %}
            <span class="student-badge pending">{% trans "Pendente" %}</span>
          {% else %}
            <span class="student-badge ok">{% trans "Ok" %}</span>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
    {% if not onboarding_status.is_complete %}
      <div class="mt-3">
        <a class="student-btn student-btn-primary" href="{% url 'ui-onboarding' %}">{% trans "Continuar configuracao" %}</a>
      </div>
    {% endif %}
  </section>

  <!-- Card Hoje -->
  <section class="student-card student-span-5">
    <div class="student-card-header">
      <h2 class="student-card-title">{% trans "Hoje" %}</h2>
      <span class="student-card-muted">{% trans "Visao rapida" %}</span>
    </div>
    <ul class="student-list">
      <li class="student-list-item">
        <div>
          <div class="student-list-title">{% trans "Proxima tarefa" %}</div>
          {% if dashboard_data.upcoming_tasks %}
            <div class="student-list-meta">{{ dashboard_data.upcoming_tasks.0.title }}</div>
          {% else %}
            <div class="student-list-meta">{% trans "Sem itens no momento" %}</div>
          {% endif %}
        </div>
        {% if dashboard_data.upcoming_tasks %}
          <span class="student-list-meta">{{ dashboard_data.upcoming_tasks.0.due_date|date:"d/m/Y" }}</span>
        {% endif %}
      </li>
      <li class="student-list-item">
        <div>
          <div class="student-list-title">{% trans "Proximo evento" %}</div>
          {% if dashboard_data.upcoming_events %}
            <div class="student-list-meta">{{ dashboard_data.upcoming_events.0.title }}</div>
          {% else %}
            <div class="student-list-meta">{% trans "Sem itens no momento" %}</div>
          {% endif %}
        </div>
        {% if dashboard_data.upcoming_events %}
          <span class="student-list-meta">{{ dashboard_data.upcoming_events.0.start_at|date:"d/m/Y" }}</span>
        {% endif %}
      </li>
      <li class="student-list-item">
        <div>
          <div class="student-list-title">{% trans "Lembretes" %}</div>
          <div class="student-list-meta">{% trans "Sem itens no momento" %}</div>
        </div>
        <span class="student-list-meta"></span>
      </li>
    </ul>
  </section>

  <!-- Prximas tarefas -->
  <section class="student-card student-span-7">
    <div class="student-card-header">
      <h2 class="student-card-title">{% trans "Proximas tarefas" %}</h2>
      <a class="student-card-muted" href="{% url 'ui-task-list' %}">{% trans "Ver todas" %}</a>
    </div>
    {% if dashboard_data.upcoming_tasks %}
      <ul class="student-list">
        {% for task in dashboard_data.upcoming_tasks %}
          <li class="student-list-item">
            <span class="student-list-title">{{ task.title }}</span>
            <span class="student-list-meta">{{ task.due_date|date:"d/m/Y" }}</span>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="student-card-muted">{% trans "Nenhuma tarefa proxima." %}</p>
    {% endif %}
  </section>

  <!-- Prximo evento -->
  <section class="student-card student-span-5">
    <div class="student-card-header">
      <h2 class="student-card-title">{% trans "Agenda" %}</h2>
      <a class="student-card-muted" href="{% url 'ui-agenda-list' %}">{% trans "Ver agenda" %}</a>
    </div>
    {% if dashboard_data.upcoming_events %}
      <div class="student-list">
        <div class="student-list-item">
          <div>
            <div class="student-list-title">{{ dashboard_data.upcoming_events.0.title }}</div>
            <div class="student-list-meta">{{ dashboard_data.upcoming_events.0.start_at|date:"d/m/Y H:i" }}</div>
          </div>
        </div>
      </div>
    {% else %}
      <p class="student-card-muted">{% trans "Nenhum evento nos proximos dias." %}</p>
    {% endif %}
  </section>

  <!-- Progresso por disciplina -->
  <section class="student-card student-span-12">
    <div class="student-card-header">
      <h2 class="student-card-title">{% trans "Progresso por disciplina" %}</h2>
      <span class="student-card-muted">{% trans "Acompanhe seu desempenho" %}</span>
    </div>
    {% if dashboard_data.course_progress %}
      {% for course in dashboard_data.course_progress %}
        <div class="student-course">
          <div class="student-course-header">
            <div class="student-list-title">{{ course.title }}</div>
            <div class="student-list-meta">{{ course.semester }}</div>
          </div>
          <div class="student-card-muted">
            {% blocktrans with current=course.current_average passing=course.passing_grade %}Media atual: {{ current }} | Media minima: {{ passing }}{% endblocktrans %}
          </div>
          <div class="student-progress">
            <div class="student-progress-bar" style="width: {{ course.progress_percent }}%;"></div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p class="student-card-muted">{% trans "Nenhuma disciplina cadastrada." %}</p>
    {% endif %}
  </section>

  <!-- Insights -->
  <section class="student-card student-span-12">
    <div class="student-card-header">
      <h2 class="student-card-title">{% trans "Insights" %}</h2>
      <span class="student-card-muted">{% trans "Visao geral da semana" %}</span>
    </div>
    <div class="student-insights">
      <div class="student-insight">
        <div class="student-insight-label">{% trans "Humor mais comum" %}</div>
        <div class="student-insight-value">{{ dashboard_data.mood_most_common|default:label_no_data }}</div>
        <div class="student-card-muted small">{% blocktrans with total=dashboard_data.mood_weekly_total %}{{ total }} registros{% endblocktrans %}</div>
      </div>
      <div class="student-insight">
        <div class="student-insight-label">{% trans "Minutos de foco" %}</div>
        <div class="student-insight-value">{{ dashboard_data.focus_minutes_week }}</div>
        <div class="student-card-muted small">{% trans "Ultimos 7 dias" %}</div>
      </div>
      <div class="student-insight">
        <div class="student-insight-label">{% trans "Estresse medio" %}</div>
        <div class="student-insight-value">{{ dashboard_data.stress_avg_week|default:label_no_data }}</div>
        <div class="student-card-muted small">{% trans "Media dos check-ins" %}</div>
      </div>
      <div class="student-insight">
        <div class="student-insight-label">{% trans "Proximos prazos" %}</div>
        <div class="student-insight-value">{{ dashboard_data.upcoming_count }}</div>
        <div class="student-card-muted small">{% trans "Tarefas e eventos" %}</div>
      </div>
    </div>
  </section>
</div>
{% endblock %}

----- END FILE: templates/ui/dashboard.html -----

----- BEGIN FILE: templates/ui/first_access.html -----
{% extends "ui/auth_base.html" %}
{% load i18n %}

{% block content %}
<!-- Bloco: Card de primeiro acesso -->
<div class="auth-card shadow-sm">
  <div class="auth-header">
    <div class="auth-logo">Campus Calm</div>
    <div class="auth-subtitle">{% trans "Primeiro acesso" %}</div>
  </div>
  <div class="auth-body">
    <h1 class="h5 mb-3">{% trans "Criar conta" %}</h1>
    <p class="text-muted small mb-4">{% trans "Preencha seus dados para iniciar no Campus Calm." %}</p>

    {% if form.errors %}
      <!-- Bloco: Erros do formulario -->
      <div class="alert alert-danger">
        {% trans "Revise os campos abaixo." %}
      </div>
    {% endif %}

    <!-- Bloco: Formulario -->
    <form method="post" novalidate>
      {% csrf_token %}
      <div class="mb-3">
        <label class="form-label">{{ form.name.label }}</label>
        {{ form.name }}
      </div>
      <div class="mb-3">
        <label class="form-label">{{ form.email.label }}</label>
        {{ form.email }}
      </div>
      <div class="mb-3">
        <label class="form-label">{{ form.phone.label }}</label>
        {{ form.phone }}
      </div>
      <div class="mb-3">
        <label class="form-label">{{ form.plan.label }}</label>
        {{ form.plan }}
      </div>
      <div class="mb-3">
        <label class="form-label">{{ form.password1.label }}</label>
        {{ form.password1 }}
      </div>
      <div class="mb-3">
        <label class="form-label">{{ form.password2.label }}</label>
        {{ form.password2 }}
      </div>

      <!-- Bloco: Consentimentos -->
      <div class="mb-3">
        <div class="form-check">
          {{ form.allow_email }}
          <label class="form-check-label" for="{{ form.allow_email.id_for_label }}">{{ form.allow_email.label }}</label>
        </div>
        <div class="form-check">
          {{ form.allow_whatsapp }}
          <label class="form-check-label" for="{{ form.allow_whatsapp.id_for_label }}">{{ form.allow_whatsapp.label }}</label>
        </div>
        <div class="form-check">
          {{ form.allow_sms }}
          <label class="form-check-label" for="{{ form.allow_sms.id_for_label }}">{{ form.allow_sms.label }}</label>
        </div>
      </div>

      <button type="submit" class="btn btn-primary w-100">{% trans "Criar conta" %}</button>
    </form>

    <!-- Bloco: Voltar para login -->
    <div class="mt-3 text-center">
      <a class="small text-decoration-none" href="{% url 'ui-login' %}">{% trans "Voltar para login" %}</a>
    </div>
  </div>
</div>
{% endblock %}

----- END FILE: templates/ui/first_access.html -----

----- BEGIN FILE: templates/ui/home.html -----
{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CampusCalm | Algorithm Insights Sistemas</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/home.css' %}?v=20260209-4">
</head>
<body>
  <div class="page-shell">
    <!-- Bloco Sidebar pblica -->
    <aside class="side-panel" aria-label="Navegao institucional">
      <div class="side-brand">
        <img src="{% static 'img/logo-campus-calm.png' %}" alt="CampusCalm" class="side-logo">
        <p class="side-title">CampusCalm</p>
        <p class="side-subtitle">Plataforma para organizao e bem-estar na rotina acadmica.</p>
      </div>
      <nav class="side-nav">
        <a class="active" href="#inicio">Viso geral</a>
        <a href="#campuscalm">CampusCalm</a>
        <a href="#sobre">Sobre</a>
        <a href="#contato">Contato</a>
      </nav>
    </aside>

    <div class="page-body">
      <!-- Bloco Header -->
      <header class="site-header" id="inicio">
        <div class="container header-content">
          <div class="brand">
            <img src="{% static 'img/logoalgorithminsights_empresa.png' %}" alt="Algorithm Insights Sistemas" class="brand-logo">
            <div class="brand-copy">
              <p class="brand-title">Algorithm Insights Sistemas</p>
              <p class="brand-tagline">Transformando dados em decises inteligentes e ajudando voc a alcanar o seu sonho.</p>
            </div>
          </div>
          <div class="header-right">
            <nav class="site-nav" aria-label="Menu principal">
              <a href="#inicio">Incio</a>
              <a href="#campuscalm">CampusCalm</a>
              <a href="#sobre">Sobre</a>
              <a href="#contato">Contato</a>
            </nav>
            <div class="header-actions">
              <a class="btn btn-primary" href="{% url 'ui-login' %}">Entrar</a>
              <a class="header-link" href="{% url 'ui-first-access' %}">Criar conta</a>
            </div>
          </div>
        </div>
      </header>

      <main>
        <!-- Bloco Hero -->
        <section class="hero">
          <div class="container hero-grid">
            <div class="hero-copy">
              <p class="eyebrow">Algorithm Insights Sistemas</p>
              <h1>CampusCalm para uma jornada acadmica mais organizada e tranquila.</h1>
              <p class="lead">Tecnologia aplicada ao dia a dia do estudante, com foco em clareza e bem-estar.</p>
              <div class="hero-actions">
                <a class="btn btn-primary" href="{% url 'ui-login' %}">Acessar rea do Aluno</a>
                <a class="btn btn-secondary" href="#campuscalm">Conhea o Projeto</a>
              </div>
            </div>
            <div class="hero-panel" aria-hidden="true">
              <div class="hero-card">
                <span class="hero-tag">CampusCalm</span>
                <h2>Clareza e serenidade na jornada educacional</h2>
                <p>
                  Estrutura pensada para apoiar pessoas com processos simples e decises bem orientadas.
                </p>
                <div class="hero-metrics">
                  <div>
                    <span class="metric-title">Bem-estar</span>
                    <span class="metric-text">Apoio contnuo</span>
                  </div>
                  <div>
                    <span class="metric-title">Tecnologia</span>
                    <span class="metric-text">Operao confivel</span>
                  </div>
                  <div>
                    <span class="metric-title">Educao</span>
                    <span class="metric-text">Ambiente integrado</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Bloco Sobre -->
        <section class="section" id="sobre">
          <div class="container">
            <div class="section-header">
              <h2>Sobre o CampusCalm</h2>
              <p>
                O CampusCalm integra tecnologia e bem-estar no contexto educacional.
                Com linguagem simples e foco em pessoas, organiza rotinas e melhora a experincia acadmica.
              </p>
            </div>
            <div class="feature-grid">
              <div class="feature-card">
                <h3>Bem-estar como prioridade</h3>
                <p>Estruturas que respeitam o ritmo humano e estimulam equilbrio.</p>
              </div>
              <div class="feature-card">
                <h3>Tecnologia aplicada</h3>
                <p>Recursos digitais que simplificam processos e favorecem decises claras.</p>
              </div>
              <div class="feature-card">
                <h3>Ambiente educacional</h3>
                <p>Integrao cuidadosa entre organizao acadmica e suporte dirio.</p>
              </div>
            </div>
          </div>
        </section>

        <!-- Bloco CampusCalm -->
        <section class="section section-alt" id="campuscalm">
          <div class="container link-grid">
            <div>
              <h2>CampusCalm e Algorithm Insights Sistemas</h2>
              <p>
                O projeto nasce da experincia da Algorithm Insights Sistemas em tecnologia aplicada
                 educao, com governana, confiabilidade e foco contnuo em pessoas.
              </p>
            </div>
            <div class="institution-card">
              <p class="institution-title">Algorithm Insights Sistemas</p>
              <p>
                Compromisso com solues responsveis para apoiar instituies, docentes e estudantes.
              </p>
            </div>
          </div>
        </section>

        <!-- Bloco Solues e pilares -->
        <section class="section" id="solucoes">
          <div class="container">
            <div class="section-header">
              <h2>Solues e pilares</h2>
              <p>Componentes essenciais do CampusCalm para uma experincia educacional mais consistente.</p>
            </div>
            <div class="pillar-grid">
              <div class="pillar-card pillar-card-primary pillar-span-6">
                <span class="pillar-badge">Destaque</span>
                <!-- Bloco Icone: Tecnologia Educacional -->
                <div class="pillar-icon" aria-hidden="true">
                  <svg class="pillar-icon-svg" viewBox="0 0 24 24">
                    <rect x="3" y="4" width="18" height="12" rx="2"></rect>
                    <path d="M9 20h6"></path>
                    <path d="M12 16v4"></path>
                    <path class="tone" d="M6 10l6-3 6 3"></path>
                    <path class="tone" d="M9 11v2m6-2v2"></path>
                  </svg>
                </div>
                <h3>Tecnologia Educacional</h3>
                <p>Ferramentas organizadas para apoiar fluxos acadmicos com clareza.</p>
              </div>
              <div class="pillar-card pillar-card-primary pillar-span-6">
                <span class="pillar-badge">Destaque</span>
                <!-- Bloco Icone: Bem-estar Digital -->
                <div class="pillar-icon" aria-hidden="true">
                  <svg class="pillar-icon-svg" viewBox="0 0 24 24">
                    <path d="M12 3l7 3v5c0 5-3.5 8-7 10-3.5-2-7-5-7-10V6z"></path>
                    <path class="tone" d="M12 16s-2.8-1.7-2.8-3.6A1.8 1.8 0 0 1 12 11a1.8 1.8 0 0 1 2.8 1.4c0 1.9-2.8 3.6-2.8 3.6z"></path>
                  </svg>
                </div>
                <h3>Bem-estar Digital</h3>
                <p>Prticas e recursos que favorecem equilbrio e ateno no cotidiano.</p>
              </div>
              <div class="pillar-card pillar-card-secondary pillar-span-5">
                <!-- Bloco Icone: Automacao Inteligente -->
                <div class="pillar-icon" aria-hidden="true">
                  <svg class="pillar-icon-svg" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M12 4v2m0 12v2M4 12h2m12 0h2"></path>
                    <path class="tone" d="M6.3 6.3l1.4 1.4m8.6 8.6l1.4 1.4m0-11.4l-1.4 1.4m-8.6 8.6l-1.4 1.4"></path>
                    <path class="tone" d="M10.5 9.8l1.5-3 1.5 3h-2.1l-.9 2.2"></path>
                  </svg>
                </div>
                <h3>Automao Inteligente</h3>
                <p>Processos simplificados com foco em eficincia e tranquilidade operacional.</p>
              </div>
              <div class="pillar-card pillar-card-secondary pillar-span-7">
                <!-- Bloco Icone: Analise e Organizacao -->
                <div class="pillar-icon" aria-hidden="true">
                  <svg class="pillar-icon-svg" viewBox="0 0 24 24">
                    <path d="M5 19v-7m5 7V8m5 11v-5m5 5V6"></path>
                    <path class="tone" d="M4 6l1.4 1.4L8 4.8"></path>
                    <path class="tone" d="M10 5h10"></path>
                  </svg>
                </div>
                <h3>Anlise e Organizao</h3>
                <p>Estruturao de informaes para decises mais claras e conscientes.</p>
              </div>
            </div>
          </div>
        </section>
      </main>

      <!-- Bloco Rodap -->
      <footer class="site-footer" id="contato">
        <div class="container footer-grid">
          <div class="footer-brand">
            <div class="footer-brand-row">
              <img src="{% static 'img/logoalgorithminsights_empresa.png' %}" alt="Algorithm Insights Sistemas" class="footer-logo">
              <div>
                <p class="footer-title">Algorithm Insights Sistemas</p>
                <p class="footer-tagline">Transformando dados em decises inteligentes e ajudando voc a alcanar o seu sonho.</p>
              </div>
            </div>
            <p class="footer-text">Solues institucionais com foco em tecnologia e bem-estar educacional.</p>
          </div>
          <div class="footer-info">
            <p class="footer-heading">Contato institucional</p>
            <p class="footer-text">
              WhatsApp Business:
              <a class="footer-link" href="https://wa.me/5585985759381" target="_blank" rel="noopener">(85) 98575-9381</a>
            </p>
          </div>
          <div class="footer-info">
            <p class="footer-heading">Redes sociais</p>
            <p class="footer-text">Em breve.</p>
          </div>
        </div>
      </footer>
    </div>
  </div>
</body>
</html>

----- END FILE: templates/ui/home.html -----

----- BEGIN FILE: templates/ui/login.html -----
{% extends "ui/auth_base.html" %}
{% load i18n %}

{% block content %}
<div class="auth-card shadow-sm">
  <div class="auth-header">
    <div class="auth-logo">Campus Calm</div>
    <div class="auth-subtitle">{% trans "Bem-estar e organizacao para universitarios" %}</div>
  </div>
  <div class="auth-body">
    <h1 class="h5 mb-3">{% trans "Acesso ao painel" %}</h1>
    <p class="text-muted small mb-4">{% trans "Entre com seu email institucional ou pessoal para continuar." %}</p>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{% if 'error' in message.tags %}danger{% elif 'warning' in message.tags %}warning{% elif 'success' in message.tags %}success{% else %}info{% endif %}">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}

    {% if form.non_field_errors %}
      <div class="alert alert-danger">
        {% for error in form.non_field_errors %}
          <div>{{ error }}</div>
        {% endfor %}
      </div>
    {% elif form.errors %}
      <div class="alert alert-danger">
        {% trans "Email ou senha invalidos. Tente novamente." %}
      </div>
    {% endif %}

    <form method="post" novalidate>
      {% csrf_token %}
      <div class="mb-3">
        <label class="form-label">{{ form.username.label }}</label>
        {{ form.username }}
      </div>
      <div class="mb-3">
        <label class="form-label">{{ form.password.label }}</label>
        <div class="input-group">
          {{ form.password }}
          <button class="btn btn-outline-secondary" type="button" id="toggle-password" data-show="{% trans "Mostrar" %}" data-hide="{% trans "Ocultar" %}">{% trans "Mostrar" %}</button>
        </div>
      </div>
      <button type="submit" class="btn btn-primary w-100">{% trans "Entrar" %}</button>
    </form>

    <div class="mt-3 text-center">
      <a class="small text-decoration-none" href="/password-reset/">{% trans "Esqueci minha senha" %}</a>
    </div>

    <!-- Bloco: Primeiro acesso -->
    <div class="mt-2 text-center">
      <a class="small text-decoration-none" href="{% url 'ui-first-access' %}">{% trans "Primeiro acesso / Criar conta" %}</a>
    </div>

    <div class="auth-footer text-muted small mt-4">
      {% trans "Dica: use o mesmo login do sistema administrativo se ja tiver acesso." %}
    </div>
  </div>
</div>

<script>
  const toggleBtn = document.getElementById("toggle-password");
  const passwordInput = document.getElementById("id_password");
  if (toggleBtn && passwordInput) {
    toggleBtn.addEventListener("click", () => {
      const showLabel = toggleBtn.dataset.show || "Mostrar";
      const hideLabel = toggleBtn.dataset.hide || "Ocultar";
      const isPassword = passwordInput.getAttribute("type") === "password";
      passwordInput.setAttribute("type", isPassword ? "text" : "password");
      toggleBtn.textContent = isPassword ? hideLabel : showLabel;
    });
  }
</script>
{% endblock %}

----- END FILE: templates/ui/login.html -----

----- BEGIN FILE: templates/ui/messages.html -----
{% extends "ui/base_student.html" %}
{% load i18n %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h1 class="h4 mb-1">{% trans "Mensagens" %}</h1>
    <div class="text-muted">{% trans "Avisos e comunicados in-app" %}</div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    {% if notifications %}
      <div class="list-group list-group-flush">
        {% for msg in notifications %}
          <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="fw-semibold">{{ msg.title }}</div>
                <div class="text-muted small">{{ msg.scheduled_for|date:"d/m/Y H:i" }}</div>
              </div>
              <span class="badge text-bg-light text-muted">{{ msg.status }}</span>
            </div>
            <div class="mt-2 text-muted">{{ msg.message|linebreaksbr }}</div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-muted">{% trans "Nenhuma mensagem registrada." %}</div>
    {% endif %}
  </div>
</div>
{% endblock %}

----- END FILE: templates/ui/messages.html -----

----- BEGIN FILE: templates/ui/messages/message_list.html -----
{% extends "ui/base_student.html" %}
{% load i18n %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">{% trans "Dashboard" %}</a></li>
    <li class="breadcrumb-item active" aria-current="page">{% trans "Mensagens" %}</li>
  </ol>
</nav>

<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h1 class="h4 mb-1">{% trans "Mensagens" %}</h1>
    <div class="text-muted">{% trans "Historico de notificacoes" %}</div>
  </div>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <form class="row g-2 align-items-end" method="get">
      <div class="col-md-3">
        <label class="form-label">{% trans "Status" %}</label>
        <select class="form-select" name="status">
          <option value="">{% trans "Todos os status" %}</option>
          {% for value, label in status_choices %}
            <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">{% trans "Canal" %}</label>
        <select class="form-select" name="channel">
          <option value="">{% trans "Todos os canais" %}</option>
          {% for value, label in channel_choices %}
            <option value="{{ value }}" {% if channel_filter == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <button class="btn btn-outline-primary w-100" type="submit">{% trans "Filtrar" %}</button>
      </div>
      <div class="col-md-2">
        <a class="btn btn-outline-secondary w-100" href="{% url 'ui-message-list' %}">{% trans "Limpar" %}</a>
      </div>
    </form>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    {% if notifications %}
      <!-- Bloco: Tabela de historico -->
      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>{% trans "Titulo" %}</th>
              <th>{% trans "Canal" %}</th>
              <th>{% trans "Status" %}</th>
              <th>{% trans "Acao" %}</th>
              <th>{% trans "Agendado" %}</th>
              <th>{% trans "Enviado" %}</th>
              <th>{% trans "Tentativas" %}</th>
              <th>{% trans "Erro" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for item in notifications %}
              <tr>
                <td>
                  <div class="fw-semibold">{{ item.title }}</div>
                  <div class="text-muted small">{{ item.message|truncatechars:80 }}</div>
                </td>
                <td>{{ item.get_channel_display }}</td>
                <td><span class="badge text-bg-light">{{ item.get_status_display }}</span></td>
                <td>{{ item.get_action_taken_display }}</td>
                <td>{{ item.scheduled_for|date:"d/m/Y H:i" }}</td>
                <td>
                  {% if item.sent_at %}
                    {{ item.sent_at|date:"d/m/Y H:i" }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>{{ item.attempts }}</td>
                <td class="text-muted small">
                  {% if item.last_error %}
                    {{ item.last_error|truncatechars:40 }}
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted">{% trans "Nenhuma mensagem registrada." %}</div>
    {% endif %}
  </div>
</div>
{% endblock %}

----- END FILE: templates/ui/messages/message_list.html -----

----- BEGIN FILE: templates/ui/onboarding.html -----
{% extends "ui/base_student.html" %}
{% load i18n %}

{% block content %}
<!-- Cabealho da pgina -->
<div class="student-page-header">
  <div>
    <h1 class="student-page-title">{% trans "Onboarding" %}</h1>
    <p class="student-page-subtitle">{% trans "Etapas para completar a configuracao" %}</p>
  </div>
</div>

<!-- Checklist de etapas -->
<div class="student-card">
  <div class="student-card-header">
    <h2 class="student-card-title">{% trans "Status das etapas" %}</h2>
    <span class="student-card-muted">{% trans "Acompanhe o progresso" %}</span>
  </div>
  <ul class="student-checklist">
    {% for step in steps %}
      <li class="student-checklist-item">
        <div>
          <div class="student-list-title">{{ step.label }}</div>
          <div class="student-list-meta">{{ step.message }}</div>
        </div>
        {% if step.missing %}
          <span class="student-badge pending"></span>
        {% else %}
          <span class="student-badge ok"></span>
        {% endif %}
      </li>
    {% endfor %}
  </ul>
</div>

<!-- Acoes recomendadas -->
{% if required_actions %}
  <div class="student-card">
    <div class="student-card-header">
      <h2 class="student-card-title">{% trans "Acoes recomendadas" %}</h2>
    </div>
    <ul class="student-list">
      {% for action in required_actions %}
        <li class="student-list-item">
          <span>{{ action }}</span>
        </li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

<!-- Sugestoes rapidas -->
<div class="student-card">
  <div class="student-card-header">
    <h2 class="student-card-title">{% trans "Sugestoes rapidas" %}</h2>
  </div>
  <ul class="student-list">
    <li class="student-list-item"><a href="{% url 'ui-semesters' %}">{% trans "Ver semestres" %}</a></li>
    <li class="student-list-item"><a href="{% url 'ui-tasks' %}">{% trans "Ver tarefas" %}</a></li>
    <li class="student-list-item"><a href="{% url 'ui-agenda-list' %}">{% trans "Ver agenda" %}</a></li>
    <li class="student-list-item"><a href="{% url 'ui-semester-list' %}">{% trans "Cadastrar avaliacao" %}</a></li>
  </ul>
</div>
{% endblock %}

----- END FILE: templates/ui/onboarding.html -----

----- BEGIN FILE: templates/ui/partials/campuscalm_widget.html -----
<div class="cc-widget" data-campuscalm-widget>
  <button
    type="button"
    class="cc-widget-trigger"
    data-cc-trigger
    title="Organizar mente"
    aria-label="Organizar mente"
    aria-controls="campuscalm-widget-panel"
    aria-expanded="false"
  >
    <span class="cc-widget-icon" aria-hidden="true"></span>
    <span class="cc-widget-tooltip">Organizar mente</span>
  </button>

  <section
    id="campuscalm-widget-panel"
    class="cc-widget-panel"
    data-cc-panel
    role="dialog"
    aria-label="CampusCalm"
    aria-hidden="true"
    hidden
  >
    <header class="cc-widget-header">
      <div>
        <h2 class="cc-widget-title">CampusCalm</h2>
        <p class="cc-widget-subtitle">Organizao emocional e foco</p>
      </div>
      <button type="button" class="cc-widget-close" data-cc-close aria-label="Fechar">X</button>
    </header>

    <div class="cc-widget-messages" data-cc-messages role="log" aria-live="polite">
      <div class="cc-widget-bubble cc-widget-bubble-bot">
        Oi! Quer organizar o que esta te preocupando agora?
        Se voc quiser, eu te ajudo a transformar isso em 10 minutos de ao.
      </div>
    </div>

    <form class="cc-widget-form" data-cc-form novalidate>
      <label class="visually-hidden" for="campuscalm-widget-input">Mensagem</label>
      <textarea
        id="campuscalm-widget-input"
        class="cc-widget-input"
        data-cc-input
        rows="1"
        aria-label="Mensagem para CampusCalm"
        placeholder="Escreva o que esta acontecendo..."
      ></textarea>
      <button type="submit" class="cc-widget-send">Enviar</button>
    </form>
  </section>
</div>

----- END FILE: templates/ui/partials/campuscalm_widget.html -----

----- BEGIN FILE: templates/ui/password_reset_complete.html -----
{% extends "ui/auth_base.html" %}
{% load i18n %}

{% block content %}
<div class="auth-card shadow-sm">
  <div class="auth-header">
    <div class="auth-logo">Campus Calm</div>
    <div class="auth-subtitle">{% trans "Senha atualizada" %}</div>
  </div>
  <div class="auth-body">
    <h1 class="h5 mb-3">{% trans "Senha redefinida" %}</h1>
    <p class="text-muted small">{% trans "Sua senha foi atualizada. Voce ja pode acessar o painel." %}</p>
    <div class="mt-3 text-center">
      <a class="small text-decoration-none" href="/login/">{% trans "Ir para o login" %}</a>
    </div>
  </div>
</div>
{% endblock %}

----- END FILE: templates/ui/password_reset_complete.html -----

----- BEGIN FILE: templates/ui/password_reset_confirm.html -----
{% extends "ui/auth_base.html" %}
{% load i18n %}

{% block content %}
<div class="auth-card shadow-sm">
  <div class="auth-header">
    <div class="auth-logo">Campus Calm</div>
    <div class="auth-subtitle">{% trans "Nova senha" %}</div>
  </div>
  <div class="auth-body">
    <h1 class="h5 mb-3">{% trans "Definir nova senha" %}</h1>
    <form method="post">
      {% csrf_token %}
      <div class="mb-3">
        <label class="form-label" for="id_new_password1">{% trans "Nova senha" %}</label>
        <input class="form-control" type="password" name="new_password1" id="id_new_password1" required>
      </div>
      <div class="mb-3">
        <label class="form-label" for="id_new_password2">{% trans "Confirmar nova senha" %}</label>
        <input class="form-control" type="password" name="new_password2" id="id_new_password2" required>
      </div>
      <button type="submit" class="btn btn-primary w-100">{% trans "Atualizar senha" %}</button>
    </form>
  </div>
</div>
{% endblock %}

----- END FILE: templates/ui/password_reset_confirm.html -----

----- BEGIN FILE: templates/ui/password_reset_done.html -----
{% extends "ui/auth_base.html" %}
{% load i18n %}

{% block content %}
<div class="auth-card shadow-sm">
  <div class="auth-header">
    <div class="auth-logo">Campus Calm</div>
    <div class="auth-subtitle">{% trans "Email enviado" %}</div>
  </div>
  <div class="auth-body">
    <h1 class="h5 mb-3">{% trans "Verifique sua caixa de entrada" %}</h1>
    <p class="text-muted small">{% trans "Se o email existir no sistema, voce recebera um link para redefinir a senha." %}</p>
    <div class="mt-3 text-center">
      <a class="small text-decoration-none" href="/login/">{% trans "Voltar ao login" %}</a>
    </div>
  </div>
</div>
{% endblock %}

----- END FILE: templates/ui/password_reset_done.html -----

----- BEGIN FILE: templates/ui/password_reset_form.html -----
{% extends "ui/auth_base.html" %}
{% load i18n %}

{% block content %}
<div class="auth-card shadow-sm">
  <div class="auth-header">
    <div class="auth-logo">Campus Calm</div>
    <div class="auth-subtitle">{% trans "Recuperacao de acesso" %}</div>
  </div>
  <div class="auth-body">
    <h1 class="h5 mb-3">{% trans "Redefinir senha" %}</h1>
    <p class="text-muted small mb-4">{% trans "Informe seu email para receber o link de redefinicao." %}</p>

    <form method="post">
      {% csrf_token %}
      <div class="mb-3">
        <label class="form-label" for="id_email">{% trans "Email" %}</label>
        <input class="form-control" type="email" name="email" id="id_email" placeholder="{% trans "seu.email@universidade.edu" %}" required>
      </div>
      <button type="submit" class="btn btn-primary w-100">{% trans "Enviar link" %}</button>
    </form>

    <div class="mt-3 text-center">
      <a class="small text-decoration-none" href="/login/">{% trans "Voltar ao login" %}</a>
    </div>
  </div>
</div>
{% endblock %}

----- END FILE: templates/ui/password_reset_form.html -----

----- BEGIN FILE: templates/ui/reminders/reminder_confirm_delete.html -----
{% extends "ui/base_student.html" %}
{% load i18n %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">{% trans "Dashboard" %}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'ui-reminder-list' %}">{% trans "Lembretes" %}</a></li>
    <li class="breadcrumb-item active" aria-current="page">{% trans "Excluir lembrete" %}</li>
  </ol>
</nav>

<div class="card shadow-sm">
  <div class="card-body">
    <h1 class="h5 mb-3">{% trans "Excluir lembrete" %}</h1>
    <p class="text-muted">{% trans "Tem certeza que deseja excluir a regra de lembrete" %}?</p>
    <form method="post">
      {% csrf_token %}
      <a class="btn btn-outline-secondary" href="{% url 'ui-reminder-list' %}">{% trans "Cancelar" %}</a>
      <button class="btn btn-danger" type="submit">{% trans "Excluir" %}</button>
    </form>
  </div>
</div>
{% endblock %}

----- END FILE: templates/ui/reminders/reminder_confirm_delete.html -----

----- BEGIN FILE: templates/ui/reminders/reminder_form.html -----
{% extends "ui/base_student.html" %}
{% load i18n %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">{% trans "Dashboard" %}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'ui-reminder-list' %}">{% trans "Lembretes" %}</a></li>
    {% if mode == "edit" %}
      <li class="breadcrumb-item active" aria-current="page">{% trans "Editar lembrete" %}</li>
    {% else %}
      <li class="breadcrumb-item active" aria-current="page">{% trans "Novo lembrete" %}</li>
    {% endif %}
  </ol>
</nav>

<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    {% if mode == "edit" %}
      <h1 class="h4 mb-1">{% trans "Editar lembrete" %}</h1>
      <div class="text-muted">{% trans "Atualize sua regra de lembrete." %}</div>
    {% else %}
      <h1 class="h4 mb-1">{% trans "Novo lembrete" %}</h1>
      <div class="text-muted">{% trans "Crie uma nova regra de lembrete." %}</div>
    {% endif %}
  </div>
  <a class="btn btn-outline-secondary" href="{% url 'ui-reminder-list' %}">{% trans "Voltar" %}</a>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <form method="post">
      {% csrf_token %}
      {% if form.non_field_errors %}
        <div class="alert alert-danger">{{ form.non_field_errors }}</div>
      {% endif %}
      <div class="mb-3">
        <label class="form-label">{{ form.target_type.label }}</label>
        {{ form.target_type }}
        {% for error in form.target_type.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>
      <div class="mb-3">
        <label class="form-label">{{ form.remind_before_minutes.label }}</label>
        {{ form.remind_before_minutes }}
        {% for error in form.remind_before_minutes.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>
      <div class="mb-3">
        <label class="form-label">{{ form.channels.label }}</label>
        <div class="d-flex flex-column gap-1">
          {{ form.channels }}
        </div>
        {% for error in form.channels.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>
      <div class="form-check mb-3">
        {{ form.is_active }}
        <label class="form-check-label" for="{{ form.is_active.id_for_label }}">{{ form.is_active.label }}</label>
      </div>
      <button class="btn btn-primary" type="submit">
        {% if mode == "edit" %}{% trans "Salvar" %}{% else %}{% trans "Criar" %}{% endif %}
      </button>
    </form>
  </div>
</div>
{% endblock %}

----- END FILE: templates/ui/reminders/reminder_form.html -----

----- BEGIN FILE: templates/ui/reminders/reminder_list.html -----
{% extends "ui/base_student.html" %}
{% load i18n %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">{% trans "Dashboard" %}</a></li>
    <li class="breadcrumb-item active" aria-current="page">{% trans "Lembretes" %}</li>
  </ol>
</nav>

<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h1 class="h4 mb-1">{% trans "Lembretes" %}</h1>
    <div class="text-muted">{% trans "Configure suas regras de lembrete." %}</div>
  </div>
  <!-- Bloco: Acoes -->
  <div class="d-flex gap-2">
    <form method="post" action="{% url 'ui-reminder-generate' %}">
      {% csrf_token %}
      <button class="btn btn-outline-primary" type="submit">{% trans "Gerar lembretes" %}</button>
    </form>
    <a class="btn btn-primary" href="{% url 'ui-reminder-create' %}">{% trans "Novo lembrete" %}</a>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    {% if reminders %}
      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>{% trans "Tipo" %}</th>
              <th>{% trans "Minutos antes" %}</th>
              <th>{% trans "Canais" %}</th>
              <th>{% trans "Status" %}</th>
              <th class="text-end">{% trans "Acoes" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for reminder in reminders %}
              <tr>
                <td>{{ reminder.get_target_type_display }}</td>
                <td>{{ reminder.remind_before_minutes }}</td>
                <td>
                  {% if reminder.channels %}
                    {{ reminder.channels|join:", " }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>
                  {% if reminder.is_active %}
                    <span class="badge text-bg-success">{% trans "Ativo" %}</span>
                  {% else %}
                    <span class="badge text-bg-secondary">{% trans "Inativo" %}</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-secondary" href="{% url 'ui-reminder-edit' reminder.pk %}">{% trans "Editar" %}</a>
                  <a class="btn btn-sm btn-outline-danger" href="{% url 'ui-reminder-delete' reminder.pk %}">{% trans "Excluir" %}</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted">{% trans "Nenhuma regra de lembrete cadastrada." %}</div>
    {% endif %}
  </div>
</div>
{% endblock %}

----- END FILE: templates/ui/reminders/reminder_list.html -----

----- BEGIN FILE: templates/ui/semester/semester_confirm_delete.html -----
{% extends "ui/base_student.html" %}
{% load i18n %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">{% trans "Dashboard" %}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'ui-semester-list' %}">{% trans "Semestres" %}</a></li>
    <li class="breadcrumb-item active" aria-current="page">{% trans "Excluir semestre" %}</li>
  </ol>
</nav>

<div class="card shadow-sm">
  <div class="card-body">
    <h1 class="h5 mb-3">{% trans "Excluir semestre" %}</h1>
    <p class="text-muted">{% trans "Tem certeza que deseja excluir o semestre" %} <strong>{{ semester.name }}</strong>?</p>
    <form method="post">
      {% csrf_token %}
      <a class="btn btn-outline-secondary" href="{% url 'ui-semester-detail' semester.pk %}">{% trans "Cancelar" %}</a>
      <button class="btn btn-danger" type="submit">{% trans "Excluir" %}</button>
    </form>
  </div>
</div>
{% endblock %}

----- END FILE: templates/ui/semester/semester_confirm_delete.html -----

----- BEGIN FILE: templates/ui/semester/semester_detail.html -----
{% extends "ui/base_student.html" %}
{% load i18n %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">{% trans "Dashboard" %}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'ui-semester-list' %}">{% trans "Semestres" %}</a></li>
    <li class="breadcrumb-item active" aria-current="page">{{ semester.name }}</li>
  </ol>
</nav>

<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h1 class="h4 mb-1">{{ semester.name }}</h1>
    <div class="text-muted">
      {% trans "Periodo" %}: {{ semester.start_date|date:"d/m/Y" }} - {{ semester.end_date|date:"d/m/Y" }}
    </div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{% url 'ui-semester-list' %}">{% trans "Voltar" %}</a>
    <a class="btn btn-outline-primary" href="{% url 'ui-semester-edit' semester.pk %}">{% trans "Editar" %}</a>
    <a class="btn btn-primary" href="{% url 'ui-course-create' semester.pk %}">{% trans "Nova Disciplina" %}</a>
  </div>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <div class="d-flex flex-wrap gap-3">
      <div>
        <div class="text-muted small">{% trans "Status" %}</div>
        <div class="fw-semibold">{{ semester.get_status_display }}</div>
      </div>
      <div>
        <div class="text-muted small">{% trans "Inicio" %}</div>
        <div class="fw-semibold">{{ semester.start_date|date:"d/m/Y" }}</div>
      </div>
      <div>
        <div class="text-muted small">{% trans "Termino" %}</div>
        <div class="fw-semibold">{{ semester.end_date|date:"d/m/Y" }}</div>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h2 class="h6 mb-0">{% trans "Disciplinas" %}</h2>
    </div>
    {% if courses %}
      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>{% trans "Disciplina" %}</th>
              <th>{% trans "Professor" %}</th>
              <th>{% trans "Status" %}</th>
              <th class="text-end">{% trans "Acoes" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for course in courses %}
              <tr>
                <td>{{ course.title }}</td>
                <td>{{ course.teacher|default:"-" }}</td>
                <td>{{ course.get_status_display }}</td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-primary" href="{% url 'ui-course-detail' course.pk %}">{% trans "Ver" %}</a>
                  <a class="btn btn-sm btn-outline-secondary" href="{% url 'ui-course-edit' course.pk %}">{% trans "Editar" %}</a>
                  <a class="btn btn-sm btn-outline-danger" href="{% url 'ui-course-delete' course.pk %}">{% trans "Excluir" %}</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted">{% trans "Nenhuma disciplina cadastrada." %}</div>
    {% endif %}
  </div>
</div>
{% endblock %}

----- END FILE: templates/ui/semester/semester_detail.html -----

----- BEGIN FILE: templates/ui/semester/semester_form.html -----
{% extends "ui/base_student.html" %}
{% load i18n %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">{% trans "Dashboard" %}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'ui-semester-list' %}">{% trans "Semestres" %}</a></li>
    {% if mode == "edit" %}
      <li class="breadcrumb-item active" aria-current="page">{% trans "Editar semestre" %}</li>
    {% else %}
      <li class="breadcrumb-item active" aria-current="page">{% trans "Novo semestre" %}</li>
    {% endif %}
  </ol>
</nav>

<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    {% if mode == "edit" %}
      <h1 class="h4 mb-1">{% trans "Editar semestre" %}</h1>
      <div class="text-muted">{{ semester.name }}</div>
    {% else %}
      <h1 class="h4 mb-1">{% trans "Novo semestre" %}</h1>
      <div class="text-muted">{% trans "Cadastre um novo semestre." %}</div>
    {% endif %}
  </div>
  <a class="btn btn-outline-secondary" href="{% url 'ui-semester-list' %}">{% trans "Voltar" %}</a>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <form method="post">
      {% csrf_token %}
      {% if form.non_field_errors %}
        <div class="alert alert-danger">{{ form.non_field_errors }}</div>
      {% endif %}
      {% for field in form %}
        <div class="mb-3">
          <label class="form-label">{{ field.label }}</label>
          {{ field }}
          {% if field.help_text %}
            <div class="form-text">{{ field.help_text }}</div>
          {% endif %}
          {% for error in field.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
      {% endfor %}
      <button class="btn btn-primary" type="submit">
        {% if mode == "edit" %}{% trans "Salvar" %}{% else %}{% trans "Criar" %}{% endif %}
      </button>
    </form>
  </div>
</div>
{% endblock %}

----- END FILE: templates/ui/semester/semester_form.html -----

----- BEGIN FILE: templates/ui/semester/semester_list.html -----
{% extends "ui/base_student.html" %}
{% load i18n %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">{% trans "Dashboard" %}</a></li>
    <li class="breadcrumb-item active" aria-current="page">{% trans "Semestres" %}</li>
  </ol>
</nav>

<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h1 class="h4 mb-1">{% trans "Semestres" %}</h1>
    <div class="text-muted">{% trans "Gerencie seus semestres e disciplinas." %}</div>
  </div>
  <a class="btn btn-primary" href="{% url 'ui-semester-create' %}">{% trans "Novo Semestre" %}</a>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    {% if semesters %}
      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>{% trans "Nome" %}</th>
              <th>{% trans "Inicio" %}</th>
              <th>{% trans "Termino" %}</th>
              <th>{% trans "Status" %}</th>
              <th class="text-end">{% trans "Acoes" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for semester in semesters %}
              <tr>
                <td>{{ semester.name }}</td>
                <td>{{ semester.start_date|date:"d/m/Y" }}</td>
                <td>{{ semester.end_date|date:"d/m/Y" }}</td>
                <td>{{ semester.get_status_display }}</td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-primary" href="{% url 'ui-semester-detail' semester.pk %}">{% trans "Ver" %}</a>
                  <a class="btn btn-sm btn-outline-secondary" href="{% url 'ui-semester-edit' semester.pk %}">{% trans "Editar" %}</a>
                  <a class="btn btn-sm btn-outline-danger" href="{% url 'ui-semester-delete' semester.pk %}">{% trans "Excluir" %}</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted">{% trans "Nenhum semestre cadastrado." %}</div>
    {% endif %}
  </div>
</div>
{% endblock %}

----- END FILE: templates/ui/semester/semester_list.html -----

----- BEGIN FILE: templates/ui/semesters.html -----
{% extends "ui/base_student.html" %}
{% load i18n %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h1 class="h4 mb-1">{% trans "Semestres" %}</h1>
    <div class="text-muted">{% trans "Resumo das disciplinas e progresso" %}</div>
  </div>
</div>

<form class="row g-2 mb-3" method="get">
  <div class="col-sm-4 col-md-2">
    <select class="form-select form-select-sm" name="status">
      <option value="">{% trans "Todos os status" %}</option>
      <option value="ACTIVE" {% if status_filter == "ACTIVE" %}selected{% endif %}>{% trans "Ativo" %}</option>
      <option value="FINISHED" {% if status_filter == "FINISHED" %}selected{% endif %}>{% trans "Finalizado" %}</option>
    </select>
  </div>
  <div class="col-sm-4 col-md-3">
    <input class="form-control form-control-sm" type="text" name="course" placeholder="{% trans "Filtrar por disciplina" %}"
           value="{{ course_query }}">
  </div>
  <div class="col-sm-4 col-md-3">
    <input class="form-control form-control-sm" type="text" name="teacher" placeholder="{% trans "Filtrar por professor" %}"
           value="{{ teacher_query }}">
  </div>
  <div class="col-auto">
    <button class="btn btn-sm btn-outline-secondary" type="submit">{% trans "Filtrar" %}</button>
    <a class="btn btn-sm btn-link" href="/semesters/?clear=1">{% trans "Limpar" %}</a>
  </div>
</form>

{% if semesters %}
  {% for semester in semesters %}
    <div class="card shadow-sm mb-3">
      <div class="card-header bg-white d-flex justify-content-between">
        <div class="fw-semibold">{{ semester.name }}</div>
        <div class="text-muted small">{{ semester.start_date|date:"d/m/Y" }} - {{ semester.end_date|date:"d/m/Y" }}</div>
      </div>
      <div class="card-body">
        {% if semester.courses %}
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>{% trans "Disciplina" %}</th>
                  <th>{% trans "Professor" %}</th>
                  <th>{% trans "Status" %}</th>
                  <th>{% trans "Media atual" %}</th>
                  <th>{% trans "Progresso" %}</th>
                  <th>{% trans "Falta para passar" %}</th>
                </tr>
              </thead>
              <tbody>
                {% for course in semester.courses %}
                  <tr>
                    <td>{{ course.title }}</td>
                    <td>{{ course.teacher|default:"-" }}</td>
                    <td>
                      {% if course.status == "PASSED" %}
                        <span class="badge text-bg-success">{% trans "Aprovado" %}</span>
                      {% elif course.status == "FAILED" %}
                        <span class="badge text-bg-danger">{% trans "Reprovado" %}</span>
                      {% else %}
                        <span class="badge text-bg-secondary">{% trans "Em andamento" %}</span>
                      {% endif %}
                    </td>
                    <td>{{ course.current_average }}</td>
                    <td style="min-width: 180px;">
                      <div class="d-flex justify-content-between">
                        <span class="small text-muted">{{ course.progress_percent }}%</span>
                      </div>
                      <div class="progress mt-1" style="height: 6px;">
                        <div class="progress-bar" role="progressbar" style="width: {{ course.progress_percent_css }}%;"></div>
                      </div>
                    </td>
                    <td>{{ course.needed_to_pass }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-muted">{% trans "Nenhuma disciplina cadastrada." %}</div>
        {% endif %}
      </div>
    </div>
  {% endfor %}
{% else %}
  <div class="alert alert-info">{% trans "Nenhum semestre cadastrado." %}</div>
{% endif %}
{% endblock %}

----- END FILE: templates/ui/semesters.html -----

----- BEGIN FILE: templates/ui/tasks.html -----
{% extends "ui/base_student.html" %}
{% load i18n %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h1 class="h4 mb-1">{% trans "Tarefas" %}</h1>
    <div class="text-muted">{% trans "Lista de tarefas academicas" %}</div>
  </div>
</div>

<form class="row g-2 mb-3" method="get">
  <div class="col-sm-4 col-md-3">
    <input class="form-control form-control-sm" type="text" name="q" placeholder="{% trans "Buscar tarefa" %}"
           value="{{ search_query }}">
  </div>
  <div class="col-sm-4 col-md-2">
    <select class="form-select form-select-sm" name="stress">
      <option value="">{% trans "Stress" %}</option>
      <option value="1" {% if stress_filter == "1" %}selected{% endif %}>1</option>
      <option value="2" {% if stress_filter == "2" %}selected{% endif %}>2</option>
      <option value="3" {% if stress_filter == "3" %}selected{% endif %}>3</option>
      <option value="4" {% if stress_filter == "4" %}selected{% endif %}>4</option>
      <option value="5" {% if stress_filter == "5" %}selected{% endif %}>5</option>
    </select>
  </div>
  <div class="col-sm-4 col-md-3">
    <select class="form-select form-select-sm" name="status">
      <option value="">{% trans "Todos os status" %}</option>
      <option value="TODO" {% if status_filter == "TODO" %}selected{% endif %}>{% trans "A fazer" %}</option>
      <option value="DOING" {% if status_filter == "DOING" %}selected{% endif %}>{% trans "Em andamento" %}</option>
      <option value="DONE" {% if status_filter == "DONE" %}selected{% endif %}>{% trans "Concluida" %}</option>
    </select>
  </div>
  <div class="col-sm-4 col-md-3">
    <select class="form-select form-select-sm" name="due">
      <option value="">{% trans "Todas as datas" %}</option>
      <option value="overdue" {% if due_filter == "overdue" %}selected{% endif %}>{% trans "Atrasadas" %}</option>
      <option value="today" {% if due_filter == "today" %}selected{% endif %}>{% trans "Hoje" %}</option>
      <option value="week" {% if due_filter == "week" %}selected{% endif %}>{% trans "Proxima semana" %}</option>
      <option value="month" {% if due_filter == "month" %}selected{% endif %}>{% trans "Proximo mes" %}</option>
    </select>
  </div>
  <div class="col-auto">
    <button class="btn btn-sm btn-outline-secondary" type="submit">{% trans "Filtrar" %}</button>
    <a class="btn btn-sm btn-link" href="/tasks/?clear=1">{% trans "Limpar" %}</a>
  </div>
</form>

<div class="card shadow-sm">
  <div class="card-body">
    {% if tasks %}
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>{% trans "Titulo" %}</th>
              <th>{% trans "Entrega" %}</th>
              <th>{% trans "Stress" %}</th>
              <th>{% trans "Status" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for task in tasks %}
              <tr>
                <td>
                  <div class="fw-semibold">{{ task.title }}</div>
                  <div class="text-muted small">{{ task.description|default:"" }}</div>
                </td>
                <td>{{ task.due_date|date:"d/m/Y" }}</td>
                <td>{{ task.stress_level }}</td>
                <td>
                  {% if task.status == "DONE" %}
                    <span class="badge text-bg-success">{% trans "Concluida" %}</span>
                  {% elif task.status == "DOING" %}
                    <span class="badge text-bg-primary">{% trans "Em andamento" %}</span>
                  {% else %}
                    <span class="badge text-bg-secondary">{% trans "A fazer" %}</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted">{% trans "Nenhuma tarefa cadastrada." %}</div>
    {% endif %}
  </div>
</div>
{% endblock %}

----- END FILE: templates/ui/tasks.html -----

----- BEGIN FILE: templates/ui/tasks/task_confirm_delete.html -----
{% extends "ui/base_student.html" %}
{% load i18n %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">{% trans "Dashboard" %}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'ui-task-list' %}">{% trans "Tarefas" %}</a></li>
    <li class="breadcrumb-item active" aria-current="page">{% trans "Excluir tarefa" %}</li>
  </ol>
</nav>

<div class="card shadow-sm">
  <div class="card-body">
    <h1 class="h5 mb-3">{% trans "Excluir tarefa" %}</h1>
    <p class="text-muted">{% trans "Tem certeza que deseja excluir a tarefa" %} <strong>{{ task.title }}</strong>?</p>
    <form method="post">
      {% csrf_token %}
      <a class="btn btn-outline-secondary" href="{% url 'ui-task-detail' task.pk %}">{% trans "Cancelar" %}</a>
      <button class="btn btn-danger" type="submit">{% trans "Excluir" %}</button>
    </form>
  </div>
</div>
{% endblock %}

----- END FILE: templates/ui/tasks/task_confirm_delete.html -----

----- BEGIN FILE: templates/ui/tasks/task_detail.html -----
{% extends "ui/base_student.html" %}
{% load i18n %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">{% trans "Dashboard" %}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'ui-task-list' %}">{% trans "Tarefas" %}</a></li>
    <li class="breadcrumb-item active" aria-current="page">{{ task.title }}</li>
  </ol>
</nav>

<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h1 class="h4 mb-1">{{ task.title }}</h1>
    <div class="text-muted">{% trans "Entrega" %}: {{ task.due_date|date:"d/m/Y" }}</div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{% url 'ui-task-list' %}">{% trans "Voltar" %}</a>
    <a class="btn btn-outline-primary" href="{% url 'ui-task-edit' task.pk %}">{% trans "Editar" %}</a>
    <a class="btn btn-outline-danger" href="{% url 'ui-task-delete' task.pk %}">{% trans "Excluir" %}</a>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-3">
        <div class="text-muted small">{% trans "Status" %}</div>
        <div class="fw-semibold">{{ task.get_status_display }}</div>
      </div>
      <div class="col-md-3">
        <div class="text-muted small">{% trans "Nivel de estresse" %}</div>
        <div class="fw-semibold">{{ task.stress_level }}</div>
      </div>
      <div class="col-md-6">
        <div class="text-muted small">{% trans "Descricao" %}</div>
        <div class="fw-semibold">{{ task.description|default:"-" }}</div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

----- END FILE: templates/ui/tasks/task_detail.html -----

----- BEGIN FILE: templates/ui/tasks/task_form.html -----
{% extends "ui/base_student.html" %}
{% load i18n %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">{% trans "Dashboard" %}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'ui-task-list' %}">{% trans "Tarefas" %}</a></li>
    {% if mode == "edit" %}
      <li class="breadcrumb-item active" aria-current="page">{% trans "Editar tarefa" %}</li>
    {% else %}
      <li class="breadcrumb-item active" aria-current="page">{% trans "Nova tarefa" %}</li>
    {% endif %}
  </ol>
</nav>

<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    {% if mode == "edit" %}
      <h1 class="h4 mb-1">{% trans "Editar tarefa" %}</h1>
      <div class="text-muted">{{ task.title }}</div>
    {% else %}
      <h1 class="h4 mb-1">{% trans "Nova tarefa" %}</h1>
      <div class="text-muted">{% trans "Cadastre uma nova tarefa." %}</div>
    {% endif %}
  </div>
  <a class="btn btn-outline-secondary" href="{% url 'ui-task-list' %}">{% trans "Voltar" %}</a>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <form method="post">
      {% csrf_token %}
      {% if form.non_field_errors %}
        <div class="alert alert-danger">{{ form.non_field_errors }}</div>
      {% endif %}
      {% for field in form %}
        <div class="mb-3">
          <label class="form-label">{{ field.label }}</label>
          {{ field }}
          {% if field.help_text %}
            <div class="form-text">{{ field.help_text }}</div>
          {% endif %}
          {% for error in field.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
      {% endfor %}
      <button class="btn btn-primary" type="submit">
        {% if mode == "edit" %}{% trans "Salvar" %}{% else %}{% trans "Criar" %}{% endif %}
      </button>
    </form>
  </div>
</div>
{% endblock %}

----- END FILE: templates/ui/tasks/task_form.html -----

----- BEGIN FILE: templates/ui/tasks/task_list.html -----
{% extends "ui/base_student.html" %}
{% load i18n %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">{% trans "Dashboard" %}</a></li>
    <li class="breadcrumb-item active" aria-current="page">{% trans "Tarefas" %}</li>
  </ol>
</nav>

<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h1 class="h4 mb-1">{% trans "Tarefas" %}</h1>
    <div class="text-muted">{% trans "Organize suas tarefas e prazos." %}</div>
  </div>
  <a class="btn btn-primary" href="{% url 'ui-task-create' %}">{% trans "Nova tarefa" %}</a>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <form class="row g-2 align-items-end" method="get">
      <div class="col-md-4">
        <label class="form-label">{% trans "Buscar" %}</label>
        <input class="form-control" type="text" name="q" value="{{ query }}" placeholder="{% trans "Buscar tarefa" %}">
      </div>
      <div class="col-md-3">
        <label class="form-label">{% trans "Status" %}</label>
        <select class="form-select" name="status">
          <option value="">{% trans "Todos os status" %}</option>
          <option value="TODO" {% if status_filter == "TODO" %}selected{% endif %}>{% trans "A fazer" %}</option>
          <option value="DOING" {% if status_filter == "DOING" %}selected{% endif %}>{% trans "Em andamento" %}</option>
          <option value="DONE" {% if status_filter == "DONE" %}selected{% endif %}>{% trans "Concluida" %}</option>
        </select>
      </div>
      <div class="col-md-2">
        <button class="btn btn-outline-primary w-100" type="submit">{% trans "Filtrar" %}</button>
      </div>
      <div class="col-md-2">
        <a class="btn btn-outline-secondary w-100" href="{% url 'ui-task-list' %}">{% trans "Limpar" %}</a>
      </div>
    </form>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    {% if tasks %}
      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>{% trans "Tarefa" %}</th>
              <th>{% trans "Entrega" %}</th>
              <th>{% trans "Status" %}</th>
              <th>{% trans "Estresse" %}</th>
              <th class="text-end">{% trans "Acoes" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for task in tasks %}
              <tr>
                <td>{{ task.title }}</td>
                <td>{{ task.due_date|date:"d/m/Y" }}</td>
                <td><span class="badge text-bg-light">{{ task.get_status_display }}</span></td>
                <td><span class="badge text-bg-secondary">{{ task.stress_level }}</span></td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-primary" href="{% url 'ui-task-detail' task.pk %}">{% trans "Ver" %}</a>
                  <a class="btn btn-sm btn-outline-secondary" href="{% url 'ui-task-edit' task.pk %}">{% trans "Editar" %}</a>
                  <a class="btn btn-sm btn-outline-danger" href="{% url 'ui-task-delete' task.pk %}">{% trans "Excluir" %}</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted">{% trans "Nenhuma tarefa cadastrada." %}</div>
    {% endif %}
  </div>
</div>
{% endblock %}

----- END FILE: templates/ui/tasks/task_list.html -----

----- BEGIN FILE: utils/academic_progress.py -----
from decimal import Decimal, ROUND_HALF_UP


def calculate_course_average(course) -> Decimal:
    assessments = course.assessments.all()
    total_weight = sum((a.weight for a in assessments), Decimal("0"))
    if total_weight == 0:
        return Decimal("0")
    total_score = sum((a.score * a.weight for a in assessments), Decimal("0"))
    return (total_score / total_weight).quantize(Decimal("0.01"), rounding=ROUND_HALF_UP)


def calculate_progress_percent(course) -> Decimal:
    current_average = calculate_course_average(course)
    passing_grade = course.passing_grade or Decimal("0")
    if passing_grade == 0:
        return Decimal("0")
    progress = (current_average / passing_grade) * Decimal("100")
    return min(Decimal("100"), progress)


def calculate_needed_to_pass(course) -> Decimal:
    current_average = calculate_course_average(course)
    passing_grade = course.passing_grade or Decimal("0")
    needed = passing_grade - current_average
    return max(Decimal("0"), needed)


def update_course_status(course, semester_status: str | None = None) -> None:
    from utils.constants import COURSE_FAILED, COURSE_IN_PROGRESS, COURSE_PASSED, SEMESTER_FINISHED

    progress = calculate_progress_percent(course)
    if progress >= Decimal("100"):
        course.status = COURSE_PASSED
        return
    if semester_status == SEMESTER_FINISHED:
        course.status = COURSE_FAILED
        return
    course.status = COURSE_IN_PROGRESS

----- END FILE: utils/academic_progress.py -----

----- BEGIN FILE: utils/constants.py -----
from django.utils.translation import gettext_lazy as _

PLAN_LITE = "LITE"
PLAN_PRO = "PRO"
PLAN_CHOICES = [
    (PLAN_LITE, "Lite"),
    (PLAN_PRO, "Pro"),
]

MOOD_VERY_BAD = "VERY_BAD"
MOOD_BAD = "BAD"
MOOD_OK = "OK"
MOOD_GOOD = "GOOD"
MOOD_VERY_GOOD = "VERY_GOOD"
MOOD_CHOICES = [
    (MOOD_VERY_BAD, "Very bad"),
    (MOOD_BAD, "Bad"),
    (MOOD_OK, "Ok"),
    (MOOD_GOOD, "Good"),
    (MOOD_VERY_GOOD, "Very good"),
]

POMODORO_COMPLETED = "COMPLETED"
POMODORO_STOPPED = "STOPPED"
POMODORO_STATUS_CHOICES = [
    (POMODORO_COMPLETED, "Completed"),
    (POMODORO_STOPPED, "Stopped"),
]

TASK_TODO = "TODO"
TASK_DOING = "DOING"
TASK_DONE = "DONE"
TASK_STATUS_CHOICES = [
    (TASK_TODO, _("Todo")),
    (TASK_DOING, _("Doing")),
    (TASK_DONE, _("Done")),
]

EVENT_PROVA = "PROVA"
EVENT_ENTREGA = "ENTREGA"
EVENT_APRESENTACAO = "APRESENTACAO"
EVENT_AULA_IMPORTANTE = "AULA_IMPORTANTE"
EVENT_REUNIAO_GRUPO = "REUNIAO_GRUPO"
EVENT_REUNIAO_PROFESSORES = "REUNIAO_PROFESSORES"
EVENT_ESTUDAR_FACULDADE = "ESTUDAR_FACULDADE"
EVENT_OUTRO = "OUTRO"
EVENT_TYPE_CHOICES = [
    (EVENT_PROVA, "Prova"),
    (EVENT_ENTREGA, "Entrega"),
    (EVENT_APRESENTACAO, "Apresentacao"),
    (EVENT_AULA_IMPORTANTE, "Aula importante"),
    (EVENT_REUNIAO_GRUPO, "Reuniao em grupo"),
    (EVENT_REUNIAO_PROFESSORES, "Reuniao com professores"),
    (EVENT_ESTUDAR_FACULDADE, "Estudar na faculdade"),
    (EVENT_OUTRO, "Outro"),
]

REMINDER_TARGET_TASK = "TASK"
REMINDER_TARGET_EVENT = "EVENT"
REMINDER_TARGET_CHOICES = [
    (REMINDER_TARGET_TASK, _("Tarefa")),
    (REMINDER_TARGET_EVENT, _("Evento")),
]

CHANNEL_IN_APP = "IN_APP"
CHANNEL_EMAIL = "EMAIL"
CHANNEL_WHATSAPP = "WHATSAPP"
CHANNEL_SMS = "SMS"
CHANNEL_CHOICES = [
    (CHANNEL_IN_APP, "In app"),
    (CHANNEL_EMAIL, "Email"),
    (CHANNEL_WHATSAPP, "WhatsApp"),
    (CHANNEL_SMS, "SMS"),
]

NOTIF_PENDING = "PENDING"
NOTIF_SENT = "SENT"
NOTIF_FAILED = "FAILED"
NOTIFICATION_STATUS_CHOICES = [
    (NOTIF_PENDING, _("Pendente")),
    (NOTIF_SENT, _("Enviado")),
    (NOTIF_FAILED, _("Erro")),
]

ACTION_NONE = "NONE"
ACTION_CONFIRMED = "CONFIRMED"
ACTION_DELAYED = "DELAYED"
ACTION_CANCELED = "CANCELED"
NOTIFICATION_ACTION_CHOICES = [
    (ACTION_NONE, "None"),
    (ACTION_CONFIRMED, "Confirmed"),
    (ACTION_DELAYED, "Delayed"),
    (ACTION_CANCELED, "Canceled"),
]

SEMESTER_ACTIVE = "ACTIVE"
SEMESTER_FINISHED = "FINISHED"
SEMESTER_STATUS_CHOICES = [
    (SEMESTER_ACTIVE, _("Ativo")),
    (SEMESTER_FINISHED, _("Finalizado")),
]

COURSE_IN_PROGRESS = "IN_PROGRESS"
COURSE_PASSED = "PASSED"
COURSE_FAILED = "FAILED"
COURSE_STATUS_CHOICES = [
    (COURSE_IN_PROGRESS, "In progress"),
    (COURSE_PASSED, "Passed"),
    (COURSE_FAILED, "Failed"),
]

COACH_PRAZO_PROXIMO = "PRAZO_PROXIMO"
COACH_ATRASO = "ATRASO"
COACH_HUMOR_BAIXO = "HUMOR_BAIXO"
COACH_SEMESTRE_CONCLUIDO = "SEMESTRE_CONCLUIDO"
COACH_REPROVACAO = "REPROVACAO"
COACH_TRIGGER_CHOICES = [
    (COACH_PRAZO_PROXIMO, "Prazo proximo"),
    (COACH_ATRASO, "Atraso"),
    (COACH_HUMOR_BAIXO, "Humor baixo"),
    (COACH_SEMESTRE_CONCLUIDO, "Semestre concluido"),
    (COACH_REPROVACAO, "Reprovacao"),
]

CONTENT_PRE_PROVA = "PRE_PROVA"
CONTENT_ANTI_PROCRASTINACAO = "ANTI_PROCRASTINACAO"
CONTENT_FOCO = "FOCO"
CONTENT_CATEGORY_CHOICES = [
    (CONTENT_PRE_PROVA, "Pre-prova"),
    (CONTENT_ANTI_PROCRASTINACAO, "Anti-procrastinacao"),
    (CONTENT_FOCO, "Foco"),
]

REQUESTER_INDIVIDUAL = "INDIVIDUAL"
REQUESTER_INSTITUTION = "INSTITUTION"
REQUESTER_TYPE_CHOICES = [
    (REQUESTER_INDIVIDUAL, "Individual"),
    (REQUESTER_INSTITUTION, "Institution"),
]

ACCESS_PENDING = "PENDING"
ACCESS_APPROVED = "APPROVED"
ACCESS_REJECTED = "REJECTED"
ACCESS_STATUS_CHOICES = [
    (ACCESS_PENDING, "Pending"),
    (ACCESS_APPROVED, "Approved"),
    (ACCESS_REJECTED, "Rejected"),
]

STEP_1_PROFILE = "STEP_1_PROFILE"
STEP_2_SEMESTER = "STEP_2_SEMESTER"
STEP_3_COURSES = "STEP_3_COURSES"
STEP_4_ASSESSMENTS = "STEP_4_ASSESSMENTS"
STEP_5_REMINDERS = "STEP_5_REMINDERS"
STEP_6_DASHBOARD = "STEP_6_DASHBOARD"

FEATURE_MOOD_BASIC = "MOOD_BASIC"
FEATURE_POMODORO_BASIC = "POMODORO_BASIC"
FEATURE_PLANNER_BASIC = "PLANNER_BASIC"
FEATURE_AGENDA_BASIC = "AGENDA_BASIC"
FEATURE_IN_APP_REMINDERS = "IN_APP_REMINDERS"
FEATURE_DASHBOARD_BASIC = "DASHBOARD_BASIC"
FEATURE_CONTENT_LIMITED = "CONTENT_LIMITED"
FEATURE_EMAIL_NOTIFICATIONS = "EMAIL_NOTIFICATIONS"
FEATURE_REPORTS_ADVANCED = "REPORTS_ADVANCED"
FEATURE_SEMESTER_SUMMARY = "SEMESTER_SUMMARY"
FEATURE_COACH_ADVANCED = "COACH_ADVANCED"
FEATURE_CONTENT_FULL = "CONTENT_FULL"
FEATURE_WHATSAPP = "WHATSAPP"
FEATURE_SMS = "SMS"

----- END FILE: utils/constants.py -----

----- BEGIN FILE: utils/features.py -----
from typing import Optional

from rest_framework.exceptions import PermissionDenied

from billing.models import Plan, UserSubscription
from utils.constants import PLAN_LITE


def get_user_plan(user) -> Optional[Plan]:
    if not user or not getattr(user, "is_authenticated", False):
        return None
    subscription = (
        UserSubscription.objects.filter(user=user, is_active=True)
        .select_related("plan")
        .first()
    )
    if subscription and subscription.plan and subscription.plan.is_active:
        return subscription.plan
    return Plan.objects.filter(code=PLAN_LITE, is_active=True).first()


def has_feature(user, feature_name: str) -> bool:
    plan = get_user_plan(user)
    if not plan or plan.features is None:
        return False
    if isinstance(plan.features, list):
        return feature_name in plan.features
    if isinstance(plan.features, dict):
        return bool(plan.features.get(feature_name))
    return False


def require_feature(user, feature_name: str, message: Optional[str] = None) -> None:
    if not has_feature(user, feature_name):
        raise PermissionDenied(message or "Seu plano atual nao permite este recurso.")

----- END FILE: utils/features.py -----

----- BEGIN FILE: utils/gating.py -----
from typing import List, Tuple

from django.utils.translation import gettext_lazy as _

from utils.constants import (
    STEP_1_PROFILE,
    STEP_2_SEMESTER,
    STEP_3_COURSES,
    STEP_4_ASSESSMENTS,
    STEP_5_REMINDERS,
    STEP_6_DASHBOARD,
)

STEPS = [
    (STEP_1_PROFILE, "has_profile", _("Complete seu perfil para continuar.")),
    (STEP_2_SEMESTER, "has_active_semester", _("Crie um semestre ativo.")),
    (STEP_3_COURSES, "has_at_least_one_course", _("Cadastre ao menos uma disciplina.")),
    (STEP_4_ASSESSMENTS, "has_at_least_one_assessment", _("Cadastre ao menos uma avaliacao.")),
    (STEP_5_REMINDERS, "has_reminder_rule", _("Configure pelo menos uma regra de lembrete.")),
    (STEP_6_DASHBOARD, None, _("Tudo pronto para seu dashboard.")),
]


def get_or_create_progress(user):
    from onboarding.models import UserSetupProgress

    progress, _ = UserSetupProgress.objects.get_or_create(user=user)
    return progress


def compute_status(progress) -> Tuple[str, List[str], List[str]]:
    missing_steps = []
    required_actions = []
    for step, field, message in STEPS:
        if field is None:
            continue
        if not getattr(progress, field):
            missing_steps.append(step)
            required_actions.append(message)
    current_step = missing_steps[0] if missing_steps else STEP_6_DASHBOARD
    return current_step, missing_steps, required_actions


def gate_course_progress(course) -> Tuple[bool, str]:
    if not course.assessments.exists():
        return False, "Cadastre ao menos uma avaliacao antes de ver o progresso."
    return True, ""


def gate_finish_semester(semester) -> Tuple[bool, str]:
    if not semester.courses.exists():
        return False, "Nao e possivel finalizar um semestre sem disciplinas."
    return True, ""


def gate_generate_reminders(user) -> Tuple[bool, str]:
    from agenda.models import ReminderRule

    if not ReminderRule.objects.filter(user=user, is_active=True).exists():
        return False, "Configure uma regra de lembrete antes de gerar notificacoes."
    return True, ""

----- END FILE: utils/gating.py -----

----- BEGIN FILE: utils/messages.py -----
from dataclasses import dataclass
from datetime import timedelta
from typing import Iterable, Optional

from django.core.mail import send_mail
from django.utils import timezone

from notifications.models import NotificationQueue
from utils.constants import (
    CHANNEL_EMAIL,
    CHANNEL_IN_APP,
    CHANNEL_SMS,
    CHANNEL_WHATSAPP,
    FEATURE_EMAIL_NOTIFICATIONS,
    FEATURE_SMS,
    FEATURE_WHATSAPP,
    NOTIF_FAILED,
    NOTIF_SENT,
)
from utils.features import has_feature


MESSAGE_REMINDER = "REMINDER"
MESSAGE_CARE = "CARE"
MESSAGE_INCENTIVE = "INCENTIVE"
MESSAGE_WARNING = "WARNING"
MESSAGE_ACHIEVEMENT = "ACHIEVEMENT"
MESSAGE_SYSTEM = "SYSTEM"

PRIORITY_LOW = "LOW"
PRIORITY_NORMAL = "NORMAL"
PRIORITY_HIGH = "HIGH"


@dataclass
class MessageTemplate:
    title: str
    body: str
    suggested_action: Optional[str] = None
    priority: str = PRIORITY_NORMAL


TEMPLATES = {
    (MESSAGE_INCENTIVE, "assessment_progress_up"): MessageTemplate(
        title="Progresso em disciplina",
        body=(
            "Voce avancou bem na disciplina {course}. "
            "Seu progresso atual esta em {progress}% e segue em evoluo."
        ),
        suggested_action="Manter pequenos blocos de estudo pode ajudar a seguir tranquilo.",
        priority=PRIORITY_NORMAL,
    ),
    (MESSAGE_CARE, "assessment_progress_down"): MessageTemplate(
        title="Ajuste de ritmo",
        body=(
            "Seu progresso em {course} teve uma pequena queda. "
            "Isso pode acontecer em semanas mais intensas."
        ),
        suggested_action="Revisar pontos-chave com calma pode trazer mais estabilidade.",
        priority=PRIORITY_NORMAL,
    ),
    (MESSAGE_WARNING, "low_progress_upcoming"): MessageTemplate(
        title="Ateno suave",
        body=(
            "Talvez revisar {course} com pequenos blocos ajuda a reduzir a presso desta semana."
        ),
        suggested_action="Escolha um horario curto para revisar o conteudo mais importante.",
        priority=PRIORITY_HIGH,
    ),
    (MESSAGE_ACHIEVEMENT, "course_passed"): MessageTemplate(
        title="Meta alcanada",
        body=(
            "Voce atingiu a media necessaria em {course}. Otimo avanco."
        ),
        suggested_action="Continue acompanhando as proximas avaliaces com tranquilidade.",
        priority=PRIORITY_NORMAL,
    ),
    (MESSAGE_ACHIEVEMENT, "semester_all_passed"): MessageTemplate(
        title="Semestre concluido",
        body=(
            "Voce concluiu o semestre com todas as disciplinas aprovadas. "
            "Parabens pelo cuidado e consistencia."
        ),
        suggested_action="Reserve um tempo para celebrar e recarregar as energias.",
        priority=PRIORITY_NORMAL,
    ),
    (MESSAGE_CARE, "semester_with_fail"): MessageTemplate(
        title="Continuidade do semestre",
        body=(
            "Algumas disciplinas ficaram abaixo da media no fechamento. "
            "Isso no diminui seu esforco, siga firme."
        ),
        suggested_action="Podemos organizar um plano simples de retomada para o proximo ciclo.",
        priority=PRIORITY_NORMAL,
    ),
    (MESSAGE_INCENTIVE, "semester_continue"): MessageTemplate(
        title="Plano de continuidade",
        body=(
            "Com alguns ajustes, voce pode recuperar o ritmo nas proximas semanas."
        ),
        suggested_action="Defina metas curtas e realistas para reequilibrar as disciplinas.",
        priority=PRIORITY_LOW,
    ),
}


def _build_message(message_type: str, context: dict) -> MessageTemplate:
    event = context.get("event")
    template = TEMPLATES.get((message_type, event))
    if not template:
        template = MessageTemplate(
            title="Mensagem do Campus Calm",
            body=context.get("body", "Estamos aqui para apoiar sua jornada academica."),
            suggested_action=context.get("suggested_action"),
        )
    return MessageTemplate(
        title=template.title.format(**context),
        body=template.body.format(**context),
        suggested_action=template.suggested_action.format(**context)
        if template.suggested_action
        else None,
        priority=template.priority,
    )


def _should_skip_duplicate(user, title: str) -> bool:
    since = timezone.now() - timedelta(hours=24)
    return NotificationQueue.objects.filter(user=user, title=title, scheduled_for__gte=since).exists()


def send_message(user, message_type: str, context: dict, channels: Optional[Iterable[str]] = None) -> None:
    if channels is None:
        channels = [CHANNEL_IN_APP]
    channels = list(dict.fromkeys(channels))
    if CHANNEL_IN_APP not in channels:
        channels.insert(0, CHANNEL_IN_APP)

    message = _build_message(message_type, context)
    if _should_skip_duplicate(user, message.title):
        return

    base_body = message.body
    if message.suggested_action:
        base_body = f"{base_body}\n\nSugestao: {message.suggested_action}"

    now = timezone.now()
    for channel in channels:
        if channel == CHANNEL_EMAIL and not has_feature(user, FEATURE_EMAIL_NOTIFICATIONS):
            continue
        if channel == CHANNEL_WHATSAPP and not has_feature(user, FEATURE_WHATSAPP):
            continue
        if channel == CHANNEL_SMS and not has_feature(user, FEATURE_SMS):
            continue

        status = NOTIF_SENT
        if channel == CHANNEL_EMAIL:
            try:
                send_mail(message.title, base_body, None, [user.email])
            except Exception:
                status = NOTIF_FAILED

        NotificationQueue.objects.create(
            user=user,
            channel=channel,
            title=message.title,
            message=base_body,
            scheduled_for=now,
            status=status,
        )

----- END FILE: utils/messages.py -----

----- BEGIN FILE: utils/triage.py -----
import os
from typing import Dict

from utils.constants import (
    FEATURE_COACH_ADVANCED,
    FEATURE_EMAIL_NOTIFICATIONS,
    FEATURE_REPORTS_ADVANCED,
    FEATURE_SMS,
    FEATURE_WHATSAPP,
    PLAN_LITE,
    PLAN_PRO,
    REQUESTER_INSTITUTION,
)

TRIAGE_MODEL_NAME = os.getenv("TRIAGE_MODEL_NAME", "mock-v1")
TRIAGE_USE_LLM = os.getenv("TRIAGE_USE_LLM", "false").lower() == "true"


def rule_based_plan(access_request) -> str:
    if access_request.requester_type == REQUESTER_INSTITUTION:
        return PLAN_PRO
    if access_request.estimated_users and access_request.estimated_users >= 50:
        return PLAN_PRO
    wants = set(access_request.wants_features or [])
    pro_features = {
        FEATURE_REPORTS_ADVANCED,
        FEATURE_EMAIL_NOTIFICATIONS,
        FEATURE_WHATSAPP,
        FEATURE_SMS,
        FEATURE_COACH_ADVANCED,
    }
    if wants.intersection(pro_features):
        return PLAN_PRO
    return PLAN_LITE


def mock_ai_output(recommended_plan: str) -> Dict[str, object]:
    if recommended_plan == PLAN_PRO:
        score = 82
        rationale = "Solicitacao com sinais de necessidade avancada."
    else:
        score = 28
        rationale = "Solicitacao adequada ao plano basico."
    return {
        "score": score,
        "recommended_plan": recommended_plan,
        "rationale": rationale,
        "llm_enabled": TRIAGE_USE_LLM,
    }


def run_triage(access_request) -> Dict[str, object]:
    recommended_plan = rule_based_plan(access_request)
    output = mock_ai_output(recommended_plan)
    return {
        "recommended_plan": recommended_plan,
        "output_payload": output,
    }

----- END FILE: utils/triage.py -----

========================================
ARQUIVOS BINARIOS/OMITIDOS (ENXUTO)
========================================
apps/access_requests/__init__.py [inode/x-empty]
apps/access_requests/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/access_requests/__pycache__/admin.cpython-312.pyc [application/x-bytecode.python]
apps/access_requests/__pycache__/apps.cpython-312.pyc [application/x-bytecode.python]
apps/access_requests/__pycache__/models.cpython-312.pyc [application/x-bytecode.python]
apps/access_requests/__pycache__/serializers.cpython-312.pyc [application/x-bytecode.python]
apps/access_requests/__pycache__/urls.cpython-312.pyc [application/x-bytecode.python]
apps/access_requests/__pycache__/views.cpython-312.pyc [application/x-bytecode.python]
apps/access_requests/migrations/__init__.py [inode/x-empty]
apps/access_requests/migrations/__pycache__/0001_initial.cpython-312.pyc [application/x-bytecode.python]
apps/access_requests/migrations/__pycache__/0002_initial.cpython-312.pyc [application/x-bytecode.python]
apps/access_requests/migrations/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/accounts/__init__.py [inode/x-empty]
apps/accounts/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/accounts/__pycache__/admin.cpython-312.pyc [application/x-bytecode.python]
apps/accounts/__pycache__/apps.cpython-312.pyc [application/x-bytecode.python]
apps/accounts/__pycache__/models.cpython-312.pyc [application/x-bytecode.python]
apps/accounts/__pycache__/serializers.cpython-312.pyc [application/x-bytecode.python]
apps/accounts/__pycache__/signals.cpython-312.pyc [application/x-bytecode.python]
apps/accounts/__pycache__/urls.cpython-312.pyc [application/x-bytecode.python]
apps/accounts/__pycache__/views.cpython-312.pyc [application/x-bytecode.python]
apps/accounts/migrations/__init__.py [inode/x-empty]
apps/accounts/migrations/__pycache__/0001_initial.cpython-312.pyc [application/x-bytecode.python]
apps/accounts/migrations/__pycache__/0002_userprofile.cpython-312.pyc [application/x-bytecode.python]
apps/accounts/migrations/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/agenda/__init__.py [inode/x-empty]
apps/agenda/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/agenda/__pycache__/admin.cpython-312.pyc [application/x-bytecode.python]
apps/agenda/__pycache__/apps.cpython-312.pyc [application/x-bytecode.python]
apps/agenda/__pycache__/models.cpython-312.pyc [application/x-bytecode.python]
apps/agenda/__pycache__/serializers.cpython-312.pyc [application/x-bytecode.python]
apps/agenda/__pycache__/urls.cpython-312.pyc [application/x-bytecode.python]
apps/agenda/__pycache__/views.cpython-312.pyc [application/x-bytecode.python]
apps/agenda/migrations/__init__.py [inode/x-empty]
apps/agenda/migrations/__pycache__/0001_initial.cpython-312.pyc [application/x-bytecode.python]
apps/agenda/migrations/__pycache__/0002_alter_calendarevent_event_type_and_more.cpython-312.pyc [application/x-bytecode.python]
apps/agenda/migrations/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/analytics/__init__.py [inode/x-empty]
apps/analytics/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/analytics/__pycache__/admin.cpython-312.pyc [application/x-bytecode.python]
apps/analytics/__pycache__/apps.cpython-312.pyc [application/x-bytecode.python]
apps/analytics/__pycache__/models.cpython-312.pyc [application/x-bytecode.python]
apps/analytics/__pycache__/urls.cpython-312.pyc [application/x-bytecode.python]
apps/analytics/__pycache__/views.cpython-312.pyc [application/x-bytecode.python]
apps/analytics/management/__init__.py [inode/x-empty]
apps/analytics/management/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/analytics/management/commands/__init__.py [inode/x-empty]
apps/analytics/management/commands/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/analytics/management/commands/__pycache__/seed_demo_data.cpython-312.pyc [application/x-bytecode.python]
apps/analytics/migrations/__init__.py [inode/x-empty]
apps/analytics/migrations/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/analytics/tests.py [inode/x-empty]
apps/billing/__init__.py [inode/x-empty]
apps/billing/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/billing/__pycache__/admin.cpython-312.pyc [application/x-bytecode.python]
apps/billing/__pycache__/apps.cpython-312.pyc [application/x-bytecode.python]
apps/billing/__pycache__/models.cpython-312.pyc [application/x-bytecode.python]
apps/billing/__pycache__/serializers.cpython-312.pyc [application/x-bytecode.python]
apps/billing/__pycache__/signals.cpython-312.pyc [application/x-bytecode.python]
apps/billing/__pycache__/urls.cpython-312.pyc [application/x-bytecode.python]
apps/billing/__pycache__/views.cpython-312.pyc [application/x-bytecode.python]
apps/billing/migrations/__init__.py [inode/x-empty]
apps/billing/migrations/__pycache__/0001_initial.cpython-312.pyc [application/x-bytecode.python]
apps/billing/migrations/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/billing/tests.py [inode/x-empty]
apps/brain/__init__.py [inode/x-empty]
apps/brain/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/brain/__pycache__/admin.cpython-312.pyc [application/x-bytecode.python]
apps/brain/__pycache__/apps.cpython-312.pyc [application/x-bytecode.python]
apps/brain/__pycache__/constants.cpython-312.pyc [application/x-bytecode.python]
apps/brain/__pycache__/models.cpython-312.pyc [application/x-bytecode.python]
apps/brain/__pycache__/tests.cpython-312.pyc [application/x-bytecode.python]
apps/brain/__pycache__/urls.cpython-312.pyc [application/x-bytecode.python]
apps/brain/__pycache__/views.cpython-312.pyc [application/x-bytecode.python]
apps/brain/migrations/__init__.py [inode/x-empty]
apps/brain/migrations/__pycache__/0001_initial.cpython-312.pyc [application/x-bytecode.python]
apps/brain/migrations/__pycache__/0002_seed_initial_data.cpython-312.pyc [application/x-bytecode.python]
apps/brain/migrations/__pycache__/0003_seed_social_category.cpython-312.pyc [application/x-bytecode.python]
apps/brain/migrations/__pycache__/0004_expand_respostas_categorias.cpython-312.pyc [application/x-bytecode.python]
apps/brain/migrations/__pycache__/0005_seed_evolucao_category.cpython-312.pyc [application/x-bytecode.python]
apps/brain/migrations/__pycache__/0006_expand_evolucao_girias.cpython-312.pyc [application/x-bytecode.python]
apps/brain/migrations/__pycache__/0007_expand_evolucao_giria_maravilha.cpython-312.pyc [application/x-bytecode.python]
apps/brain/migrations/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/coach_ai/__init__.py [inode/x-empty]
apps/coach_ai/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/coach_ai/__pycache__/admin.cpython-312.pyc [application/x-bytecode.python]
apps/coach_ai/__pycache__/apps.cpython-312.pyc [application/x-bytecode.python]
apps/coach_ai/__pycache__/models.cpython-312.pyc [application/x-bytecode.python]
apps/coach_ai/migrations/__init__.py [inode/x-empty]
apps/coach_ai/migrations/__pycache__/0001_initial.cpython-312.pyc [application/x-bytecode.python]
apps/coach_ai/migrations/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/coach_ai/tests.py [inode/x-empty]
apps/coach_ai/views.py [inode/x-empty]
apps/content/__init__.py [inode/x-empty]
apps/content/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/content/__pycache__/admin.cpython-312.pyc [application/x-bytecode.python]
apps/content/__pycache__/apps.cpython-312.pyc [application/x-bytecode.python]
apps/content/__pycache__/models.cpython-312.pyc [application/x-bytecode.python]
apps/content/__pycache__/serializers.cpython-312.pyc [application/x-bytecode.python]
apps/content/__pycache__/urls.cpython-312.pyc [application/x-bytecode.python]
apps/content/__pycache__/views.cpython-312.pyc [application/x-bytecode.python]
apps/content/migrations/__init__.py [inode/x-empty]
apps/content/migrations/__pycache__/0001_initial.cpython-312.pyc [application/x-bytecode.python]
apps/content/migrations/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/content/tests.py [inode/x-empty]
apps/mood/__init__.py [inode/x-empty]
apps/mood/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/mood/__pycache__/admin.cpython-312.pyc [application/x-bytecode.python]
apps/mood/__pycache__/apps.cpython-312.pyc [application/x-bytecode.python]
apps/mood/__pycache__/models.cpython-312.pyc [application/x-bytecode.python]
apps/mood/__pycache__/serializers.cpython-312.pyc [application/x-bytecode.python]
apps/mood/__pycache__/urls.cpython-312.pyc [application/x-bytecode.python]
apps/mood/__pycache__/views.cpython-312.pyc [application/x-bytecode.python]
apps/mood/migrations/__init__.py [inode/x-empty]
apps/mood/migrations/__pycache__/0001_initial.cpython-312.pyc [application/x-bytecode.python]
apps/mood/migrations/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/notifications/__init__.py [inode/x-empty]
apps/notifications/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/notifications/__pycache__/admin.cpython-312.pyc [application/x-bytecode.python]
apps/notifications/__pycache__/apps.cpython-312.pyc [application/x-bytecode.python]
apps/notifications/__pycache__/models.cpython-312.pyc [application/x-bytecode.python]
apps/notifications/__pycache__/serializers.cpython-312.pyc [application/x-bytecode.python]
apps/notifications/__pycache__/urls.cpython-312.pyc [application/x-bytecode.python]
apps/notifications/__pycache__/views.cpython-312.pyc [application/x-bytecode.python]
apps/notifications/management/__init__.py [inode/x-empty]
apps/notifications/management/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/notifications/management/commands/__init__.py [inode/x-empty]
apps/notifications/management/commands/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/notifications/management/commands/__pycache__/process_notification_queue.cpython-312.pyc [application/x-bytecode.python]
apps/notifications/migrations/__init__.py [inode/x-empty]
apps/notifications/migrations/__pycache__/0001_initial.cpython-312.pyc [application/x-bytecode.python]
apps/notifications/migrations/__pycache__/0002_notificationqueue_action_taken_and_more.cpython-312.pyc [application/x-bytecode.python]
apps/notifications/migrations/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/notifications/services/__pycache__/reminder_queue.cpython-312.pyc [application/x-bytecode.python]
apps/notifications/services/__pycache__/whatsapp_cloud.cpython-312.pyc [application/x-bytecode.python]
apps/notifications/services/__pycache__/whatsapp_service.cpython-312.pyc [application/x-bytecode.python]
apps/notifications/tests.py [inode/x-empty]
apps/onboarding/__init__.py [inode/x-empty]
apps/onboarding/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/onboarding/__pycache__/admin.cpython-312.pyc [application/x-bytecode.python]
apps/onboarding/__pycache__/apps.cpython-312.pyc [application/x-bytecode.python]
apps/onboarding/__pycache__/models.cpython-312.pyc [application/x-bytecode.python]
apps/onboarding/__pycache__/services.cpython-312.pyc [application/x-bytecode.python]
apps/onboarding/__pycache__/signals.cpython-312.pyc [application/x-bytecode.python]
apps/onboarding/__pycache__/urls.cpython-312.pyc [application/x-bytecode.python]
apps/onboarding/__pycache__/views.cpython-312.pyc [application/x-bytecode.python]
apps/onboarding/migrations/__init__.py [inode/x-empty]
apps/onboarding/migrations/__pycache__/0001_initial.cpython-312.pyc [application/x-bytecode.python]
apps/onboarding/migrations/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/onboarding/tests.py [inode/x-empty]
apps/planner/__init__.py [inode/x-empty]
apps/planner/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/planner/__pycache__/admin.cpython-312.pyc [application/x-bytecode.python]
apps/planner/__pycache__/apps.cpython-312.pyc [application/x-bytecode.python]
apps/planner/__pycache__/models.cpython-312.pyc [application/x-bytecode.python]
apps/planner/__pycache__/serializers.cpython-312.pyc [application/x-bytecode.python]
apps/planner/__pycache__/urls.cpython-312.pyc [application/x-bytecode.python]
apps/planner/__pycache__/views.cpython-312.pyc [application/x-bytecode.python]
apps/planner/migrations/__init__.py [inode/x-empty]
apps/planner/migrations/__pycache__/0001_initial.cpython-312.pyc [application/x-bytecode.python]
apps/planner/migrations/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/planner/tests.py [inode/x-empty]
apps/pomodoro/__init__.py [inode/x-empty]
apps/pomodoro/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/pomodoro/__pycache__/admin.cpython-312.pyc [application/x-bytecode.python]
apps/pomodoro/__pycache__/apps.cpython-312.pyc [application/x-bytecode.python]
apps/pomodoro/__pycache__/models.cpython-312.pyc [application/x-bytecode.python]
apps/pomodoro/__pycache__/serializers.cpython-312.pyc [application/x-bytecode.python]
apps/pomodoro/__pycache__/urls.cpython-312.pyc [application/x-bytecode.python]
apps/pomodoro/__pycache__/views.cpython-312.pyc [application/x-bytecode.python]
apps/pomodoro/migrations/__init__.py [inode/x-empty]
apps/pomodoro/migrations/__pycache__/0001_initial.cpython-312.pyc [application/x-bytecode.python]
apps/pomodoro/migrations/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/pomodoro/tests.py [inode/x-empty]
apps/semester/__init__.py [inode/x-empty]
apps/semester/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/semester/__pycache__/admin.cpython-312.pyc [application/x-bytecode.python]
apps/semester/__pycache__/apps.cpython-312.pyc [application/x-bytecode.python]
apps/semester/__pycache__/models.cpython-312.pyc [application/x-bytecode.python]
apps/semester/__pycache__/serializers.cpython-312.pyc [application/x-bytecode.python]
apps/semester/__pycache__/urls.cpython-312.pyc [application/x-bytecode.python]
apps/semester/__pycache__/views.cpython-312.pyc [application/x-bytecode.python]
apps/semester/migrations/__init__.py [inode/x-empty]
apps/semester/migrations/__pycache__/0001_initial.cpython-312.pyc [application/x-bytecode.python]
apps/semester/migrations/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/ui/__init__.py [inode/x-empty]
apps/ui/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
apps/ui/__pycache__/apps.cpython-312.pyc [application/x-bytecode.python]
apps/ui/__pycache__/forms.cpython-312.pyc [application/x-bytecode.python]
apps/ui/__pycache__/forms_academic.cpython-312.pyc [application/x-bytecode.python]
apps/ui/__pycache__/forms_agenda.cpython-312.pyc [application/x-bytecode.python]
apps/ui/__pycache__/forms_reminders.cpython-312.pyc [application/x-bytecode.python]
apps/ui/__pycache__/forms_tasks.cpython-312.pyc [application/x-bytecode.python]
apps/ui/__pycache__/services_academic.cpython-312.pyc [application/x-bytecode.python]
apps/ui/__pycache__/urls.cpython-312.pyc [application/x-bytecode.python]
apps/ui/__pycache__/views.cpython-312.pyc [application/x-bytecode.python]
apps/ui/__pycache__/views_academic.cpython-312.pyc [application/x-bytecode.python]
apps/ui/__pycache__/views_agenda.cpython-312.pyc [application/x-bytecode.python]
apps/ui/__pycache__/views_messages.cpython-312.pyc [application/x-bytecode.python]
apps/ui/__pycache__/views_reminders.cpython-312.pyc [application/x-bytecode.python]
apps/ui/__pycache__/views_tasks.cpython-312.pyc [application/x-bytecode.python]
config/__init__.py [inode/x-empty]
config/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
config/__pycache__/settings.cpython-312.pyc [application/x-bytecode.python]
config/__pycache__/settings_migrations.cpython-312.pyc [application/x-bytecode.python]
config/__pycache__/urls.cpython-312.pyc [application/x-bytecode.python]
config/__pycache__/views.cpython-312.pyc [application/x-bytecode.python]
config/__pycache__/wsgi.cpython-312.pyc [application/x-bytecode.python]
static/img/logo-campus-calm.png [image/png]
static/img/logoalgorithminsights_empresa.png [image/png]
utils/__init__.py [inode/x-empty]
utils/__pycache__/__init__.cpython-312.pyc [application/x-bytecode.python]
utils/__pycache__/academic_progress.cpython-312.pyc [application/x-bytecode.python]
utils/__pycache__/constants.cpython-312.pyc [application/x-bytecode.python]
utils/__pycache__/features.cpython-312.pyc [application/x-bytecode.python]
utils/__pycache__/gating.cpython-312.pyc [application/x-bytecode.python]
utils/__pycache__/messages.cpython-312.pyc [application/x-bytecode.python]
utils/__pycache__/triage.cpython-312.pyc [application/x-bytecode.python]
