Campus Calm - Full Project Dump
===============================


--- FILE: .env.example ---
DJANGO_SECRET_KEY=change-me
DJANGO_DEBUG=True
DJANGO_ALLOWED_HOSTS=localhost,127.0.0.1
DEFAULT_FROM_EMAIL=no-reply@campuscalm.local
TRIAGE_MODEL_NAME=mock-v1
TRIAGE_USE_LLM=false

--- FILE: README.md ---
# Campus Calm (MVP)

MVP para universitarios acompanharem o semestre com bem-estar, organizacao e foco. O projeto usa Django + Django REST Framework, autenticacao JWT e banco SQLite em dev.

## Requisitos
- Python 3.12+
- Pip

## Setup rapido
```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt

python manage.py migrate
python manage.py createsuperuser
python manage.py runserver
```

## Variaveis de ambiente
Copie `.env.example` e ajuste conforme necessario. A variavel `TRIAGE_USE_LLM` prepara a triagem para LLM futuro (mock no MVP).

## Endpoints principais
- Auth: `/api/auth/register/`, `/api/auth/login/`, `/api/auth/refresh/`, `/api/auth/me/`
- Billing: `/api/billing/plan/`, `/api/billing/set-plan/` (admin)
- Onboarding: `/api/onboarding/status/`
- Mood: `/api/mood/entries/`, `/api/mood/summary/weekly/`
- Pomodoro: `/api/pomodoro/start/`, `/api/pomodoro/stop/{id}/`, `/api/pomodoro/summary/weekly/`
- Planner: `/api/planner/tasks/`
- Agenda: `/api/agenda/events/`, `/api/agenda/week/`, `/api/agenda/generate-reminders/`
- Semester: `/api/semester/semesters/`, `/api/semester/courses/`, `/api/semester/assessments/`, `/api/semester/courses/{id}/progress/`, `/api/semester/finish/{semester_id}/`
- Content: `/api/content/guided/`, `/api/content/guided/{id}/`
- Notifications: `/api/notifications/test-email/`, `/api/notifications/pending/`
- Access Requests: `/api/access/requests/`, `/api/access/requests/{id}/approve/`, `/api/access/requests/{id}/reject/`, `/api/access/triage/{id}/log/`
- Analytics: `/api/analytics/dashboard/`, `/api/analytics/semester/{semester_id}/`

## Documentacao automatica
- Schema: `/api/schema/`
- Swagger UI: `/api/docs/`

## Exemplos com curl
### Registrar
```bash
curl -X POST http://localhost:8000/api/auth/register/ \
  -H "Content-Type: application/json" \
  -d '{"email":"aluno@exemplo.com","name":"Aluno","password":"senha123"}'
```

### Login
```bash
curl -X POST http://localhost:8000/api/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{"email":"aluno@exemplo.com","password":"senha123"}'
```

### Criar check-in de humor
```bash
curl -X POST http://localhost:8000/api/mood/entries/ \
  -H "Authorization: Bearer <ACCESS_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{"mood":"OK","notes":"Dia produtivo"}'
```

### Criar tarefa
```bash
curl -X POST http://localhost:8000/api/planner/tasks/ \
  -H "Authorization: Bearer <ACCESS_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{"title":"Trabalho final","due_date":"2026-03-10","stress_level":3,"status":"TODO"}'
```

### Criar regra de lembrete e gerar notificacoes
```bash
curl -X POST http://localhost:8000/api/agenda/reminder-rules/ \
  -H "Authorization: Bearer <ACCESS_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{"target_type":"TASK","remind_before_minutes":60,"channels":["EMAIL"],"is_active":true}'

curl -X POST http://localhost:8000/api/agenda/generate-reminders/ \
  -H "Authorization: Bearer <ACCESS_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{}'
```

### Solicitar acesso (triagem automatica)
```bash
curl -X POST http://localhost:8000/api/access/requests/ \
  -H "Content-Type: application/json" \
  -d '{"requester_email":"coord@faculdade.com","requester_type":"INSTITUTION","estimated_users":120}'
```

## Health-check
```bash
curl http://localhost:8000/health/
```

## Script de demo (curl)
```bash
bash scripts/run_curl_demo.sh
```

## Seed de dados (mais completo)
```bash
python manage.py seed_demo_data --email nari.naluu@gmail.com
```

## Notificacoes
- Email: backend console em dev.
- WhatsApp/SMS: mock no MVP.

Processar fila manualmente:
```bash
python manage.py process_notification_queue
```

## Observacoes de seguranca
- O sistema nao e um dispositivo medico.
- Em humor muito baixo recorrente, o sistema recomenda apoio profissional (ex: CVV 188).

## Tests
```bash
python manage.py test
```

--- FILE: apps/access_requests/__init__.py ---


--- FILE: apps/access_requests/admin.py ---
from django.contrib import admin

from access_requests.models import AccessRequest, AITriageLog


@admin.register(AccessRequest)
class AccessRequestAdmin(admin.ModelAdmin):
    list_display = ("requester_email", "requester_type", "status", "recommended_plan", "decided_plan")
    list_filter = ("status", "requester_type")
    search_fields = ("requester_email", "requester_name")


@admin.register(AITriageLog)
class AITriageLogAdmin(admin.ModelAdmin):
    list_display = ("access_request", "model_name", "created_at")

--- FILE: apps/access_requests/apps.py ---
from django.apps import AppConfig


class AccessRequestsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'access_requests'

--- FILE: apps/access_requests/migrations/0001_initial.py ---
# Generated by Django 4.2.11 on 2026-01-28 13:35

from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='AccessRequest',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('requester_email', models.EmailField(max_length=254)),
                ('requester_name', models.CharField(blank=True, max_length=255)),
                ('requester_type', models.CharField(choices=[('INDIVIDUAL', 'Individual'), ('INSTITUTION', 'Institution')], max_length=20)),
                ('institution_name', models.CharField(blank=True, max_length=255)),
                ('estimated_users', models.PositiveIntegerField(blank=True, null=True)),
                ('wants_features', models.JSONField(default=list)),
                ('message', models.TextField(blank=True)),
                ('status', models.CharField(choices=[('PENDING', 'Pending'), ('APPROVED', 'Approved'), ('REJECTED', 'Rejected')], default='PENDING', max_length=20)),
                ('recommended_plan', models.CharField(blank=True, choices=[('LITE', 'Lite'), ('PRO', 'Pro')], max_length=10)),
                ('decided_plan', models.CharField(blank=True, choices=[('LITE', 'Lite'), ('PRO', 'Pro')], max_length=10)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
        ),
        migrations.CreateModel(
            name='AITriageLog',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('model_name', models.CharField(max_length=100)),
                ('input_payload', models.JSONField()),
                ('output_payload', models.JSONField()),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('access_request', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='triage_logs', to='access_requests.accessrequest')),
            ],
        ),
    ]

--- FILE: apps/access_requests/migrations/0002_initial.py ---
# Generated by Django 4.2.11 on 2026-01-28 13:35

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('access_requests', '0001_initial'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.AddField(
            model_name='accessrequest',
            name='created_user',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL),
        ),
    ]

--- FILE: apps/access_requests/migrations/__init__.py ---


--- FILE: apps/access_requests/models.py ---
from django.conf import settings
from django.db import models

from utils.constants import ACCESS_STATUS_CHOICES, ACCESS_PENDING, PLAN_CHOICES, REQUESTER_TYPE_CHOICES


class AccessRequest(models.Model):
    requester_email = models.EmailField()
    requester_name = models.CharField(max_length=255, blank=True)
    requester_type = models.CharField(max_length=20, choices=REQUESTER_TYPE_CHOICES)
    institution_name = models.CharField(max_length=255, blank=True)
    estimated_users = models.PositiveIntegerField(null=True, blank=True)
    wants_features = models.JSONField(default=list)
    message = models.TextField(blank=True)
    status = models.CharField(max_length=20, choices=ACCESS_STATUS_CHOICES, default=ACCESS_PENDING)
    recommended_plan = models.CharField(max_length=10, choices=PLAN_CHOICES, blank=True)
    decided_plan = models.CharField(max_length=10, choices=PLAN_CHOICES, blank=True)
    created_user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.SET_NULL, null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return self.requester_email


class AITriageLog(models.Model):
    access_request = models.ForeignKey(AccessRequest, on_delete=models.CASCADE, related_name="triage_logs")
    model_name = models.CharField(max_length=100)
    input_payload = models.JSONField()
    output_payload = models.JSONField()
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return f"{self.access_request.id} - {self.model_name}"

--- FILE: apps/access_requests/serializers.py ---
from rest_framework import serializers

from access_requests.models import AccessRequest, AITriageLog
from utils.constants import ACCESS_APPROVED, ACCESS_REJECTED


class AccessRequestCreateSerializer(serializers.ModelSerializer):
    class Meta:
        model = AccessRequest
        fields = (
            "id",
            "requester_email",
            "requester_name",
            "requester_type",
            "institution_name",
            "estimated_users",
            "wants_features",
            "message",
            "status",
            "recommended_plan",
            "created_at",
        )
        read_only_fields = ("id", "status", "recommended_plan", "created_at")


class AccessRequestSerializer(serializers.ModelSerializer):
    class Meta:
        model = AccessRequest
        fields = "__all__"


class AITriageLogSerializer(serializers.ModelSerializer):
    class Meta:
        model = AITriageLog
        fields = ("id", "model_name", "input_payload", "output_payload", "created_at")
        read_only_fields = fields


class AccessDecisionSerializer(serializers.Serializer):
    decided_plan = serializers.CharField(required=False)

    def validate_decided_plan(self, value):
        if value and value not in {"LITE", "PRO"}:
            raise serializers.ValidationError("Plano invalido")
        return value

--- FILE: apps/access_requests/tests.py ---
from rest_framework.test import APITestCase

from utils.constants import FEATURE_EMAIL_NOTIFICATIONS, PLAN_PRO


class AccessRequestTriageTests(APITestCase):
    def test_triage_recommends_pro(self):
        payload = {
            "requester_email": "inst@example.com",
            "requester_type": "INDIVIDUAL",
            "wants_features": [FEATURE_EMAIL_NOTIFICATIONS],
        }
        response = self.client.post("/api/access/requests/", payload, format="json")
        self.assertEqual(response.status_code, 201)
        self.assertEqual(response.data["recommended_plan"], PLAN_PRO)

--- FILE: apps/access_requests/urls.py ---
from django.urls import path

from access_requests.views import (
    AccessApproveView,
    AccessRejectView,
    AccessRequestDetailView,
    AccessRequestListCreateView,
    AccessTriageLogView,
)

urlpatterns = [
    path("requests/", AccessRequestListCreateView.as_view(), name="access-request-list-create"),
    path("requests/<int:pk>/", AccessRequestDetailView.as_view(), name="access-request-detail"),
    path("requests/<int:pk>/approve/", AccessApproveView.as_view(), name="access-request-approve"),
    path("requests/<int:pk>/reject/", AccessRejectView.as_view(), name="access-request-reject"),
    path("triage/<int:pk>/log/", AccessTriageLogView.as_view(), name="access-triage-log"),
]

--- FILE: apps/access_requests/views.py ---
from django.shortcuts import get_object_or_404
from rest_framework import permissions, status
from rest_framework.response import Response
from rest_framework.views import APIView

from access_requests.models import AccessRequest, AITriageLog
from access_requests.serializers import (
    AccessDecisionSerializer,
    AccessRequestCreateSerializer,
    AccessRequestSerializer,
    AITriageLogSerializer,
)
from utils.constants import ACCESS_APPROVED, ACCESS_REJECTED
from utils.triage import TRIAGE_MODEL_NAME, run_triage


class AccessRequestListCreateView(APIView):
    def get_permissions(self):
        if self.request.method == "POST":
            return [permissions.AllowAny()]
        return [permissions.IsAdminUser()]

    def get(self, request):
        requests = AccessRequest.objects.all().order_by("-created_at")
        return Response(AccessRequestSerializer(requests, many=True).data)

    def post(self, request):
        serializer = AccessRequestCreateSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        access_request = serializer.save()
        triage_result = run_triage(access_request)
        recommended_plan = triage_result["recommended_plan"]
        access_request.recommended_plan = recommended_plan
        access_request.save(update_fields=["recommended_plan"])
        input_payload = serializer.validated_data
        output_payload = triage_result["output_payload"]
        AITriageLog.objects.create(
            access_request=access_request,
            model_name=TRIAGE_MODEL_NAME,
            input_payload=input_payload,
            output_payload=output_payload,
        )
        return Response(AccessRequestCreateSerializer(access_request).data, status=status.HTTP_201_CREATED)


class AccessRequestDetailView(APIView):
    permission_classes = [permissions.IsAdminUser]

    def get(self, request, pk):
        access_request = get_object_or_404(AccessRequest, pk=pk)
        return Response(AccessRequestSerializer(access_request).data)


class AccessApproveView(APIView):
    permission_classes = [permissions.IsAdminUser]

    def post(self, request, pk):
        access_request = get_object_or_404(AccessRequest, pk=pk)
        serializer = AccessDecisionSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        access_request.status = ACCESS_APPROVED
        access_request.decided_plan = serializer.validated_data.get("decided_plan") or access_request.recommended_plan
        access_request.save(update_fields=["status", "decided_plan"])
        return Response(AccessRequestSerializer(access_request).data)


class AccessRejectView(APIView):
    permission_classes = [permissions.IsAdminUser]

    def post(self, request, pk):
        access_request = get_object_or_404(AccessRequest, pk=pk)
        access_request.status = ACCESS_REJECTED
        access_request.save(update_fields=["status"])
        return Response(AccessRequestSerializer(access_request).data)


class AccessTriageLogView(APIView):
    permission_classes = [permissions.IsAdminUser]

    def get(self, request, pk):
        access_request = get_object_or_404(AccessRequest, pk=pk)
        log = access_request.triage_logs.order_by("-created_at").first()
        if not log:
            return Response({"detail": "Sem log de triagem."}, status=status.HTTP_404_NOT_FOUND)
        return Response(AITriageLogSerializer(log).data)

--- FILE: apps/accounts/__init__.py ---


--- FILE: apps/accounts/admin.py ---
from django.contrib import admin
from django.contrib.auth.admin import UserAdmin as DjangoUserAdmin

from accounts.models import User


@admin.register(User)
class UserAdmin(DjangoUserAdmin):
    model = User
    ordering = ("email",)
    list_display = ("email", "name", "is_staff", "is_active", "created_at")
    search_fields = ("email", "name")
    fieldsets = (
        (None, {"fields": ("email", "password")}),
        ("Personal info", {"fields": ("name", "phone_number")}),
        ("Permissions", {"fields": ("is_active", "is_staff", "is_superuser", "groups", "user_permissions")}),
        ("Important dates", {"fields": ("last_login",)}),
    )
    add_fieldsets = (
        (
            None,
            {
                "classes": ("wide",),
                "fields": ("email", "name", "password1", "password2", "is_staff", "is_superuser"),
            },
        ),
    )

--- FILE: apps/accounts/apps.py ---
from django.apps import AppConfig


class AccountsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'accounts'

--- FILE: apps/accounts/migrations/0001_initial.py ---
# Generated by Django 4.2.11 on 2026-01-28 13:35

from django.db import migrations, models
import django.utils.timezone


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('auth', '0012_alter_user_first_name_max_length'),
    ]

    operations = [
        migrations.CreateModel(
            name='User',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('password', models.CharField(max_length=128, verbose_name='password')),
                ('last_login', models.DateTimeField(blank=True, null=True, verbose_name='last login')),
                ('is_superuser', models.BooleanField(default=False, help_text='Designates that this user has all permissions without explicitly assigning them.', verbose_name='superuser status')),
                ('email', models.EmailField(max_length=254, unique=True)),
                ('name', models.CharField(max_length=255)),
                ('phone_number', models.CharField(blank=True, max_length=30)),
                ('created_at', models.DateTimeField(default=django.utils.timezone.now)),
                ('is_active', models.BooleanField(default=True)),
                ('is_staff', models.BooleanField(default=False)),
                ('groups', models.ManyToManyField(blank=True, help_text='The groups this user belongs to. A user will get all permissions granted to each of their groups.', related_name='user_set', related_query_name='user', to='auth.group', verbose_name='groups')),
                ('user_permissions', models.ManyToManyField(blank=True, help_text='Specific permissions for this user.', related_name='user_set', related_query_name='user', to='auth.permission', verbose_name='user permissions')),
            ],
            options={
                'abstract': False,
            },
        ),
    ]

--- FILE: apps/accounts/migrations/__init__.py ---


--- FILE: apps/accounts/models.py ---
from django.contrib.auth.models import AbstractBaseUser, BaseUserManager, PermissionsMixin
from django.db import models
from django.utils import timezone


class UserManager(BaseUserManager):
    def create_user(self, email, password=None, **extra_fields):
        if not email:
            raise ValueError("Email is required")
        email = self.normalize_email(email)
        user = self.model(email=email, **extra_fields)
        user.set_password(password)
        user.save(using=self._db)
        return user

    def create_superuser(self, email, password=None, **extra_fields):
        extra_fields.setdefault("is_staff", True)
        extra_fields.setdefault("is_superuser", True)
        extra_fields.setdefault("is_active", True)
        if not extra_fields.get("is_staff"):
            raise ValueError("Superuser must have is_staff=True")
        if not extra_fields.get("is_superuser"):
            raise ValueError("Superuser must have is_superuser=True")
        return self.create_user(email, password, **extra_fields)


class User(AbstractBaseUser, PermissionsMixin):
    email = models.EmailField(unique=True)
    name = models.CharField(max_length=255)
    phone_number = models.CharField(max_length=30, blank=True)
    created_at = models.DateTimeField(default=timezone.now)

    is_active = models.BooleanField(default=True)
    is_staff = models.BooleanField(default=False)

    objects = UserManager()

    EMAIL_FIELD = "email"
    USERNAME_FIELD = "email"
    REQUIRED_FIELDS = ["name"]

    def __str__(self):
        return self.email

--- FILE: apps/accounts/serializers.py ---
from django.contrib.auth import get_user_model
from rest_framework import serializers

User = get_user_model()


class UserSerializer(serializers.ModelSerializer):
    class Meta:
        model = User
        fields = ("id", "email", "name", "phone_number", "created_at")
        read_only_fields = ("id", "created_at")


class RegisterSerializer(serializers.ModelSerializer):
    password = serializers.CharField(write_only=True, min_length=6)

    class Meta:
        model = User
        fields = ("email", "name", "phone_number", "password")

    def create(self, validated_data):
        password = validated_data.pop("password")
        user = User.objects.create_user(password=password, **validated_data)
        return user

--- FILE: apps/accounts/tests.py ---
from django.urls import reverse
from rest_framework.test import APITestCase


class AuthTests(APITestCase):
    def test_register_and_login(self):
        register_url = "/api/auth/register/"
        payload = {
            "email": "test@example.com",
            "name": "Teste",
            "password": "strongpass123",
        }
        response = self.client.post(register_url, payload, format="json")
        self.assertEqual(response.status_code, 201)
        self.assertIn("access", response.data)

        login_url = "/api/auth/login/"
        login_response = self.client.post(login_url, {"email": payload["email"], "password": payload["password"]})
        self.assertEqual(login_response.status_code, 200)
        self.assertIn("access", login_response.data)

--- FILE: apps/accounts/urls.py ---
from django.urls import path
from rest_framework_simplejwt.views import TokenObtainPairView, TokenRefreshView

from accounts.views import MeView, RegisterView

urlpatterns = [
    path("register/", RegisterView.as_view(), name="auth-register"),
    path("login/", TokenObtainPairView.as_view(), name="auth-login"),
    path("refresh/", TokenRefreshView.as_view(), name="auth-refresh"),
    path("me/", MeView.as_view(), name="auth-me"),
]

--- FILE: apps/accounts/views.py ---
from rest_framework import permissions, status
from rest_framework.response import Response
from rest_framework.views import APIView
from rest_framework_simplejwt.tokens import RefreshToken

from accounts.serializers import RegisterSerializer, UserSerializer
from billing.models import Plan, UserSubscription
from utils.constants import PLAN_LITE


class RegisterView(APIView):
    permission_classes = [permissions.AllowAny]

    def post(self, request):
        serializer = RegisterSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        user = serializer.save()
        plan = Plan.objects.filter(code=PLAN_LITE, is_active=True).first()
        if plan:
            UserSubscription.objects.get_or_create(user=user, defaults={"plan": plan})
        refresh = RefreshToken.for_user(user)
        return Response(
            {
                "user": UserSerializer(user).data,
                "refresh": str(refresh),
                "access": str(refresh.access_token),
            },
            status=status.HTTP_201_CREATED,
        )


class MeView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request):
        return Response(UserSerializer(request.user).data)

--- FILE: apps/agenda/__init__.py ---


--- FILE: apps/agenda/admin.py ---
from django.contrib import admin

from agenda.models import CalendarEvent, ReminderRule


@admin.register(CalendarEvent)
class CalendarEventAdmin(admin.ModelAdmin):
    list_display = ("title", "user", "event_type", "start_at")
    list_filter = ("event_type",)
    search_fields = ("title", "user__email")


@admin.register(ReminderRule)
class ReminderRuleAdmin(admin.ModelAdmin):
    list_display = ("user", "target_type", "remind_before_minutes", "is_active")
    list_filter = ("target_type", "is_active")

--- FILE: apps/agenda/apps.py ---
from django.apps import AppConfig


class AgendaConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'agenda'

--- FILE: apps/agenda/migrations/0001_initial.py ---
# Generated by Django 4.2.11 on 2026-01-28 13:35

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
        ('planner', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='ReminderRule',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('target_type', models.CharField(choices=[('TASK', 'Task'), ('EVENT', 'Event')], max_length=10)),
                ('remind_before_minutes', models.PositiveIntegerField()),
                ('channels', models.JSONField(default=list)),
                ('is_active', models.BooleanField(default=True)),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='reminder_rules', to=settings.AUTH_USER_MODEL)),
            ],
        ),
        migrations.CreateModel(
            name='CalendarEvent',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('title', models.CharField(max_length=200)),
                ('event_type', models.CharField(choices=[('PROVA', 'Prova'), ('ENTREGA', 'Entrega'), ('APRESENTACAO', 'Apresentacao'), ('AULA_IMPORTANTE', 'Aula importante'), ('OUTRO', 'Outro')], max_length=20)),
                ('start_at', models.DateTimeField()),
                ('end_at', models.DateTimeField(blank=True, null=True)),
                ('notes', models.TextField(blank=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('related_task', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='events', to='planner.task')),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='events', to=settings.AUTH_USER_MODEL)),
            ],
        ),
    ]

--- FILE: apps/agenda/migrations/__init__.py ---


--- FILE: apps/agenda/models.py ---
from django.conf import settings
from django.db import models

from planner.models import Task
from utils.constants import EVENT_TYPE_CHOICES, REMINDER_TARGET_CHOICES


class CalendarEvent(models.Model):
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name="events")
    title = models.CharField(max_length=200)
    event_type = models.CharField(max_length=20, choices=EVENT_TYPE_CHOICES)
    start_at = models.DateTimeField()
    end_at = models.DateTimeField(null=True, blank=True)
    related_task = models.ForeignKey(Task, on_delete=models.SET_NULL, null=True, blank=True, related_name="events")
    notes = models.TextField(blank=True)
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return self.title


class ReminderRule(models.Model):
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name="reminder_rules")
    target_type = models.CharField(max_length=10, choices=REMINDER_TARGET_CHOICES)
    remind_before_minutes = models.PositiveIntegerField()
    channels = models.JSONField(default=list)
    is_active = models.BooleanField(default=True)

    def __str__(self):
        return f"{self.user.email} - {self.target_type}"

--- FILE: apps/agenda/serializers.py ---
from rest_framework import serializers

from agenda.models import CalendarEvent, ReminderRule


class CalendarEventSerializer(serializers.ModelSerializer):
    class Meta:
        model = CalendarEvent
        fields = (
            "id",
            "title",
            "event_type",
            "start_at",
            "end_at",
            "related_task",
            "notes",
            "created_at",
        )
        read_only_fields = ("id", "created_at")


class ReminderRuleSerializer(serializers.ModelSerializer):
    class Meta:
        model = ReminderRule
        fields = ("id", "target_type", "remind_before_minutes", "channels", "is_active")
        read_only_fields = ("id",)

--- FILE: apps/agenda/tests.py ---
from datetime import date

from django.contrib.auth import get_user_model
from rest_framework.test import APITestCase
from rest_framework_simplejwt.tokens import RefreshToken

from billing.models import Plan, UserSubscription
from utils.constants import FEATURE_IN_APP_REMINDERS, FEATURE_PLANNER_BASIC, PLAN_LITE

User = get_user_model()


class ReminderGenerationTests(APITestCase):
    def setUp(self):
        self.user = User.objects.create_user(email="agenda@example.com", name="Agenda", password="pass12345")
        plan, _ = Plan.objects.get_or_create(
            code=PLAN_LITE,
            defaults={
                "name": "Lite",
                "features": [FEATURE_PLANNER_BASIC, FEATURE_IN_APP_REMINDERS],
                "is_active": True,
            },
        )
        UserSubscription.objects.create(user=self.user, plan=plan)
        refresh = RefreshToken.for_user(self.user)
        self.client.credentials(HTTP_AUTHORIZATION=f"Bearer {refresh.access_token}")

    def test_task_create_and_generate_reminders(self):
        task_payload = {
            "title": "Trabalho",
            "description": "Entrega final",
            "due_date": date.today().isoformat(),
            "stress_level": 3,
            "status": "TODO",
        }
        task_response = self.client.post("/api/planner/tasks/", task_payload, format="json")
        self.assertEqual(task_response.status_code, 201)

        rule_payload = {
            "target_type": "TASK",
            "remind_before_minutes": 60,
            "channels": ["EMAIL"],
            "is_active": True,
        }
        rule_response = self.client.post("/api/agenda/reminder-rules/", rule_payload, format="json")
        self.assertEqual(rule_response.status_code, 201)

        generate_response = self.client.post("/api/agenda/generate-reminders/", {}, format="json")
        self.assertEqual(generate_response.status_code, 200)
        self.assertIn("created", generate_response.data)

--- FILE: apps/agenda/urls.py ---
from django.urls import path
from rest_framework.routers import DefaultRouter

from agenda.views import CalendarEventViewSet, GenerateRemindersView, AgendaWeekView, ReminderRuleViewSet

router = DefaultRouter()
router.register(r"events", CalendarEventViewSet, basename="events")
router.register(r"reminder-rules", ReminderRuleViewSet, basename="reminder-rules")

urlpatterns = router.urls + [
    path("week/", AgendaWeekView.as_view(), name="agenda-week"),
    path("generate-reminders/", GenerateRemindersView.as_view(), name="agenda-generate-reminders"),
]

--- FILE: apps/agenda/views.py ---
from datetime import datetime, time, timedelta

from django.utils import timezone
from rest_framework import permissions, status, viewsets
from rest_framework.response import Response
from rest_framework.views import APIView

from agenda.models import CalendarEvent, ReminderRule
from agenda.serializers import CalendarEventSerializer, ReminderRuleSerializer
from notifications.models import NotificationQueue
from planner.models import Task
from utils.constants import (
    CHANNEL_EMAIL,
    FEATURE_AGENDA_BASIC,
    FEATURE_IN_APP_REMINDERS,
    NOTIF_PENDING,
    REMINDER_TARGET_EVENT,
    REMINDER_TARGET_TASK,
)
from utils.features import require_feature
from utils.gating import gate_generate_reminders


class CalendarEventViewSet(viewsets.ModelViewSet):
    serializer_class = CalendarEventSerializer
    permission_classes = [permissions.IsAuthenticated]

    def initial(self, request, *args, **kwargs):
        require_feature(request.user, FEATURE_AGENDA_BASIC)
        return super().initial(request, *args, **kwargs)

    def get_queryset(self):
        return CalendarEvent.objects.filter(user=self.request.user).order_by("start_at")

    def perform_create(self, serializer):
        serializer.save(user=self.request.user)


class ReminderRuleViewSet(viewsets.ModelViewSet):
    serializer_class = ReminderRuleSerializer
    permission_classes = [permissions.IsAuthenticated]

    def initial(self, request, *args, **kwargs):
        require_feature(request.user, FEATURE_IN_APP_REMINDERS)
        return super().initial(request, *args, **kwargs)

    def get_queryset(self):
        return ReminderRule.objects.filter(user=self.request.user)

    def perform_create(self, serializer):
        serializer.save(user=self.request.user)


class AgendaWeekView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request):
        require_feature(request.user, FEATURE_AGENDA_BASIC)
        now = timezone.now()
        start_of_week = now - timedelta(days=now.weekday())
        end_of_week = start_of_week + timedelta(days=6)
        events = CalendarEvent.objects.filter(
            user=request.user,
            start_at__date__gte=start_of_week.date(),
            start_at__date__lte=end_of_week.date(),
        ).order_by("start_at")
        return Response(CalendarEventSerializer(events, many=True).data)


class GenerateRemindersView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def post(self, request):
        require_feature(request.user, FEATURE_IN_APP_REMINDERS)
        allowed, message = gate_generate_reminders(request.user)
        if not allowed:
            return Response({"detail": message}, status=status.HTTP_403_FORBIDDEN)

        now = timezone.now()
        created = 0
        rules = ReminderRule.objects.filter(user=request.user, is_active=True)
        for rule in rules:
            channels = rule.channels or [CHANNEL_EMAIL]
            if rule.target_type == REMINDER_TARGET_EVENT:
                events = CalendarEvent.objects.filter(user=request.user, start_at__gte=now)
                for event in events:
                    scheduled_for = event.start_at - timedelta(minutes=rule.remind_before_minutes)
                    if scheduled_for < now:
                        scheduled_for = now
                    for channel in channels:
                        title = f"Lembrete: {event.title}"
                        exists = NotificationQueue.objects.filter(
                            user=request.user,
                            channel=channel,
                            title=title,
                            scheduled_for=scheduled_for,
                        ).exists()
                        if not exists:
                            NotificationQueue.objects.create(
                                user=request.user,
                                channel=channel,
                                title=title,
                                message=f"Evento {event.title} em {event.start_at}.",
                                scheduled_for=scheduled_for,
                                status=NOTIF_PENDING,
                            )
                            created += 1
            if rule.target_type == REMINDER_TARGET_TASK:
                tasks = Task.objects.filter(user=request.user, due_date__gte=timezone.localdate())
                for task in tasks:
                    due_datetime = datetime.combine(task.due_date, time(9, 0), tzinfo=timezone.get_current_timezone())
                    scheduled_for = due_datetime - timedelta(minutes=rule.remind_before_minutes)
                    if scheduled_for < now:
                        scheduled_for = now
                    for channel in channels:
                        title = f"Lembrete: {task.title}"
                        exists = NotificationQueue.objects.filter(
                            user=request.user,
                            channel=channel,
                            title=title,
                            scheduled_for=scheduled_for,
                        ).exists()
                        if not exists:
                            NotificationQueue.objects.create(
                                user=request.user,
                                channel=channel,
                                title=title,
                                message=f"Tarefa {task.title} vence em {task.due_date}.",
                                scheduled_for=scheduled_for,
                                status=NOTIF_PENDING,
                            )
                            created += 1
        return Response({"created": created})

--- FILE: apps/analytics/__init__.py ---


--- FILE: apps/analytics/admin.py ---
from django.contrib import admin

# No models to register for MVP.

--- FILE: apps/analytics/apps.py ---
from django.apps import AppConfig


class AnalyticsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'analytics'

--- FILE: apps/analytics/management/__init__.py ---


--- FILE: apps/analytics/management/commands/__init__.py ---


--- FILE: apps/analytics/management/commands/seed_demo_data.py ---
from datetime import date, timedelta

from django.core.management.base import BaseCommand
from django.utils import timezone

from agenda.models import CalendarEvent, ReminderRule
from billing.models import Plan, UserSubscription
from content.models import GuidedContent
from mood.models import MoodEntry
from planner.models import Task
from semester.models import Assessment, Course, Semester
from utils.constants import (
    CONTENT_ANTI_PROCRASTINACAO,
    CONTENT_FOCO,
    CONTENT_PRE_PROVA,
    EVENT_ENTREGA,
    EVENT_PROVA,
    MOOD_BAD,
    MOOD_GOOD,
    MOOD_OK,
    MOOD_VERY_GOOD,
    PLAN_LITE,
)
from django.contrib.auth import get_user_model


class Command(BaseCommand):
    help = "Cria dados de exemplo para o MVP"

    def add_arguments(self, parser):
        parser.add_argument("--email", help="Email do usuario para popular dados")

    def handle(self, *args, **options):
        User = get_user_model()
        email = options.get("email")
        if email:
            user = User.objects.filter(email=email).first()
            if not user:
                self.stdout.write(self.style.ERROR("Usuario nao encontrado."))
                return
        else:
            user = User.objects.first()
            if not user:
                self.stdout.write(self.style.ERROR("Nenhum usuario encontrado."))
                return

        plan = Plan.objects.filter(code=PLAN_LITE).first()
        if plan:
            UserSubscription.objects.get_or_create(user=user, defaults={"plan": plan})

        MoodEntry.objects.get_or_create(user=user, mood=MOOD_OK, defaults={"notes": "Inicio do semestre"})
        MoodEntry.objects.get_or_create(user=user, mood=MOOD_GOOD, defaults={"notes": "Boa semana"})
        MoodEntry.objects.get_or_create(user=user, mood=MOOD_BAD, defaults={"notes": "Cansaco"})
        MoodEntry.objects.get_or_create(user=user, mood=MOOD_VERY_GOOD, defaults={"notes": "Semana excelente"})

        Task.objects.get_or_create(
            user=user,
            title="Trabalho final",
            defaults={
                "description": "Entrega da disciplina X",
                "due_date": date.today() + timedelta(days=10),
                "stress_level": 3,
                "status": "TODO",
            },
        )
        Task.objects.get_or_create(
            user=user,
            title="Leitura cap. 3",
            defaults={
                "description": "Revisao para prova",
                "due_date": date.today() + timedelta(days=5),
                "stress_level": 2,
                "status": "DOING",
            },
        )
        Task.objects.get_or_create(
            user=user,
            title="Lista de exercicios",
            defaults={
                "description": "Praticar conteudos de logica",
                "due_date": date.today() + timedelta(days=3),
                "stress_level": 2,
                "status": "TODO",
            },
        )

        semester, _ = Semester.objects.get_or_create(
            user=user,
            name="2026.1",
            defaults={
                "start_date": date.today() - timedelta(days=20),
                "end_date": date.today() + timedelta(days=120),
            },
        )

        course_math, _ = Course.objects.get_or_create(
            semester=semester,
            title="Matematica Discreta",
            defaults={"teacher": "Prof. Silva", "credits": 4},
        )
        course_alg, _ = Course.objects.get_or_create(
            semester=semester,
            title="Algoritmos I",
            defaults={"teacher": "Prof. Souza", "credits": 4},
        )
        course_db, _ = Course.objects.get_or_create(
            semester=semester,
            title="Banco de Dados",
            defaults={"teacher": "Profa. Carla", "credits": 4},
        )

        Assessment.objects.get_or_create(
            course=course_math,
            title="Prova 1",
            defaults={"score": 7.5, "max_score": 10, "weight": 1, "date": date.today() + timedelta(days=7)},
        )
        Assessment.objects.get_or_create(
            course=course_math,
            title="Trabalho 1",
            defaults={"score": 8.0, "max_score": 10, "weight": 1, "date": date.today() + timedelta(days=14)},
        )
        Assessment.objects.get_or_create(
            course=course_alg,
            title="Trabalho 1",
            defaults={"score": 8.0, "max_score": 10, "weight": 1, "date": date.today() + timedelta(days=12)},
        )
        Assessment.objects.get_or_create(
            course=course_db,
            title="Prova 1",
            defaults={"score": 6.5, "max_score": 10, "weight": 1, "date": date.today() + timedelta(days=9)},
        )

        CalendarEvent.objects.get_or_create(
            user=user,
            title="Entrega Trabalho Final",
            defaults={"event_type": EVENT_ENTREGA, "start_at": timezone.now() + timedelta(days=9)},
        )
        CalendarEvent.objects.get_or_create(
            user=user,
            title="Prova Matematica",
            defaults={"event_type": EVENT_PROVA, "start_at": timezone.now() + timedelta(days=7)},
        )
        CalendarEvent.objects.get_or_create(
            user=user,
            title="Prova Banco de Dados",
            defaults={"event_type": EVENT_PROVA, "start_at": timezone.now() + timedelta(days=9)},
        )

        ReminderRule.objects.get_or_create(
            user=user,
            target_type="TASK",
            defaults={"remind_before_minutes": 1440, "channels": ["EMAIL"], "is_active": True},
        )

        GuidedContent.objects.get_or_create(
            title="Respiracao pre-prova",
            defaults={
                "category": CONTENT_PRE_PROVA,
                "duration_minutes": 8,
                "body_text": "Exercicio guiado de respiracao para antes da prova.",
                "is_premium": False,
            },
        )
        GuidedContent.objects.get_or_create(
            title="Anti-procrastinacao em 10 minutos",
            defaults={
                "category": CONTENT_ANTI_PROCRASTINACAO,
                "duration_minutes": 10,
                "body_text": "Passos curtos para iniciar tarefas e manter o ritmo.",
                "is_premium": False,
            },
        )
        GuidedContent.objects.get_or_create(
            title="Foco profundo 25min",
            defaults={
                "category": CONTENT_FOCO,
                "duration_minutes": 25,
                "body_text": "Sessao guiada de foco com pausas conscientes.",
                "is_premium": True,
            },
        )

        self.stdout.write(self.style.SUCCESS("seed_demo_data: ok"))

--- FILE: apps/analytics/migrations/__init__.py ---


--- FILE: apps/analytics/models.py ---
from django.db import models

# Intencionalmente vazio para o MVP.

--- FILE: apps/analytics/tests.py ---


--- FILE: apps/analytics/urls.py ---
from django.urls import path

from analytics.views import DashboardView, SemesterAnalyticsView

urlpatterns = [
    path("dashboard/", DashboardView.as_view(), name="analytics-dashboard"),
    path("semester/<int:semester_id>/", SemesterAnalyticsView.as_view(), name="analytics-semester"),
]

--- FILE: apps/analytics/views.py ---
from django.shortcuts import get_object_or_404
from django.utils import timezone
from rest_framework import permissions, status
from rest_framework.response import Response
from rest_framework.views import APIView

from agenda.models import CalendarEvent
from mood.models import MoodEntry
from planner.models import Task
from semester.models import Semester
from utils.constants import FEATURE_DASHBOARD_BASIC, FEATURE_REPORTS_ADVANCED, SEMESTER_ACTIVE
from utils.features import has_feature, require_feature


class DashboardView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request):
        require_feature(request.user, FEATURE_DASHBOARD_BASIC)
        now = timezone.now()
        tasks = Task.objects.filter(user=request.user)
        events = CalendarEvent.objects.filter(user=request.user, start_at__gte=now)
        moods = MoodEntry.objects.filter(user=request.user)
        active_semester = Semester.objects.filter(user=request.user, status=SEMESTER_ACTIVE).first()
        return Response(
            {
                "tasks": {
                    "todo": tasks.filter(status="TODO").count(),
                    "doing": tasks.filter(status="DOING").count(),
                    "done": tasks.filter(status="DONE").count(),
                },
                "upcoming_events": events.count(),
                "mood_entries": moods.count(),
                "active_semester": active_semester.name if active_semester else None,
            }
        )


class SemesterAnalyticsView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request, semester_id):
        if not has_feature(request.user, FEATURE_REPORTS_ADVANCED):
            return Response({"detail": "Plano atual nao permite analytics avancado."}, status=status.HTTP_403_FORBIDDEN)
        semester = get_object_or_404(Semester, pk=semester_id, user=request.user)
        courses = semester.courses.all()
        return Response(
            {
                "semester": semester.name,
                "courses": [
                    {
                        "title": course.title,
                        "status": course.status,
                        "final_grade": course.final_grade,
                    }
                    for course in courses
                ],
            }
        )

--- FILE: apps/billing/__init__.py ---


--- FILE: apps/billing/admin.py ---
from django.contrib import admin

from billing.models import Plan, UserSubscription


@admin.register(Plan)
class PlanAdmin(admin.ModelAdmin):
    list_display = ("code", "name", "is_active")
    list_filter = ("is_active",)


@admin.register(UserSubscription)
class UserSubscriptionAdmin(admin.ModelAdmin):
    list_display = ("user", "plan", "is_active", "started_at")
    list_filter = ("is_active", "plan")

--- FILE: apps/billing/apps.py ---
from django.apps import AppConfig
from django.db.models.signals import post_migrate


class BillingConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'billing'

    def ready(self):
        from billing.signals import seed_plans

        post_migrate.connect(seed_plans, sender=self)

--- FILE: apps/billing/migrations/0001_initial.py ---
# Generated by Django 4.2.11 on 2026-01-28 13:35

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='Plan',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('code', models.CharField(choices=[('LITE', 'Lite'), ('PRO', 'Pro')], max_length=10, unique=True)),
                ('name', models.CharField(max_length=100)),
                ('description', models.TextField(blank=True)),
                ('features', models.JSONField(default=list)),
                ('is_active', models.BooleanField(default=True)),
            ],
        ),
        migrations.CreateModel(
            name='UserSubscription',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('started_at', models.DateTimeField(auto_now_add=True)),
                ('is_active', models.BooleanField(default=True)),
                ('plan', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, to='billing.plan')),
                ('user', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='subscription', to=settings.AUTH_USER_MODEL)),
            ],
        ),
    ]

--- FILE: apps/billing/migrations/__init__.py ---


--- FILE: apps/billing/models.py ---
from django.conf import settings
from django.db import models

from utils.constants import PLAN_CHOICES, PLAN_LITE


class Plan(models.Model):
    code = models.CharField(max_length=10, choices=PLAN_CHOICES, unique=True)
    name = models.CharField(max_length=100)
    description = models.TextField(blank=True)
    features = models.JSONField(default=list)
    is_active = models.BooleanField(default=True)

    def __str__(self):
        return f"{self.code}"

    @staticmethod
    def default_lite_features():
        return [
            "MOOD_BASIC",
            "POMODORO_BASIC",
            "PLANNER_BASIC",
            "AGENDA_BASIC",
            "IN_APP_REMINDERS",
            "DASHBOARD_BASIC",
            "CONTENT_LIMITED",
        ]

    @staticmethod
    def default_pro_features():
        return Plan.default_lite_features() + [
            "EMAIL_NOTIFICATIONS",
            "REPORTS_ADVANCED",
            "SEMESTER_SUMMARY",
            "COACH_ADVANCED",
            "CONTENT_FULL",
        ]


class UserSubscription(models.Model):
    user = models.OneToOneField(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name="subscription")
    plan = models.ForeignKey(Plan, on_delete=models.PROTECT)
    started_at = models.DateTimeField(auto_now_add=True)
    is_active = models.BooleanField(default=True)

    def __str__(self):
        return f"{self.user.email} -> {self.plan.code if self.plan else PLAN_LITE}"

--- FILE: apps/billing/serializers.py ---
from rest_framework import serializers

from billing.models import Plan, UserSubscription


class PlanSerializer(serializers.ModelSerializer):
    class Meta:
        model = Plan
        fields = ("code", "name", "description", "features")


class UserSubscriptionSerializer(serializers.ModelSerializer):
    plan = PlanSerializer()

    class Meta:
        model = UserSubscription
        fields = ("plan", "started_at", "is_active")


class SetPlanSerializer(serializers.Serializer):
    user_id = serializers.IntegerField()
    plan_code = serializers.CharField()

--- FILE: apps/billing/signals.py ---
from django.db import transaction

from billing.models import Plan
from utils.constants import (
    FEATURE_AGENDA_BASIC,
    FEATURE_COACH_ADVANCED,
    FEATURE_CONTENT_FULL,
    FEATURE_CONTENT_LIMITED,
    FEATURE_DASHBOARD_BASIC,
    FEATURE_EMAIL_NOTIFICATIONS,
    FEATURE_IN_APP_REMINDERS,
    FEATURE_MOOD_BASIC,
    FEATURE_PLANNER_BASIC,
    FEATURE_POMODORO_BASIC,
    FEATURE_REPORTS_ADVANCED,
    FEATURE_SEMESTER_SUMMARY,
    PLAN_LITE,
    PLAN_PRO,
)


def seed_plans(sender, **kwargs):
    with transaction.atomic():
        Plan.objects.get_or_create(
            code=PLAN_LITE,
            defaults={
                "name": "Lite",
                "description": "Plano basico para organizacao e bem-estar.",
                "features": [
                    FEATURE_MOOD_BASIC,
                    FEATURE_POMODORO_BASIC,
                    FEATURE_PLANNER_BASIC,
                    FEATURE_AGENDA_BASIC,
                    FEATURE_IN_APP_REMINDERS,
                    FEATURE_DASHBOARD_BASIC,
                    FEATURE_CONTENT_LIMITED,
                ],
                "is_active": True,
            },
        )
        Plan.objects.get_or_create(
            code=PLAN_PRO,
            defaults={
                "name": "Pro",
                "description": "Plano completo com notificacoes e relatorios.",
                "features": [
                    FEATURE_MOOD_BASIC,
                    FEATURE_POMODORO_BASIC,
                    FEATURE_PLANNER_BASIC,
                    FEATURE_AGENDA_BASIC,
                    FEATURE_IN_APP_REMINDERS,
                    FEATURE_DASHBOARD_BASIC,
                    FEATURE_CONTENT_LIMITED,
                    FEATURE_EMAIL_NOTIFICATIONS,
                    FEATURE_REPORTS_ADVANCED,
                    FEATURE_SEMESTER_SUMMARY,
                    FEATURE_COACH_ADVANCED,
                    FEATURE_CONTENT_FULL,
                ],
                "is_active": True,
            },
        )

--- FILE: apps/billing/tests.py ---


--- FILE: apps/billing/urls.py ---
from django.urls import path

from billing.views import CurrentPlanView, SetPlanView

urlpatterns = [
    path("plan/", CurrentPlanView.as_view(), name="billing-plan"),
    path("set-plan/", SetPlanView.as_view(), name="billing-set-plan"),
]

--- FILE: apps/billing/views.py ---
from django.contrib.auth import get_user_model
from rest_framework import permissions, status
from rest_framework.response import Response
from rest_framework.views import APIView

from billing.models import Plan, UserSubscription
from billing.serializers import PlanSerializer, SetPlanSerializer, UserSubscriptionSerializer
from utils.constants import PLAN_LITE

User = get_user_model()


class CurrentPlanView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request):
        subscription = UserSubscription.objects.filter(user=request.user, is_active=True).select_related("plan").first()
        if subscription:
            return Response(UserSubscriptionSerializer(subscription).data)
        plan = Plan.objects.filter(code=PLAN_LITE, is_active=True).first()
        if not plan:
            return Response({"detail": "Plano nao configurado."}, status=status.HTTP_404_NOT_FOUND)
        return Response({"plan": PlanSerializer(plan).data, "started_at": None, "is_active": False})


class SetPlanView(APIView):
    permission_classes = [permissions.IsAdminUser]

    def post(self, request):
        serializer = SetPlanSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        user = User.objects.get(id=serializer.validated_data["user_id"])
        plan = Plan.objects.get(code=serializer.validated_data["plan_code"])
        subscription, _ = UserSubscription.objects.get_or_create(user=user, defaults={"plan": plan})
        subscription.plan = plan
        subscription.is_active = True
        subscription.save()
        return Response(UserSubscriptionSerializer(subscription).data)

--- FILE: apps/coach_ai/__init__.py ---


--- FILE: apps/coach_ai/admin.py ---
from django.contrib import admin

from coach_ai.models import CoachLog


@admin.register(CoachLog)
class CoachLogAdmin(admin.ModelAdmin):
    list_display = ("user", "trigger_type", "created_at")
    list_filter = ("trigger_type",)

--- FILE: apps/coach_ai/apps.py ---
from django.apps import AppConfig


class CoachAiConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'coach_ai'

--- FILE: apps/coach_ai/migrations/0001_initial.py ---
# Generated by Django 4.2.11 on 2026-01-28 13:35

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='CoachLog',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('trigger_type', models.CharField(choices=[('PRAZO_PROXIMO', 'Prazo proximo'), ('ATRASO', 'Atraso'), ('HUMOR_BAIXO', 'Humor baixo'), ('SEMESTRE_CONCLUIDO', 'Semestre concluido'), ('REPROVACAO', 'Reprovacao')], max_length=30)),
                ('suggestion_text', models.TextField()),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='coach_logs', to=settings.AUTH_USER_MODEL)),
            ],
        ),
    ]

--- FILE: apps/coach_ai/migrations/__init__.py ---


--- FILE: apps/coach_ai/models.py ---
from django.conf import settings
from django.db import models

from utils.constants import COACH_TRIGGER_CHOICES


class CoachLog(models.Model):
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name="coach_logs")
    trigger_type = models.CharField(max_length=30, choices=COACH_TRIGGER_CHOICES)
    suggestion_text = models.TextField()
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return f"{self.user.email} - {self.trigger_type}"

--- FILE: apps/coach_ai/tests.py ---


--- FILE: apps/coach_ai/views.py ---


--- FILE: apps/content/__init__.py ---


--- FILE: apps/content/admin.py ---
from django.contrib import admin

from content.models import GuidedContent


@admin.register(GuidedContent)
class GuidedContentAdmin(admin.ModelAdmin):
    list_display = ("title", "category", "duration_minutes", "is_premium")
    list_filter = ("category", "is_premium")

--- FILE: apps/content/apps.py ---
from django.apps import AppConfig


class ContentConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'content'

--- FILE: apps/content/migrations/0001_initial.py ---
# Generated by Django 4.2.11 on 2026-01-28 13:35

from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='GuidedContent',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('title', models.CharField(max_length=200)),
                ('category', models.CharField(choices=[('PRE_PROVA', 'Pre-prova'), ('ANTI_PROCRASTINACAO', 'Anti-procrastinacao'), ('FOCO', 'Foco')], max_length=50)),
                ('duration_minutes', models.PositiveIntegerField()),
                ('body_text', models.TextField()),
                ('is_premium', models.BooleanField(default=False)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
            ],
        ),
    ]

--- FILE: apps/content/migrations/__init__.py ---


--- FILE: apps/content/models.py ---
from django.db import models

from utils.constants import CONTENT_CATEGORY_CHOICES


class GuidedContent(models.Model):
    title = models.CharField(max_length=200)
    category = models.CharField(max_length=50, choices=CONTENT_CATEGORY_CHOICES)
    duration_minutes = models.PositiveIntegerField()
    body_text = models.TextField()
    is_premium = models.BooleanField(default=False)
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return self.title

--- FILE: apps/content/serializers.py ---
from rest_framework import serializers

from content.models import GuidedContent


class GuidedContentSerializer(serializers.ModelSerializer):
    class Meta:
        model = GuidedContent
        fields = ("id", "title", "category", "duration_minutes", "body_text", "is_premium", "created_at")
        read_only_fields = ("id", "created_at")

--- FILE: apps/content/tests.py ---


--- FILE: apps/content/urls.py ---
from django.urls import path

from content.views import GuidedContentDetailView, GuidedContentListView

urlpatterns = [
    path("guided/", GuidedContentListView.as_view(), name="guided-content"),
    path("guided/<int:pk>/", GuidedContentDetailView.as_view(), name="guided-content-detail"),
]

--- FILE: apps/content/views.py ---
from django.shortcuts import get_object_or_404
from rest_framework import permissions, status
from rest_framework.response import Response
from rest_framework.views import APIView

from content.models import GuidedContent
from content.serializers import GuidedContentSerializer
from utils.constants import FEATURE_CONTENT_FULL, FEATURE_CONTENT_LIMITED
from utils.features import has_feature


class GuidedContentListView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request):
        if not has_feature(request.user, FEATURE_CONTENT_FULL) and not has_feature(request.user, FEATURE_CONTENT_LIMITED):
            return Response({"detail": "Plano atual nao permite conteudos."}, status=status.HTTP_403_FORBIDDEN)
        queryset = GuidedContent.objects.all().order_by("-created_at")
        if not has_feature(request.user, FEATURE_CONTENT_FULL):
            queryset = queryset.filter(is_premium=False)
        return Response(GuidedContentSerializer(queryset, many=True).data)


class GuidedContentDetailView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request, pk):
        content = get_object_or_404(GuidedContent, pk=pk)
        if content.is_premium and not has_feature(request.user, FEATURE_CONTENT_FULL):
            return Response({"detail": "Plano atual nao permite este conteudo."}, status=status.HTTP_403_FORBIDDEN)
        return Response(GuidedContentSerializer(content).data)

--- FILE: apps/mood/__init__.py ---


--- FILE: apps/mood/admin.py ---
from django.contrib import admin

from mood.models import MoodEntry


@admin.register(MoodEntry)
class MoodEntryAdmin(admin.ModelAdmin):
    list_display = ("user", "mood", "created_at")
    list_filter = ("mood",)
    search_fields = ("user__email",)

--- FILE: apps/mood/apps.py ---
from django.apps import AppConfig


class MoodConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'mood'

--- FILE: apps/mood/migrations/0001_initial.py ---
# Generated by Django 4.2.11 on 2026-01-28 13:35

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='MoodEntry',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('mood', models.CharField(choices=[('VERY_BAD', 'Very bad'), ('BAD', 'Bad'), ('OK', 'Ok'), ('GOOD', 'Good'), ('VERY_GOOD', 'Very good')], max_length=20)),
                ('notes', models.TextField(blank=True)),
                ('tags', models.JSONField(default=list)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='mood_entries', to=settings.AUTH_USER_MODEL)),
            ],
        ),
    ]

--- FILE: apps/mood/migrations/__init__.py ---


--- FILE: apps/mood/models.py ---
from django.conf import settings
from django.db import models

from utils.constants import MOOD_CHOICES


class MoodEntry(models.Model):
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name="mood_entries")
    mood = models.CharField(max_length=20, choices=MOOD_CHOICES)
    notes = models.TextField(blank=True)
    tags = models.JSONField(default=list)
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return f"{self.user.email} - {self.mood}"

--- FILE: apps/mood/serializers.py ---
from rest_framework import serializers

from mood.models import MoodEntry


class MoodEntrySerializer(serializers.ModelSerializer):
    class Meta:
        model = MoodEntry
        fields = ("id", "mood", "notes", "tags", "created_at")
        read_only_fields = ("id", "created_at")

--- FILE: apps/mood/tests.py ---
from django.contrib.auth import get_user_model
from rest_framework.test import APITestCase
from rest_framework_simplejwt.tokens import RefreshToken

from billing.models import Plan, UserSubscription
from utils.constants import FEATURE_MOOD_BASIC, PLAN_LITE

User = get_user_model()


class MoodEntryTests(APITestCase):
    def setUp(self):
        self.user = User.objects.create_user(email="mood@example.com", name="Mood", password="pass12345")
        plan, _ = Plan.objects.get_or_create(
            code=PLAN_LITE, defaults={"name": "Lite", "features": [FEATURE_MOOD_BASIC], "is_active": True}
        )
        UserSubscription.objects.create(user=self.user, plan=plan)
        refresh = RefreshToken.for_user(self.user)
        self.client.credentials(HTTP_AUTHORIZATION=f"Bearer {refresh.access_token}")

    def test_create_mood_entry(self):
        response = self.client.post("/api/mood/entries/", {"mood": "OK", "notes": "Tudo bem"}, format="json")
        self.assertEqual(response.status_code, 201)

--- FILE: apps/mood/urls.py ---
from django.urls import path

from mood.views import MoodEntryListCreateView, MoodWeeklySummaryView

urlpatterns = [
    path("entries/", MoodEntryListCreateView.as_view(), name="mood-entries"),
    path("summary/weekly/", MoodWeeklySummaryView.as_view(), name="mood-summary-weekly"),
]

--- FILE: apps/mood/views.py ---
from datetime import timedelta

from django.utils import timezone
from rest_framework import permissions, status
from rest_framework.response import Response
from rest_framework.views import APIView
from rest_framework.generics import ListCreateAPIView

from mood.models import MoodEntry
from mood.serializers import MoodEntrySerializer
from utils.constants import FEATURE_MOOD_BASIC, MOOD_VERY_BAD
from utils.features import require_feature


class MoodEntryListCreateView(ListCreateAPIView):
    serializer_class = MoodEntrySerializer
    permission_classes = [permissions.IsAuthenticated]

    def get_queryset(self):
        require_feature(self.request.user, FEATURE_MOOD_BASIC)
        return MoodEntry.objects.filter(user=self.request.user).order_by("-created_at")

    def perform_create(self, serializer):
        require_feature(self.request.user, FEATURE_MOOD_BASIC)
        serializer.save(user=self.request.user)

    def create(self, request, *args, **kwargs):
        response = super().create(request, *args, **kwargs)
        week_ago = timezone.now() - timedelta(days=7)
        very_bad_count = MoodEntry.objects.filter(
            user=request.user, mood=MOOD_VERY_BAD, created_at__gte=week_ago
        ).count()
        if very_bad_count >= 3:
            response.data["wellness_notice"] = (
                "Percebemos humor muito baixo recorrente. Procure apoio profissional."
                " No Brasil, o CVV atende 188 (24h)."
            )
        return response


class MoodWeeklySummaryView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request):
        require_feature(request.user, FEATURE_MOOD_BASIC)
        week_ago = timezone.now() - timedelta(days=7)
        entries = MoodEntry.objects.filter(user=request.user, created_at__gte=week_ago)
        summary = {}
        for mood, _label in MoodEntry._meta.get_field("mood").choices:
            summary[mood] = entries.filter(mood=mood).count()
        return Response({"summary": summary})

--- FILE: apps/notifications/__init__.py ---


--- FILE: apps/notifications/admin.py ---
from django.contrib import admin

from notifications.models import NotificationQueue


@admin.register(NotificationQueue)
class NotificationQueueAdmin(admin.ModelAdmin):
    list_display = ("user", "channel", "status", "scheduled_for")
    list_filter = ("channel", "status")

--- FILE: apps/notifications/apps.py ---
from django.apps import AppConfig


class NotificationsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'notifications'

--- FILE: apps/notifications/management/__init__.py ---


--- FILE: apps/notifications/management/commands/__init__.py ---


--- FILE: apps/notifications/management/commands/process_notification_queue.py ---
from django.core.management.base import BaseCommand
from django.core.mail import send_mail
from django.utils import timezone

from notifications.models import NotificationQueue
from utils.constants import CHANNEL_EMAIL, CHANNEL_SMS, CHANNEL_WHATSAPP, NOTIF_FAILED, NOTIF_PENDING, NOTIF_SENT


class Command(BaseCommand):
    help = "Processa a fila de notificacoes pendentes."

    def handle(self, *args, **options):
        now = timezone.now()
        pending = NotificationQueue.objects.filter(status=NOTIF_PENDING, scheduled_for__lte=now)
        for notification in pending:
            try:
                if notification.channel == CHANNEL_EMAIL:
                    send_mail(notification.title, notification.message, None, [notification.user.email])
                elif notification.channel in {CHANNEL_WHATSAPP, CHANNEL_SMS}:
                    # Mock para MVP.
                    pass
                notification.status = NOTIF_SENT
                notification.save()
                self.stdout.write(self.style.SUCCESS(f"Enviado: {notification.id}"))
            except Exception:
                notification.status = NOTIF_FAILED
                notification.save()
                self.stdout.write(self.style.ERROR(f"Falhou: {notification.id}"))

--- FILE: apps/notifications/migrations/0001_initial.py ---
# Generated by Django 4.2.11 on 2026-01-28 13:35

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='NotificationQueue',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('channel', models.CharField(choices=[('EMAIL', 'Email'), ('WHATSAPP', 'WhatsApp'), ('SMS', 'SMS')], max_length=20)),
                ('title', models.CharField(max_length=200)),
                ('message', models.TextField()),
                ('scheduled_for', models.DateTimeField()),
                ('status', models.CharField(choices=[('PENDING', 'Pending'), ('SENT', 'Sent'), ('FAILED', 'Failed')], default='PENDING', max_length=20)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='notifications', to=settings.AUTH_USER_MODEL)),
            ],
        ),
    ]

--- FILE: apps/notifications/migrations/__init__.py ---


--- FILE: apps/notifications/models.py ---
from django.conf import settings
from django.db import models

from utils.constants import CHANNEL_CHOICES, NOTIFICATION_STATUS_CHOICES, NOTIF_PENDING


class NotificationQueue(models.Model):
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name="notifications")
    channel = models.CharField(max_length=20, choices=CHANNEL_CHOICES)
    title = models.CharField(max_length=200)
    message = models.TextField()
    scheduled_for = models.DateTimeField()
    status = models.CharField(max_length=20, choices=NOTIFICATION_STATUS_CHOICES, default=NOTIF_PENDING)
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return f"{self.user.email} - {self.channel}"

--- FILE: apps/notifications/serializers.py ---
from rest_framework import serializers

from notifications.models import NotificationQueue


class NotificationQueueSerializer(serializers.ModelSerializer):
    class Meta:
        model = NotificationQueue
        fields = (
            "id",
            "channel",
            "title",
            "message",
            "scheduled_for",
            "status",
            "created_at",
        )
        read_only_fields = ("id", "created_at")

--- FILE: apps/notifications/tests.py ---


--- FILE: apps/notifications/urls.py ---
from django.urls import path

from notifications.views import PendingNotificationsView, TestEmailView

urlpatterns = [
    path("test-email/", TestEmailView.as_view(), name="notifications-test-email"),
    path("pending/", PendingNotificationsView.as_view(), name="notifications-pending"),
]

--- FILE: apps/notifications/views.py ---
from django.core.mail import send_mail
from django.utils import timezone
from rest_framework import permissions, status
from rest_framework.response import Response
from rest_framework.views import APIView

from notifications.models import NotificationQueue
from notifications.serializers import NotificationQueueSerializer
from utils.constants import CHANNEL_EMAIL, NOTIF_PENDING
from utils.features import has_feature
from utils.constants import FEATURE_EMAIL_NOTIFICATIONS


class TestEmailView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def post(self, request):
        if not has_feature(request.user, FEATURE_EMAIL_NOTIFICATIONS):
            return Response({"detail": "Plano atual nao permite email."}, status=status.HTTP_403_FORBIDDEN)
        subject = "Campus Calm - Teste de Email"
        message = "Este e um email de teste do Campus Calm."
        send_mail(subject, message, None, [request.user.email])
        return Response({"detail": "Email enviado para console."})


class PendingNotificationsView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request):
        now = timezone.now()
        pending = NotificationQueue.objects.filter(
            user=request.user, status=NOTIF_PENDING, scheduled_for__lte=now
        ).order_by("scheduled_for")
        return Response(NotificationQueueSerializer(pending, many=True).data)

--- FILE: apps/onboarding/__init__.py ---


--- FILE: apps/onboarding/admin.py ---
from django.contrib import admin

from onboarding.models import UserSetupProgress


@admin.register(UserSetupProgress)
class UserSetupProgressAdmin(admin.ModelAdmin):
    list_display = ("user", "has_profile", "has_active_semester", "has_at_least_one_course", "has_at_least_one_assessment", "has_reminder_rule")

--- FILE: apps/onboarding/apps.py ---
from django.apps import AppConfig


class OnboardingConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'onboarding'

    def ready(self):
        from onboarding import signals  # noqa: F401

--- FILE: apps/onboarding/migrations/0001_initial.py ---
# Generated by Django 4.2.11 on 2026-01-28 13:35

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='UserSetupProgress',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('has_profile', models.BooleanField(default=False)),
                ('has_active_semester', models.BooleanField(default=False)),
                ('has_at_least_one_course', models.BooleanField(default=False)),
                ('has_at_least_one_assessment', models.BooleanField(default=False)),
                ('has_reminder_rule', models.BooleanField(default=False)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('user', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='setup_progress', to=settings.AUTH_USER_MODEL)),
            ],
        ),
    ]

--- FILE: apps/onboarding/migrations/__init__.py ---


--- FILE: apps/onboarding/models.py ---
from django.conf import settings
from django.db import models


class UserSetupProgress(models.Model):
    user = models.OneToOneField(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name="setup_progress")
    has_profile = models.BooleanField(default=False)
    has_active_semester = models.BooleanField(default=False)
    has_at_least_one_course = models.BooleanField(default=False)
    has_at_least_one_assessment = models.BooleanField(default=False)
    has_reminder_rule = models.BooleanField(default=False)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return self.user.email

--- FILE: apps/onboarding/services.py ---
from semester.models import Assessment, Course, Semester
from agenda.models import ReminderRule
from onboarding.models import UserSetupProgress
from utils.constants import SEMESTER_ACTIVE


def refresh_user_progress(user):
    progress, _ = UserSetupProgress.objects.get_or_create(user=user)
    progress.has_profile = bool(user.name)
    progress.has_active_semester = Semester.objects.filter(user=user, status=SEMESTER_ACTIVE).exists()
    progress.has_at_least_one_course = Course.objects.filter(semester__user=user).exists()
    progress.has_at_least_one_assessment = Assessment.objects.filter(course__semester__user=user).exists()
    progress.has_reminder_rule = ReminderRule.objects.filter(user=user, is_active=True).exists()
    progress.save()
    return progress

--- FILE: apps/onboarding/signals.py ---
from django.db.models.signals import post_delete, post_save
from django.dispatch import receiver

from accounts.models import User
from agenda.models import ReminderRule
from onboarding.services import refresh_user_progress
from semester.models import Assessment, Course, Semester


@receiver(post_save, sender=User)
def user_saved(sender, instance, **kwargs):
    refresh_user_progress(instance)


@receiver(post_save, sender=Semester)
@receiver(post_delete, sender=Semester)
def semester_changed(sender, instance, **kwargs):
    refresh_user_progress(instance.user)


@receiver(post_save, sender=Course)
@receiver(post_delete, sender=Course)
def course_changed(sender, instance, **kwargs):
    refresh_user_progress(instance.semester.user)


@receiver(post_save, sender=Assessment)
@receiver(post_delete, sender=Assessment)
def assessment_changed(sender, instance, **kwargs):
    refresh_user_progress(instance.course.semester.user)


@receiver(post_save, sender=ReminderRule)
@receiver(post_delete, sender=ReminderRule)
def reminder_changed(sender, instance, **kwargs):
    refresh_user_progress(instance.user)

--- FILE: apps/onboarding/tests.py ---


--- FILE: apps/onboarding/urls.py ---
from django.urls import path

from onboarding.views import OnboardingStatusView

urlpatterns = [
    path("status/", OnboardingStatusView.as_view(), name="onboarding-status"),
]

--- FILE: apps/onboarding/views.py ---
from rest_framework import permissions
from rest_framework.response import Response
from rest_framework.views import APIView

from onboarding.services import refresh_user_progress
from utils.gating import compute_status


class OnboardingStatusView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request):
        progress = refresh_user_progress(request.user)
        current_step, missing_steps, required_actions = compute_status(progress)
        return Response(
            {
                "current_step": current_step,
                "missing_steps": missing_steps,
                "required_actions": required_actions,
            }
        )

--- FILE: apps/planner/__init__.py ---


--- FILE: apps/planner/admin.py ---
from django.contrib import admin

from planner.models import Task


@admin.register(Task)
class TaskAdmin(admin.ModelAdmin):
    list_display = ("title", "user", "due_date", "status")
    list_filter = ("status",)
    search_fields = ("title", "user__email")

--- FILE: apps/planner/apps.py ---
from django.apps import AppConfig


class PlannerConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'planner'

--- FILE: apps/planner/migrations/0001_initial.py ---
# Generated by Django 4.2.11 on 2026-01-28 13:35

from django.conf import settings
import django.core.validators
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='Task',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('title', models.CharField(max_length=200)),
                ('description', models.TextField(blank=True)),
                ('due_date', models.DateField()),
                ('stress_level', models.PositiveSmallIntegerField(validators=[django.core.validators.MinValueValidator(1), django.core.validators.MaxValueValidator(5)])),
                ('status', models.CharField(choices=[('TODO', 'Todo'), ('DOING', 'Doing'), ('DONE', 'Done')], default='TODO', max_length=10)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='tasks', to=settings.AUTH_USER_MODEL)),
            ],
        ),
    ]

--- FILE: apps/planner/migrations/__init__.py ---


--- FILE: apps/planner/models.py ---
from django.conf import settings
from django.core.validators import MaxValueValidator, MinValueValidator
from django.db import models

from utils.constants import TASK_STATUS_CHOICES, TASK_TODO


class Task(models.Model):
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name="tasks")
    title = models.CharField(max_length=200)
    description = models.TextField(blank=True)
    due_date = models.DateField()
    stress_level = models.PositiveSmallIntegerField(validators=[MinValueValidator(1), MaxValueValidator(5)])
    status = models.CharField(max_length=10, choices=TASK_STATUS_CHOICES, default=TASK_TODO)
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return self.title

--- FILE: apps/planner/serializers.py ---
from rest_framework import serializers

from planner.models import Task


class TaskSerializer(serializers.ModelSerializer):
    class Meta:
        model = Task
        fields = (
            "id",
            "title",
            "description",
            "due_date",
            "stress_level",
            "status",
            "created_at",
        )
        read_only_fields = ("id", "created_at")

--- FILE: apps/planner/tests.py ---


--- FILE: apps/planner/urls.py ---
from rest_framework.routers import DefaultRouter

from planner.views import TaskViewSet

router = DefaultRouter()
router.register(r"tasks", TaskViewSet, basename="tasks")

urlpatterns = router.urls

--- FILE: apps/planner/views.py ---
from rest_framework import permissions, viewsets

from planner.models import Task
from planner.serializers import TaskSerializer
from utils.constants import FEATURE_PLANNER_BASIC
from utils.features import require_feature


class TaskViewSet(viewsets.ModelViewSet):
    serializer_class = TaskSerializer
    permission_classes = [permissions.IsAuthenticated]

    def initial(self, request, *args, **kwargs):
        require_feature(request.user, FEATURE_PLANNER_BASIC)
        return super().initial(request, *args, **kwargs)

    def get_queryset(self):
        return Task.objects.filter(user=self.request.user).order_by("-created_at")

    def perform_create(self, serializer):
        serializer.save(user=self.request.user)

--- FILE: apps/pomodoro/__init__.py ---


--- FILE: apps/pomodoro/admin.py ---
from django.contrib import admin

from pomodoro.models import PomodoroSession


@admin.register(PomodoroSession)
class PomodoroSessionAdmin(admin.ModelAdmin):
    list_display = ("user", "status", "started_at", "ended_at")
    list_filter = ("status",)

--- FILE: apps/pomodoro/apps.py ---
from django.apps import AppConfig


class PomodoroConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'pomodoro'

--- FILE: apps/pomodoro/migrations/0001_initial.py ---
# Generated by Django 4.2.11 on 2026-01-28 13:35

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion
import django.utils.timezone


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='PomodoroSession',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('focus_minutes', models.PositiveIntegerField(default=25)),
                ('break_minutes', models.PositiveIntegerField(default=5)),
                ('started_at', models.DateTimeField(default=django.utils.timezone.now)),
                ('ended_at', models.DateTimeField(blank=True, null=True)),
                ('status', models.CharField(choices=[('COMPLETED', 'Completed'), ('STOPPED', 'Stopped')], default='STOPPED', max_length=20)),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='pomodoro_sessions', to=settings.AUTH_USER_MODEL)),
            ],
        ),
    ]

--- FILE: apps/pomodoro/migrations/__init__.py ---


--- FILE: apps/pomodoro/models.py ---
from django.conf import settings
from django.db import models
from django.utils import timezone

from utils.constants import POMODORO_STATUS_CHOICES, POMODORO_STOPPED


class PomodoroSession(models.Model):
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name="pomodoro_sessions")
    focus_minutes = models.PositiveIntegerField(default=25)
    break_minutes = models.PositiveIntegerField(default=5)
    started_at = models.DateTimeField(default=timezone.now)
    ended_at = models.DateTimeField(null=True, blank=True)
    status = models.CharField(max_length=20, choices=POMODORO_STATUS_CHOICES, default=POMODORO_STOPPED)

    def __str__(self):
        return f"{self.user.email} - {self.status}"

--- FILE: apps/pomodoro/serializers.py ---
from rest_framework import serializers

from pomodoro.models import PomodoroSession


class PomodoroSessionSerializer(serializers.ModelSerializer):
    class Meta:
        model = PomodoroSession
        fields = (
            "id",
            "focus_minutes",
            "break_minutes",
            "started_at",
            "ended_at",
            "status",
        )
        read_only_fields = ("id", "started_at", "ended_at", "status")

--- FILE: apps/pomodoro/tests.py ---


--- FILE: apps/pomodoro/urls.py ---
from django.urls import path

from pomodoro.views import PomodoroStartView, PomodoroStopView, PomodoroWeeklySummaryView

urlpatterns = [
    path("start/", PomodoroStartView.as_view(), name="pomodoro-start"),
    path("stop/<int:pk>/", PomodoroStopView.as_view(), name="pomodoro-stop"),
    path("summary/weekly/", PomodoroWeeklySummaryView.as_view(), name="pomodoro-summary-weekly"),
]

--- FILE: apps/pomodoro/views.py ---
from datetime import timedelta

from django.utils import timezone
from rest_framework import permissions, status
from rest_framework.response import Response
from rest_framework.views import APIView

from pomodoro.models import PomodoroSession
from pomodoro.serializers import PomodoroSessionSerializer
from utils.constants import FEATURE_POMODORO_BASIC, POMODORO_COMPLETED, POMODORO_STOPPED
from utils.features import require_feature


class PomodoroStartView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def post(self, request):
        require_feature(request.user, FEATURE_POMODORO_BASIC)
        focus_minutes = int(request.data.get("focus_minutes", 25))
        break_minutes = int(request.data.get("break_minutes", 5))
        session = PomodoroSession.objects.create(
            user=request.user,
            focus_minutes=focus_minutes,
            break_minutes=break_minutes,
        )
        return Response(PomodoroSessionSerializer(session).data, status=status.HTTP_201_CREATED)


class PomodoroStopView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def post(self, request, pk):
        require_feature(request.user, FEATURE_POMODORO_BASIC)
        session = PomodoroSession.objects.get(pk=pk, user=request.user)
        completed_value = request.data.get("completed", False)
        completed = str(completed_value).lower() in {"1", "true", "yes", "on"}
        session.ended_at = timezone.now()
        session.status = POMODORO_COMPLETED if completed else POMODORO_STOPPED
        session.save()
        return Response(PomodoroSessionSerializer(session).data)


class PomodoroWeeklySummaryView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request):
        require_feature(request.user, FEATURE_POMODORO_BASIC)
        week_ago = timezone.now() - timedelta(days=7)
        sessions = PomodoroSession.objects.filter(user=request.user, started_at__gte=week_ago)
        total_sessions = sessions.count()
        total_focus_minutes = sum(session.focus_minutes for session in sessions)
        return Response(
            {
                "total_sessions": total_sessions,
                "total_focus_minutes": total_focus_minutes,
            }
        )

--- FILE: apps/semester/__init__.py ---


--- FILE: apps/semester/admin.py ---
from django.contrib import admin

from semester.models import Assessment, Course, Semester, SemesterCheckin


@admin.register(Semester)
class SemesterAdmin(admin.ModelAdmin):
    list_display = ("name", "user", "status", "start_date", "end_date")
    list_filter = ("status",)


@admin.register(Course)
class CourseAdmin(admin.ModelAdmin):
    list_display = ("title", "semester", "status", "passing_grade", "final_grade")
    list_filter = ("status",)


@admin.register(Assessment)
class AssessmentAdmin(admin.ModelAdmin):
    list_display = ("title", "course", "score", "max_score", "weight")


@admin.register(SemesterCheckin)
class SemesterCheckinAdmin(admin.ModelAdmin):
    list_display = ("semester", "overall_stress", "created_at")

--- FILE: apps/semester/apps.py ---
from django.apps import AppConfig


class SemesterConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'semester'

--- FILE: apps/semester/migrations/0001_initial.py ---
# Generated by Django 4.2.11 on 2026-01-28 13:35

from decimal import Decimal
from django.conf import settings
import django.core.validators
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='Semester',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=50)),
                ('start_date', models.DateField()),
                ('end_date', models.DateField()),
                ('status', models.CharField(choices=[('ACTIVE', 'Active'), ('FINISHED', 'Finished')], default='ACTIVE', max_length=20)),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='semesters', to=settings.AUTH_USER_MODEL)),
            ],
        ),
        migrations.CreateModel(
            name='SemesterCheckin',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('overall_stress', models.PositiveSmallIntegerField(validators=[django.core.validators.MinValueValidator(1), django.core.validators.MaxValueValidator(5)])),
                ('comment', models.TextField(blank=True)),
                ('semester', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='checkins', to='semester.semester')),
            ],
        ),
        migrations.CreateModel(
            name='Course',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('title', models.CharField(max_length=200)),
                ('teacher', models.CharField(blank=True, max_length=200)),
                ('credits', models.PositiveIntegerField(blank=True, null=True)),
                ('passing_grade', models.DecimalField(decimal_places=2, default=Decimal('7.0'), max_digits=4)),
                ('status', models.CharField(choices=[('IN_PROGRESS', 'In progress'), ('PASSED', 'Passed'), ('FAILED', 'Failed')], default='IN_PROGRESS', max_length=20)),
                ('final_grade', models.DecimalField(blank=True, decimal_places=2, max_digits=5, null=True)),
                ('notes', models.TextField(blank=True)),
                ('semester', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='courses', to='semester.semester')),
            ],
        ),
        migrations.CreateModel(
            name='Assessment',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('title', models.CharField(max_length=200)),
                ('score', models.DecimalField(decimal_places=2, max_digits=5, validators=[django.core.validators.MinValueValidator(0)])),
                ('max_score', models.DecimalField(decimal_places=2, default=Decimal('10.0'), max_digits=5)),
                ('weight', models.DecimalField(decimal_places=2, default=Decimal('1.0'), max_digits=5, validators=[django.core.validators.MinValueValidator(0)])),
                ('date', models.DateField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('course', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='assessments', to='semester.course')),
            ],
        ),
    ]

--- FILE: apps/semester/migrations/__init__.py ---


--- FILE: apps/semester/models.py ---
from decimal import Decimal

from django.conf import settings
from django.core.validators import MaxValueValidator, MinValueValidator
from django.db import models

from utils.constants import COURSE_STATUS_CHOICES, COURSE_IN_PROGRESS, SEMESTER_STATUS_CHOICES, SEMESTER_ACTIVE


class Semester(models.Model):
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name="semesters")
    name = models.CharField(max_length=50)
    start_date = models.DateField()
    end_date = models.DateField()
    status = models.CharField(max_length=20, choices=SEMESTER_STATUS_CHOICES, default=SEMESTER_ACTIVE)

    def __str__(self):
        return self.name


class Course(models.Model):
    semester = models.ForeignKey(Semester, on_delete=models.CASCADE, related_name="courses")
    title = models.CharField(max_length=200)
    teacher = models.CharField(max_length=200, blank=True)
    credits = models.PositiveIntegerField(null=True, blank=True)
    passing_grade = models.DecimalField(max_digits=4, decimal_places=2, default=Decimal("7.0"))
    status = models.CharField(max_length=20, choices=COURSE_STATUS_CHOICES, default=COURSE_IN_PROGRESS)
    final_grade = models.DecimalField(max_digits=5, decimal_places=2, null=True, blank=True)
    notes = models.TextField(blank=True)

    def __str__(self):
        return self.title


class Assessment(models.Model):
    course = models.ForeignKey(Course, on_delete=models.CASCADE, related_name="assessments")
    title = models.CharField(max_length=200)
    score = models.DecimalField(max_digits=5, decimal_places=2, validators=[MinValueValidator(0)])
    max_score = models.DecimalField(max_digits=5, decimal_places=2, default=Decimal("10.0"))
    weight = models.DecimalField(max_digits=5, decimal_places=2, default=Decimal("1.0"), validators=[MinValueValidator(0)])
    date = models.DateField(null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return self.title


class SemesterCheckin(models.Model):
    semester = models.ForeignKey(Semester, on_delete=models.CASCADE, related_name="checkins")
    created_at = models.DateTimeField(auto_now_add=True)
    overall_stress = models.PositiveSmallIntegerField(validators=[MinValueValidator(1), MaxValueValidator(5)])
    comment = models.TextField(blank=True)

    def __str__(self):
        return f"{self.semester.name} checkin"

--- FILE: apps/semester/serializers.py ---
from decimal import Decimal, ROUND_HALF_UP

from rest_framework import serializers

from semester.models import Assessment, Course, Semester, SemesterCheckin


def compute_course_average(course):
    assessments = course.assessments.all()
    total_weight = sum((a.weight for a in assessments), Decimal("0"))
    if total_weight == 0:
        return Decimal("0")
    total_score = sum((a.score * a.weight for a in assessments), Decimal("0"))
    return (total_score / total_weight).quantize(Decimal("0.01"), rounding=ROUND_HALF_UP)


def compute_course_progress(course):
    current_average = compute_course_average(course)
    passing_grade = course.passing_grade or Decimal("0")
    if passing_grade == 0:
        progress_percent = Decimal("0")
    else:
        progress_percent = min(Decimal("100"), (current_average / passing_grade) * Decimal("100"))
    needed_to_pass = max(Decimal("0"), passing_grade - current_average)
    return current_average, progress_percent, needed_to_pass


class SemesterSerializer(serializers.ModelSerializer):
    class Meta:
        model = Semester
        fields = ("id", "name", "start_date", "end_date", "status")
        read_only_fields = ("id",)


class CourseSerializer(serializers.ModelSerializer):
    current_average = serializers.SerializerMethodField()
    progress_percent = serializers.SerializerMethodField()
    needed_to_pass = serializers.SerializerMethodField()

    class Meta:
        model = Course
        fields = (
            "id",
            "semester",
            "title",
            "teacher",
            "credits",
            "passing_grade",
            "status",
            "final_grade",
            "notes",
            "current_average",
            "progress_percent",
            "needed_to_pass",
        )
        read_only_fields = ("id", "status", "final_grade", "current_average", "progress_percent", "needed_to_pass")

    def get_current_average(self, obj):
        return compute_course_progress(obj)[0]

    def get_progress_percent(self, obj):
        return compute_course_progress(obj)[1]

    def get_needed_to_pass(self, obj):
        return compute_course_progress(obj)[2]


class AssessmentSerializer(serializers.ModelSerializer):
    class Meta:
        model = Assessment
        fields = ("id", "course", "title", "score", "max_score", "weight", "date", "created_at")
        read_only_fields = ("id", "created_at")

    def validate(self, attrs):
        score = attrs.get("score")
        max_score = attrs.get("max_score")
        weight = attrs.get("weight")
        if score is not None and max_score is not None and score > max_score:
            raise serializers.ValidationError("score deve ser <= max_score")
        if weight is not None and weight < 0:
            raise serializers.ValidationError("weight deve ser >= 0")
        return attrs


class SemesterCheckinSerializer(serializers.ModelSerializer):
    class Meta:
        model = SemesterCheckin
        fields = ("id", "semester", "created_at", "overall_stress", "comment")
        read_only_fields = ("id", "created_at")

--- FILE: apps/semester/tests.py ---
from datetime import date
from decimal import Decimal

from django.contrib.auth import get_user_model
from rest_framework.test import APITestCase
from rest_framework_simplejwt.tokens import RefreshToken

from coach_ai.models import CoachLog
from semester.models import Assessment, Course, Semester
from utils.constants import COACH_REPROVACAO, COACH_SEMESTRE_CONCLUIDO, COURSE_FAILED, COURSE_PASSED

User = get_user_model()


class SemesterProgressTests(APITestCase):
    def setUp(self):
        self.user = User.objects.create_user(email="semester@example.com", name="Semestre", password="pass12345")
        refresh = RefreshToken.for_user(self.user)
        self.client.credentials(HTTP_AUTHORIZATION=f"Bearer {refresh.access_token}")
        self.semester = Semester.objects.create(
            user=self.user,
            name="2026.1",
            start_date=date.today(),
            end_date=date.today(),
        )
        self.course = Course.objects.create(semester=self.semester, title="Matematica")

    def test_course_progress_requires_assessment(self):
        response = self.client.get(f"/api/semester/courses/{self.course.id}/progress/")
        self.assertEqual(response.status_code, 403)
        self.assertIn("detail", response.data)

    def test_finish_semester_passed(self):
        Assessment.objects.create(course=self.course, title="Prova 1", score=Decimal("9"), max_score=Decimal("10"))
        response = self.client.post(f"/api/semester/finish/{self.semester.id}/")
        self.assertEqual(response.status_code, 200)
        self.course.refresh_from_db()
        self.assertEqual(self.course.status, COURSE_PASSED)
        self.assertTrue(CoachLog.objects.filter(user=self.user, trigger_type=COACH_SEMESTRE_CONCLUIDO).exists())

    def test_finish_semester_failed(self):
        failing_course = Course.objects.create(semester=self.semester, title="Fisica", passing_grade=Decimal("7"))
        Assessment.objects.create(course=failing_course, title="Prova 1", score=Decimal("3"), max_score=Decimal("10"))
        response = self.client.post(f"/api/semester/finish/{self.semester.id}/")
        self.assertEqual(response.status_code, 200)
        failing_course.refresh_from_db()
        self.assertEqual(failing_course.status, COURSE_FAILED)
        self.assertTrue(CoachLog.objects.filter(user=self.user, trigger_type=COACH_REPROVACAO).exists())

--- FILE: apps/semester/urls.py ---
from django.urls import path
from rest_framework.routers import DefaultRouter

from semester.views import AssessmentViewSet, CourseProgressView, CourseViewSet, FinishSemesterView, SemesterViewSet

router = DefaultRouter()
router.register(r"semesters", SemesterViewSet, basename="semesters")
router.register(r"courses", CourseViewSet, basename="courses")
router.register(r"assessments", AssessmentViewSet, basename="assessments")

urlpatterns = router.urls + [
    path("courses/<int:pk>/progress/", CourseProgressView.as_view(), name="course-progress"),
    path("finish/<int:semester_id>/", FinishSemesterView.as_view(), name="semester-finish"),
]

--- FILE: apps/semester/views.py ---
from decimal import Decimal

from django.shortcuts import get_object_or_404
from rest_framework import permissions, status, viewsets
from rest_framework.exceptions import PermissionDenied
from rest_framework.response import Response
from rest_framework.views import APIView

from coach_ai.models import CoachLog
from semester.models import Assessment, Course, Semester
from semester.serializers import AssessmentSerializer, CourseSerializer, SemesterSerializer, compute_course_progress
from utils.constants import COACH_REPROVACAO, COACH_SEMESTRE_CONCLUIDO, COURSE_FAILED, COURSE_PASSED, SEMESTER_FINISHED
from utils.gating import gate_course_progress, gate_finish_semester


class SemesterViewSet(viewsets.ModelViewSet):
    serializer_class = SemesterSerializer
    permission_classes = [permissions.IsAuthenticated]

    def get_queryset(self):
        return Semester.objects.filter(user=self.request.user).order_by("-start_date")

    def perform_create(self, serializer):
        serializer.save(user=self.request.user)


class CourseViewSet(viewsets.ModelViewSet):
    serializer_class = CourseSerializer
    permission_classes = [permissions.IsAuthenticated]

    def get_queryset(self):
        return Course.objects.filter(semester__user=self.request.user).order_by("title")

    def perform_create(self, serializer):
        semester = serializer.validated_data["semester"]
        if semester.user != self.request.user:
            raise PermissionDenied("Semestre nao pertence ao usuario")
        serializer.save()


class AssessmentViewSet(viewsets.ModelViewSet):
    serializer_class = AssessmentSerializer
    permission_classes = [permissions.IsAuthenticated]

    def get_queryset(self):
        return Assessment.objects.filter(course__semester__user=self.request.user).order_by("-created_at")

    def perform_create(self, serializer):
        course = serializer.validated_data["course"]
        if course.semester.user != self.request.user:
            raise PermissionDenied("Curso nao pertence ao usuario")
        serializer.save()


class CourseProgressView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request, pk):
        course = get_object_or_404(Course, pk=pk, semester__user=request.user)
        allowed, message = gate_course_progress(course)
        if not allowed:
            return Response({"detail": message}, status=status.HTTP_403_FORBIDDEN)
        current_average, progress_percent, needed_to_pass = compute_course_progress(course)
        return Response(
            {
                "course_id": course.id,
                "current_average": current_average,
                "progress_percent": progress_percent,
                "needed_to_pass": needed_to_pass,
            }
        )


class FinishSemesterView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def post(self, request, semester_id):
        semester = get_object_or_404(Semester, pk=semester_id, user=request.user)
        allowed, message = gate_finish_semester(semester)
        if not allowed:
            return Response({"detail": message}, status=status.HTTP_403_FORBIDDEN)

        any_failed = False
        for course in semester.courses.all():
            current_average, _progress, _needed = compute_course_progress(course)
            course.final_grade = current_average
            if current_average >= (course.passing_grade or Decimal("0")):
                course.status = COURSE_PASSED
            else:
                course.status = COURSE_FAILED
                any_failed = True
            course.save()

        semester.status = SEMESTER_FINISHED
        semester.save()

        if any_failed:
            CoachLog.objects.create(
                user=request.user,
                trigger_type=COACH_REPROVACAO,
                suggestion_text=(
                    "Identificamos disciplinas reprovadas. Vamos montar um plano de continuidade e recuperar o ritmo."
                ),
            )
        else:
            CoachLog.objects.create(
                user=request.user,
                trigger_type=COACH_SEMESTRE_CONCLUIDO,
                suggestion_text=(
                    "Parabens! Voce concluiu o semestre sem reprovacoes. Continue com esse ritmo."
                ),
            )

        return Response({"detail": "Semestre finalizado."})

--- FILE: apps/ui/__init__.py ---


--- FILE: apps/ui/apps.py ---
from django.apps import AppConfig


class UiConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "ui"

--- FILE: apps/ui/forms.py ---
from django import forms
from django.contrib.auth.forms import AuthenticationForm


class EmailAuthenticationForm(AuthenticationForm):
    username = forms.EmailField(
        label="Email",
        widget=forms.EmailInput(attrs={"class": "form-control", "placeholder": "seu.email@universidade.edu"}),
    )
    password = forms.CharField(
        label="Senha",
        widget=forms.PasswordInput(attrs={"class": "form-control", "placeholder": "Sua senha"}),
    )

--- FILE: apps/ui/urls.py ---
from django.contrib.auth import views as auth_views
from django.urls import path

from ui.forms import EmailAuthenticationForm
from ui.views import agenda_view, dashboard_view, onboarding_view, semesters_view, tasks_view

urlpatterns = [
    path(
        "login/",
        auth_views.LoginView.as_view(
            template_name="ui/login.html",
            authentication_form=EmailAuthenticationForm,
        ),
        name="ui-login",
    ),
    path("logout/", auth_views.LogoutView.as_view(next_page="/login/"), name="ui-logout"),
    path(
        "password-reset/",
        auth_views.PasswordResetView.as_view(
            template_name="ui/password_reset_form.html",
            email_template_name="registration/password_reset_email.html",
            subject_template_name="registration/password_reset_subject.txt",
            success_url="/password-reset/done/",
        ),
        name="password_reset",
    ),
    path(
        "password-reset/done/",
        auth_views.PasswordResetDoneView.as_view(
            template_name="ui/password_reset_done.html",
        ),
        name="password_reset_done",
    ),
    path(
        "reset/<uidb64>/<token>/",
        auth_views.PasswordResetConfirmView.as_view(
            template_name="ui/password_reset_confirm.html",
            success_url="/reset/done/",
        ),
        name="password_reset_confirm",
    ),
    path(
        "reset/done/",
        auth_views.PasswordResetCompleteView.as_view(
            template_name="ui/password_reset_complete.html",
        ),
        name="password_reset_complete",
    ),
    path("", dashboard_view, name="ui-dashboard"),
    path("onboarding/", onboarding_view, name="ui-onboarding"),
    path("semesters/", semesters_view, name="ui-semesters"),
    path("tasks/", tasks_view, name="ui-tasks"),
    path("agenda/", agenda_view, name="ui-agenda"),
]

--- FILE: apps/ui/views.py ---
from collections import Counter
from datetime import timedelta

from django.contrib.auth.decorators import login_required
from django.db.models import Q
from django.shortcuts import redirect, render
from django.utils import timezone

from agenda.models import CalendarEvent, ReminderRule
from mood.models import MoodEntry
from onboarding.services import refresh_user_progress
from planner.models import Task
from pomodoro.models import PomodoroSession
from semester.models import Semester, SemesterCheckin
from semester.serializers import compute_course_progress
from utils.constants import (
    EVENT_TYPE_CHOICES,
    SEMESTER_ACTIVE,
    SEMESTER_FINISHED,
    TASK_DOING,
    TASK_DONE,
    TASK_TODO,
)
from utils.gating import STEPS, compute_status

STEP_LABELS = {
    "STEP_1_PROFILE": "Perfil",
    "STEP_2_SEMESTER": "Semestre",
    "STEP_3_COURSES": "Disciplinas",
    "STEP_4_ASSESSMENTS": "Avaliacoes",
    "STEP_5_REMINDERS": "Lembretes",
    "STEP_6_DASHBOARD": "Dashboard",
}


def _build_steps(progress):
    current_step, missing_steps, required_actions = compute_status(progress)
    steps = []
    for step, _field, message in STEPS:
        label = STEP_LABELS.get(step, step)
        is_missing = step in missing_steps
        steps.append(
            {
                "code": step,
                "label": label,
                "missing": is_missing,
                "message": message if is_missing else "Concluido",
            }
        )
    return {
        "current_step": current_step,
        "missing_steps": missing_steps,
        "required_actions": required_actions,
        "steps": steps,
        "is_complete": len(missing_steps) == 0,
    }


@login_required(login_url="/login/")
def dashboard_view(request):
    user = request.user
    progress = refresh_user_progress(user)
    onboarding_status = _build_steps(progress)

    session_key = "ui_dashboard_filters"
    if request.GET.get("clear") == "1":
        request.session.pop(session_key, None)
        return redirect(request.path)
    if "q" in request.GET:
        search_query = request.GET.get("q", "").strip()
        request.session[session_key] = {"q": search_query}
    else:
        search_query = request.session.get(session_key, {}).get("q", "")

    now = timezone.now()
    week_ago = now - timedelta(days=7)

    mood_entries = MoodEntry.objects.filter(user=user, created_at__gte=week_ago)
    mood_counts = Counter(mood_entries.values_list("mood", flat=True))
    most_common_mood = None
    if mood_counts:
        most_common_mood = mood_counts.most_common(1)[0][0]

    focus_minutes = (
        PomodoroSession.objects.filter(user=user, started_at__gte=week_ago)
        .values_list("focus_minutes", flat=True)
    )
    total_focus_minutes = sum(focus_minutes)

    stress_values = SemesterCheckin.objects.filter(semester__user=user, created_at__gte=week_ago).values_list(
        "overall_stress", flat=True
    )
    stress_avg = round(sum(stress_values) / len(stress_values), 2) if stress_values else None

    today = timezone.localdate()
    next_week = today + timedelta(days=7)
    upcoming_tasks = Task.objects.filter(user=user, due_date__gte=today, due_date__lte=next_week).order_by("due_date")
    upcoming_events = CalendarEvent.objects.filter(
        user=user, start_at__date__gte=today, start_at__date__lte=next_week
    ).order_by("start_at")
    if search_query:
        upcoming_tasks = upcoming_tasks.filter(Q(title__icontains=search_query) | Q(description__icontains=search_query))
        upcoming_events = upcoming_events.filter(title__icontains=search_query)

    tasks = Task.objects.filter(user=user)
    dashboard_data = {
        "tasks": {
            "todo": tasks.filter(status=TASK_TODO).count(),
            "doing": tasks.filter(status=TASK_DOING).count(),
            "done": tasks.filter(status=TASK_DONE).count(),
        },
        "mood_weekly_total": mood_entries.count(),
        "mood_most_common": most_common_mood,
        "focus_minutes_week": total_focus_minutes,
        "stress_avg_week": stress_avg,
        "upcoming_tasks": upcoming_tasks[:5],
        "upcoming_events": upcoming_events[:5],
        "upcoming_count": upcoming_tasks.count() + upcoming_events.count(),
    }

    return render(
        request,
        "ui/dashboard.html",
        {
            "onboarding_status": onboarding_status,
            "dashboard_data": dashboard_data,
            "search_query": search_query,
        },
    )


@login_required(login_url="/login/")
def onboarding_view(request):
    user = request.user
    progress = refresh_user_progress(user)
    onboarding_status = _build_steps(progress)
    return render(
        request,
        "ui/onboarding.html",
        {
            "current_step": onboarding_status["current_step"],
            "missing_steps": onboarding_status["missing_steps"],
            "required_actions": onboarding_status["required_actions"],
            "steps": onboarding_status["steps"],
        },
    )


@login_required(login_url="/login/")
def semesters_view(request):
    user = request.user
    session_key = "ui_semesters_filters"
    if request.GET.get("clear") == "1":
        request.session.pop(session_key, None)
        return redirect(request.path)
    if any(key in request.GET for key in ("status", "course", "teacher")):
        status_filter = request.GET.get("status", "")
        course_query = request.GET.get("course", "").strip()
        teacher_query = request.GET.get("teacher", "").strip()
        request.session[session_key] = {
            "status": status_filter,
            "course": course_query,
            "teacher": teacher_query,
        }
    else:
        saved = request.session.get(session_key, {})
        status_filter = saved.get("status", "")
        course_query = saved.get("course", "")
        teacher_query = saved.get("teacher", "")
    semesters = Semester.objects.filter(user=user)
    if status_filter in {SEMESTER_ACTIVE, SEMESTER_FINISHED}:
        semesters = semesters.filter(status=status_filter)
    semesters = semesters.order_by("-start_date")
    semester_cards = []
    for semester in semesters.prefetch_related("courses__assessments"):
        courses_data = []
        for course in semester.courses.all():
            if course_query and course_query.lower() not in course.title.lower():
                continue
            if teacher_query and teacher_query.lower() not in (course.teacher or "").lower():
                continue
            current_average, progress_percent, needed_to_pass = compute_course_progress(course)
            courses_data.append(
                {
                    "title": course.title,
                    "teacher": course.teacher,
                    "status": course.status,
                    "passing_grade": course.passing_grade,
                    "current_average": current_average,
                    "progress_percent": progress_percent,
                    "needed_to_pass": needed_to_pass,
                }
            )
        if (course_query or teacher_query) and not courses_data:
            continue
        semester_cards.append(
            {
                "name": semester.name,
                "start_date": semester.start_date,
                "end_date": semester.end_date,
                "status": semester.status,
                "courses": courses_data,
            }
        )

    return render(
        request,
        "ui/semesters.html",
        {
            "semesters": semester_cards,
            "status_filter": status_filter,
            "course_query": course_query,
            "teacher_query": teacher_query,
        },
    )


@login_required(login_url="/login/")
def tasks_view(request):
    user = request.user
    session_key = "ui_tasks_filters"
    if request.GET.get("clear") == "1":
        request.session.pop(session_key, None)
        return redirect(request.path)
    if any(key in request.GET for key in ("status", "due", "q", "stress")):
        status_filter = request.GET.get("status", "")
        due_filter = request.GET.get("due", "")
        search_query = request.GET.get("q", "").strip()
        stress_filter = request.GET.get("stress", "")
        request.session[session_key] = {
            "status": status_filter,
            "due": due_filter,
            "q": search_query,
            "stress": stress_filter,
        }
    else:
        saved = request.session.get(session_key, {})
        status_filter = saved.get("status", "")
        due_filter = saved.get("due", "")
        search_query = saved.get("q", "")
        stress_filter = saved.get("stress", "")
    tasks = Task.objects.filter(user=user)
    if status_filter in {TASK_TODO, TASK_DOING, TASK_DONE}:
        tasks = tasks.filter(status=status_filter)
    today = timezone.localdate()
    if due_filter == "overdue":
        tasks = tasks.filter(due_date__lt=today)
    elif due_filter == "today":
        tasks = tasks.filter(due_date=today)
    elif due_filter == "week":
        tasks = tasks.filter(due_date__gte=today, due_date__lte=today + timedelta(days=7))
    elif due_filter == "month":
        tasks = tasks.filter(due_date__gte=today, due_date__lte=today + timedelta(days=30))
    if search_query:
        tasks = tasks.filter(Q(title__icontains=search_query) | Q(description__icontains=search_query))
    if stress_filter in {"1", "2", "3", "4", "5"}:
        tasks = tasks.filter(stress_level=int(stress_filter))
    tasks = tasks.order_by("due_date")
    return render(
        request,
        "ui/tasks.html",
        {
            "tasks": tasks,
            "status_filter": status_filter,
            "due_filter": due_filter,
            "search_query": search_query,
            "stress_filter": stress_filter,
        },
    )


@login_required(login_url="/login/")
def agenda_view(request):
    user = request.user
    today = timezone.localdate()
    session_key = "ui_agenda_filters"
    if request.GET.get("clear") == "1":
        request.session.pop(session_key, None)
        return redirect(request.path)
    if any(key in request.GET for key in ("range", "q", "type")):
        range_days = request.GET.get("range", "30")
        if range_days not in {"7", "15", "30", "60", "90"}:
            range_days = "30"
        search_query = request.GET.get("q", "").strip()
        type_filter = request.GET.get("type", "")
        request.session[session_key] = {
            "range": range_days,
            "q": search_query,
            "type": type_filter,
        }
    else:
        saved = request.session.get(session_key, {})
        range_days = saved.get("range", "30")
        search_query = saved.get("q", "")
        type_filter = saved.get("type", "")
    next_month = today + timedelta(days=int(range_days))
    events = CalendarEvent.objects.filter(
        user=user, start_at__date__gte=today, start_at__date__lte=next_month
    ).order_by("start_at")
    if search_query:
        events = events.filter(title__icontains=search_query)
    event_type_values = [value for value, _label in EVENT_TYPE_CHOICES]
    if type_filter in event_type_values:
        events = events.filter(event_type=type_filter)
    reminder_rules = ReminderRule.objects.filter(user=user, is_active=True)
    return render(
        request,
        "ui/agenda.html",
        {
            "events": events,
            "reminder_rules": reminder_rules,
            "range_days": range_days,
            "search_query": search_query,
            "type_filter": type_filter,
            "event_type_choices": EVENT_TYPE_CHOICES,
        },
    )

--- FILE: config/__init__.py ---


--- FILE: config/asgi.py ---
"""
ASGI config for config project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/4.2/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

application = get_asgi_application()

--- FILE: config/settings.py ---
"""
Django settings for campus_calm project.
"""

import os
import sys
from pathlib import Path

BASE_DIR = Path(__file__).resolve().parent.parent

# Ensure /apps is on the path for INSTALLED_APPS like "accounts"
sys.path.insert(0, str(BASE_DIR / "apps"))

SECRET_KEY = os.getenv("DJANGO_SECRET_KEY", "django-insecure-dev-key")
DEBUG = os.getenv("DJANGO_DEBUG", "True").lower() == "true"
ALLOWED_HOSTS = [host for host in os.getenv("DJANGO_ALLOWED_HOSTS", "").split(",") if host]

INSTALLED_APPS = [
    "django.contrib.admin",
    "django.contrib.auth",
    "django.contrib.contenttypes",
    "django.contrib.sessions",
    "django.contrib.messages",
    "django.contrib.staticfiles",
    "corsheaders",
    "rest_framework",
    "rest_framework_simplejwt",
    "drf_spectacular",
    "accounts",
    "billing.apps.BillingConfig",
    "mood",
    "pomodoro",
    "planner",
    "agenda",
    "semester",
    "content",
    "coach_ai",
    "notifications",
    "access_requests",
    "onboarding.apps.OnboardingConfig",
    "analytics",
    "ui.apps.UiConfig",
]

MIDDLEWARE = [
    "corsheaders.middleware.CorsMiddleware",
    "django.middleware.security.SecurityMiddleware",
    "django.contrib.sessions.middleware.SessionMiddleware",
    "django.middleware.common.CommonMiddleware",
    "django.middleware.csrf.CsrfViewMiddleware",
    "django.contrib.auth.middleware.AuthenticationMiddleware",
    "django.contrib.messages.middleware.MessageMiddleware",
    "django.middleware.clickjacking.XFrameOptionsMiddleware",
]

ROOT_URLCONF = "config.urls"

TEMPLATES = [
    {
        "BACKEND": "django.template.backends.django.DjangoTemplates",
        "DIRS": [BASE_DIR / "templates"],
        "APP_DIRS": True,
        "OPTIONS": {
            "context_processors": [
                "django.template.context_processors.debug",
                "django.template.context_processors.request",
                "django.contrib.auth.context_processors.auth",
                "django.contrib.messages.context_processors.messages",
            ],
        },
    }
]

WSGI_APPLICATION = "config.wsgi.application"

DATABASES = {
    "default": {
        "ENGINE": "django.db.backends.sqlite3",
        "NAME": BASE_DIR / "db.sqlite3",
    }
}

AUTH_PASSWORD_VALIDATORS = [
    {"NAME": "django.contrib.auth.password_validation.UserAttributeSimilarityValidator"},
    {"NAME": "django.contrib.auth.password_validation.MinimumLengthValidator"},
    {"NAME": "django.contrib.auth.password_validation.CommonPasswordValidator"},
    {"NAME": "django.contrib.auth.password_validation.NumericPasswordValidator"},
]

LANGUAGE_CODE = "pt-br"
TIME_ZONE = "America/Sao_Paulo"
USE_I18N = True
USE_TZ = True

STATIC_URL = "/static/"
STATICFILES_DIRS = [BASE_DIR / "static"]

MEDIA_URL = "/media/"
MEDIA_ROOT = BASE_DIR / "media"

DEFAULT_AUTO_FIELD = "django.db.models.BigAutoField"
AUTH_USER_MODEL = "accounts.User"

REST_FRAMEWORK = {
    "DEFAULT_AUTHENTICATION_CLASSES": (
        "rest_framework_simplejwt.authentication.JWTAuthentication",
    ),
    "DEFAULT_PERMISSION_CLASSES": ("rest_framework.permissions.IsAuthenticated",),
    "DEFAULT_SCHEMA_CLASS": "drf_spectacular.openapi.AutoSchema",
}

SPECTACULAR_SETTINGS = {
    "TITLE": "Campus Calm API",
    "DESCRIPTION": "API do MVP Campus Calm",
    "VERSION": "0.1.0",
}

CORS_ALLOW_ALL_ORIGINS = True

EMAIL_BACKEND = "django.core.mail.backends.console.EmailBackend"
DEFAULT_FROM_EMAIL = os.getenv("DEFAULT_FROM_EMAIL", "no-reply@campuscalm.local")

LOGIN_URL = "/login/"
LOGIN_REDIRECT_URL = "/"
LOGOUT_REDIRECT_URL = "/login/"

--- FILE: config/settings_migrations.py ---
"""Settings file for generating migrations without third-party dependencies."""

import os
import sys
from pathlib import Path

BASE_DIR = Path(__file__).resolve().parent.parent
sys.path.insert(0, str(BASE_DIR / "apps"))

SECRET_KEY = "migration-only"
DEBUG = True
ALLOWED_HOSTS = []

INSTALLED_APPS = [
    "django.contrib.admin",
    "django.contrib.auth",
    "django.contrib.contenttypes",
    "django.contrib.sessions",
    "django.contrib.messages",
    "django.contrib.staticfiles",
    "accounts",
    "billing.apps.BillingConfig",
    "mood",
    "pomodoro",
    "planner",
    "agenda",
    "semester",
    "content",
    "coach_ai",
    "notifications",
    "access_requests",
    "onboarding.apps.OnboardingConfig",
    "analytics",
    "ui.apps.UiConfig",
]

MIDDLEWARE = [
    "django.middleware.security.SecurityMiddleware",
    "django.contrib.sessions.middleware.SessionMiddleware",
    "django.middleware.common.CommonMiddleware",
    "django.middleware.csrf.CsrfViewMiddleware",
    "django.contrib.auth.middleware.AuthenticationMiddleware",
    "django.contrib.messages.middleware.MessageMiddleware",
    "django.middleware.clickjacking.XFrameOptionsMiddleware",
]

ROOT_URLCONF = "config.urls"

TEMPLATES = [
    {
        "BACKEND": "django.template.backends.django.DjangoTemplates",
        "DIRS": [BASE_DIR / "templates"],
        "APP_DIRS": True,
        "OPTIONS": {
            "context_processors": [
                "django.template.context_processors.debug",
                "django.template.context_processors.request",
                "django.contrib.auth.context_processors.auth",
                "django.contrib.messages.context_processors.messages",
            ],
        },
    }
]

DATABASES = {
    "default": {
        "ENGINE": "django.db.backends.sqlite3",
        "NAME": BASE_DIR / "db.sqlite3",
    }
}

LANGUAGE_CODE = "pt-br"
TIME_ZONE = "America/Sao_Paulo"
USE_I18N = True
USE_TZ = True

STATIC_URL = "/static/"
MEDIA_URL = "/media/"
MEDIA_ROOT = BASE_DIR / "media"

DEFAULT_AUTO_FIELD = "django.db.models.BigAutoField"
AUTH_USER_MODEL = "accounts.User"

--- FILE: config/urls.py ---
from django.conf import settings
from django.conf.urls.static import static
from django.contrib import admin
from django.urls import include, path
from drf_spectacular.views import SpectacularAPIView, SpectacularSwaggerView

from config.views import health_check

urlpatterns = [
    path("admin/", admin.site.urls),
    path("health/", health_check, name="health-check"),
    path("", include("ui.urls")),
    path("api/schema/", SpectacularAPIView.as_view(), name="schema"),
    path("api/docs/", SpectacularSwaggerView.as_view(url_name="schema"), name="docs"),
    path("api/auth/", include("accounts.urls")),
    path("api/billing/", include("billing.urls")),
    path("api/mood/", include("mood.urls")),
    path("api/pomodoro/", include("pomodoro.urls")),
    path("api/planner/", include("planner.urls")),
    path("api/agenda/", include("agenda.urls")),
    path("api/semester/", include("semester.urls")),
    path("api/content/", include("content.urls")),
    path("api/notifications/", include("notifications.urls")),
    path("api/access/", include("access_requests.urls")),
    path("api/onboarding/", include("onboarding.urls")),
    path("api/analytics/", include("analytics.urls")),
]

if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)

--- FILE: config/views.py ---
from django.http import JsonResponse
from django.utils import timezone


def health_check(_request):
    return JsonResponse({"status": "ok", "timestamp": timezone.now().isoformat()})

--- FILE: config/wsgi.py ---
"""
WSGI config for config project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/4.2/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

application = get_wsgi_application()

--- FILE: manage.py ---
#!/usr/bin/env python3
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()

--- FILE: requirements.txt ---
Django>=5.0
djangorestframework>=3.15
djangorestframework-simplejwt>=5.3
django-cors-headers>=4.3
drf-spectacular>=0.27

--- FILE: scripts/run_curl_demo.sh ---
#!/usr/bin/env bash
set -euo pipefail

API_HOST="${API_HOST:-http://localhost:8000}"
EMAIL="${API_EMAIL:-nari.naluu@gmail.com}"
PASSWORD="${API_PASSWORD:-Pucca&garu@20}"

login_response=$(curl -s -X POST "${API_HOST}/api/auth/login/" \
  -H "Content-Type: application/json" \
  -d "{\"email\":\"${EMAIL}\",\"password\":\"${PASSWORD}\"}")

access=$(printf '%s' "$login_response" | python3 - <<'PY'
import json, sys
try:
    data = json.load(sys.stdin)
    print(data.get("access", ""))
except Exception:
    print("", end="")
PY
)

if [ -z "$access" ]; then
  echo "Falha no login. Resposta:" >&2
  echo "$login_response" >&2
  exit 1
fi

bearer="Authorization: Bearer $access"

echo "== /api/auth/me/"
curl -s -H "$bearer" "${API_HOST}/api/auth/me/" | python3 -m json.tool

echo "== /api/mood/entries/"
curl -s -H "$bearer" "${API_HOST}/api/mood/entries/" | python3 -m json.tool

echo "== /api/planner/tasks/"
curl -s -H "$bearer" "${API_HOST}/api/planner/tasks/" | python3 -m json.tool

echo "== /api/agenda/week/"
curl -s -H "$bearer" "${API_HOST}/api/agenda/week/" | python3 -m json.tool

echo "== /api/semester/courses/"
course_list=$(curl -s -H "$bearer" "${API_HOST}/api/semester/courses/")
course_id=$(printf '%s' "$course_list" | python3 - <<'PY'
import json, sys
try:
    data = json.load(sys.stdin)
    if data:
        print(data[0].get("id", ""))
except Exception:
    print("")
PY
)

echo "$course_list" | python3 -m json.tool

if [ -n "$course_id" ]; then
  echo "== /api/semester/courses/${course_id}/progress/"
  curl -s -H "$bearer" "${API_HOST}/api/semester/courses/${course_id}/progress/" | python3 -m json.tool
fi

echo "== /api/content/guided/"
curl -s -H "$bearer" "${API_HOST}/api/content/guided/" | python3 -m json.tool

echo "== /api/onboarding/status/"
curl -s -H "$bearer" "${API_HOST}/api/onboarding/status/" | python3 -m json.tool

echo "== /api/analytics/dashboard/"
curl -s -H "$bearer" "${API_HOST}/api/analytics/dashboard/" | python3 -m json.tool

--- FILE: static/css/app.css ---
:root {
  --sidebar-width: 220px;
  --sidebar-bg: #ffffff;
  --primary-soft: #e8f0fb;
  --brand: #1d4ed8;
}

body {
  font-family: "Sora", system-ui, sans-serif;
}

.sidebar {
  width: var(--sidebar-width);
  min-height: 100vh;
  position: fixed;
  left: 0;
  top: 0;
  padding-top: 12px;
  box-shadow: 0 0 12px rgba(15, 23, 42, 0.04);
}

.content {
  margin-left: var(--sidebar-width);
  min-height: 100vh;
}

.nav-link {
  color: #334155;
  padding: 0.5rem 0.75rem;
  margin-bottom: 4px;
}

.nav-link:hover {
  background: var(--primary-soft);
  border-radius: 6px;
}

.nav-link.active {
  background: #dbe7f8;
  border-radius: 6px;
  font-weight: 600;
}

.card {
  border-radius: 10px;
}

.bg-auth {
  min-height: 100vh;
  background: radial-gradient(circle at top left, #e2e8f0, #f8fafc 60%);
  position: relative;
  overflow: hidden;
}

.auth-shell {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 24px;
  position: relative;
  z-index: 1;
}

.auth-card {
  background: #ffffff;
  border-radius: 16px;
  width: min(420px, 100%);
  overflow: hidden;
  border: 1px solid #e2e8f0;
}

.auth-header {
  padding: 28px 28px 16px;
  background: linear-gradient(135deg, #1d4ed8, #3b82f6);
  color: #fff;
}

.auth-logo {
  font-weight: 700;
  font-size: 1.25rem;
  letter-spacing: 0.2px;
}

.auth-subtitle {
  font-size: 0.85rem;
  opacity: 0.9;
}

.auth-body {
  padding: 24px 28px 28px;
}

.bg-auth::before,
.bg-auth::after {
  content: "";
  position: absolute;
  width: 320px;
  height: 320px;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, rgba(59, 130, 246, 0.25), transparent 60%);
  filter: blur(2px);
}

.bg-auth::before {
  top: -80px;
  right: -120px;
}

.bg-auth::after {
  bottom: -100px;
  left: -120px;
}

--- FILE: templates/base.html ---
{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Campus Calm</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{% static 'css/app.css' %}" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="d-flex">
    <nav class="sidebar bg-white border-end">
      <div class="p-3">
        <div class="fw-bold fs-5">Campus Calm</div>
        <div class="text-muted small">Painel do aluno</div>
        <div class="mt-3 small text-muted">
          Ol, {{ request.user.name|default:request.user.email }}
        </div>
        <ul class="nav flex-column mt-4">
          <li class="nav-item">
            <a class="nav-link {% if request.path == '/' %}active{% endif %}" href="/">Dashboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if request.path|slice:":11" == "/onboarding" %}active{% endif %}" href="/onboarding/">Onboarding</a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if request.path|slice:":10" == "/semesters" %}active{% endif %}" href="/semesters/">Semestres</a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if request.path|slice:":6" == "/tasks" %}active{% endif %}" href="/tasks/">Tarefas</a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if request.path|slice:":7" == "/agenda" %}active{% endif %}" href="/agenda/">Agenda</a>
          </li>
        </ul>
        <div class="mt-4 pt-3 border-top">
          <a class="nav-link text-danger" href="/logout/">Sair</a>
        </div>
      </div>
    </nav>

    <main class="content flex-grow-1">
      <div class="container-fluid py-4">
        {% block content %}{% endblock %}
      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

--- FILE: templates/registration/password_reset_email.html ---
{% autoescape off %}
Voce solicitou a redefinicao de senha do Campus Calm.

Para criar uma nova senha, acesse o link abaixo:
{{ protocol }}://{{ domain }}{% url 'password_reset_confirm' uidb64=uid token=token %}

Se voce nao solicitou, ignore esta mensagem.
{% endautoescape %}

--- FILE: templates/registration/password_reset_subject.txt ---
Campus Calm - Redefinicao de senha

--- FILE: templates/ui/agenda.html ---
{% extends "base.html" %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h1 class="h4 mb-1">Agenda</h1>
    <div class="text-muted">Eventos dos proximos {{ range_days }} dias</div>
  </div>
</div>

<form class="row g-2 mb-3" method="get">
  <div class="col-sm-4 col-md-3">
    <input class="form-control form-control-sm" type="text" name="q" placeholder="Buscar evento"
           value="{{ search_query }}">
  </div>
  <div class="col-sm-4 col-md-3">
    <select class="form-select form-select-sm" name="type">
      <option value="">Todos os tipos</option>
      {% for value,label in event_type_choices %}
        <option value="{{ value }}" {% if type_filter == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-sm-4 col-md-3">
    <select class="form-select form-select-sm" name="range">
      <option value="7" {% if range_days == "7" %}selected{% endif %}>Proximos 7 dias</option>
      <option value="15" {% if range_days == "15" %}selected{% endif %}>Proximos 15 dias</option>
      <option value="30" {% if range_days == "30" %}selected{% endif %}>Proximos 30 dias</option>
      <option value="60" {% if range_days == "60" %}selected{% endif %}>Proximos 60 dias</option>
      <option value="90" {% if range_days == "90" %}selected{% endif %}>Proximos 90 dias</option>
    </select>
  </div>
  <div class="col-auto">
    <button class="btn btn-sm btn-outline-secondary" type="submit">Filtrar</button>
    <a class="btn btn-sm btn-link" href="/agenda/?clear=1">Limpar</a>
  </div>
</form>

<div class="row g-3">
  <div class="col-lg-7">
    <div class="card shadow-sm">
      <div class="card-header bg-white fw-semibold">Eventos</div>
      <div class="card-body">
        {% if events %}
          <ul class="list-group list-group-flush">
            {% for event in events %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-semibold">{{ event.title }}</div>
                  <div class="text-muted small">{{ event.event_type }}</div>
                </div>
                <span class="text-muted small">{{ event.start_at|date:"d/m/Y H:i" }}</span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted">Nenhum evento nos proximos dias.</div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-lg-5">
    <div class="card shadow-sm">
      <div class="card-header bg-white fw-semibold">Lembretes ativos</div>
      <div class="card-body">
        {% if reminder_rules %}
          <ul class="list-group list-group-flush">
            {% for rule in reminder_rules %}
              <li class="list-group-item d-flex justify-content-between">
                <span>{{ rule.target_type }}</span>
                <span class="text-muted small">{{ rule.remind_before_minutes }} min antes</span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted">Nenhuma regra ativa.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

--- FILE: templates/ui/auth_base.html ---
{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Campus Calm - Acesso</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{% static 'css/app.css' %}" rel="stylesheet">
</head>
<body class="bg-auth">
  <div class="auth-shell">
    {% block content %}{% endblock %}
  </div>
</body>
</html>

--- FILE: templates/ui/dashboard.html ---
{% extends "base.html" %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h1 class="h4 mb-1">Dashboard</h1>
    <div class="text-muted">Resumo da semana</div>
  </div>
  <form class="d-flex" method="get">
    <input class="form-control form-control-sm me-2" type="text" name="q" placeholder="Buscar tarefa ou evento"
           value="{{ search_query }}">
    <button class="btn btn-sm btn-outline-secondary" type="submit">Aplicar</button>
    <a class="btn btn-sm btn-link ms-2" href="/?clear=1">Limpar</a>
  </form>
</div>

{% if not onboarding_status.is_complete %}
<div class="alert alert-warning">
  <div class="fw-semibold">Onboarding incompleto</div>
  <div>Finalize as etapas pendentes para liberar todo o painel.</div>
  <a class="btn btn-sm btn-outline-dark mt-2" href="/onboarding/">Continuar configuracao</a>
</div>
{% endif %}

<div class="row g-3">
  <div class="col-md-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="text-muted small">Humor da semana</div>
        <div class="fs-4 fw-bold">{{ dashboard_data.mood_most_common|default:"Sem dados" }}</div>
        <div class="text-muted small">{{ dashboard_data.mood_weekly_total }} registros</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="text-muted small">Minutos de foco</div>
        <div class="fs-4 fw-bold">{{ dashboard_data.focus_minutes_week }}</div>
        <div class="text-muted small">ultimos 7 dias</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="text-muted small">Estresse da semana</div>
        <div class="fs-4 fw-bold">{{ dashboard_data.stress_avg_week|default:"Sem dados" }}</div>
        <div class="text-muted small">media dos check-ins</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="text-muted small">Proximos prazos</div>
        <div class="fs-4 fw-bold">{{ dashboard_data.upcoming_count }}</div>
        <div class="text-muted small">tarefas e eventos</div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mt-3">
  <div class="col-lg-7">
    <div class="card shadow-sm">
      <div class="card-header bg-white fw-semibold">Proximos eventos</div>
      <div class="card-body">
        {% if dashboard_data.upcoming_events %}
          <ul class="list-group list-group-flush">
            {% for event in dashboard_data.upcoming_events %}
              <li class="list-group-item d-flex justify-content-between">
                <span>{{ event.title }}</span>
                <span class="text-muted small">{{ event.start_at|date:"d/m/Y H:i" }}</span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted">Nenhum evento nos proximos dias.</div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-lg-5">
    <div class="card shadow-sm">
      <div class="card-header bg-white fw-semibold">Tarefas proximas</div>
      <div class="card-body">
        {% if dashboard_data.upcoming_tasks %}
          <ul class="list-group list-group-flush">
            {% for task in dashboard_data.upcoming_tasks %}
              <li class="list-group-item d-flex justify-content-between">
                <span>{{ task.title }}</span>
                <span class="text-muted small">{{ task.due_date|date:"d/m/Y" }}</span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted">Nenhuma tarefa proxima.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm mt-4">
  <div class="card-header bg-white fw-semibold">Status do Onboarding</div>
  <div class="card-body">
    <ul class="list-group list-group-flush">
      {% for step in onboarding_status.steps %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <span>{{ step.label }}</span>
          {% if step.missing %}
            <span class="badge text-bg-warning">Pendente</span>
          {% else %}
            <span class="badge text-bg-success">Ok</span>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
    {% if not onboarding_status.is_complete %}
      <div class="mt-3">
        <a class="btn btn-primary btn-sm" href="/onboarding/">Continuar configuracao</a>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

--- FILE: templates/ui/login.html ---
{% extends "ui/auth_base.html" %}

{% block content %}
<div class="auth-card shadow-sm">
  <div class="auth-header">
    <div class="auth-logo">Campus Calm</div>
    <div class="auth-subtitle">Bem-estar e organizacao para universitarios</div>
  </div>
  <div class="auth-body">
    <h1 class="h5 mb-3">Acesso ao painel</h1>
    <p class="text-muted small mb-4">Entre com seu email institucional ou pessoal para continuar.</p>

    {% if form.errors %}
      <div class="alert alert-danger">
        Email ou senha invalidos. Tente novamente.
      </div>
    {% endif %}

    <form method="post" novalidate>
      {% csrf_token %}
      <div class="mb-3">
        <label class="form-label">{{ form.username.label }}</label>
        {{ form.username }}
      </div>
      <div class="mb-3">
        <label class="form-label">{{ form.password.label }}</label>
        <div class="input-group">
          {{ form.password }}
          <button class="btn btn-outline-secondary" type="button" id="toggle-password">Mostrar</button>
        </div>
      </div>
      <button type="submit" class="btn btn-primary w-100">Entrar</button>
    </form>

    <div class="mt-3 text-center">
      <a class="small text-decoration-none" href="/password-reset/">Esqueci minha senha</a>
    </div>

    <div class="auth-footer text-muted small mt-4">
      Dica: use o mesmo login do sistema administrativo se ja tiver acesso.
    </div>
  </div>
</div>

<script>
  const toggleBtn = document.getElementById("toggle-password");
  const passwordInput = document.getElementById("id_password");
  if (toggleBtn && passwordInput) {
    toggleBtn.addEventListener("click", () => {
      const isPassword = passwordInput.getAttribute("type") === "password";
      passwordInput.setAttribute("type", isPassword ? "text" : "password");
      toggleBtn.textContent = isPassword ? "Ocultar" : "Mostrar";
    });
  }
</script>
{% endblock %}

--- FILE: templates/ui/onboarding.html ---
{% extends "base.html" %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h1 class="h4 mb-1">Onboarding</h1>
    <div class="text-muted">Etapas para completar a configuracao</div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <ul class="list-group list-group-flush">
      {% for step in steps %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <div class="fw-semibold">{{ step.label }}</div>
            <div class="text-muted small">{{ step.message }}</div>
          </div>
          {% if step.missing %}
            <span class="badge text-bg-warning"></span>
          {% else %}
            <span class="badge text-bg-success"></span>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  </div>
</div>

{% if required_actions %}
<div class="card shadow-sm mt-3">
  <div class="card-header bg-white fw-semibold">Acoes recomendadas</div>
  <div class="card-body">
    <ul class="mb-0">
      {% for action in required_actions %}
        <li>{{ action }}</li>
      {% endfor %}
    </ul>
  </div>
</div>
{% endif %}

<div class="card shadow-sm mt-3">
  <div class="card-header bg-white fw-semibold">Sugestoes rapidas</div>
  <div class="card-body">
    <ul class="mb-0">
      <li><a href="/semesters/">Ver semestres</a></li>
      <li><a href="/tasks/">Ver tarefas</a></li>
      <li><a href="/agenda/">Ver agenda</a></li>
      <li><a href="/api/semester/assessments/">Cadastrar avaliacao (API)</a></li>
    </ul>
  </div>
</div>
{% endblock %}

--- FILE: templates/ui/password_reset_complete.html ---
{% extends "ui/auth_base.html" %}

{% block content %}
<div class="auth-card shadow-sm">
  <div class="auth-header">
    <div class="auth-logo">Campus Calm</div>
    <div class="auth-subtitle">Senha atualizada</div>
  </div>
  <div class="auth-body">
    <h1 class="h5 mb-3">Senha redefinida</h1>
    <p class="text-muted small">Sua senha foi atualizada. Voce ja pode acessar o painel.</p>
    <div class="mt-3 text-center">
      <a class="small text-decoration-none" href="/login/">Ir para o login</a>
    </div>
  </div>
</div>
{% endblock %}

--- FILE: templates/ui/password_reset_confirm.html ---
{% extends "ui/auth_base.html" %}

{% block content %}
<div class="auth-card shadow-sm">
  <div class="auth-header">
    <div class="auth-logo">Campus Calm</div>
    <div class="auth-subtitle">Nova senha</div>
  </div>
  <div class="auth-body">
    <h1 class="h5 mb-3">Definir nova senha</h1>
    <form method="post">
      {% csrf_token %}
      <div class="mb-3">
        <label class="form-label" for="id_new_password1">Nova senha</label>
        <input class="form-control" type="password" name="new_password1" id="id_new_password1" required>
      </div>
      <div class="mb-3">
        <label class="form-label" for="id_new_password2">Confirmar nova senha</label>
        <input class="form-control" type="password" name="new_password2" id="id_new_password2" required>
      </div>
      <button type="submit" class="btn btn-primary w-100">Atualizar senha</button>
    </form>
  </div>
</div>
{% endblock %}

--- FILE: templates/ui/password_reset_done.html ---
{% extends "ui/auth_base.html" %}

{% block content %}
<div class="auth-card shadow-sm">
  <div class="auth-header">
    <div class="auth-logo">Campus Calm</div>
    <div class="auth-subtitle">Email enviado</div>
  </div>
  <div class="auth-body">
    <h1 class="h5 mb-3">Verifique sua caixa de entrada</h1>
    <p class="text-muted small">Se o email existir no sistema, voce recebera um link para redefinir a senha.</p>
    <div class="mt-3 text-center">
      <a class="small text-decoration-none" href="/login/">Voltar ao login</a>
    </div>
  </div>
</div>
{% endblock %}

--- FILE: templates/ui/password_reset_form.html ---
{% extends "ui/auth_base.html" %}

{% block content %}
<div class="auth-card shadow-sm">
  <div class="auth-header">
    <div class="auth-logo">Campus Calm</div>
    <div class="auth-subtitle">Recuperacao de acesso</div>
  </div>
  <div class="auth-body">
    <h1 class="h5 mb-3">Redefinir senha</h1>
    <p class="text-muted small mb-4">Informe seu email para receber o link de redefinicao.</p>

    <form method="post">
      {% csrf_token %}
      <div class="mb-3">
        <label class="form-label" for="id_email">Email</label>
        <input class="form-control" type="email" name="email" id="id_email" placeholder="seu.email@universidade.edu" required>
      </div>
      <button type="submit" class="btn btn-primary w-100">Enviar link</button>
    </form>

    <div class="mt-3 text-center">
      <a class="small text-decoration-none" href="/login/">Voltar ao login</a>
    </div>
  </div>
</div>
{% endblock %}

--- FILE: templates/ui/semesters.html ---
{% extends "base.html" %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h1 class="h4 mb-1">Semestres</h1>
    <div class="text-muted">Resumo das disciplinas e progresso</div>
  </div>
</div>

<form class="row g-2 mb-3" method="get">
  <div class="col-sm-4 col-md-2">
    <select class="form-select form-select-sm" name="status">
      <option value="">Todos os status</option>
      <option value="ACTIVE" {% if status_filter == "ACTIVE" %}selected{% endif %}>Ativo</option>
      <option value="FINISHED" {% if status_filter == "FINISHED" %}selected{% endif %}>Finalizado</option>
    </select>
  </div>
  <div class="col-sm-4 col-md-3">
    <input class="form-control form-control-sm" type="text" name="course" placeholder="Filtrar por disciplina"
           value="{{ course_query }}">
  </div>
  <div class="col-sm-4 col-md-3">
    <input class="form-control form-control-sm" type="text" name="teacher" placeholder="Filtrar por professor"
           value="{{ teacher_query }}">
  </div>
  <div class="col-auto">
    <button class="btn btn-sm btn-outline-secondary" type="submit">Filtrar</button>
    <a class="btn btn-sm btn-link" href="/semesters/?clear=1">Limpar</a>
  </div>
</form>

{% if semesters %}
  {% for semester in semesters %}
    <div class="card shadow-sm mb-3">
      <div class="card-header bg-white d-flex justify-content-between">
        <div class="fw-semibold">{{ semester.name }}</div>
        <div class="text-muted small">{{ semester.start_date|date:"d/m/Y" }} - {{ semester.end_date|date:"d/m/Y" }}</div>
      </div>
      <div class="card-body">
        {% if semester.courses %}
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Disciplina</th>
                  <th>Professor</th>
                  <th>Status</th>
                  <th>Media atual</th>
                  <th>Progresso</th>
                  <th>Falta para passar</th>
                </tr>
              </thead>
              <tbody>
                {% for course in semester.courses %}
                  <tr>
                    <td>{{ course.title }}</td>
                    <td>{{ course.teacher|default:"-" }}</td>
                    <td>
                      {% if course.status == "PASSED" %}
                        <span class="badge text-bg-success">Aprovado</span>
                      {% elif course.status == "FAILED" %}
                        <span class="badge text-bg-danger">Reprovado</span>
                      {% else %}
                        <span class="badge text-bg-secondary">Em andamento</span>
                      {% endif %}
                    </td>
                    <td>{{ course.current_average }}</td>
                    <td>{{ course.progress_percent }}%</td>
                    <td>{{ course.needed_to_pass }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-muted">Nenhuma disciplina cadastrada.</div>
        {% endif %}
      </div>
    </div>
  {% endfor %}
{% else %}
  <div class="alert alert-info">Nenhum semestre cadastrado.</div>
{% endif %}
{% endblock %}

--- FILE: templates/ui/tasks.html ---
{% extends "base.html" %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h1 class="h4 mb-1">Tarefas</h1>
    <div class="text-muted">Lista de tarefas academicas</div>
  </div>
</div>

<form class="row g-2 mb-3" method="get">
  <div class="col-sm-4 col-md-3">
    <input class="form-control form-control-sm" type="text" name="q" placeholder="Buscar tarefa"
           value="{{ search_query }}">
  </div>
  <div class="col-sm-4 col-md-2">
    <select class="form-select form-select-sm" name="stress">
      <option value="">Stress</option>
      <option value="1" {% if stress_filter == "1" %}selected{% endif %}>1</option>
      <option value="2" {% if stress_filter == "2" %}selected{% endif %}>2</option>
      <option value="3" {% if stress_filter == "3" %}selected{% endif %}>3</option>
      <option value="4" {% if stress_filter == "4" %}selected{% endif %}>4</option>
      <option value="5" {% if stress_filter == "5" %}selected{% endif %}>5</option>
    </select>
  </div>
  <div class="col-sm-4 col-md-3">
    <select class="form-select form-select-sm" name="status">
      <option value="">Todos os status</option>
      <option value="TODO" {% if status_filter == "TODO" %}selected{% endif %}>A fazer</option>
      <option value="DOING" {% if status_filter == "DOING" %}selected{% endif %}>Em andamento</option>
      <option value="DONE" {% if status_filter == "DONE" %}selected{% endif %}>Concluida</option>
    </select>
  </div>
  <div class="col-sm-4 col-md-3">
    <select class="form-select form-select-sm" name="due">
      <option value="">Todas as datas</option>
      <option value="overdue" {% if due_filter == "overdue" %}selected{% endif %}>Atrasadas</option>
      <option value="today" {% if due_filter == "today" %}selected{% endif %}>Hoje</option>
      <option value="week" {% if due_filter == "week" %}selected{% endif %}>Proxima semana</option>
      <option value="month" {% if due_filter == "month" %}selected{% endif %}>Proximo mes</option>
    </select>
  </div>
  <div class="col-auto">
    <button class="btn btn-sm btn-outline-secondary" type="submit">Filtrar</button>
    <a class="btn btn-sm btn-link" href="/tasks/?clear=1">Limpar</a>
  </div>
</form>

<div class="card shadow-sm">
  <div class="card-body">
    {% if tasks %}
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Titulo</th>
              <th>Entrega</th>
              <th>Stress</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for task in tasks %}
              <tr>
                <td>
                  <div class="fw-semibold">{{ task.title }}</div>
                  <div class="text-muted small">{{ task.description|default:"" }}</div>
                </td>
                <td>{{ task.due_date|date:"d/m/Y" }}</td>
                <td>{{ task.stress_level }}</td>
                <td>
                  {% if task.status == "DONE" %}
                    <span class="badge text-bg-success">Concluida</span>
                  {% elif task.status == "DOING" %}
                    <span class="badge text-bg-primary">Em andamento</span>
                  {% else %}
                    <span class="badge text-bg-secondary">A fazer</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted">Nenhuma tarefa cadastrada.</div>
    {% endif %}
  </div>
</div>
{% endblock %}

--- FILE: utils/__init__.py ---


--- FILE: utils/constants.py ---
PLAN_LITE = "LITE"
PLAN_PRO = "PRO"
PLAN_CHOICES = [
    (PLAN_LITE, "Lite"),
    (PLAN_PRO, "Pro"),
]

MOOD_VERY_BAD = "VERY_BAD"
MOOD_BAD = "BAD"
MOOD_OK = "OK"
MOOD_GOOD = "GOOD"
MOOD_VERY_GOOD = "VERY_GOOD"
MOOD_CHOICES = [
    (MOOD_VERY_BAD, "Very bad"),
    (MOOD_BAD, "Bad"),
    (MOOD_OK, "Ok"),
    (MOOD_GOOD, "Good"),
    (MOOD_VERY_GOOD, "Very good"),
]

POMODORO_COMPLETED = "COMPLETED"
POMODORO_STOPPED = "STOPPED"
POMODORO_STATUS_CHOICES = [
    (POMODORO_COMPLETED, "Completed"),
    (POMODORO_STOPPED, "Stopped"),
]

TASK_TODO = "TODO"
TASK_DOING = "DOING"
TASK_DONE = "DONE"
TASK_STATUS_CHOICES = [
    (TASK_TODO, "Todo"),
    (TASK_DOING, "Doing"),
    (TASK_DONE, "Done"),
]

EVENT_PROVA = "PROVA"
EVENT_ENTREGA = "ENTREGA"
EVENT_APRESENTACAO = "APRESENTACAO"
EVENT_AULA_IMPORTANTE = "AULA_IMPORTANTE"
EVENT_OUTRO = "OUTRO"
EVENT_TYPE_CHOICES = [
    (EVENT_PROVA, "Prova"),
    (EVENT_ENTREGA, "Entrega"),
    (EVENT_APRESENTACAO, "Apresentacao"),
    (EVENT_AULA_IMPORTANTE, "Aula importante"),
    (EVENT_OUTRO, "Outro"),
]

REMINDER_TARGET_TASK = "TASK"
REMINDER_TARGET_EVENT = "EVENT"
REMINDER_TARGET_CHOICES = [
    (REMINDER_TARGET_TASK, "Task"),
    (REMINDER_TARGET_EVENT, "Event"),
]

CHANNEL_EMAIL = "EMAIL"
CHANNEL_WHATSAPP = "WHATSAPP"
CHANNEL_SMS = "SMS"
CHANNEL_CHOICES = [
    (CHANNEL_EMAIL, "Email"),
    (CHANNEL_WHATSAPP, "WhatsApp"),
    (CHANNEL_SMS, "SMS"),
]

NOTIF_PENDING = "PENDING"
NOTIF_SENT = "SENT"
NOTIF_FAILED = "FAILED"
NOTIFICATION_STATUS_CHOICES = [
    (NOTIF_PENDING, "Pending"),
    (NOTIF_SENT, "Sent"),
    (NOTIF_FAILED, "Failed"),
]

SEMESTER_ACTIVE = "ACTIVE"
SEMESTER_FINISHED = "FINISHED"
SEMESTER_STATUS_CHOICES = [
    (SEMESTER_ACTIVE, "Active"),
    (SEMESTER_FINISHED, "Finished"),
]

COURSE_IN_PROGRESS = "IN_PROGRESS"
COURSE_PASSED = "PASSED"
COURSE_FAILED = "FAILED"
COURSE_STATUS_CHOICES = [
    (COURSE_IN_PROGRESS, "In progress"),
    (COURSE_PASSED, "Passed"),
    (COURSE_FAILED, "Failed"),
]

COACH_PRAZO_PROXIMO = "PRAZO_PROXIMO"
COACH_ATRASO = "ATRASO"
COACH_HUMOR_BAIXO = "HUMOR_BAIXO"
COACH_SEMESTRE_CONCLUIDO = "SEMESTRE_CONCLUIDO"
COACH_REPROVACAO = "REPROVACAO"
COACH_TRIGGER_CHOICES = [
    (COACH_PRAZO_PROXIMO, "Prazo proximo"),
    (COACH_ATRASO, "Atraso"),
    (COACH_HUMOR_BAIXO, "Humor baixo"),
    (COACH_SEMESTRE_CONCLUIDO, "Semestre concluido"),
    (COACH_REPROVACAO, "Reprovacao"),
]

CONTENT_PRE_PROVA = "PRE_PROVA"
CONTENT_ANTI_PROCRASTINACAO = "ANTI_PROCRASTINACAO"
CONTENT_FOCO = "FOCO"
CONTENT_CATEGORY_CHOICES = [
    (CONTENT_PRE_PROVA, "Pre-prova"),
    (CONTENT_ANTI_PROCRASTINACAO, "Anti-procrastinacao"),
    (CONTENT_FOCO, "Foco"),
]

REQUESTER_INDIVIDUAL = "INDIVIDUAL"
REQUESTER_INSTITUTION = "INSTITUTION"
REQUESTER_TYPE_CHOICES = [
    (REQUESTER_INDIVIDUAL, "Individual"),
    (REQUESTER_INSTITUTION, "Institution"),
]

ACCESS_PENDING = "PENDING"
ACCESS_APPROVED = "APPROVED"
ACCESS_REJECTED = "REJECTED"
ACCESS_STATUS_CHOICES = [
    (ACCESS_PENDING, "Pending"),
    (ACCESS_APPROVED, "Approved"),
    (ACCESS_REJECTED, "Rejected"),
]

STEP_1_PROFILE = "STEP_1_PROFILE"
STEP_2_SEMESTER = "STEP_2_SEMESTER"
STEP_3_COURSES = "STEP_3_COURSES"
STEP_4_ASSESSMENTS = "STEP_4_ASSESSMENTS"
STEP_5_REMINDERS = "STEP_5_REMINDERS"
STEP_6_DASHBOARD = "STEP_6_DASHBOARD"

FEATURE_MOOD_BASIC = "MOOD_BASIC"
FEATURE_POMODORO_BASIC = "POMODORO_BASIC"
FEATURE_PLANNER_BASIC = "PLANNER_BASIC"
FEATURE_AGENDA_BASIC = "AGENDA_BASIC"
FEATURE_IN_APP_REMINDERS = "IN_APP_REMINDERS"
FEATURE_DASHBOARD_BASIC = "DASHBOARD_BASIC"
FEATURE_CONTENT_LIMITED = "CONTENT_LIMITED"
FEATURE_EMAIL_NOTIFICATIONS = "EMAIL_NOTIFICATIONS"
FEATURE_REPORTS_ADVANCED = "REPORTS_ADVANCED"
FEATURE_SEMESTER_SUMMARY = "SEMESTER_SUMMARY"
FEATURE_COACH_ADVANCED = "COACH_ADVANCED"
FEATURE_CONTENT_FULL = "CONTENT_FULL"
FEATURE_WHATSAPP = "WHATSAPP"
FEATURE_SMS = "SMS"

--- FILE: utils/features.py ---
from typing import Optional

from rest_framework.exceptions import PermissionDenied

from billing.models import Plan, UserSubscription
from utils.constants import PLAN_LITE


def get_user_plan(user) -> Optional[Plan]:
    if not user or not getattr(user, "is_authenticated", False):
        return None
    subscription = (
        UserSubscription.objects.filter(user=user, is_active=True)
        .select_related("plan")
        .first()
    )
    if subscription and subscription.plan and subscription.plan.is_active:
        return subscription.plan
    return Plan.objects.filter(code=PLAN_LITE, is_active=True).first()


def has_feature(user, feature_name: str) -> bool:
    plan = get_user_plan(user)
    if not plan or plan.features is None:
        return False
    if isinstance(plan.features, list):
        return feature_name in plan.features
    if isinstance(plan.features, dict):
        return bool(plan.features.get(feature_name))
    return False


def require_feature(user, feature_name: str, message: Optional[str] = None) -> None:
    if not has_feature(user, feature_name):
        raise PermissionDenied(message or "Seu plano atual nao permite este recurso.")

--- FILE: utils/gating.py ---
from typing import List, Tuple

from utils.constants import (
    STEP_1_PROFILE,
    STEP_2_SEMESTER,
    STEP_3_COURSES,
    STEP_4_ASSESSMENTS,
    STEP_5_REMINDERS,
    STEP_6_DASHBOARD,
)

STEPS = [
    (STEP_1_PROFILE, "has_profile", "Complete seu perfil para continuar."),
    (STEP_2_SEMESTER, "has_active_semester", "Crie um semestre ativo."),
    (STEP_3_COURSES, "has_at_least_one_course", "Cadastre ao menos uma disciplina."),
    (STEP_4_ASSESSMENTS, "has_at_least_one_assessment", "Cadastre ao menos uma avaliacao."),
    (STEP_5_REMINDERS, "has_reminder_rule", "Configure pelo menos uma regra de lembrete."),
    (STEP_6_DASHBOARD, None, "Tudo pronto para seu dashboard."),
]


def get_or_create_progress(user):
    from onboarding.models import UserSetupProgress

    progress, _ = UserSetupProgress.objects.get_or_create(user=user)
    return progress


def compute_status(progress) -> Tuple[str, List[str], List[str]]:
    missing_steps = []
    required_actions = []
    for step, field, message in STEPS:
        if field is None:
            continue
        if not getattr(progress, field):
            missing_steps.append(step)
            required_actions.append(message)
    current_step = missing_steps[0] if missing_steps else STEP_6_DASHBOARD
    return current_step, missing_steps, required_actions


def gate_course_progress(course) -> Tuple[bool, str]:
    if not course.assessments.exists():
        return False, "Cadastre ao menos uma avaliacao antes de ver o progresso."
    return True, ""


def gate_finish_semester(semester) -> Tuple[bool, str]:
    if not semester.courses.exists():
        return False, "Nao e possivel finalizar um semestre sem disciplinas."
    return True, ""


def gate_generate_reminders(user) -> Tuple[bool, str]:
    from agenda.models import ReminderRule

    if not ReminderRule.objects.filter(user=user, is_active=True).exists():
        return False, "Configure uma regra de lembrete antes de gerar notificacoes."
    return True, ""

--- FILE: utils/triage.py ---
import os
from typing import Dict

from utils.constants import (
    FEATURE_COACH_ADVANCED,
    FEATURE_EMAIL_NOTIFICATIONS,
    FEATURE_REPORTS_ADVANCED,
    FEATURE_SMS,
    FEATURE_WHATSAPP,
    PLAN_LITE,
    PLAN_PRO,
    REQUESTER_INSTITUTION,
)

TRIAGE_MODEL_NAME = os.getenv("TRIAGE_MODEL_NAME", "mock-v1")
TRIAGE_USE_LLM = os.getenv("TRIAGE_USE_LLM", "false").lower() == "true"


def rule_based_plan(access_request) -> str:
    if access_request.requester_type == REQUESTER_INSTITUTION:
        return PLAN_PRO
    if access_request.estimated_users and access_request.estimated_users >= 50:
        return PLAN_PRO
    wants = set(access_request.wants_features or [])
    pro_features = {
        FEATURE_REPORTS_ADVANCED,
        FEATURE_EMAIL_NOTIFICATIONS,
        FEATURE_WHATSAPP,
        FEATURE_SMS,
        FEATURE_COACH_ADVANCED,
    }
    if wants.intersection(pro_features):
        return PLAN_PRO
    return PLAN_LITE


def mock_ai_output(recommended_plan: str) -> Dict[str, object]:
    if recommended_plan == PLAN_PRO:
        score = 82
        rationale = "Solicitacao com sinais de necessidade avancada."
    else:
        score = 28
        rationale = "Solicitacao adequada ao plano basico."
    return {
        "score": score,
        "recommended_plan": recommended_plan,
        "rationale": rationale,
        "llm_enabled": TRIAGE_USE_LLM,
    }


def run_triage(access_request) -> Dict[str, object]:
    recommended_plan = rule_based_plan(access_request)
    output = mock_ai_output(recommended_plan)
    return {
        "recommended_plan": recommended_plan,
        "output_payload": output,
    }
